<section id="HomeContent" class="min-h-screen bg-slate-50">
  <!-- HERO -->
  <header
    class="relative text-white">
 
      <div id="hero-slides" class="absolute inset-0"></div>
      <div class="absolute inset-0 bg-black/30 pointer-events-none"></div>
      <div class="absolute inset-x-0 bottom-0 p-6 md:p-10 text-white">
        <h1 class="text-2xl md:text-4xl font-extrabold drop-shadow">
          Sabinas Hidalgo ‚Äî Lugares que inspiran
        </h1>
        <p class="mt-2 text-sm md:text-base opacity-90">
          Descubre los rincones m√°s representativos del municipio.
        </p>
      
    </div>
  </header>

  <!-- KPI STRIP -->
  <section class="-mt-10 relative z-10">
    <div class="max-w-7xl mx-auto px-4">
      <div id="kpi-strip" class="grid grid-cols-2 md:grid-cols-5 gap-4"></div>
    </div>
  </section>

  <!-- SERVICES + FEATURED NEWS -->
  <section id="Servicios" class="py-16 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4">
      <!-- Featured News (showInHome) -->
      <div id="home-news" class="mb-10">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold text-municipal-blue">Featured News</h2>
          <a href="#/noticias" class="text-sm text-blue-600 hover:underline"
            >View all</a
          >
        </div>
        <div
          id="home-news-grid"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
        ></div>
        <div id="home-news-empty" class="text-gray-500 text-sm hidden">
          No featured news yet.
        </div>
      </div>

      <!-- Quick Links -->
      <section id="Servicios" class="py-16 bg-gray-50">
        <div class="max-w-6xl mx-auto px-4">
          <h2
            class="text-3xl md:text-4xl font-bold text-municipal-blue text-center mb-12"
          >
            Accesos R√°pidos
          </h2>

          <div
            id="ql-home-grid"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"
          ></div>
          <div
            id="ql-home-empty"
            class="text-center text-slate-500 text-sm hidden"
          >
            Sin accesos configurados.
          </div>
        </div>
      </section>
    </div>
  </section>

  <!-- TURISMO SHOW IN HOME -->
  <div class="p-1">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-2xl font-bold text-gray-800">Turismo Sabinense</h2>
      <div class="text-sm text-gov-gray">
        Explora nuestros lugares recomendados
      </div>
    </div>

    <!-- Grid simple (<=4) -->
    <div
      id="home-grid"
      style="display: none"
      class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"
    ></div>
    <div
      id="turismo-stack"
      class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"
    ></div>
    <!-- Reel (>4) -->
    <div id="home-reel" class="relative hidden">
      <button
        id="reel-prev"
        class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-white/90 hover:bg-white shadow p-3 rounded-full"
      >
        <i class="fas fa-chevron-left"></i>
      </button>
      <div id="reel-track" class="overflow-hidden">
        <div id="reel-inner" class="flex gap-4 will-change-transform"></div>
      </div>
      <button
        id="reel-next"
        class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-white/90 hover:bg-white shadow p-3 rounded-full"
      >
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>

  <!-- EVENTS + TURISMO (masonry-ish) -->
  <section class="py-12">
    <div class="mx-auto px-4">
      <div class="grid grid-cols-1">
        <!-- Events -->
        <div class="lg:col-span-1">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-slate-900">
              Pr√≥ximos Eventos
            </h2>
            <a href="#/eventos" class="text-sm text-blue-600 hover:underline"
              >Calendario</a
            >
          </div>
          <div
            id="events-grid"
            class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4"
          ></div>
          <div id="events-empty" class="text-slate-500 text-sm">
            No hay eventos pr√≥ximos.
          </div>
        </div>

        <!-- Turismo -->
        <div style="display: none">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-slate-900"></h2>
            <a
              href="#/turismo"
              class="text-sm text-blue-600 hover:underline"
            ></a>
          </div>
          <div id="turismo-stack" class="space-y-4"></div>
          <div id="turismo-empty" class="text-slate-500 text-sm">
            A√∫n no hay lugares tur√≠sticos.
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- EMERGENCY STRIP -->
  <section id="HomeContacts" class="py-12">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl md:text-3xl font-bold text-slate-900">
          Contactos de Emergencia
        </h2>
        <a href="#/contactos" class="text-sm text-blue-600 hover:underline"
          >Ver todos</a
        >
      </div>

      <div
        id="home-contacts-grid"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"
      ></div>
      <div id="home-contacts-empty" class="text-slate-500 text-sm">
        No hay contactos destacados para la p√°gina de inicio.
      </div>
    </div>
  </section>
</section>


<script>
  (() => {
    const CONTACTS_KEY = "municipio.contactos.emergencia.v1";

    // same icon/tone map as admin (kept succinct)
    const ICON = (cat) =>
      ({
        "Emergencias M√©dicas": "fas fa-kit-medical",
        "Seguridad P√∫blica": "fas fa-shield-halved",
        Bomberos: "fas fa-fire-extinguisher",
        "Protecci√≥n Civil": "fas fa-triangle-exclamation",
        "Servicios P√∫blicos": "fas fa-wrench",
        "Gobierno Municipal": "fas fa-landmark",
        "Otros Servicios": "fas fa-phone",
      }[cat] || "fas fa-phone");

    const TONE = (cat) =>
      ({
        "Emergencias M√©dicas": ["text-rose-600", "bg-rose-100"],
        "Seguridad P√∫blica": ["text-blue-600", "bg-blue-100"],
        Bomberos: ["text-orange-600", "bg-orange-100"],
        "Protecci√≥n Civil": ["text-amber-700", "bg-amber-100"],
        "Servicios P√∫blicos": ["text-green-600", "bg-green-100"],
        "Gobierno Municipal": ["text-purple-600", "bg-purple-100"],
        "Otros Servicios": ["text-slate-700", "bg-slate-100"],
      }[cat] || ["text-slate-700", "bg-slate-100"]);

    function getHomeContacts() {
      try {
        const raw = localStorage.getItem(CONTACTS_KEY);
        if (!raw) return [];
        return JSON.parse(raw)
          .filter((c) => c && c.activo === true && c.showInHome === true)
          .sort(
            (a, b) =>
              (a.prioridad || 99) - (b.prioridad || 99) ||
              (a.nombre || "").localeCompare(b.nombre || "")
          );
      } catch {
        return [];
      }
    }

    function telHref(val) {
      if (!val) return "";
      // strip spaces/parentheses/dashes for tel: link
      return "tel:" + String(val).replace(/[^\d+#*]/g, "");
    }

    function cardHTML(c) {
      const [txt, bg] = TONE(c.categoria);
      const icon = ICON(c.categoria);
      const telMain = telHref(c.telefono);
      const telAlt = telHref(c.telefonoAlt);

      return `
      <article class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm flex flex-col">
        <div class="flex items-center gap-3 mb-3">
          <div class="${bg} w-12 h-12 rounded-xl flex items-center justify-center">
            <i class="${icon} ${txt} text-xl"></i>
          </div>
          <div>
            <h3 class="font-bold text-slate-900 leading-tight">${
              c.nombre || ""
            }</h3>
            <div class="text-xs text-slate-500">${c.categoria || ""} ‚Ä¢ ${
        c.disponibilidad || ""
      }</div>
          </div>
        </div>

        ${
          c.descripcion
            ? `<p class="text-sm text-slate-700 mb-3 line-clamp-3">${c.descripcion}</p>`
            : ""
        }

        <div class="mt-auto space-y-2">
          ${
            c.telefono
              ? `
            <a href="${telMain}" class="w-full inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-red-600 text-white text-sm hover:bg-red-700">
              <i class="fas fa-phone"></i><span>${c.telefono}</span>
            </a>`
              : ``
          }

          ${
            c.telefonoAlt
              ? `
            <a href="${telAlt}" class="w-full inline-flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-slate-100 text-slate-800 text-xs hover:bg-slate-200">
              <i class="fas fa-phone"></i><span>Alterno: ${c.telefonoAlt}</span>
            </a>`
              : ``
          }

          <div class="flex gap-2 mt-1">
            ${
              c.email
                ? `<a href="mailto:${c.email}" class="text-xs text-blue-700 hover:underline">Email</a>`
                : ``
            }
            ${
              c.direccion
                ? `<span class="text-xs text-slate-500 line-clamp-1">${c.direccion}</span>`
                : ``
            }
          </div>
        </div>
      </article>
    `;
    }

    function renderHomeContacts() {
      const grid = document.getElementById("home-contacts-grid");
      const empty = document.getElementById("home-contacts-empty");
      if (!grid) return;

      const list = getHomeContacts();
      grid.innerHTML = list.map(cardHTML).join("");
      empty.classList.toggle("hidden", list.length > 0);
    }

    // live update when admin changes
    window.addEventListener("storage", (e) => {
      if (e.key === CONTACTS_KEY) renderHomeContacts();
    });

    // expose (optional)
    window.renderHomeContacts = renderHomeContacts;

    // run now
    if (document.readyState === "loading")
      document.addEventListener("DOMContentLoaded", renderHomeContacts);
    else renderHomeContacts();
  })();
</script>

<script>
  (() => {
    const STORAGE_KEY = "municipio.quicklinks.v1";

    function safeGetQuickLinks() {
      // Prefer the admin helper if present
      if (typeof window.getQuickLinks === "function") {
        try {
          return window.getQuickLinks();
        } catch {
          /* fall back */
        }
      }
      // Fallback: read, filter activos, sort by order then title
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        const list = raw ? JSON.parse(raw) : [];
        return list
          .filter((x) => x && x.activo)
          .sort(
            (a, b) =>
              (a.order ?? 0) - (b.order ?? 0) ||
              (a.titulo || "").localeCompare(b.titulo || "")
          );
      } catch {
        return [];
      }
    }

    const isHttp = (u) => /^https?:\/\//i.test(u);
    function go(href) {
      if (!href) return;
      if (href.startsWith("#")) location.hash = href;
      else if (isHttp(href)) window.open(href, "_blank", "noopener");
      else location.href = href; // site-relative
    }

    function cardHTML(i) {
      const iconClass = i.iconClass || "fas fa-circle";
      const iconColor = i.iconColor || "#0f172a";
      const titleColor = i.titleColor || "#0f172a";
      const bgColor = i.bgColor || "#ffffff";

      return `
      <button data-href="${i.href || "#"}"
        class="group bg-white p-10 rounded-2xl shadow hover:shadow-lg hover:-translate-y-1 transition flex flex-col items-center text-center border border-slate-200"
        style="background:${bgColor}">
        <i class="${iconClass} text-5xl mb-6" style="color:${iconColor}"></i>
        <h3 class="text-xl font-semibold"
            style="color:${titleColor}">${i.titulo || ""}</h3>
        ${
          i.href
            ? `<div class="mt-2 text-xs text-slate-500 break-all">${""}</div>`
            : ""
        }
      </button>
    `; //poner una descripcion despues
    }

    function renderQL() {
      const grid = document.getElementById("ql-home-grid");
      const empty = document.getElementById("ql-home-empty");
      if (!grid) return;

      const list = safeGetQuickLinks();
      grid.innerHTML = list.map(cardHTML).join("");
      empty?.classList.toggle("hidden", list.length > 0);

      // wire clicks
      grid.querySelectorAll("[data-href]").forEach((el) => {
        el.onclick = () => go(el.dataset.href);
      });
    }

    // live updates if admin changes in another tab
    window.addEventListener("storage", (e) => {
      if (e.key === STORAGE_KEY) renderQL();
    });

    if (document.readyState === "loading")
      document.addEventListener("DOMContentLoaded", renderQL);
    else renderQL();
  })();
</script>

<!-- ============ HOME (Turismo + Eventos + Hero) ============ -->
<script>
  (() => {
    // ====== Constants (must match your admin modules) ======
    const TURISMO_LS = "lugaresTuristicos";
    const TURISMO_IDB = "TurismoDB";
    const TURISMO_STORE = "imagenes";

    const EVENTOS_LS = "eventos";
    const EVENTOS_IDB = "EventosDB";
    const EVENTOS_STORE = "imagenes";

    // ====== State ======
    let turismoDb = null;
    let eventosDb = null;
    let heroTimer = null;
    let currentSlide = 0;
    let blobUrls = [];

    // ====== Helpers ======
    const jget = (k, d = []) => {
      try {
        return JSON.parse(localStorage.getItem(k) || JSON.stringify(d));
      } catch {
        return d;
      }
    };
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const isHttpUrl = (u) => {
      try {
        const x = new URL(u);
        return x.protocol === "http:" || x.protocol === "https:";
      } catch {
        return false;
      }
    };
    const makeBlobUrl = (blob) => {
      if (!blob) return "";
      const u = URL.createObjectURL(blob);
      blobUrls.push(u);
      return u;
    };
    const cleanupBlobs = () => {
      blobUrls.forEach((u) => {
        try {
          URL.revokeObjectURL(u);
        } catch {}
      });
      blobUrls = [];
    };

    function idbOpen(name, store) {
      return new Promise((resolve) => {
        const req = indexedDB.open(name, 1);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(store)) db.createObjectStore(store);
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => resolve(null);
      });
    }
    function idbGet(db, store, key) {
      return new Promise((resolve) => {
        if (!db || !db.objectStoreNames.contains(store)) return resolve(null);
        const tx = db.transaction(store, "readonly");
        const rq = tx.objectStore(store).get(key);
        rq.onsuccess = () => resolve(rq.result || null);
        rq.onerror = () => resolve(null);
      });
    }

    // ====== HERO (uses Turismo images: fotoIds -> fotoUrls -> legacy imagenes) ======
    async function buildHero(lugares) {
      const hero = document.getElementById("hero-slides");
      hero.innerHTML = "";

      const heroes = lugares.filter((l) => l.useAsHero);
      const candidates = heroes.length
        ? heroes
        : lugares.filter((l) => l.showInHome);
      const top = candidates.slice(0, 3);

      const heroImages = [];
      for (const l of top) {
        const ids = Array.isArray(l.fotoIds) ? [...l.fotoIds] : [];
        const urls = Array.isArray(l.fotoUrls)
          ? [...l.fotoUrls].filter(isHttpUrl)
          : [];
        const legacy = Array.isArray(l.imagenes) ? [...l.imagenes] : [];

        if (ids.length && turismoDb) {
          const mainIdx = clamp(l.imagenPrincipal || 0, 0, ids.length - 1);
          const ordered = [
            ids[mainIdx],
            ...ids.filter((_, i) => i !== mainIdx),
          ].slice(0, 6);
          for (const fid of ordered) {
            const blob = await idbGet(turismoDb, TURISMO_STORE, fid);
            const src = makeBlobUrl(blob);
            if (src) heroImages.push({ src, alt: l.nombre });
          }
        }
        if (!heroImages.length && urls.length) {
          urls
            .slice(0, 6)
            .forEach((u) => heroImages.push({ src: u, alt: l.nombre }));
        }
        if (!heroImages.length && legacy.length) {
          legacy
            .slice(0, 6)
            .forEach((u) => heroImages.push({ src: u, alt: l.nombre }));
        }
      }

      if (!heroImages.length) {
        const ph = document.createElement("div");
        ph.className =
          "w-full h-full bg-gradient-to-br from-slate-200 to-slate-300";
        hero.appendChild(ph);
        return;
      }

      heroImages.forEach((img, i) => {
        const el = document.createElement("img");
        el.src = img.src;
        el.alt = img.alt || "";
        el.className =
          "absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-1000 ease-in-out";
        if (i === 0) el.classList.add("opacity-100");
        hero.appendChild(el);
      });

      const slides = Array.from(hero.querySelectorAll("img"));
      currentSlide = 0;
      if (heroTimer) {
        clearInterval(heroTimer);
        heroTimer = null;
      }
      heroTimer = setInterval(() => {
        const prev = currentSlide;
        currentSlide = (currentSlide + 1) % slides.length;
        slides[prev].classList.remove("opacity-100");
        slides[currentSlide].classList.add("opacity-100");
      }, 5000);
    }

    // ====== Turismo cards (Home grid) ======
    function turismoCard({ url, lugar }) {
      return `
      <div class="bg-white rounded-2xl shadow-sm overflow-hidden min-w-[260px] max-w-[320px]">
        <div class="relative">
          <img src="${url}" alt="${
        lugar.nombre
      }" class="w-full h-40 object-cover">
          <div class="absolute top-3 left-3 flex gap-2">
            <span class="bg-orange-500 text-white px-3 py-1 rounded-full text-xs font-medium">${
              lugar.categoria || ""
            }</span>
          </div>
        </div>
        <div class="p-4">
          <div class="flex items-start justify-between mb-2">
            <h3 class="text-lg font-bold text-gray-800 line-clamp-2">${
              lugar.nombre
            }</h3>
            <div class="bg-orange-100 p-2 rounded-lg ml-3">
              <i class="${
                lugar.icono || "fas fa-map-marked-alt"
              } text-orange-600"></i>
            </div>
          </div>
          <p class="text-gray-600 text-sm line-clamp-3 mb-3">${
            lugar.descripcion || ""
          }</p>
          <div class="flex gap-2">
            <button onclick="Home.viewPlace(${JSON.stringify(lugar.id)})"
              class="flex-1 bg-orange-500 text-white py-2 px-3 rounded-lg hover:bg-orange-600 transition text-sm font-medium">
              <i class="fas fa-images mr-2"></i>Ver
            </button>
            ${
              lugar.googleMaps
                ? `<a href="${lugar.googleMaps}" target="_blank" class="bg-blue-500 text-white py-2 px-3 rounded-lg hover:bg-blue-600 transition text-sm"><i class="fas fa-map"></i></a>`
                : ""
            }
          </div>
        </div>
      </div>
    `;
    }

    async function turismoCover(l) {
      if (Array.isArray(l.fotoIds) && l.fotoIds.length && turismoDb) {
        const mainIdx = clamp(l.imagenPrincipal || 0, 0, l.fotoIds.length - 1);
        const blob = await idbGet(turismoDb, TURISMO_STORE, l.fotoIds[mainIdx]);
        const u = makeBlobUrl(blob);
        if (u) return u;
      }
      if (Array.isArray(l.fotoUrls)) {
        const u = l.fotoUrls.find(isHttpUrl);
        if (u) return u;
      }
      if (Array.isArray(l.imagenes) && l.imagenes.length) {
        return l.imagenes[l.imagenPrincipal || 0] || l.imagenes[0];
      }
      return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='640' height='360'%3E%3Crect width='100%25' height='100%25' fill='%23f5f5f5'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%2399a' font-family='Arial' font-size='16'%3ESin imagen%3C/text%3E%3C/svg%3E";
    }

    async function buildHomeCards(lugares) {
      const list = lugares.filter((l) => l.showInHome);
      const grid = document.getElementById("home-grid");
      const reel = document.getElementById("home-reel");
      const track = document.getElementById("reel-track");
      const inner = document.getElementById("reel-inner");

      grid.innerHTML = "";
      inner.innerHTML = "";
      reel.classList.add("hidden");

      if (!list.length) return;

      const cards = [];
      for (const l of list) {
        const url = await turismoCover(l);
        cards.push({ url, lugar: l });
      }

      if (cards.length <= 4) {
        cards.forEach((c) => {
          const wrap = document.createElement("div");
          wrap.innerHTML = turismoCard(c);
          grid.appendChild(wrap.firstElementChild);
        });
      } else {
        reel.classList.remove("hidden");
        inner.style.transition = "transform 400ms ease";
        cards.forEach((c) => {
          const item = document.createElement("div");
          item.innerHTML = turismoCard(c);
          inner.appendChild(item.firstElementChild);
        });
        document.getElementById("reel-prev").onclick = () =>
          track.scrollBy({
            left: -Math.floor(track.clientWidth * 0.9),
            behavior: "smooth",
          });
        document.getElementById("reel-next").onclick = () =>
          track.scrollBy({
            left: Math.floor(track.clientWidth * 0.9),
            behavior: "smooth",
          });
      }
    }

    // ====== Events (fotoIds -> fotoUrls -> legacy imageId) ======
    async function renderEvents() {
      const grid = document.getElementById("events-grid");
      const empty = document.getElementById("events-empty");
      const eventos = (() => {
        try {
          return JSON.parse(localStorage.getItem("eventos") || "[]");
        } catch {
          return [];
        }
      })();
      const today = new Date(new Date().toDateString());

      const isHttpUrl = (u) => {
        try {
          const x = new URL(u);
          return x.protocol === "http:" || x.protocol === "https:";
        } catch {
          return false;
        }
      };
      const makeBlobUrl = (blob) => (blob ? URL.createObjectURL(blob) : "");
      async function idbOpen(name, store) {
        return new Promise((resolve) => {
          const req = indexedDB.open(name, 1);
          req.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(store))
              db.createObjectStore(store);
          };
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => resolve(null);
        });
      }
      async function idbGet(db, store, key) {
        return new Promise((resolve) => {
          if (!db || !db.objectStoreNames.contains(store)) return resolve(null);
          const tx = db.transaction(store, "readonly");
          const rq = tx.objectStore(store).get(key);
          rq.onsuccess = () => resolve(rq.result || null);
          rq.onerror = () => resolve(null);
        });
      }

      const eventosDb = await idbOpen("EventosDB", "imagenes");

      async function coverFor(ev) {
        // fotoIds (IDB)
        if (Array.isArray(ev.fotoIds) && ev.fotoIds.length && eventosDb) {
          const blob = await idbGet(eventosDb, "imagenes", ev.fotoIds[0]);
          const u = makeBlobUrl(blob);
          if (u) return u;
        }
        // fotoUrls (remotas)
        if (Array.isArray(ev.fotoUrls) && ev.fotoUrls.length) {
          const u = ev.fotoUrls.find(isHttpUrl);
          if (u) return u;
        }
        // legacy imageId (IDB)
        if (ev.imageId && eventosDb) {
          const blob = await idbGet(eventosDb, "imagenes", ev.imageId);
          const u = makeBlobUrl(blob);
          if (u) return u;
        }
        return "";
      }

      // upcoming sorted by date asc
      const upcoming = eventos
        //.filter(e => !e.fechaInicio || new Date(e.fechaInicio) >= today)
        .sort(
          (a, b) =>
            new Date(a.fechaInicio || "2100-01-01") -
            new Date(b.fechaInicio || "2100-01-01")
        );

      // Featured first
      const destacados = upcoming.filter((e) => !!e.destacado);
      const normales = upcoming.filter((e) => !e.destacado);
      const ordered = [...destacados, ...normales].slice(0, 8);

      const cards = await Promise.all(
        ordered.map(async (e, idx) => {
          const img = await coverFor(e);
          const when =
            e.fechaInicio && e.fechaFin
              ? `${e.fechaInicio} ¬∑ ${e.fechaFin}`
              : e.fechaInicio || "Pr√≥ximamente";
          const isFeatured = !!e.destacado;

          // Outer wrapper lets featured span 2 cols on lg screens
          return `
        <div class="${isFeatured ? "lg:col-span-2" : ""}">
          <article class="relative bg-white rounded-xl overflow-hidden border border-slate-200 shadow-sm ${
            isFeatured ? "ring-2 ring-amber-300" : ""
          }">
            ${
              img
                ? `<img src="${img}" class="w-full ${
                    isFeatured ? "h-48" : "h-32"
                  } object-cover">`
                : `<div class="${
                    isFeatured ? "h-48" : "h-32"
                  } w-full bg-slate-100 flex items-center justify-center text-4xl">üéâ</div>`
            }
            ${
              isFeatured
                ? `
              <span class="absolute top-3 left-3 bg-amber-500 text-white text-xs font-semibold px-2 py-1 rounded-full shadow">
                <i class="fas fa-star mr-1"></i> Destacado
              </span>`
                : ``
            }
            <div class="p-4">
              <div class="font-semibold text-slate-900 line-clamp-2">${
                e.titulo || "Evento"
              }</div>
              <div class="text-slate-500 text-sm line-clamp-2 mt-1">${
                e.descripcion || ""
              }</div>
              <div class="text-blue-700 text-xs font-semibold mt-2">${when}</div>
              ${
                e.precio
                  ? `<div class="mt-2 text-xs text-slate-600"><i class="fas fa-dollar-sign mr-1"></i>${e.precio}</div>`
                  : ""
              }
            </div>
          </article>
        </div>`;
        })
      );

      grid.innerHTML = cards.join("");
      document
        .getElementById("events-empty")
        .classList.toggle("hidden", ordered.length > 0);
    }

    // ====== Turismo stacked (right column) ======
    async function renderTurismoStack() {
      const stack = document.getElementById("turismo-stack");
      const empty = document.getElementById("turismo-empty");
      const lugares = jget(TURISMO_LS, []);

      const picks = [...lugares]
        .sort(
          (a, b) =>
            (b.fotoIds?.length ||
              b.fotoUrls?.length ||
              b.imagenes?.length ||
              0) -
            (a.fotoIds?.length || a.fotoUrls?.length || a.imagenes?.length || 0)
        )
        .slice(0, 4);

      const cards = await Promise.all(
        picks.map(async (l) => {
          const img = await turismoCover(l);
          return `
        <div class="bg-white border border-slate-200 rounded-2xl overflow-hidden shadow-sm">
          ${
            img
              ? `<img src="${img}" class="w-full h-40 object-cover">`
              : `<div class="h-40 bg-gradient-to-br from-orange-100 to-amber-100 flex items-center justify-center text-3xl">üìç</div>`
          }
          <div class="p-4">
            <div class="flex items-start justify-between">
              <h4 class="font-bold text-slate-900">${l.nombre || ""}</h4>
              <i class="${
                l.icono || "fas fa-map-marked-alt"
              } text-orange-600"></i>
            </div>
            <div class="text-slate-500 text-xs mt-1">${l.categoria || ""}</div>
            <p class="text-slate-600 text-sm mt-2 line-clamp-3">${
              l.descripcion || ""
            }</p>
            <div class="mt-3 flex gap-2">
              ${
                l.googleMaps
                  ? `<a target="_blank" href="${l.googleMaps}" class="px-3 py-1.5 rounded-lg text-white bg-blue-600 text-xs hover:bg-blue-700">Mapa</a>`
                  : ""
              }
              <a href="#/turismo" class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-xs hover:bg-slate-200">Ver m√°s</a>
            </div>
          </div>
        </div>`;
        })
      );

      stack.innerHTML = cards.join("");
      empty.classList.toggle("hidden", cards.length > 0);
    }

    // ====== Emergency (unchanged logic) ======
    function getEmergencyContactsForHome() {
      if (typeof window.getEmergencyContactsForHome === "function") {
        try {
          return window.getEmergencyContactsForHome();
        } catch {}
      }
      const stored = localStorage.getItem("municipio.contactos.emergencia.v1");
      if (!stored) return [];
      try {
        return JSON.parse(stored).filter(
          (c) => c && c.activo === true && c.showInHome === true
        );
      } catch {
        return [];
      }
    }
    function renderEmergency() {
      const contacts = getEmergencyContactsForHome()
        .sort(
          (a, b) =>
            (a.prioridad || 99) - (b.prioridad || 99) ||
            (a.nombre || "").localeCompare(b.nombre || "")
        )
        .slice(0, 12);
      const icon = (cat) =>
        ({
          "Emergencias M√©dicas": "fas fa-kit-medical",
          "Seguridad P√∫blica": "fas fa-shield-halved",
          Bomberos: "fas fa-fire-extinguisher",
          "Protecci√≥n Civil": "fas fa-triangle-exclamation",
          "Servicios P√∫blicos": "fas fa-wrench",
          "Gobierno Municipal": "fas fa-landmark",
          "Otros Servicios": "fas fa-phone",
        }[cat] || "fas fa-phone");
      const tone = (cat) =>
        ({
          "Emergencias M√©dicas": ["rose", "text-rose-600", "bg-rose-100"],
          "Seguridad P√∫blica": ["blue", "text-blue-600", "bg-blue-100"],
          Bomberos: ["orange", "text-orange-600", "bg-orange-100"],
          "Protecci√≥n Civil": ["amber", "text-amber-700", "bg-amber-100"],
          "Servicios P√∫blicos": ["green", "text-green-600", "bg-green-100"],
          "Gobierno Municipal": ["purple", "text-purple-600", "bg-purple-100"],
          "Otros Servicios": ["slate", "text-slate-700", "bg-slate-100"],
        }[cat] || ["slate", "text-slate-700", "bg-slate-100"]);
      const grid = document.getElementById("emerg-grid");
      grid.innerHTML = contacts
        .map((c) => {
          const [, txt, bg] = tone(c.categoria);
          return `
        <div class="bg-white rounded-xl p-4 border border-slate-200 shadow-sm text-center">
          <div class="${bg} w-12 h-12 rounded-full mx-auto flex items-center justify-center mb-2">
            <i class="${icon(c.categoria)} ${txt} text-xl"></i>
          </div>
          <div class="text-lg font-extrabold ${txt}">${c.telefono || ""}</div>
          <div class="text-slate-800 font-medium">${c.nombre || ""}</div>
          <div class="text-slate-500 text-xs">${
            c.descripcion || c.disponibilidad || ""
          }</div>
        </div>`;
        })
        .join("");
      document
        .getElementById("emerg-empty")
        .classList.toggle("hidden", contacts.length > 0);
    }

    // ====== KPI (placeholder) ======
    function renderKpiStrip() {
      document.getElementById("kpi-strip").innerHTML = "";
    }

    // ====== Public hook ======
    async function viewPlace(id) {
      if (window.Turismo && typeof window.Turismo.view === "function") {
        window.Turismo.view(id);
        return;
      }
      alert("Visor de im√°genes no disponible en este contexto.");
    }

    // ====== Init ======
    async function initHome() {
      cleanupBlobs();
      turismoDb = await idbOpen(TURISMO_IDB, TURISMO_STORE);
      eventosDb = await idbOpen(EVENTOS_IDB, EVENTOS_STORE);

      const lugares = jget(TURISMO_LS, []);
      await buildHero(lugares);
      await buildHomeCards(lugares);
      await renderEvents();
      await renderTurismoStack();
      renderEmergency();
      renderKpiStrip();
    }

    window.addEventListener("storage", (e) => {
      if ([TURISMO_LS, EVENTOS_LS].includes(e.key)) initHome();
    });
    if (document.readyState === "loading")
      document.addEventListener("DOMContentLoaded", initHome);
    else initHome();

    window.addEventListener("beforeunload", cleanupBlobs);
    window.Home = { viewPlace };
  })();
</script>

<!-- ============ FEATURED NEWS (supports imageIds + imageUrls + legacy imagenes) ============ -->
<script>
  (() => {
    const NEWS_LS_KEY = "noticias.v1";
    const NEWS_IDB_NAME = "NoticiasDB";
    const NEWS_STORE = "imagenes";

    let newsDb = null;
    let blobUrls = [];
    const makeBlobUrl = (b) => {
      if (!b) return "";
      const u = URL.createObjectURL(b);
      blobUrls.push(u);
      return u;
    };
    const cleanup = () => {
      blobUrls.forEach((u) => {
        try {
          URL.revokeObjectURL(u);
        } catch {}
      });
      blobUrls = [];
    };
    const isHttpUrl = (u) => {
      try {
        const x = new URL(u);
        return x.protocol === "http:" || x.protocol === "https:";
      } catch {
        return false;
      }
    };

    function loadNews() {
      try {
        return JSON.parse(localStorage.getItem(NEWS_LS_KEY) || "[]");
      } catch {
        return [];
      }
    }
    function sortDesc(a, b) {
      return (
        new Date(b.date || "1970-01-01") - new Date(a.date || "1970-01-01")
      );
    }
    function fmtDateShort(d) {
      try {
        const dt = new Date(d);
        return dt.toLocaleDateString(undefined, {
          year: "numeric",
          month: "short",
          day: "2-digit",
        });
      } catch {
        return d || "";
      }
    }

    function idbOpen() {
      return new Promise((resolve) => {
        const req = indexedDB.open(NEWS_IDB_NAME, 1);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(NEWS_STORE))
            db.createObjectStore(NEWS_STORE);
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => resolve(null);
      });
    }
    function idbGet(id) {
      return new Promise((resolve) => {
        if (!newsDb) return resolve(null);
        const tx = newsDb.transaction(NEWS_STORE, "readonly");
        const rq = tx.objectStore(NEWS_STORE).get(id);
        rq.onsuccess = () => resolve(rq.result || null);
        rq.onerror = () => resolve(null);
      });
    }

    async function coverUrl(item) {
      // 1) imageIds (IDB)
      if (Array.isArray(item.imageIds) && item.imageIds.length && newsDb) {
        const idx = Math.min(item.coverIndex || 0, item.imageIds.length - 1);
        const blob = await idbGet(item.imageIds[idx]);
        const u = makeBlobUrl(blob);
        if (u) return u;
      }
      // 2) imageUrls (remote)
      if (Array.isArray(item.imageUrls) && item.imageUrls.length) {
        const u = item.imageUrls.find(isHttpUrl);
        if (u) return u;
      }
      // 3) legacy base64 array
      if (Array.isArray(item.imagenes) && item.imagenes.length) {
        const idx = Math.min(item.coverIndex || 0, item.imagenes.length - 1);
        return item.imagenes[idx] || item.imagenes[0];
      }
      return "";
    }

    async function renderHomeNews() {
      cleanup();
      if (!newsDb) newsDb = await idbOpen();

      const grid = document.getElementById("home-news-grid");
      const empty = document.getElementById("home-news-empty");
      if (!grid) return;

      const list = loadNews()
        .filter((n) => !n.archived && n.showInHome)
        .sort(sortDesc)
        .slice(0, 6);
      grid.innerHTML = "";
      if (!list.length) {
        empty?.classList.remove("hidden");
        return;
      }
      empty?.classList.add("hidden");

      for (const n of list) {
        const cover = await coverUrl(n);
        const card = document.createElement("article");
        card.className =
          "bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-200 flex flex-col";
        card.innerHTML = `
        <div class="relative">
          ${
            cover
              ? `<img src="${cover}" class="w-full h-40 object-cover">`
              : `<div class="h-40 w-full bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-3xl">üì∞</div>`
          }
          <div class="absolute top-3 left-3">
            <span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-700">${
              n.category || ""
            }</span>
          </div>
        </div>
        <div class="p-5 flex flex-col gap-2 flex-1">
          <h3 class="text-lg font-bold text-slate-900 line-clamp-2">${
            n.title || ""
          }</h3>
          <div class="text-gray-500 text-xs">${fmtDateShort(n.date)} ¬∑ ${
          n.author || ""
        }</div>
          <p class="text-sm text-gray-700 line-clamp-3">${n.summary || ""}</p>
          <div class="mt-auto pt-2 flex gap-2">
            <button class="px-3 py-1.5 rounded-lg bg-blue-600 text-white text-xs hover:bg-blue-700"
              onclick="(window.Noticias&&Noticias.view)?Noticias.view(${
                n.id
              }):location.hash='#/noticias'">Ver m√°s</button>
          </div>
        </div>`;
        grid.appendChild(card);
      }
    }

    window.addEventListener("storage", (e) => {
      if (e.key === NEWS_LS_KEY) renderHomeNews();
    });
    window.addEventListener("beforeunload", cleanup);

    if (document.readyState === "loading")
      document.addEventListener("DOMContentLoaded", renderHomeNews);
    else renderHomeNews();
  })();
</script>
