<section id="HomeContent" class="min-h-screen bg-slate-50">
  <!-- HERO: blurred city/museum backdrop, headline & CTA -->
  <section class="section-content">
    <!-- HERO -->
    <div
      id="hero-wrap"
      class="relative h-[20vh] md:h-[30vh] lg:h-[50vh] overflow-hidden"
    >
      <div id="hero-slides" class="absolute inset-0"></div>

      <!-- Overlay (titulo/CTA opcional) -->
      <div class="absolute inset-0 bg-black/30 pointer-events-none"></div>
      <div class="absolute inset-x-0 bottom-0 p-6 md:p-10 text-white">
        <h1 class="text-2xl md:text-4xl font-extrabold drop-shadow">
          Sabinas Hidalgo ‚Äî Lugares que inspiran
        </h1>
        <p class="mt-2 text-sm md:text-base opacity-90">
          Descubre los rincones m√°s representativos del municipio.
        </p>
      </div>
    </div>
  </section>

  <!-- KPI STRIP -->
  <section class="-mt-10 relative z-10">
    <div class="max-w-7xl mx-auto px-4">
      <div id="kpi-strip" class="grid grid-cols-2 md:grid-cols-5 gap-4"></div>
    </div>
  </section>

  <!-- SERVICES (compact chips + icons) -->
  <!-- Services (static, fixed URLs) -->
  <section id="Servicios" class="py-16 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4">
      <!-- Featured News (showInHome) -->
      <div id="home-news" class="mb-10">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold text-municipal-blue">Featured News</h2>
          <a href="#/noticias" class="text-sm text-blue-600 hover:underline"
            >View all</a
          >
        </div>
        <div
          id="home-news-grid"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
        ></div>
        <div id="home-news-empty" class="text-gray-500 text-sm hidden">
          No featured news yet.
        </div>
      </div>

      <!-- All services grid -->
      <!-- Services Quick Links -->
      <section id="Servicios" class="py-16 bg-gray-50">
        <div class="max-w-6xl mx-auto px-4">
          <h2
            class="text-3xl md:text-4xl font-bold text-municipal-blue text-center mb-12"
          >
            Accesos R√°pidos
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <a
              href="/pagos/multas"
              class="group bg-white p-10 rounded-2xl shadow hover:shadow-lg hover:-translate-y-1 transition flex flex-col items-center text-center"
            >
              <i class="fas fa-car text-5xl text-municipal-blue mb-6"></i>
              <h3
                class="text-xl font-semibold text-gray-800 group-hover:text-municipal-blue"
              >
                Servicios Municipales
              </h3>
            </a>

            <a
              href="/tramites"
              class="group bg-white p-10 rounded-2xl shadow hover:shadow-lg hover:-translate-y-1 transition flex flex-col items-center text-center"
            >
              <i class="fas fa-file-alt text-5xl text-municipal-teal mb-6"></i>
              <h3
                class="text-xl font-semibold text-gray-800 group-hover:text-municipal-teal"
              >
                Tr√°mites Municipales
              </h3>
            </a>

            <a
              href="/eventos"
              class="group bg-white p-10 rounded-2xl shadow hover:shadow-lg hover:-translate-y-1 transition flex flex-col items-center text-center"
            >
              <i
                class="fas fa-calendar-alt text-5xl text-municipal-green mb-6"
              ></i>
              <h3
                class="text-xl font-semibold text-gray-800 group-hover:text-municipal-green"
              >
                Eventos
              </h3>
            </a>

            <a
              href="/transparencia"
              class="group bg-white p-10 rounded-2xl shadow hover:shadow-lg hover:-translate-y-1 transition flex flex-col items-center text-center"
            >
              <i
                class="fas fa-balance-scale text-5xl text-municipal-pink mb-6"
              ></i>
              <h3
                class="text-xl font-semibold text-gray-800 group-hover:text-municipal-pink"
              >
                Transparencia
              </h3>
            </a>
          </div>
        </div>
      </section>

      <!-- CTA -->
      <div class="mt-12 text-center">
        <a
          href="/servicios"
          class="inline-flex items-center gap-2 rounded-full bg-municipal-blue px-6 py-3 text-white font-semibold hover:bg-blue-700 transition"
        >
          Ver todos los servicios
          <i class="fas fa-arrow-right"></i>
        </a>
      </div>
    </div>
  </section>

  <!-- TURISM SHOW IN HOME -->
  <div class="p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-2xl font-bold text-gray-800">Turismo Sabinense</h2>
      <div class="text-sm text-gov-gray">
        Explora nuestros lugares recomendados
      </div>
    </div>

    <!-- Grid simple (<=4) -->
    <div
      id="home-grid"
      class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"
    ></div>

    <!-- Reel (>4) -->
    <div id="home-reel" class="relative hidden">
      <button
        id="reel-prev"
        class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-white/90 hover:bg-white shadow p-3 rounded-full"
      >
        <i class="fas fa-chevron-left"></i>
      </button>
      <div id="reel-track" class="overflow-hidden">
        <div id="reel-inner" class="flex gap-4 will-change-transform"></div>
      </div>
      <button
        id="reel-next"
        class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-white/90 hover:bg-white shadow p-3 rounded-full"
      >
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>
  <!-- EVENTS + TURISMO (masonry-ish) -->
  <section class="py-12">
    <div class="max-w-7xl mx-auto px-4">
      <div class="grid lg:grid-cols-3 gap-8">
        <!-- Events -->
        <div class="lg:col-span-2">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-slate-900">
              Pr√≥ximos Eventos
            </h2>
            <a href="#/eventos" class="text-sm text-blue-600 hover:underline"
              >Calendario</a
            >
          </div>
          <div
            id="events-grid"
            class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"
          ></div>
          <div id="events-empty" class="text-slate-500 text-sm">
            No hay eventos pr√≥ximos.
          </div>
        </div>

        <!-- Turismo -->
        <div>
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-slate-900">
              Turismo
            </h2>
            <a href="#/turismo" class="text-sm text-blue-600 hover:underline"
              >Ver m√°s</a
            >
          </div>
          <div id="turismo-stack" class="space-y-4"></div>
          <div id="turismo-empty" class="text-slate-500 text-sm">
            A√∫n no hay lugares tur√≠sticos.
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- EMERGENCY STRIP -->
  <section class="py-10 bg-white border-t">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex items-end justify-between mb-6">
        <h2
          id="emerg-title"
          class="text-2xl md:text-3xl font-bold text-red-600"
        >
          N√∫meros de Emergencia
        </h2>
        <p class="text-sm text-slate-500">Atenci√≥n 24/7</p>
      </div>
      <div
        id="emerg-grid"
        class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"
      ></div>
      <div id="emerg-empty" class="text-slate-500 text-sm">
        Marca ‚ÄúMostrar en p√°gina de inicio‚Äù en
        <em>Contactos de Emergencia</em> para verlos aqu√≠.
      </div>
    </div>
  </section>
</section>

<script>
  (() => {
    // ====== Constantes de storage compartidas con Turismo ======
    LS_KEY = "lugaresTuristicos";
    const IDB_NAME = "TurismoDB";
    const IDB_STORE = "imagenes";

    // ====== Estado ======
    let db = null;
    let blobUrls = []; // para limpieza
    let heroTimer = null;
    let currentSlide = 0;

    // ====== Helpers ======
    const loadLugares = () => {
      try {
        return JSON.parse(localStorage.getItem(LS_KEY) || "[]");
      } catch {
        return [];
      }
    };

    function idbOpen() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(IDB_NAME, 1);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(IDB_STORE)) {
            db.createObjectStore(IDB_STORE);
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    async function idbGet(id) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(IDB_STORE, "readonly");
        const rq = tx.objectStore(IDB_STORE).get(id);
        rq.onsuccess = () => resolve(rq.result || null);
        rq.onerror = () => reject(rq.error);
      });
    }

    function makeBlobUrl(blob) {
      if (!blob) return null;
      const url = URL.createObjectURL(blob);
      blobUrls.push(url);
      return url;
    }

    function cleanupBlobs() {
      blobUrls.forEach((u) => {
        try {
          URL.revokeObjectURL(u);
        } catch {}
      });
      blobUrls = [];
    }

    function clamp(n, min, max) {
      return Math.max(min, Math.min(max, n));
    }

    // ====== HERO ======
    async function buildHero(lugares) {
      const heroPlaces = lugares.filter((l) => l.useAsHero).slice(0, 2);

      // fallback: si no hay marcados, intenta usar los showInHome como respaldo
      const candidates = heroPlaces.length
        ? heroPlaces
        : lugares.filter((l) => l.showInHome).slice(0, 2);

      // Recopila varias fotos (prioriza imagenPrincipal de cada lugar, luego el resto)
      const heroImages = [];
      for (const l of candidates) {
        const ids = Array.isArray(l.fotoIds) ? [...l.fotoIds] : [];
        if (!ids.length) continue;
        const mainIdx = clamp(l.imagenPrincipal || 0, 0, ids.length - 1);

        // Subir primero la principal
        const ordered = [ids[mainIdx], ...ids.filter((_, i) => i !== mainIdx)];
        // Limita cu√°ntas tomamos por lugar para no crear demasiadas
        const take = ordered.slice(0, 6);

        for (const fid of take) {
          const blob = await idbGet(fid);
          const url = makeBlobUrl(blob);
          if (url) heroImages.push({ url, alt: l.nombre });
        }
      }

      const hero = document.getElementById("hero-slides");
      hero.innerHTML = "";

      if (!heroImages.length) {
        // Sin im√°genes: renderiza un placeholder est√°tico
        const ph = document.createElement("div");
        ph.className =
          "w-full h-full bg-gradient-to-br from-slate-200 to-slate-300";
        hero.appendChild(ph);
        return;
      }

      // Crea slides (im√°genes absolutas con fade)
      heroImages.forEach((img, idx) => {
        const el = document.createElement("img");
        el.src = img.url;
        el.alt = img.alt || "";
        el.className = [
          "absolute inset-0 w-full h-full object-cover",
          "opacity-0 transition-opacity duration-1000 ease-in-out",
        ].join(" ");
        if (idx === 0) el.classList.add("opacity-100");
        hero.appendChild(el);
      });

      // Auto-slide
      const slides = Array.from(hero.querySelectorAll("img"));
      currentSlide = 0;
      if (heroTimer) {
        clearInterval(heroTimer);
        heroTimer = null;
      }

      heroTimer = setInterval(() => {
        const prev = currentSlide;
        currentSlide = (currentSlide + 1) % slides.length;
        slides[prev].classList.remove("opacity-100");
        slides[currentSlide].classList.add("opacity-100");
      }, 5000); // cada 5s
    }

    // ====== CARDS ======
    function cardTemplate({ url, lugar }) {
      return `
      <div class="bg-white rounded-2xl shadow-sm overflow-hidden min-w-[260px] max-w-[320px]">
        <div class="relative">
          <img src="${url}" alt="${
        lugar.nombre
      }" class="w-full h-40 object-cover">
          <div class="absolute top-3 left-3 flex gap-2">
            <span class="bg-orange-500 text-white px-3 py-1 rounded-full text-xs font-medium">${
              lugar.categoria || ""
            }</span>
          </div>
        </div>
        <div class="p-4">
          <div class="flex items-start justify-between mb-2">
            <h3 class="text-lg font-bold text-gray-800 line-clamp-2">${
              lugar.nombre
            }</h3>
            <div class="bg-orange-100 p-2 rounded-lg ml-3"><i class="${
              lugar.icono || "fas fa-map-marked-alt"
            } text-orange-600"></i></div>
          </div>
          <p class="text-gray-600 text-sm line-clamp-3 mb-3">${
            lugar.descripcion || ""
          }</p>
          <div class="flex gap-2">
            <button onclick="Home.viewPlace(${JSON.stringify(lugar.id)})"
              class="flex-1 bg-orange-500 text-white py-2 px-3 rounded-lg hover:bg-orange-600 transition text-sm font-medium">
              <i class="fas fa-images mr-2"></i>Ver
            </button>
            ${
              lugar.googleMaps
                ? `<a href="${lugar.googleMaps}" target="_blank"
              class="bg-blue-500 text-white py-2 px-3 rounded-lg hover:bg-blue-600 transition text-sm"><i class="fas fa-map"></i></a>`
                : ""
            }
          </div>
        </div>
      </div>
    `;
    }

    async function buildHomeCards(lugares) {
      const list = lugares.filter((l) => l.showInHome);

      const grid = document.getElementById("home-grid");
      const reel = document.getElementById("home-reel");
      const track = document.getElementById("reel-track");
      const inner = document.getElementById("reel-inner");

      // Limpia
      grid.innerHTML = "";
      inner.innerHTML = "";
      reel.classList.add("hidden");

      if (!list.length) return;

      // Resolver im√°genes principales
      const cards = [];
      for (const l of list) {
        let url = null;
        if (Array.isArray(l.fotoIds) && l.fotoIds.length) {
          const mainIdx = clamp(
            l.imagenPrincipal || 0,
            0,
            l.fotoIds.length - 1
          );
          const blob = await idbGet(l.fotoIds[mainIdx]);
          url = makeBlobUrl(blob);
        }
        // fallback visual
        if (!url) {
          url =
            "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='640' height='360'%3E%3Crect width='100%25' height='100%25' fill='%23f5f5f5'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%2399a' font-family='Arial' font-size='16'%3ESin imagen%3C/text%3E%3C/svg%3E";
        }
        cards.push({ url, lugar: l });
      }

      if (cards.length <= 4) {
        // Grid
        cards.forEach((c) => {
          const wrap = document.createElement("div");
          wrap.innerHTML = cardTemplate(c);
          grid.appendChild(wrap.firstElementChild);
        });
      } else {
        // Reel
        reel.classList.remove("hidden");
        // Estilos responsivos: 4 por "vista" aprox
        inner.style.transition = "transform 400ms ease";

        cards.forEach((c) => {
          const item = document.createElement("div");
          item.innerHTML = cardTemplate(c);
          inner.appendChild(item.firstElementChild);
        });

        // Navegaci√≥n
        const prev = document.getElementById("reel-prev");
        const next = document.getElementById("reel-next");

        function scrollByAmount(dir) {
          const el = track; // overflow-hidden contenedor
          const delta = Math.floor(el.clientWidth * 0.9) * (dir < 0 ? -1 : 1);
          el.scrollBy({ left: delta, behavior: "smooth" });
        }

        prev.onclick = () => scrollByAmount(-1);
        next.onclick = () => scrollByAmount(1);
      }
    }

    // ====== Integraci√≥n / View de un lugar (reutiliza visor de Turismo si existe) ======
    async function viewPlace(id) {
      // Si tienes el modal de Turismo cargado en el Layout, intenta reutilizarlo:
      if (window.Turismo && typeof window.Turismo.view === "function") {
        window.Turismo.view(id);
        return;
      }
      alert("Visor de im√°genes no disponible en este contexto.");
    }

    // ====== Init ======
    async function initHome() {
      cleanupBlobs();
      db = await idbOpen().catch(console.error);
      const lugares = loadLugares();

      await buildHero(lugares);
      await buildHomeCards(lugares);
    }

    // Re-render cuando cambian los datos (si alg√∫n m√≥dulo los actualiza)
    window.addEventListener("storage", (e) => {
      if (e.key === LS_KEY) initHome();
    });

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initHome);
    } else {
      initHome();
    }

    // Limpieza blobs al salir
    window.addEventListener("beforeunload", cleanupBlobs);

    // Expose para botones
    window.Home = { viewPlace };
  })();
</script>

<script>
  (() => {
    const root = document.getElementById("HomeContent");
    const $ = (sel) => root.querySelector(sel);
    const fmt = new Intl.NumberFormat("es-MX");
    const jget = (k, d) => {
      try {
        return JSON.parse(localStorage.getItem(k) ?? JSON.stringify(d));
      } catch {
        return d;
      }
    };
    const today = new Date(new Date().toDateString());

    // ---------- IndexedDB helpers (read-only, safe) ----------
    function idbOpen(name, version = 1) {
      return new Promise((res) => {
        const r = indexedDB.open(name, version);
        r.onsuccess = () => res(r.result);
        r.onerror = () => res(null);
        r.onupgradeneeded = () => res(r.result);
      });
    }
    function idbGet(db, store, key) {
      return new Promise((res) => {
        if (!db || !db.objectStoreNames.contains(store)) return res(null);
        const tx = db.transaction(store, "readonly");
        const os = tx.objectStore(store);
        const rq = os.get(key);
        rq.onsuccess = () => res(rq.result || null);
        rq.onerror = () => res(null);
      });
    }
    function idbIndexAll(db, store, index, value) {
      return new Promise((res) => {
        if (!db || !db.objectStoreNames.contains(store)) return res([]);
        const os = db.transaction(store, "readonly").objectStore(store);
        if (!os.indexNames.contains(index)) return res([]);
        const rq = os.index(index).getAll(value);
        rq.onsuccess = () => res(rq.result || []);
        rq.onerror = () => res([]);
      });
    }
    const blobUrls = new Set();
    const asUrl = (b) => {
      const u = URL.createObjectURL(b);
      blobUrls.add(u);
      return u;
    };
    window.addEventListener("beforeunload", () => {
      blobUrls.forEach(URL.revokeObjectURL);
    });

    // ---------- HERO ----------
    async function renderHero() {
      const cfg = jget("home.config", {});
      const title = cfg.title || "Gobierno Municipal";
      const subtitle =
        cfg.subtitle ||
        "Servicios, proyectos y transparencia en un solo lugar.";
      const cta = cfg.ctaText || "Agenda tu visita";
      const ctaHref = cfg.ctaHref || "#/agenda";
      const cta2 = cfg.ctaAltText || "Conoce m√°s";
      const cta2Href = cfg.ctaAltHref || "#/transparencia";

      // try to use a tourism image or config.bg
      let bgUrl = "";
      if (cfg.bg?.type === "image" && cfg.bg.url) {
        bgUrl = cfg.bg.url;
      } else {
        // take first tourism image in IDB or base64
        const lugares = jget("lugaresTuristicos", []);
        const first = lugares.find(
          (l) => l.photoIds?.length || l.imagenes?.length
        );
        if (first) {
          const tdb = await idbOpen("TurismoMedia", 1);
          if (first.photoIds?.length && tdb) {
            const rec = await idbGet(tdb, "imagenes", first.photoIds[0]);
            if (rec?.blob) bgUrl = asUrl(rec.blob);
          }
          if (!bgUrl && first.imagenes?.length)
            bgUrl =
              first.imagenes[first.imagenPrincipal || 0] || first.imagenes[0];
        }
      }
      $("#hero-img").style.backgroundImage = bgUrl
        ? `url("${bgUrl}")`
        : "linear-gradient(90deg,#0ea5e9,#14b8a6)";

      $("#hero-title").innerHTML = title.replace(/\n/g, "<br>");
      $("#hero-sub").textContent = subtitle;
      const c1 = $("#hero-cta");
      c1.classList.remove("hidden");
      c1.querySelector("span").textContent = cta;
      c1.href = ctaHref;
      const c2 = $("#hero-cta-sec");
      c2.classList.remove("hidden");
      c2.querySelector("span").textContent = cta2;
      c2.href = cta2Href;
    }

    // ---------- KPI STRIP ----------
    function renderKpiStrip() {
      const proyectos = jget("municipio.proyectos.v1", []);
      const negocios = jget("negocios", []);
      const docs = jget("transparenciaDocs", []);
      const eventos = jget("eventos", []);
      const lugares = jget("lugaresTuristicos", []);

      const activosProy = proyectos.filter((p) =>
        ["En Progreso", "Planificaci√≥n"].includes(p.estatusGeneral)
      ).length;
      const avanceProm = proyectos.length
        ? Math.round(
            proyectos.reduce((s, p) => {
              const total = (p.etapas || []).reduce((acc, e) => {
                const avance =
                  typeof e.avanceManual === "number"
                    ? Math.max(0, Math.min(100, e.avanceManual))
                    : e.tareas?.length
                    ? Math.round(
                        (e.tareas.filter((t) => t.completada).length /
                          e.tareas.length) *
                          100
                      )
                    : 0;
                return acc + (e.peso / 100) * avance;
              }, 0);
              return s + Math.round(total);
            }, 0) / proyectos.length
          )
        : 0;

      const upcoming = (eventos || []).filter(
        (e) => !e.fechaInicio || new Date(e.fechaInicio) >= today
      ).length;

      const KPIS = [
        // { label:'Proyectos activos', val: fmt.format(activosProy), icon:'fa-diagram-project', tone:'indigo' },
        // { label:'Avance promedio', val: `${avanceProm}%`, icon:'fa-chart-line', tone:'green' },
        // { label:'Negocios', val: fmt.format(negocios.length), icon:'fa-store', tone:'blue' },
        // { label:'Documentos', val: fmt.format(docs.length), icon:'fa-file-pdf', tone:'rose' },
        // { label:'Eventos', val: fmt.format(upcoming), icon:'fa-calendar-days', tone:'orange' },
      ];

      $("#kpi-strip").innerHTML = KPIS.map(
        (k) => `
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 flex items-center gap-3">
        <div class="w-11 h-11 rounded-lg bg-${k.tone}-100 flex items-center justify-center">
          <i class="fas ${k.icon} text-${k.tone}-600"></i>
        </div>
        <div>
          <div class="text-xl font-bold text-slate-900">${k.val}</div>
          <div class="text-slate-500 text-xs">${k.label}</div>
        </div>
      </div>
    `
      ).join("");
    }

    // ---------- SERVICES ----------
    function renderServices() {
      const grid = $("#services-grid");
      const empty = $("#services-empty");
      const sub = $("#services-sub");
      const q = $("#services-search");
      const services = jget("services", []); // [{title,desc,icon,href,bgClass}]
      if (sub)
        sub.textContent = services.length
          ? "Accede r√°pido a lo m√°s solicitado"
          : "A√∫n no hay servicios configurados";

      const draw = (list) => {
        if (!grid) return;
        grid.innerHTML = list
          .map(
            (s) => `
        <button data-href="${
          s.href || "#"
        }" class="group bg-white hover:bg-slate-50 border border-slate-200 rounded-xl px-3 py-4 text-left shadow-sm hover:shadow transition">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center">
              <i class="${s.icon || "fas fa-circle"} text-slate-700"></i>
            </div>
            <div>
              <div class="font-semibold text-slate-900 leading-tight">${
                s.title || ""
              }</div>
              <div class="text-slate-500 text-xs mt-1">${s.desc || ""}</div>
            </div>
          </div>
        </button>
      `
          )
          .join("");
        empty?.classList.toggle("hidden", list.length > 0);
        grid.querySelectorAll("[data-href]").forEach(
          (b) =>
            (b.onclick = () => {
              const href = b.dataset.href;
              if (!href) return;
              if (href.startsWith("#")) location.hash = href;
              else location.href = href;
            })
        );
      };
      draw(services);
      q?.addEventListener("input", () => {
        const t = q.value.trim().toLowerCase();
        draw(
          services.filter((s) =>
            [s.title, s.desc].some((v) => (v || "").toLowerCase().includes(t))
          )
        );
      });
    }

    // ---------- FEATURED: Proyectos / Transparencia / Negocios ----------
    function renderFeatured() {
      const proyectos = jget("municipio.proyectos.v1", []);
      const docs = jget("transparenciaDocs", []);
      const negocios = jget("negocios", []);

      // proyectos (top 3 by inversi√≥n)
      $("#proj-list").innerHTML =
        [...proyectos]
          .sort((a, b) => (b.inversionTotal || 0) - (a.inversionTotal || 0))
          .slice(0, 3)
          .map((p) => {
            const fin = p.etapas?.[p.etapas.length - 1]?.fin || "";
            return `
          <div class="flex items-center gap-3">
            <div class="w-11 h-11 rounded-lg bg-blue-100 flex items-center justify-center"><i class="fas fa-helmet-safety text-blue-600"></i></div>
            <div class="flex-1">
              <div class="font-semibold text-slate-900">${p.nombre || ""}</div>
              <div class="text-slate-500 text-xs">${p.categoria || ""} ¬∑ Fin: ${
              fin || "‚Äî"
            }</div>
            </div>
            <div class="text-right">
              <div class="text-sm font-bold text-slate-900">$${
                p.inversionTotal
                  ? p.inversionTotal.toLocaleString("es-MX")
                  : "0"
              }</div>
              <div class="text-xs text-slate-500">${
                p.estatusGeneral || ""
              }</div>
            </div>
          </div>`;
          })
          .join("") ||
        `<div class="text-slate-500 text-sm">A√∫n no hay proyectos.</div>`;

      // transparencia (latest 4)
      $("#tx-list").innerHTML =
        [...docs]
          .sort((a, b) => ((b.createdAt || "") > (a.createdAt || "") ? 1 : -1))
          .slice(0, 4)
          .map(
            (d) => `
      <div class="flex items-center justify-between">
        <div>
          <div class="font-medium text-slate-900">${d.titulo || ""}</div>
          <div class="text-slate-500 text-xs">${d.categoria || ""} ¬∑ ${
              d.dependencia || ""
            } ¬∑ ${d.anio}${d.mes ? "-" + d.mes : ""}</div>
        </div>
        <span class="text-xs px-2 py-0.5 rounded ${
          d.estado === "Publicado"
            ? "bg-green-100 text-green-700"
            : "bg-slate-100 text-slate-600"
        }">${d.estado || "‚Äî"}</span>
      </div>
    `
          )
          .join("") ||
        `<div class="text-slate-500 text-sm">Sin documentos.</div>`;

      // negocios (latest 5)
      $("#biz-list").innerHTML =
        [...negocios]
          .slice(-5)
          .reverse()
          .map(
            (n) => `
      <div class="flex items-center justify-between">
        <div class="truncate">
          <div class="font-medium text-slate-900 truncate">${
            n.nombre || ""
          }</div>
          <div class="text-slate-500 text-xs truncate">${
            n.giroNombre || n.giro || ""
          } ¬∑ ${n.telefono || ""}</div>
        </div>
        <span class="text-xs px-2 py-0.5 rounded ${
          n.estado === "activo"
            ? "bg-green-100 text-green-700"
            : n.estado === "pendiente"
            ? "bg-yellow-100 text-yellow-700"
            : "bg-slate-100 text-slate-600"
        }">
          ${n.estado || "‚Äî"}
        </span>
      </div>
    `
          )
          .join("") ||
        `<div class="text-slate-500 text-sm">A√∫n no hay negocios.</div>`;
    }

    // ---------- EVENTS ----------
    async function renderEvents() {
      const grid = $("#events-grid");
      const empty = $("#events-empty");
      const eventos = jget("eventos", []);
      const db = await idbOpen("EventosDB", 1);
      const upcoming = eventos
        .filter((e) => !e.fechaInicio || new Date(e.fechaInicio) >= today)
        .sort(
          (a, b) =>
            new Date(a.fechaInicio || "2100-01-01") -
            new Date(b.fechaInicio || "2100-01-01")
        )
        .slice(0, 6);
      async function imgFor(e) {
        if (e.imageId && db) {
          const rec = await idbGet(db, "imagenes", e.imageId);
          if (rec?.blob) return asUrl(rec.blob);
        }
        return "";
      }
      const cards = await Promise.all(
        upcoming.map(async (e) => {
          const img = await imgFor(e);
          const when =
            e.fechaInicio && e.fechaFin
              ? `${e.fechaInicio} ¬∑ ${e.fechaFin}`
              : e.fechaInicio || "Pr√≥ximamente";
          return `
        <div class="bg-white rounded-xl overflow-hidden border border-slate-200 shadow-sm">
          ${
            img
              ? `<img src="${img}" class="w-full h-32 object-cover">`
              : `<div class="h-32 w-full bg-slate-100 flex items-center justify-center text-4xl">üéâ</div>`
          }
          <div class="p-4">
            <div class="font-semibold text-slate-900 line-clamp-2">${
              e.titulo || "Evento"
            }</div>
            <div class="text-slate-500 text-sm line-clamp-2 mt-1">${
              e.descripcion || ""
            }</div>
            <div class="text-blue-700 text-xs font-semibold mt-2">${when}</div>
          </div>
        </div>`;
        })
      );
      grid.innerHTML = cards.join("");
      empty.classList.toggle("hidden", cards.length > 0);
    }

    // ---------- TURISMO (stacked editorial cards) ----------
    async function renderTurismo() {
      const stack = $("#turismo-stack");
      const empty = $("#turismo-empty");
      const lugares = jget("lugaresTuristicos", []);
      const db = await idbOpen("TurismoMedia", 1);

      async function cover(l) {
        if (l.photoIds?.length && db) {
          const rec = await idbGet(db, "imagenes", l.photoIds[0]);
          if (rec?.blob) return asUrl(rec.blob);
        }
        if (l.imagenes?.length)
          return l.imagenes[l.imagenPrincipal || 0] || l.imagenes[0];
        return "";
      }

      const picks = [...lugares]
        .sort(
          (a, b) =>
            (b.photoIds?.length || b.imagenes?.length || 0) -
            (a.photoIds?.length || a.imagenes?.length || 0)
        )
        .slice(0, 4);
      const cards = await Promise.all(
        picks.map(async (l) => {
          const img = await cover(l);
          return `
        <div class="bg-white border border-slate-200 rounded-2xl overflow-hidden shadow-sm">
          ${
            img
              ? `<img src="${img}" class="w-full h-40 object-cover">`
              : `<div class="h-40 bg-gradient-to-br from-orange-100 to-amber-100 flex items-center justify-center text-3xl">üìç</div>`
          }
          <div class="p-4">
            <div class="flex items-start justify-between">
              <h4 class="font-bold text-slate-900">${l.nombre || ""}</h4>
              <i class="${
                l.icono || "fas fa-map-marked-alt"
              } text-orange-600"></i>
            </div>
            <div class="text-slate-500 text-xs mt-1">${l.categoria || ""}</div>
            <p class="text-slate-600 text-sm mt-2 line-clamp-3">${
              l.descripcion || ""
            }</p>
            <div class="mt-3 flex gap-2">
              ${
                l.googleMaps
                  ? `<a target="_blank" href="${l.googleMaps}" class="px-3 py-1.5 rounded-lg text-white bg-blue-600 text-xs hover:bg-blue-700">Mapa</a>`
                  : ""
              }
              <a href="#/turismo" class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-xs hover:bg-slate-200">Ver m√°s</a>
            </div>
          </div>
        </div>`;
        })
      );
      stack.innerHTML = cards.join("");
      empty.classList.toggle("hidden", cards.length > 0);
    }

    // ---------- EMERGENCY (reads from contactos with showInHome=true) ----------
    function getEmergencyContactsForHome() {
      // If admin script exposed a helper, use it; otherwise read storage directly
      if (typeof window.getEmergencyContactsForHome === "function") {
        try {
          return window.getEmergencyContactsForHome();
        } catch {
          /* fall through */
        }
      }
      const stored = localStorage.getItem("municipio.contactos.emergencia.v1");
      if (!stored) return [];
      try {
        const all = JSON.parse(stored);
        return all.filter(
          (c) => c && c.activo === true && c.showInHome === true
        );
      } catch {
        return [];
      }
    }

    function renderEmergency() {
      const contacts = getEmergencyContactsForHome()
        .sort(
          (a, b) =>
            (a.prioridad || 99) - (b.prioridad || 99) ||
            (a.nombre || "").localeCompare(b.nombre || "")
        )
        .slice(0, 12); // show up to 12 (fits 2 rows on lg)

      const iconByCategoria = (cat) => {
        const map = {
          "Emergencias M√©dicas": "fas fa-kit-medical",
          "Seguridad P√∫blica": "fas fa-shield-halved",
          Bomberos: "fas fa-fire-extinguisher",
          "Protecci√≥n Civil": "fas fa-triangle-exclamation",
          "Servicios P√∫blicos": "fas fa-wrench",
          "Gobierno Municipal": "fas fa-landmark",
          "Otros Servicios": "fas fa-phone",
        };
        return map[cat] || "fas fa-phone";
      };

      const toneByCategoria = (cat) => {
        const map = {
          "Emergencias M√©dicas": ["rose", "text-rose-600", "bg-rose-100"],
          "Seguridad P√∫blica": ["blue", "text-blue-600", "bg-blue-100"],
          Bomberos: ["orange", "text-orange-600", "bg-orange-100"],
          "Protecci√≥n Civil": ["amber", "text-amber-700", "bg-amber-100"],
          "Servicios P√∫blicos": ["green", "text-green-600", "bg-green-100"],
          "Gobierno Municipal": ["purple", "text-purple-600", "bg-purple-100"],
          "Otros Servicios": ["slate", "text-slate-700", "bg-slate-100"],
        };
        return map[cat] || ["slate", "text-slate-700", "bg-slate-100"];
      };

      $("#emerg-grid").innerHTML = contacts
        .map((c) => {
          const [, toneText, toneBg] = toneByCategoria(c.categoria);
          const icon = iconByCategoria(c.categoria);
          return `
        <div class="bg-white rounded-xl p-4 border border-slate-200 shadow-sm text-center">
          <div class="${toneBg} w-12 h-12 rounded-full mx-auto flex items-center justify-center mb-2">
            <i class="${icon} ${toneText} text-xl"></i>
          </div>
          <div class="text-lg font-extrabold ${toneText}">${
            c.telefono || ""
          }</div>
          <div class="text-slate-800 font-medium">${c.nombre || ""}</div>
          <div class="text-slate-500 text-xs">${
            c.descripcion || c.disponibilidad || ""
          }</div>
        </div>
      `;
        })
        .join("");

      $("#emerg-empty").classList.toggle("hidden", contacts.length > 0);
    }

    // ---------- INIT ----------
    (async function init() {
      await renderHero();
      renderKpiStrip();
      renderServices();
      renderFeatured();
      await renderEvents();
      await renderTurismo();
      renderEmergency();
    })();
  })();
</script>

<script>
(() => {
  // ---- Storage & DB constants (must match Noticias.html) ----
  const NEWS_LS_KEY   = "noticias.v1";
  const NEWS_IDB_NAME = "NoticiasDB";
  const NEWS_IDB_STORE= "imagenes";

  // ---- IDB helpers ----
  let newsDb = null;
  function newsIdbOpen(){
    return new Promise((resolve,reject)=>{
      const req = indexedDB.open(NEWS_IDB_NAME,1);
      req.onupgradeneeded = (e)=>{
        const db = e.target.result;
        if(!db.objectStoreNames.contains(NEWS_IDB_STORE)){
          db.createObjectStore(NEWS_IDB_STORE);
        }
      };
      req.onsuccess = ()=>resolve(req.result);
      req.onerror  = ()=>reject(req.error);
    });
  }
  function newsIdbGet(id){
    return new Promise((resolve,reject)=>{
      const tx = newsDb.transaction(NEWS_IDB_STORE,"readonly");
      const rq = tx.objectStore(NEWS_IDB_STORE).get(id);
      rq.onsuccess = ()=>resolve(rq.result||null);
      rq.onerror   = ()=>reject(rq.error);
    });
  }

  // ---- Local helpers ----
  let blobUrls = [];
  function makeBlobUrl(blob){
    if(!blob) return "";
    const url = URL.createObjectURL(blob);
    blobUrls.push(url);
    return url;
  }
  function cleanupBlobs(){
    blobUrls.forEach(u => { try { URL.revokeObjectURL(u); } catch{} });
    blobUrls = [];
  }
  function newsLoad(){
    try { return JSON.parse(localStorage.getItem(NEWS_LS_KEY) || "[]"); }
    catch { return []; }
  }
  function newsSortDesc(a,b){
    return new Date(b.date || "1970-01-01") - new Date(a.date || "1970-01-01");
  }
  function fmtDateShort(d){
    try{
      const dt = new Date(d);
      return dt.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'});
    } catch { return d||""; }
  }
  async function newsCoverUrl(item){
    if(!item?.imageIds?.length || !newsDb) return "";
    const idx = Math.min(item.coverIndex || 0, item.imageIds.length - 1);
    const blob = await newsIdbGet(item.imageIds[idx]);
    return blob ? makeBlobUrl(blob) : "";
  }

  // ---- Render Featured News (showInHome) ----
  async function renderHomeNews(){
    // ensure DB open
    try { if(!newsDb) newsDb = await newsIdbOpen(); } catch(e){ console.warn("NoticiasDB open failed", e); }

    const grid  = document.getElementById("home-news-grid");
    const empty = document.getElementById("home-news-empty");
    if(!grid) return;

    cleanupBlobs();
    const list = newsLoad()
      .filter(n => !n.archived && n.showInHome)
      .sort(newsSortDesc)
      .slice(0, 6); // cap for perf

    grid.innerHTML = "";
    if(!list.length){
      empty?.classList.remove("hidden");
      return;
    }
    empty?.classList.add("hidden");

    for(const n of list){
      const cover = await newsCoverUrl(n);
      const card = document.createElement("article");
      card.className = "bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-200 flex flex-col";
      card.innerHTML = `
        <div class="relative">
          ${cover
            ? `<img src="${cover}" class="w-full h-40 object-cover">`
            : `<div class="h-40 w-full bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-3xl">üì∞</div>`}
          <div class="absolute top-3 left-3">
            <span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-700">${n.category || ""}</span>
          </div>
        </div>
        <div class="p-5 flex flex-col gap-2 flex-1">
          <h3 class="text-lg font-bold text-slate-900 line-clamp-2">${n.title || ""}</h3>
          <div class="text-gray-500 text-xs">${fmtDateShort(n.date)} ¬∑ ${n.author || ""}</div>
          <p class="text-sm text-gray-700 line-clamp-3">${n.summary || ""}</p>
          <div class="mt-auto pt-2 flex gap-2">
            <button class="px-3 py-1.5 rounded-lg bg-blue-600 text-white text-xs hover:bg-blue-700"
              onclick="(window.Noticias&&Noticias.view)?Noticias.view(${n.id}):location.hash='#/noticias'">Read</button>
            <a href="#/noticias" class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-xs hover:bg-slate-200">All news</a>
          </div>
        </div>`;
      grid.appendChild(card);
    }
  }

  // Re-render when news change elsewhere
  window.addEventListener("storage", (e) => {
    if(e.key === NEWS_LS_KEY) renderHomeNews();
  });

  // Init now
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", renderHomeNews);
  } else {
    renderHomeNews();
  }
})();
</script>