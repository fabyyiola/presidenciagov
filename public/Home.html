<section id="HomeContent" class="min-h-screen bg-slate-50">

  <!-- HERO: blurred city/museum backdrop, headline & CTA -->
  <section class="relative">
    <div id="hero-img" class="h-[420px] w-full bg-center bg-cover"></div>
    <div class="absolute inset-0 bg-gradient-to-r from-black/60 via-black/40 to-transparent"></div>
    <div class="absolute inset-0 pointer-events-none backdrop-blur-[2px]"></div>
    <div class="absolute inset-0 flex items-center">
      <div class="max-w-7xl mx-auto px-4 w-full">
        <div class="text-white max-w-3xl">
          <h1 id="hero-title" class="text-4xl md:text-5xl font-extrabold leading-tight"></h1>
          <p id="hero-sub" class="mt-4 text-white/90 text-lg"></p>
          <div class="mt-6 flex gap-3">
            <a id="hero-cta" class="hidden inline-flex items-center gap-2 px-5 py-3 rounded-xl bg-blue-600 hover:bg-blue-700 font-semibold shadow-md transition">
              <i class="fas fa-calendar-check"></i><span></span>
            </a>
            <a id="hero-cta-sec" class="hidden inline-flex items-center gap-2 px-5 py-3 rounded-xl bg-white/10 hover:bg-white/20 font-semibold backdrop-blur transition">
              <i class="fas fa-info-circle"></i><span></span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- KPI STRIP -->
  <section class="-mt-10 relative z-10">
    <div class="max-w-7xl mx-auto px-4">
      <div id="kpi-strip" class="grid grid-cols-2 md:grid-cols-5 gap-4"></div>
    </div>
  </section>

  <!-- SERVICES (compact chips + icons) -->
  <!-- Services (static, fixed URLs) -->
<section id="Servicios" class="py-16 bg-gray-50">
  <div class="max-w-7xl mx-auto px-4">
    <header class="mb-10 text-center">
      <h2 class="text-3xl md:text-4xl font-bold text-municipal-blue">¿Cómo te podemos ayudar?</h2>
      <p class="mt-2 text-gray-600">Pagos, trámites, reportes y más servicios municipales en un solo lugar.</p>
    </header>

    <!-- Highlights row -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
      <a href="/pagos/multas" class="group rounded-2xl bg-white p-5 shadow-sm ring-1 ring-gray-100 hover:shadow-md hover:ring-municipal-blue/30 transition">
        <div class="flex items-start gap-4">
          <div class="shrink-0 rounded-xl bg-municipal-blue/10 p-3 text-municipal-blue">
            <i class="fas fa-car text-2xl"></i>
          </div>
          <div>
            <h3 class="font-semibold text-gray-900 group-hover:text-municipal-blue">Avisos de Ocasion</h3>
            <p class="text-gray-600 text-sm">Consulta y publica avisos de ocasion.</p>
          </div>
        </div>
      </a>
      <a href="/tramites/licencia" class="group rounded-2xl bg-white p-5 shadow-sm ring-1 ring-gray-100 hover:shadow-md hover:ring-municipal-teal/30 transition">
        <div class="flex items-start gap-4">
          <div class="shrink-0 rounded-xl bg-municipal-teal/10 p-3 text-municipal-teal">
            <i class="fas fa-store text-2xl"></i>
          </div>
          <div>
            <h3 class="font-semibold text-gray-900 group-hover:text-municipal-teal">Licencia de Funcionamiento</h3>
            <p class="text-gray-600 text-sm">Nueva o refrendo para tu negocio.</p>
          </div>
        </div>
      </a>
      <a href="/sam" class="group rounded-2xl bg-white p-5 shadow-sm ring-1 ring-gray-100 hover:shadow-md hover:ring-municipal-pink/30 transition">
        <div class="flex items-start gap-4">
          <div class="shrink-0 rounded-xl bg-municipal-pink/10 p-3 text-municipal-pink">
            <i class="fas fa-comments text-2xl"></i>
          </div>
          <div>
            <h3 class="font-semibold text-gray-900 group-hover:text-municipal-pink">SAM: Atención Municipal</h3>
            <p class="text-gray-600 text-sm">Pregunta, reporta o solicita.</p>
          </div>
        </div>
      </a>
    </div>

    <!-- All services grid -->
<!-- Services Quick Links -->
<section id="Servicios" class="py-16 bg-gray-50">
  <div class="max-w-6xl mx-auto px-4">
    <h2 class="text-3xl md:text-4xl font-bold text-municipal-blue text-center mb-12">
      Accesos Rápidos
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <a href="/pagos/multas" class="group bg-white p-10 rounded-2xl shadow hover:shadow-lg hover:-translate-y-1 transition flex flex-col items-center text-center">
        <i class="fas fa-car text-5xl text-municipal-blue mb-6"></i>
        <h3 class="text-xl font-semibold text-gray-800 group-hover:text-municipal-blue">Multas de Tránsito</h3>
      </a>

      <a href="/tramites" class="group bg-white p-10 rounded-2xl shadow hover:shadow-lg hover:-translate-y-1 transition flex flex-col items-center text-center">
        <i class="fas fa-file-alt text-5xl text-municipal-teal mb-6"></i>
        <h3 class="text-xl font-semibold text-gray-800 group-hover:text-municipal-teal">Trámites Municipales</h3>
      </a>

      <a href="/eventos" class="group bg-white p-10 rounded-2xl shadow hover:shadow-lg hover:-translate-y-1 transition flex flex-col items-center text-center">
        <i class="fas fa-calendar-alt text-5xl text-municipal-green mb-6"></i>
        <h3 class="text-xl font-semibold text-gray-800 group-hover:text-municipal-green">Eventos</h3>
      </a>

      <a href="/transparencia" class="group bg-white p-10 rounded-2xl shadow hover:shadow-lg hover:-translate-y-1 transition flex flex-col items-center text-center">
        <i class="fas fa-balance-scale text-5xl text-municipal-pink mb-6"></i>
        <h3 class="text-xl font-semibold text-gray-800 group-hover:text-municipal-pink">Transparencia</h3>
      </a>
    </div>
  </div>
</section>


    <!-- CTA -->
    <div class="mt-12 text-center">
      <a href="/servicios" class="inline-flex items-center gap-2 rounded-full bg-municipal-blue px-6 py-3 text-white font-semibold hover:bg-blue-700 transition">
        Ver todos los servicios
        <i class="fas fa-arrow-right"></i>
      </a>
    </div>
  </div>
</section>


  <!-- FEATURED BAND: proyectos + transparencia KPIs -->
  <section class="py-10 bg-gradient-to-r from-blue-50 to-teal-50 border-y">
    <div class="max-w-7xl mx-auto px-4">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Proyectos -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-slate-900">Proyectos Municipales</h3>
            <a href="#/proyectos" class="text-sm text-blue-600 hover:underline">Ver todos</a>
          </div>
          <div id="proj-list" class="space-y-4"></div>
        </div>
        <!-- Transparencia -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-slate-900">Últimos Documentos de Transparencia</h3>
            <a href="#/transparencia" class="text-sm text-blue-600 hover:underline">Ir a Transparencia</a>
          </div>
          <div id="tx-list" class="space-y-3"></div>
        </div>
        <!-- Negocios -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-slate-900">Directorio de Negocios</h3>
            <a href="#/negocios" class="text-sm text-blue-600 hover:underline">Explorar</a>
          </div>
          <div id="biz-list" class="space-y-3"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- EVENTS + TURISMO (masonry-ish) -->
  <section class="py-12">
    <div class="max-w-7xl mx-auto px-4">
      <div class="grid lg:grid-cols-3 gap-8">
        <!-- Events -->
        <div class="lg:col-span-2">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-slate-900">Próximos Eventos</h2>
            <a href="#/eventos" class="text-sm text-blue-600 hover:underline">Calendario</a>
          </div>
          <div id="events-grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          <div id="events-empty" class="text-slate-500 text-sm">No hay eventos próximos.</div>
        </div>

        <!-- Turismo -->
        <div>
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl md:text-3xl font-bold text-slate-900">Turismo</h2>
            <a href="#/turismo" class="text-sm text-blue-600 hover:underline">Ver más</a>
          </div>
          <div id="turismo-stack" class="space-y-4"></div>
          <div id="turismo-empty" class="text-slate-500 text-sm">Aún no hay lugares turísticos.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- EMERGENCY STRIP -->
  <section class="py-10 bg-white border-t">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex items-end justify-between mb-6">
        <h2 id="emerg-title" class="text-2xl md:text-3xl font-bold text-red-600">Números de Emergencia</h2>
        <p class="text-sm text-slate-500">Atención 24/7</p>
      </div>
      <div id="emerg-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
      <div id="emerg-empty" class="text-slate-500 text-sm">
        Marca “Mostrar en página de inicio” en <em>Contactos de Emergencia</em> para verlos aquí.
      </div>
    </div>
  </section>

</section>

<script>
(() => {
  const root = document.getElementById('HomeContent');
  const $ = (sel) => root.querySelector(sel);
  const fmt = new Intl.NumberFormat('es-MX');
  const jget = (k, d) => { try { return JSON.parse(localStorage.getItem(k) ?? JSON.stringify(d)); } catch { return d; } };
  const today = new Date(new Date().toDateString());

  // ---------- IndexedDB helpers (read-only, safe) ----------
  function idbOpen(name, version=1){ return new Promise(res=>{ const r=indexedDB.open(name,version); r.onsuccess=()=>res(r.result); r.onerror=()=>res(null); r.onupgradeneeded=()=>res(r.result); }); }
  function idbGet(db, store, key){ return new Promise(res=>{ if(!db||!db.objectStoreNames.contains(store)) return res(null); const tx=db.transaction(store,'readonly'); const os=tx.objectStore(store); const rq=os.get(key); rq.onsuccess=()=>res(rq.result||null); rq.onerror=()=>res(null); }); }
  function idbIndexAll(db, store, index, value){ return new Promise(res=>{ if(!db||!db.objectStoreNames.contains(store)) return res([]); const os=db.transaction(store,'readonly').objectStore(store); if(!os.indexNames.contains(index)) return res([]); const rq=os.index(index).getAll(value); rq.onsuccess=()=>res(rq.result||[]); rq.onerror=()=>res([]); }); }
  const blobUrls = new Set(); const asUrl = (b)=>{ const u=URL.createObjectURL(b); blobUrls.add(u); return u; };
  window.addEventListener('beforeunload', ()=>{ blobUrls.forEach(URL.revokeObjectURL); });

  // ---------- HERO ----------
  async function renderHero(){
    const cfg = jget('home.config', {});
    const title = cfg.title || 'Gobierno Municipal';
    const subtitle = cfg.subtitle || 'Servicios, proyectos y transparencia en un solo lugar.';
    const cta = cfg.ctaText || 'Agenda tu visita';
    const ctaHref = cfg.ctaHref || '#/agenda';
    const cta2 = cfg.ctaAltText || 'Conoce más';
    const cta2Href = cfg.ctaAltHref || '#/transparencia';

    // try to use a tourism image or config.bg
    let bgUrl = '';
    if (cfg.bg?.type === 'image' && cfg.bg.url){ bgUrl = cfg.bg.url; }
    else {
      // take first tourism image in IDB or base64
      const lugares = jget('lugaresTuristicos', []);
      const first = lugares.find(l => (l.photoIds?.length || l.imagenes?.length));
      if (first){
        const tdb = await idbOpen('TurismoMedia', 1);
        if (first.photoIds?.length && tdb) {
          const rec = await idbGet(tdb,'imagenes',first.photoIds[0]);
          if(rec?.blob) bgUrl = asUrl(rec.blob);
        }
        if (!bgUrl && first.imagenes?.length) bgUrl = first.imagenes[first.imagenPrincipal||0] || first.imagenes[0];
      }
    }
    $('#hero-img').style.backgroundImage = bgUrl ? `url("${bgUrl}")` : 'linear-gradient(90deg,#0ea5e9,#14b8a6)';

    $('#hero-title').innerHTML = title.replace(/\n/g,'<br>');
    $('#hero-sub').textContent = subtitle;
    const c1 = $('#hero-cta'); c1.classList.remove('hidden'); c1.querySelector('span').textContent = cta; c1.href = ctaHref;
    const c2 = $('#hero-cta-sec'); c2.classList.remove('hidden'); c2.querySelector('span').textContent = cta2; c2.href = cta2Href;
  }

  // ---------- KPI STRIP ----------
  function renderKpiStrip(){
    const proyectos = jget('municipio.proyectos.v1', []);
    const negocios = jget('negocios', []);
    const docs = jget('transparenciaDocs', []);
    const eventos = jget('eventos', []);
    const lugares = jget('lugaresTuristicos', []);

    const activosProy = proyectos.filter(p=>['En Progreso','Planificación'].includes(p.estatusGeneral)).length;
    const avanceProm = proyectos.length ? Math.round(proyectos.reduce((s,p)=>{
      const total=(p.etapas||[]).reduce((acc,e)=>{
        const avance = (typeof e.avanceManual==='number') ? Math.max(0,Math.min(100,e.avanceManual))
          : (e.tareas?.length ? Math.round((e.tareas.filter(t=>t.completada).length/e.tareas.length)*100) : 0);
        return acc + (e.peso/100)*avance;
      },0);
      return s+Math.round(total);
    },0)/proyectos.length) : 0;

    const upcoming = (eventos||[]).filter(e=>!e.fechaInicio || new Date(e.fechaInicio)>=today).length;

    const KPIS = [
      { label:'Proyectos activos', val: fmt.format(activosProy), icon:'fa-diagram-project', tone:'indigo' },
      { label:'Avance promedio', val: `${avanceProm}%`, icon:'fa-chart-line', tone:'green' },
      { label:'Negocios', val: fmt.format(negocios.length), icon:'fa-store', tone:'blue' },
      { label:'Documentos', val: fmt.format(docs.length), icon:'fa-file-pdf', tone:'rose' },
      { label:'Eventos', val: fmt.format(upcoming), icon:'fa-calendar-days', tone:'orange' },
    ];

    $('#kpi-strip').innerHTML = KPIS.map(k=>`
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 flex items-center gap-3">
        <div class="w-11 h-11 rounded-lg bg-${k.tone}-100 flex items-center justify-center">
          <i class="fas ${k.icon} text-${k.tone}-600"></i>
        </div>
        <div>
          <div class="text-xl font-bold text-slate-900">${k.val}</div>
          <div class="text-slate-500 text-xs">${k.label}</div>
        </div>
      </div>
    `).join('');
  }

  // ---------- SERVICES ----------
  function renderServices(){
    const grid = $('#services-grid');
    const empty = $('#services-empty');
    const sub = $('#services-sub');
    const q = $('#services-search');
    const services = jget('services', []); // [{title,desc,icon,href,bgClass}]
    if (sub) sub.textContent = services.length ? 'Accede rápido a lo más solicitado' : 'Aún no hay servicios configurados';

    const draw = (list)=>{
      if (!grid) return;
      grid.innerHTML = list.map(s=>`
        <button data-href="${s.href||'#'}" class="group bg-white hover:bg-slate-50 border border-slate-200 rounded-xl px-3 py-4 text-left shadow-sm hover:shadow transition">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center">
              <i class="${s.icon||'fas fa-circle'} text-slate-700"></i>
            </div>
            <div>
              <div class="font-semibold text-slate-900 leading-tight">${s.title||''}</div>
              <div class="text-slate-500 text-xs mt-1">${s.desc||''}</div>
            </div>
          </div>
        </button>
      `).join('');
      empty?.classList.toggle('hidden', list.length>0);
      grid.querySelectorAll('[data-href]').forEach(b=>b.onclick=()=>{ const href=b.dataset.href; if(!href) return; if(href.startsWith('#')) location.hash=href; else location.href=href; });
    };
    draw(services);
    q?.addEventListener('input', ()=>{ const t=q.value.trim().toLowerCase(); draw(services.filter(s=>[s.title,s.desc].some(v=>(v||'').toLowerCase().includes(t)))); });
  }

  // ---------- FEATURED: Proyectos / Transparencia / Negocios ----------
  function renderFeatured(){
    const proyectos = jget('municipio.proyectos.v1', []);
    const docs = jget('transparenciaDocs', []);
    const negocios = jget('negocios', []);

    // proyectos (top 3 by inversión)
    $('#proj-list').innerHTML = [...proyectos]
      .sort((a,b)=> (b.inversionTotal||0)-(a.inversionTotal||0)).slice(0,3)
      .map(p=>{
        const fin = p.etapas?.[p.etapas.length-1]?.fin || '';
        return `
          <div class="flex items-center gap-3">
            <div class="w-11 h-11 rounded-lg bg-blue-100 flex items-center justify-center"><i class="fas fa-helmet-safety text-blue-600"></i></div>
            <div class="flex-1">
              <div class="font-semibold text-slate-900">${p.nombre||''}</div>
              <div class="text-slate-500 text-xs">${p.categoria||''} · Fin: ${fin||'—'}</div>
            </div>
            <div class="text-right">
              <div class="text-sm font-bold text-slate-900">$${(p.inversionTotal? p.inversionTotal.toLocaleString('es-MX'): '0')}</div>
              <div class="text-xs text-slate-500">${p.estatusGeneral||''}</div>
            </div>
          </div>`;
      }).join('') || `<div class="text-slate-500 text-sm">Aún no hay proyectos.</div>`;

    // transparencia (latest 4)
    $('#tx-list').innerHTML = [...docs].sort((a,b)=>(b.createdAt||'')>(a.createdAt||'')?1:-1).slice(0,4).map(d=>`
      <div class="flex items-center justify-between">
        <div>
          <div class="font-medium text-slate-900">${d.titulo||''}</div>
          <div class="text-slate-500 text-xs">${d.categoria||''} · ${d.dependencia||''} · ${d.anio}${d.mes?'-'+d.mes:''}</div>
        </div>
        <span class="text-xs px-2 py-0.5 rounded ${d.estado==='Publicado'?'bg-green-100 text-green-700':'bg-slate-100 text-slate-600'}">${d.estado||'—'}</span>
      </div>
    `).join('') || `<div class="text-slate-500 text-sm">Sin documentos.</div>`;

    // negocios (latest 5)
    $('#biz-list').innerHTML = [...negocios].slice(-5).reverse().map(n=>`
      <div class="flex items-center justify-between">
        <div class="truncate">
          <div class="font-medium text-slate-900 truncate">${n.nombre||''}</div>
          <div class="text-slate-500 text-xs truncate">${n.giroNombre||n.giro||''} · ${n.telefono||''}</div>
        </div>
        <span class="text-xs px-2 py-0.5 rounded ${n.estado==='activo'?'bg-green-100 text-green-700': n.estado==='pendiente'?'bg-yellow-100 text-yellow-700':'bg-slate-100 text-slate-600'}">
          ${n.estado||'—'}
        </span>
      </div>
    `).join('') || `<div class="text-slate-500 text-sm">Aún no hay negocios.</div>`;
  }

  // ---------- EVENTS ----------
  async function renderEvents(){
    const grid = $('#events-grid'); const empty = $('#events-empty');
    const eventos = jget('eventos', []);
    const db = await idbOpen('EventosDB',1);
    const upcoming = eventos.filter(e=>!e.fechaInicio || new Date(e.fechaInicio)>=today)
                            .sort((a,b)=>new Date(a.fechaInicio||'2100-01-01')-new Date(b.fechaInicio||'2100-01-01'))
                            .slice(0,6);
    async function imgFor(e){
      if(e.imageId && db){ const rec = await idbGet(db,'imagenes', e.imageId); if(rec?.blob) return asUrl(rec.blob); }
      return '';
    }
    const cards = await Promise.all(upcoming.map(async e=>{
      const img = await imgFor(e);
      const when = e.fechaInicio && e.fechaFin ? `${e.fechaInicio} · ${e.fechaFin}` : (e.fechaInicio||'Próximamente');
      return `
        <div class="bg-white rounded-xl overflow-hidden border border-slate-200 shadow-sm">
          ${img ? `<img src="${img}" class="w-full h-32 object-cover">` : `<div class="h-32 w-full bg-slate-100 flex items-center justify-center text-4xl">🎉</div>`}
          <div class="p-4">
            <div class="font-semibold text-slate-900 line-clamp-2">${e.titulo||'Evento'}</div>
            <div class="text-slate-500 text-sm line-clamp-2 mt-1">${e.descripcion||''}</div>
            <div class="text-blue-700 text-xs font-semibold mt-2">${when}</div>
          </div>
        </div>`;
    }));
    grid.innerHTML = cards.join('');
    empty.classList.toggle('hidden', cards.length>0);
  }

  // ---------- TURISMO (stacked editorial cards) ----------
  async function renderTurismo(){
    const stack = $('#turismo-stack'); const empty = $('#turismo-empty');
    const lugares = jget('lugaresTuristicos', []);
    const db = await idbOpen('TurismoMedia',1);

    async function cover(l){
      if (l.photoIds?.length && db){ const rec = await idbGet(db,'imagenes', l.photoIds[0]); if(rec?.blob) return asUrl(rec.blob); }
      if (l.imagenes?.length) return l.imagenes[l.imagenPrincipal||0] || l.imagenes[0];
      return '';
    }

    const picks = [...lugares].sort((a,b)=> (b.photoIds?.length||b.imagenes?.length||0)-(a.photoIds?.length||a.imagenes?.length||0)).slice(0,4);
    const cards = await Promise.all(picks.map(async l=>{
      const img = await cover(l);
      return `
        <div class="bg-white border border-slate-200 rounded-2xl overflow-hidden shadow-sm">
          ${img ? `<img src="${img}" class="w-full h-40 object-cover">` : `<div class="h-40 bg-gradient-to-br from-orange-100 to-amber-100 flex items-center justify-center text-3xl">📍</div>`}
          <div class="p-4">
            <div class="flex items-start justify-between">
              <h4 class="font-bold text-slate-900">${l.nombre||''}</h4>
              <i class="${l.icono||'fas fa-map-marked-alt'} text-orange-600"></i>
            </div>
            <div class="text-slate-500 text-xs mt-1">${l.categoria||''}</div>
            <p class="text-slate-600 text-sm mt-2 line-clamp-3">${l.descripcion||''}</p>
            <div class="mt-3 flex gap-2">
              ${l.googleMaps? `<a target="_blank" href="${l.googleMaps}" class="px-3 py-1.5 rounded-lg text-white bg-blue-600 text-xs hover:bg-blue-700">Mapa</a>`:''}
              <a href="#/turismo" class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-xs hover:bg-slate-200">Ver más</a>
            </div>
          </div>
        </div>`;
    }));
    stack.innerHTML = cards.join('');
    empty.classList.toggle('hidden', cards.length>0);
  }

  // ---------- EMERGENCY (reads from contactos with showInHome=true) ----------
  function getEmergencyContactsForHome() {
    // If admin script exposed a helper, use it; otherwise read storage directly
    if (typeof window.getEmergencyContactsForHome === 'function') {
      try { return window.getEmergencyContactsForHome(); } catch { /* fall through */ }
    }
    const stored = localStorage.getItem('municipio.contactos.emergencia.v1');
    if (!stored) return [];
    try {
      const all = JSON.parse(stored);
      return all.filter(c => c && c.activo === true && c.showInHome === true);
    } catch {
      return [];
    }
  }

  function renderEmergency(){
    const contacts = getEmergencyContactsForHome()
      .sort((a,b)=> (a.prioridad||99)-(b.prioridad||99) || (a.nombre||'').localeCompare(b.nombre||''))
      .slice(0, 12); // show up to 12 (fits 2 rows on lg)

    const iconByCategoria = (cat)=>{
      const map = {
        'Emergencias Médicas': 'fas fa-kit-medical',
        'Seguridad Pública': 'fas fa-shield-halved',
        'Bomberos': 'fas fa-fire-extinguisher',
        'Protección Civil': 'fas fa-triangle-exclamation',
        'Servicios Públicos': 'fas fa-wrench',
        'Gobierno Municipal': 'fas fa-landmark',
        'Otros Servicios': 'fas fa-phone'
      };
      return map[cat] || 'fas fa-phone';
    };

    const toneByCategoria = (cat)=>{
      const map = {
        'Emergencias Médicas': ['rose','text-rose-600','bg-rose-100'],
        'Seguridad Pública': ['blue','text-blue-600','bg-blue-100'],
        'Bomberos': ['orange','text-orange-600','bg-orange-100'],
        'Protección Civil': ['amber','text-amber-700','bg-amber-100'],
        'Servicios Públicos': ['green','text-green-600','bg-green-100'],
        'Gobierno Municipal': ['purple','text-purple-600','bg-purple-100'],
        'Otros Servicios': ['slate','text-slate-700','bg-slate-100']
      };
      return map[cat] || ['slate','text-slate-700','bg-slate-100'];
    };

    $('#emerg-grid').innerHTML = contacts.map(c=>{
      const [, toneText, toneBg] = toneByCategoria(c.categoria);
      const icon = iconByCategoria(c.categoria);
      return `
        <div class="bg-white rounded-xl p-4 border border-slate-200 shadow-sm text-center">
          <div class="${toneBg} w-12 h-12 rounded-full mx-auto flex items-center justify-center mb-2">
            <i class="${icon} ${toneText} text-xl"></i>
          </div>
          <div class="text-lg font-extrabold ${toneText}">${c.telefono||''}</div>
          <div class="text-slate-800 font-medium">${c.nombre||''}</div>
          <div class="text-slate-500 text-xs">${c.descripcion||c.disponibilidad||''}</div>
        </div>
      `;
    }).join('');

    $('#emerg-empty').classList.toggle('hidden', contacts.length>0);
  }

  // ---------- INIT ----------
  (async function init(){
    await renderHero();
    renderKpiStrip();
    renderServices();
    renderFeatured();
    await renderEvents();
    await renderTurismo();
    renderEmergency();
  })();
})();
</script>
