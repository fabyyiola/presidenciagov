<section id="HomeContent" class="min-h-screen bg-slate-50">
  <!-- HERO: blurred city/museum backdrop, headline & CTA -->
  <section class="section-content">
    <!-- HERO -->
    <div
      id="hero-wrap"
      class="relative h-[20vh] md:h-[30vh] lg:h-[50vh] overflow-hidden"
    >
      <div id="hero-slides" class="absolute inset-0"></div>

      <!-- Overlay (titulo/CTA opcional) -->
      <div class="absolute inset-0 bg-black/30 pointer-events-none"></div>
      <div class="absolute inset-x-0 bottom-0 p-6 md:p-10 text-white">
        <h1 class="text-2xl md:text-4xl font-extrabold drop-shadow">
          Sabinas Hidalgo ‚Äî Lugares que inspiran
        </h1>
        <p class="mt-2 text-sm md:text-base opacity-90">
          Descubre los rincones m√°s representativos del municipio.
        </p>
      </div>
    </div>
  </section>

  <!-- KPI STRIP -->
  <section class="-mt-10 relative z-10">
    <div class="max-w-7xl mx-auto px-4">
      <div id="kpi-strip" class="grid grid-cols-2 md:grid-cols-5 gap-4"></div>
    </div>
  </section>

  <!-- SERVICES (compact chips + icons) -->
  <!-- Services (static, fixed URLs) -->
  <section id="Servicios" class="py-16 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4">
      <header class="mb-10 text-center">
        <h2 class="text-3xl md:text-4xl font-bold text-municipal-blue">
          ¬øC√≥mo te podemos ayudar?
        </h2>
        <p class="mt-2 text-gray-600">
          Pagos, tr√°mites, reportes y m√°s servicios municipales en un solo
          lugar.
        </p>
      </header>

      <!-- Noticias destacadas (showInHome) -->
      <div id="home-news" class="mb-10">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold text-municipal-blue">Noticias destacadas</h2>
          <a href="#/noticias" class="text-sm text-blue-600 hover:underline">Ver todas</a>
        </div>
        <div id="home-news-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        <div id="home-news-empty" class="text-gray-500 text-sm hidden">A√∫n no hay noticias destacadas.</div>
      </div>

      <!-- All services grid -->
      <!-- Services Quick Links -->
      <section id="Servicios" class="py-16 bg-gray-50">
        <div class="max-w-6xl mx-auto px-4">
          <h2
            class="text-3xl md:text-4xl font-bold text-municipal-blue text-center mb-12"
          >
            Accesos R√°pidos
          </h2>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <a
              href="/pagos/multas"
              class="group bg-white p-10 rounded-2xl shadow hover:shadow-lg ring-1 ring-gray-100 hover:ring-2 hover:ring-municipal-blue/30 transform hover:-translate-y-1 transition flex flex-col items-center text-center"
            >
              <i class="fas fa-car text-5xl text-municipal-blue mb-6"></i>
              <h3 class="font-semibold text-gray-900 mb-2">Avisos de Ocasion</h3>
              <p class="text-gray-600 text-sm">
                Consulta y publica avisos de ocasion.
              </p>
            </a>

            <a
              href="/tramites/licencia"
              class="group bg-white p-10 rounded-2xl shadow hover:shadow-lg ring-1 ring-gray-100 hover:ring-2 hover:ring-municipal-green/30 transform hover:-translate-y-1 transition flex flex-col items-center text-center"
            >
              <i class="fas fa-id-card text-5xl text-municipal-green mb-6"></i>
              <h3 class="font-semibold text-gray-900 mb-2">
                Licencias y Permisos
              </h3>
              <p class="text-gray-600 text-sm">Licencias, permisos y m√°s.</p>
            </a>

            <a
              href="/transparencia"
              class="group bg-white p-10 rounded-2xl shadow hover:shadow-lg ring-1 ring-gray-100 hover:ring-2 hover:ring-municipal-purple/30 transform hover:-translate-y-1 transition flex flex-col items-center text-center"
            >
              <i class="fas fa-file-alt text-5xl text-municipal-purple mb-6"></i>
              <h3 class="font-semibold text-gray-900 mb-2">Transparencia</h3>
              <p class="text-gray-600 text-sm">
                Accede a obligaciones de transparencia.
              </p>
            </a>

            <a
              href="/sam"
              class="group bg-white p-10 rounded-2xl shadow hover:shadow-lg ring-1 ring-gray-100 hover:ring-2 hover:ring-municipal-pink/30 transform hover:-translate-y-1 transition flex flex-col items-center text-center"
            >
              <i class="fas fa-comments text-5xl text-municipal-pink mb-6"></i>
              <h3 class="font-semibold text-gray-900 mb-2">
                SAM: Atenci√≥n Municipal
              </h3>
              <p class="text-gray-600 text-sm">Pregunta, reporta o solicita.</p>
            </a>
          </div>
        </div>
      </section>

      <!-- Feeds: eventos / transparencia / proyectos / negocios -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Eventos -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-slate-900">Pr√≥ximos Eventos</h3>
            <a href="#/eventos" class="text-sm text-blue-600 hover:underline"
              >Ver todos</a
            >
          </div>
          <div id="ev-list" class="space-y-3"></div>
        </div>
        <!-- Proyectos -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-slate-900">Proyectos Municipales</h3>
            <a href="#/proyectos" class="text-sm text-blue-600 hover:underline"
              >Ver m√°s</a
            >
          </div>
          <div id="proj-list" class="space-y-4"></div>
        </div>
        <!-- Transparencia -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-slate-900">
              √öltimos Documentos de Transparencia
            </h3>
            <a
              href="#/transparencia"
              class="text-sm text-blue-600 hover:underline"
              >Ir a Transparencia</a
            >
          </div>
          <div id="tx-list" class="space-y-3"></div>
        </div>
        <!-- Negocios -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-slate-900">Directorio de Negocios</h3>
            <a href="#/negocios" class="text-sm text-blue-600 hover:underline"
              >Explorar</a
            >
          </div>
          <div id="biz-list" class="space-y-3"></div>
        </div>
      </div>
    </div>
  </section>
  <!-- TURISM SHOW IN HOME -->
  <section class="py-16">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-slate-900">
          Lugares tur√≠sticos destacados
        </h2>
        <a href="#/turismo" class="text-sm text-blue-600 hover:underline"
          >Ver todos</a
        >
      </div>

      <div id="turismo-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>

      <!-- Reel (si >4) -->
      <div id="turismo-reel" class="relative hidden">
        <button
          id="reel-prev"
          class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-white/90 hover:bg-white shadow p-3 rounded-full"
        >
          <i class="fas fa-chevron-left"></i>
        </button>
        <div id="reel-track" class="overflow-hidden">
          <div id="reel-inner" class="flex gap-4 will-change-transform"></div>
        </div>
        <button
          id="reel-next"
          class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-white/90 hover:bg-white shadow p-3 rounded-full"
        >
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </section>
</section>

<script>
  (() => {
    // ====== Constantes de storage compartidas con Turismo ======
    const LS_KEY = "lugaresTuristicos";
    const IDB_NAME = "TurismoDB";
    const IDB_STORE = "imagenes";

    // ====== Estado ======
    let db = null;
    let blobUrls = []; // para limpieza
    let heroTimer = null;
    let currentSlide = 0;

    // ====== Helpers ======
    const loadLugares = () => {
      try {
        return JSON.parse(localStorage.getItem(LS_KEY) || "[]");
      } catch {
        return [];
      }
    };

    function idbOpen() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(IDB_NAME, 1);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(IDB_STORE)) {
            db.createObjectStore(IDB_STORE);
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }

    function idbGet(id) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(IDB_STORE, "readonly");
        const rq = tx.objectStore(IDB_STORE).get(id);
        rq.onsuccess = () => resolve(rq.result || null);
        rq.onerror = () => reject(rq.error);
      });
    }

    function makeBlobUrl(blob) {
      if (!blob) return null;
      const url = URL.createObjectURL(blob);
      blobUrls.push(url);
      return url;
    }

    function cleanupBlobs() {
      blobUrls.forEach((u) => {
        try {
          URL.revokeObjectURL(u);
        } catch {}
      });
      blobUrls = [];
    }

    function clamp(n, min, max) {
      return Math.max(min, Math.min(max, n));
    }

    // ===== HERO (si tienes fotos de lugares "hero" en Turismo) =====
    async function renderHero() {
      // Puedes conectar aqu√≠ con tu l√≥gica de turismo (no se modifica en este cambio)
      const hero = document.getElementById("hero-slides");
      if (!hero) return;
      hero.innerHTML = `<div class="w-full h-full bg-gradient-to-br from-slate-200 to-slate-300"></div>`;
    }

    // ===== KPI strip (demo) =====
    function renderKpiStrip() {
      const host = document.getElementById("kpi-strip");
      if (!host) return;
      const kpis = [
        { label: "Poblaci√≥n", value: "34,000+" },
        { label: "Negocios", value: "1,200+" },
        { label: "Eventos", value: "50+" },
        { label: "Proyectos", value: "20" },
        { label: "Transparencia", value: "100%" },
      ];
      host.innerHTML = kpis
        .map(
          (k) => `
      <div class="bg-white rounded-2xl p-4 text-center shadow-sm ring-1 ring-gray-100">
        <div class="text-2xl font-extrabold text-slate-900">${k.value}</div>
        <div class="text-slate-500 text-xs">${k.label}</div>
      </div>`
        )
        .join("");
    }

    // ===== Services chips / quick actions (lee de localStorage: "services") =====
    function jget(key, fallback) {
      try {
        const v = localStorage.getItem(key);
        return v ? JSON.parse(v) : fallback;
      } catch {
        return fallback;
      }
    }

    function renderServices() {
      // Subtitle din√°mico (ya exist√≠a)
      const sub = document.querySelector(
        '#Servicios header p, #Servicios .section-subtitle'
      );
      const grid = document.querySelector(
        '#Servicios + section #Servicios ~ .grid, #Servicios + section .grid'
      );
      const empty = null;

      const services = jget("services", []); // [{title,desc,icon,href,bgClass}]
      if (sub)
        sub.textContent = services.length
          ? "Accede r√°pido a lo m√°s solicitado"
          : "A√∫n no hay servicios configurados";

      const draw = (list) => {
        if (!grid) return;
        grid.innerHTML = list
          .map(
            (s) => `
        <button data-href="${
          s.href || "#"
        }" class="group bg-white hover:bg-slate-50 border border-gray-100 rounded-xl px-3 py-4 text-left shadow-sm hover:shadow transition">
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center">
              <i class="${s.icon || "fas fa-circle"} text-slate-700"></i>
            </div>
            <div>
              <div class="font-semibold text-slate-900 leading-tight">${
                s.title || ""
              }</div>
              <div class="text-slate-500 text-xs mt-1">${s.desc || ""}</div>
            </div>
          </div>
        </button>
      `
          )
          .join("");
        empty?.classList.toggle("hidden", list.length > 0);

        // Navegaci√≥n
        grid.querySelectorAll("[data-href]").forEach((b) =>
          b.addEventListener("click", () => {
            const href = b.getAttribute("data-href") || "#";
            if (href.startsWith("#")) location.hash = href;
            else window.location.href = href;
          })
        );
      };

      draw(services);
    }

    // ===== Feed: destacados (placeholder previo) =====
    function renderFeatured() {
      // Conservado si ten√≠as l√≥gica anterior
    }

    // ===== Noticias (Home) ======
    const NEWS_LS_KEY = "noticias.v1";
    const NEWS_IDB_NAME = "NoticiasDB";
    const NEWS_IDB_STORE = "imagenes";
    let newsDb = null;

    function newsLoad() {
      try { return JSON.parse(localStorage.getItem(NEWS_LS_KEY) || "[]"); }
      catch { return []; }
    }
    function newsSortDesc(a,b){
      return new Date(b.date || "1970-01-01") - new Date(a.date || "1970-01-01");
    }
    function newsIdbOpen(){
      return new Promise((resolve,reject)=>{
        const req = indexedDB.open(NEWS_IDB_NAME,1);
        req.onupgradeneeded = (e)=>{
          const db = e.target.result;
          if(!db.objectStoreNames.contains(NEWS_IDB_STORE)){
            db.createObjectStore(NEWS_IDB_STORE);
          }
        };
        req.onsuccess = ()=>resolve(req.result);
        req.onerror = ()=>reject(req.error);
      });
    }
    function newsIdbGet(id){
      return new Promise((resolve,reject)=>{
        const tx = newsDb.transaction(NEWS_IDB_STORE,"readonly");
        const rq = tx.objectStore(NEWS_IDB_STORE).get(id);
        rq.onsuccess = ()=>resolve(rq.result||null);
        rq.onerror = ()=>reject(rq.error);
      });
    }
    async function newsCoverUrl(item){
      if(!item?.imageIds?.length || !newsDb) return "";
      const idx = Math.min(item.coverIndex || 0, item.imageIds.length - 1);
      const blob = await newsIdbGet(item.imageIds[idx]);
      return blob ? makeBlobUrl(blob) : "";
    }
    function fmtDateShort(d){
      try{ const dt = new Date(d); return dt.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'}); }catch{ return d||""; }
    }
    async function renderHomeNews(){
      // Ensure DB
      try { newsDb = await newsIdbOpen(); } catch(e){ console.warn("NoticiasDB open failed", e); }
      const grid = document.getElementById("home-news-grid");
      const empty = document.getElementById("home-news-empty");
      if(!grid) return;

      const list = newsLoad()
        .filter(n => !n.archived && n.showInHome)
        .sort(newsSortDesc)
        .slice(0, 6); // cap for performance; grid shows 3, but keep a few more if design changes

      grid.innerHTML = "";
      if(!list.length){
        empty?.classList.remove("hidden");
        return;
      }
      empty?.classList.add("hidden");

      for(const n of list.slice(0, 6)){
        const cover = await newsCoverUrl(n);
        const card = document.createElement("article");
        card.className = "bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-200 flex flex-col";
        card.innerHTML = `
          <div class="relative">
            ${cover ? `<img src="${cover}" class="w-full h-40 object-cover">`
                     : `<div class="h-40 w-full bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center text-3xl">üì∞</div>`}
            <div class="absolute top-3 left-3">
              <span class="px-2 py-0.5 text-xs rounded-full bg-blue-100 text-blue-700">${n.category || ""}</span>
            </div>
          </div>
          <div class="p-5 flex flex-col gap-2 flex-1">
            <h3 class="text-lg font-bold text-slate-900 line-clamp-2">${n.title || ""}</h3>
            <div class="text-gray-500 text-xs">${fmtDateShort(n.date)} ¬∑ ${n.author || ""}</div>
            <p class="text-sm text-gray-700 line-clamp-3">${n.summary || ""}</p>
            <div class="mt-auto pt-2 flex gap-2">
              <button class="px-3 py-1.5 rounded-lg bg-blue-600 text-white text-xs hover:bg-blue-700" onclick="(window.Noticias&&Noticias.view)?Noticias.view(${n.id}):location.hash='#/noticias'">Leer</button>
              <a href="#/noticias" class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-xs hover:bg-slate-200">Ver todas</a>
            </div>
          </div>
        `;
        grid.appendChild(card);
      }
    }
    window.addEventListener("storage", (e)=>{
      if(e.key === NEWS_LS_KEY) renderHomeNews();
    });

    // ===== Feeds: eventos, transparencia, negocios, turismo =====
    async function renderEvents() {
      // Tu l√≥gica existente de eventos
    }
    async function renderTurismo() {
      const grid = document.getElementById("turismo-grid");
      const reel = document.getElementById("turismo-reel");
      const track = document.getElementById("reel-track");
      const inner = document.getElementById("reel-inner");
      const lugares = loadLugares();

      // Resolver portada
      async function cover(lugar) {
        if (!Array.isArray(lugar.fotoIds) || !lugar.fotoIds.length) return "";
        const idx = clamp(
          lugar.imagenPrincipal || 0,
          0,
          lugar.fotoIds.length - 1
        );
        const blob = await idbGet(lugar.fotoIds[idx]);
        return blob ? makeBlobUrl(blob) : "";
      }

      const picks = lugares.filter((l) => !!l.showInHome);
      grid.innerHTML = "";
      reel.classList.add("hidden");
      inner.innerHTML = "";

      if (!picks.length) return;

      if (picks.length <= 4) {
        // Grid
        const html = await Promise.all(
          picks.map(async (l) => {
            const img = await cover(l);
            return `
        <div class="bg-white border border-slate-200 rounded-2xl overflow-hidden shadow-sm">
          ${
            img
              ? `<img src="${img}" class="w-full h-40 object-cover">`
              : `<div class="h-40 bg-gradient-to-br from-orange-50 to-amber-100 flex items-center justify-center text-3xl">üìç</div>`
          }
          <div class="p-4">
            <div class="flex items-start justify-between">
              <h4 class="font-bold text-slate-900">${l.nombre || ""}</h4>
              <i class="${
                l.icono || "fas fa-map-marked-alt"
              } text-orange-600"></i>
            </div>
            <div class="text-slate-500 text-xs mt-1">${l.categoria || ""}</div>
            <p class="text-slate-600 text-sm mt-2 line-clamp-3">${
              l.descripcion || ""
            }</p>
            <div class="mt-3 flex gap-2">
              ${
                l.googleMaps
                  ? `<a target="_blank" href="${l.googleMaps}" class="px-3 py-1.5 rounded-lg text-white bg-blue-600 text-xs hover:bg-blue-700">Mapa</a>`
                  : ""
              }
              <a href="#/turismo" class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-xs hover:bg-slate-200">Ver m√°s</a>
            </div>
          </div>
        </div>`;
          })
        );
        grid.innerHTML = html.join("");
      } else {
        // Reel
        reel.classList.remove("hidden");
        inner.style.transition = "transform 400ms ease";

        for (const l of picks) {
          const img = await cover(l);
          const el = document.createElement("div");
          el.className =
            "bg-white border border-slate-200 rounded-2xl overflow-hidden shadow-sm min-w-[260px] max-w-[320px]";
          el.innerHTML = `
            ${
              img
                ? `<img src="${img}" class="w-full h-40 object-cover">`
                : `<div class="h-40 bg-gradient-to-br from-orange-50 to-amber-100 flex items-center justify-center text-3xl">üìç</div>`
            }
            <div class="p-4">
              <div class="flex items-start justify-between">
                <h4 class="font-bold text-slate-900">${l.nombre || ""}</h4>
                <i class="${l.icono || "fas fa-map-marked-alt"} text-orange-600"></i>
              </div>
              <div class="text-slate-500 text-xs mt-1">${l.categoria || ""}</div>
              <p class="text-slate-600 text-sm mt-2 line-clamp-3">${l.descripcion || ""}</p>
              <div class="mt-3 flex gap-2">
                ${l.googleMaps ? `<a target="_blank" href="${l.googleMaps}" class="px-3 py-1.5 rounded-lg text-white bg-blue-600 text-xs hover:bg-blue-700">Mapa</a>` : ""}
                <a href="#/turismo" class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-700 text-xs hover:bg-slate-200">Ver m√°s</a>
              </div>
            </div>
          `;
          inner.appendChild(el);
        }

        const prev = document.getElementById("reel-prev");
        const next = document.getElementById("reel-next");

        function scrollByAmount(dir) {
          const el = track; // overflow-hidden contenedor
          const delta = Math.floor(el.clientWidth * 0.9) * (dir < 0 ? -1 : 1);
          el.scrollBy({ left: delta, behavior: "smooth" });
        }

        prev.onclick = () => scrollByAmount(-1);
        next.onclick = () => scrollByAmount(1);
      }
    }

    // ====== Integraci√≥n / View de un lugar (reutiliza visor de Turismo si existe) ======
    async function viewPlace(id) {
      // Si tienes el modal de Turismo cargado en el Layout, intenta reutilizarlo:
      if (window.Turismo && typeof window.Turismo.view === "function") {
        window.Turismo.view(id);
        return;
      }
      alert("Visor de im√°genes no disponible en este contexto.");
    }

    // ====== Init ======
    async function initHome() {
      cleanupBlobs();
      db = await idbOpen().catch(console.error);
      const lugares = loadLugares();

      await renderHero();
      renderKpiStrip();
      renderServices();
      renderFeatured();
      await renderHomeNews();
      await renderEvents();
      await renderTurismo();
      renderEmergency();
    }

    // ====== Emergencias (placeholder demo) ======
    function renderEmergency() {
      // Si tienes un banner/alert de emergencia, col√≥calo aqu√≠
    }

    // ---------- INIT ----------
    (async function init() {
      await renderHero();
      renderKpiStrip();
      renderServices();
      renderFeatured();
      await renderHomeNews();
      await renderEvents();
      await renderTurismo();
      renderEmergency();
    })();
  })();
</script>
