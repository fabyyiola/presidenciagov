<!-- Hero Section (dynamic stats fed by stored data) -->
<header
  class="relative text-white min-h-[60vh] md:min-h-[70vh] lg:min-h-[80vh] overflow-hidden"
  id="HeroTransparencia"
>
  <!-- Slides -->
  <div id="transparencia-slides" class="absolute inset-0 w-full h-full"></div>

  <!-- Dark overlay -->
  <div class="absolute inset-0 bg-black/60"></div>

  <!-- Content -->
  <div class="relative container mx-auto px-6 py-16 text-left z-10">
    <h1 class="text-4xl md:text-6xl font-bold mb-6 leading-tight">
      Transparencia<br />
      <span class="text-green-200">Rendici√≥n de Cuentas</span>
    </h1>
    <p class="text-xl md:text-2xl mb-8 text-blue-100 leading-relaxed">
      Acceso p√∫blico a documentos y reportes oficiales del Gobierno Municipal.
    </p>
    <p id="heroSubcopy" class="text-lg mb-10 text-blue-50 max-w-2xl">
      Cargando estad√≠sticas...
    </p>
  </div>
</header>

<!-- Search Section -->
<section class="py-8 bg-white border-b">
  <div class="max-w-4xl mx-auto px-4">
    <div class="bg-gray-50 rounded-lg p-6">
      <h2 class="text-4xl font-bold text-municipal-blue text-center mb-6">
        BUSCAR DOCUMENTOS
      </h2>

      <div class="flex flex-col md:flex-row gap-4 mb-4">
        <input
          type="text"
          id="documentSearch"
          placeholder="Buscar documentos, actas, presupuestos, normativas..."
          class="flex-1 px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-municipal-blue text-lg"
        />
        <select
          id="categoryFilter"
          class="px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-municipal-blue"
        >
          <option value="">Todas las categor√≠as</option>
          <!-- Filtros alineados con las categor√≠as base del m√≥dulo Transparencia -->
          <option value="Presupuesto">Presupuesto</option>
          <option value="N√≥mina">N√≥mina</option>
          <option value="Contrataciones">Contrataciones</option>
          <option value="Obra P√∫blica">Obra P√∫blica</option>
          <option value="Informes">Informes</option>
        </select>
        <select
          id="yearFilter"
          class="px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-municipal-blue"
        >
          <option value="">Todos los a√±os</option>
          <option value="2025">2025</option>
          <option value="2024">2024</option>
          <option value="2023">2023</option>
          <option value="2022">2022</option>
        </select>
      </div>

      <div class="text-center">
        <p class="text-gray-600 text-sm">
          üí° <strong>Tip:</strong> Usa palabras clave como "presupuesto",
          "cuenta p√∫blica", "n√≥mina" o "licitaci√≥n".
        </p>
      </div>
    </div>
  </div>
</section>

<!-- Quick Stats (din√°micos) -->
<section class="py-8 bg-white">
  <div class="max-w-7xl mx-auto px-4">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
      <div class="text-center">
        <div
          class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-3"
        >
          <i class="fas fa-file-alt text-2xl text-municipal-blue"></i>
        </div>
        <h3 id="statDocs" class="text-2xl font-bold text-municipal-blue">‚Äî</h3>
        <p class="text-gray-600">Documentos Publicados</p>
      </div>

      <div class="text-center">
        <div
          class="bg-green-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-3"
        >
          <i class="fas fa-calendar text-2xl text-municipal-green"></i>
        </div>
        <h3 id="statUpdated" class="text-2xl font-bold text-municipal-green">‚Äî</h3>
        <p class="text-gray-600">√öltima Actualizaci√≥n</p>
      </div>

      <div class="text-center">
        <div
          class="bg-teal-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-3"
        >
          <i class="fas fa-download text-2xl text-municipal-teal"></i>
        </div>
        <h3 class="text-2xl font-bold text-municipal-teal">24/7</h3>
        <p class="text-gray-600">Acceso Libre</p>
      </div>

      <div class="text-center">
        <div
          class="bg-purple-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-3"
        >
          <i class="fas fa-shield-alt text-2xl text-purple-600"></i>
        </div>
        <h3 class="text-2xl font-bold text-purple-600">100%</h3>
        <p class="text-gray-600">Transparente</p>
      </div>
    </div>
  </div>
</section>

<!-- Document Categories (tarjetas con conteo din√°mico) -->
<section class="py-12 bg-gray-50">
  <div class="max-w-7xl mx-auto px-4">
    <h2 class="text-3xl font-bold text-municipal-blue text-center mb-12">
      CATEGOR√çAS DE DOCUMENTOS
    </h2>

    <div
      id="categoriesGrid"
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6"
    >
      <!-- Las tarjetas se conectan a las categor√≠as base del m√≥dulo Transparencia -->
      <div
        class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-300 cursor-pointer category-card"
        data-map='["N√≥mina"]'
      >
        <div class="text-center">
          <div
            class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4"
          >
            <i class="fas fa-users text-2xl text-municipal-blue"></i>
          </div>
          <h3 class="font-bold text-municipal-blue mb-2">Recursos Humanos</h3>
          <p class="text-gray-600 text-sm mb-3">
            N√≥minas, directorio y estructura
          </p>
          <div class="text-xs text-gray-500">
            <span class="bg-blue-50 px-2 py-1 rounded"
              ><span data-count>‚Äî</span> documentos</span
            >
          </div>
        </div>
      </div>

      <div
        class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-300 cursor-pointer category-card"
        data-map='["Presupuesto","Informes"]'
      >
        <div class="text-center">
          <div
            class="bg-green-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4"
          >
            <i class="fas fa-chart-line text-2xl text-municipal-green"></i>
          </div>
          <h3 class="font-bold text-municipal-blue mb-2">Finanzas</h3>
          <p class="text-gray-600 text-sm mb-3">
            Presupuestos y estados financieros
          </p>
          <div class="text-xs text-gray-500">
            <span class="bg-green-50 px-2 py-1 rounded"
              ><span data-count>‚Äî</span> documentos</span
            >
          </div>
        </div>
      </div>

      <div
        class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-300 cursor-pointer category-card"
        data-map='["Informes"]'
      >
        <div class="text-center">
          <div
            class="bg-purple-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4"
          >
            <i class="fas fa-gavel text-2xl text-purple-600"></i>
          </div>
          <h3 class="font-bold text-municipal-blue mb-2">Normatividad</h3>
          <p class="text-gray-600 text-sm mb-3">
            Reglamentos y disposiciones
          </p>
          <div class="text-xs text-gray-500">
            <span class="bg-purple-50 px-2 py-1 rounded"
              ><span data-count>‚Äî</span> documentos</span
            >
          </div>
        </div>
      </div>

      <div
        class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-300 cursor-pointer category-card"
        data-map='["Informes","Contrataciones"]'
      >
        <div class="text-center">
          <div
            class="bg-teal-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4"
          >
            <i class="fas fa-eye text-2xl text-municipal-teal"></i>
          </div>
          <h3 class="font-bold text-municipal-blue mb-2">Gobierno Abierto</h3>
          <p class="text-gray-600 text-sm mb-3">
            Transparencia proactiva y datos abiertos
          </p>
          <div class="text-xs text-gray-500">
            <span class="bg-teal-50 px-2 py-1 rounded"
              ><span data-count>‚Äî</span> documentos</span
            >
          </div>
        </div>
      </div>

      <div
        class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-300 cursor-pointer category-card"
        data-map='["Informes"]'
      >
        <div class="text-center">
          <div
            class="bg-red-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4"
          >
            <i class="fas fa-landmark text-2xl text-red-600"></i>
          </div>
          <h3 class="font-bold text-municipal-blue mb-2">Ayuntamiento</h3>
          <p class="text-gray-600 text-sm mb-3">Actas y sesiones</p>
          <div class="text-xs text-gray-500">
            <span class="bg-red-50 px-2 py-1 rounded"
              ><span data-count>‚Äî</span> documentos</span
            >
          </div>
        </div>
      </div>

      <div
        class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-300 cursor-pointer category-card"
        data-map='["Informes"]'
      >
        <div class="text-center">
          <div
            class="bg-orange-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4"
          >
            <i class="fas fa-map text-2xl text-orange-600"></i>
          </div>
          <h3 class="font-bold text-municipal-blue mb-2">Planeaci√≥n</h3>
          <p class="text-gray-600 text-sm mb-3">Planes y programas</p>
          <div class="text-xs text-gray-500">
            <span class="bg-orange-50 px-2 py-1 rounded"
              ><span data-count>‚Äî</span> documentos</span
            >
          </div>
        </div>
      </div>

      <div
        class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-300 cursor-pointer category-card"
        data-map='["Obra P√∫blica","Contrataciones"]'
      >
        <div class="text-center">
          <div
            class="bg-yellow-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4"
          >
            <i class="fas fa-hard-hat text-2xl text-yellow-600"></i>
          </div>
          <h3 class="font-bold text-municipal-blue mb-2">Obras P√∫blicas</h3>
          <p class="text-gray-600 text-sm mb-3">
            Licitaciones, contratos y avances
          </p>
          <div class="text-xs text-gray-500">
            <span class="bg-yellow-50 px-2 py-1 rounded"
              ><span data-count>‚Äî</span> documentos</span
            >
          </div>
        </div>
      </div>

      <div
        class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-300 cursor-pointer category-card"
        data-map='["Informes"]'
      >
        <div class="text-center">
          <div
            class="bg-indigo-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4"
          >
            <i class="fas fa-cogs text-2xl text-indigo-600"></i>
          </div>
          <h3 class="font-bold text-municipal-blue mb-2">Servicios P√∫blicos</h3>
          <p class="text-gray-600 text-sm mb-3">Agua, limpia, alumbrado</p>
          <div class="text-xs text-gray-500">
            <span class="bg-indigo-50 px-2 py-1 rounded"
              ><span data-count>‚Äî</span> documentos</span
            >
          </div>
        </div>
      </div>

      <div
        class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-300 cursor-pointer category-card"
        data-map='["Informes"]'
      >
        <div class="text-center">
          <div
            class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4"
          >
            <i class="fas fa-shield-alt text-2xl text-blue-600"></i>
          </div>
          <h3 class="font-bold text-municipal-blue mb-2">Seguridad P√∫blica</h3>
          <p class="text-gray-600 text-sm mb-3">Reportes y estad√≠sticas</p>
          <div class="text-xs text-gray-500">
            <span class="bg-blue-50 px-2 py-1 rounded"
              ><span data-count>‚Äî</span> documentos</span
            >
          </div>
        </div>
      </div>

      <div
        class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-300 cursor-pointer category-card"
        data-map='["Informes"]'
      >
        <div class="text-center">
          <div
            class="bg-pink-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4"
          >
            <i class="fas fa-heart text-2xl text-pink-600"></i>
          </div>
          <h3 class="font-bold text-municipal-blue mb-2">Desarrollo Social</h3>
          <p class="text-gray-600 text-sm mb-3">Programas y padrones</p>
          <div class="text-xs text-gray-500">
            <span class="bg-pink-50 px-2 py-1 rounded"
              ><span data-count>‚Äî</span> documentos</span
            >
          </div>
        </div>
      </div>
      <!-- Puedes mantener/duplicar m√°s tarjetas si lo requieres; el conteo se llena din√°micamente -->
    </div>
  </div>
</section>

<!-- Document Modal (rellenado desde datos guardados) -->
<div
  id="documentModal"
  class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4"
>
  <div class="bg-white rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 id="modalTitle" class="text-2xl font-bold text-municipal-blue"></h3>
        <button id="closeModal" class="text-gray-500 hover:text-gray-700 text-2xl">
          &times;
        </button>
      </div>

      <div class="mb-4">
        <input
          id="modalSearch"
          type="text"
          placeholder="Buscar en esta categor√≠a..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-municipal-blue"
        />
      </div>

      <div id="modalContent" class="space-y-3"></div>

      <div class="mt-6 text-center">
        <p id="modalFooter" class="text-gray-600 text-sm">‚Äî</p>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    "use strict";

    // ====== Config (coincide con tu m√≥dulo Transparencia) ======
    const LS_KEY = "transparenciaDocs";
    const IDB_NAME = "TransparenciaDB";
    const IDB_STORE = "archivos";

    // ====== Hero background (est√°tico, puedes cambiar a tu preferencia) ======
    const fotos = [
      "https://scontent.fntr8-1.fna.fbcdn.net/v/t51.82787-15/543411036_18293228668264631_1528231244587165159_n.jpg?_nc_cat=109&ccb=1-7&_nc_sid=127cfc&_nc_eui2=AeG3yBqAEhz_OD-CKfjFY8KaUjQRTyWT1iNSNBFPJZPWI2mnHJ1s1_uCkuzSX3GAzgwN9EV6uM6BxZY_qW6bss_R&_nc_ohc=ULaepqrpGqMQ7kNvwF2ln-j&_nc_oc=AdkEUiWQoVpAq6mx0q6llN4CdS38RtzYCaiga8JV-gt7LuXShMXkWSvYrPTn_z_zTpS8cqYNuCNUvuNc62n4BESx&_nc_zt=23&_nc_ht=scontent.fntr8-1.fna&_nc_gid=04YgI-7VC-wWMbfI3J65Bg&oh=00_AfZT5X2CfAeqQ5oKePddszfKs387PgNnyP347NKvUoHyvQ&oe=68C78DFA",
      "https://scontent.fntr8-1.fna.fbcdn.net/v/t51.82787-15/541385071_18293106994264631_2069341172021805007_n.jpg?_nc_cat=111&ccb=1-7&_nc_sid=127cfc&_nc_eui2=AeHFTmGfs-V6kGm-O13RO7_dH5DXY-TNmK0fkNdj5M2YreM-ePEeRhjg8gK9FLELKiE4SpUEHBSqFdaESz5hal1W&_nc_ohc=IIk7hLrXKawQ7kNvwHx8GCn&_nc_oc=AdkunGtpsvJf3ZRmeTdQArO7wt3KfUypCZcKDM4M03qjssfvHFV6c2reKmWQpX-9pyzNwbdh_Vka540VICvZuBjH&_nc_zt=23&_nc_ht=scontent.fntr8-1.fna&_nc_gid=x2L9cfLnKC_37zEyuLLMSw&oh=00_Afbbc29JERQcirwkn1WspzRM8Qp4H5YGqsMgPYB2Gis-pA&oe=68C7885E",
      "https://scontent.fntr8-1.fna.fbcdn.net/v/t39.30808-6/537443703_1083175363990686_8045232977682833621_n.jpg?_nc_cat=101&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeHFKmSngXodx6ohCkdwY33quu5ihEImdb667mKEQiZ1vtGT4xomiZqx4UJbjiOfpcA53iME9KPTybE-mq7RK--L&_nc_ohc=RNl-MM1NnbQQ7kNvwF8V5kj&_nc_oc=AdmYrMgG5oeODvMZHwxTnylSDoqnu0xc2K9zvF9R8EvWOmf8veDSqjhfLu248IWHP4QfSHvpcGpv2Q9pLBqbhavE&_nc_zt=23&_nc_ht=scontent.fntr8-1.fna&_nc_gid=NqYF_VNV5jMZdbeupbxu-g&oh=00_AfaVuQtXw0xJXuwprnRn0KusoJgXq3lxKcyfUz3P-uNXfA&oe=68C78C49",
    ];
    const slidesContainer = document.getElementById("transparencia-slides");
    fotos.forEach((url, i) => {
      const slide = document.createElement("div");
      slide.className =
        "absolute inset-0 w-full h-full transition-opacity duration-1000 " +
        (i === 0 ? "opacity-100" : "opacity-0");
      slide.style.backgroundImage = `url('${url}')`;
      slide.style.backgroundSize = "cover";
      slide.style.backgroundPosition = "center";
      slidesContainer.appendChild(slide);
    });
    const slides = Array.from(slidesContainer.children);
    let idx = 0;
    setInterval(() => {
      slides[idx].classList.replace("opacity-100", "opacity-0");
      idx = (idx + 1) % slides.length;
      slides[idx].classList.replace("opacity-0", "opacity-100");
    }, 5000);

    // ====== IndexedDB helpers ======
    let db;
    function idbOpen() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(IDB_NAME, 1);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(IDB_STORE)) {
            db.createObjectStore(IDB_STORE);
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    function idbGet(key) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(IDB_STORE, "readonly");
        const store = tx.objectStore(IDB_STORE);
        const req = store.get(key);
        req.onsuccess = () => resolve(req.result || null);
        req.onerror = () => reject(req.error);
      });
    }

    // ====== Load docs (desde localStorage) ======
    function loadDocs() {
      try {
        return JSON.parse(localStorage.getItem(LS_KEY) || "[]");
      } catch {
        return [];
      }
    }

    // ====== Utils ======
    const byId = (id) => document.getElementById(id);
    const fmtDate = (iso) => {
      if (!iso) return "‚Äî";
      const d = new Date(iso);
      if (isNaN(d)) return "‚Äî";
      return d.toLocaleDateString("es-MX", {
        year: "numeric",
        month: "short",
        day: "2-digit",
      });
    };
    const periodStr = (d) => (d.mes ? `${d.anio}-${d.mes}` : d.anio || "‚Äî");

    // Mapeo de tarjetas (UI) -> categor√≠as base del m√≥dulo Transparencia
    // Cada tarjeta trae un data-map='["Cat1","Cat2"]'
    function getCardCategories(card) {
      try {
        return JSON.parse(card.getAttribute("data-map") || "[]");
      } catch {
        return [];
      }
    }

    // ====== Dynamic Stats / Counters ======
    function updateStats(docs) {
      const published = docs.filter((d) => d.estado === "Publicado");
      byId("statDocs").textContent = published.length.toLocaleString("es-MX");

      const last = [...docs]
        .map((d) => d.createdAt)
        .filter(Boolean)
        .sort()
        .pop();
      byId("statUpdated").textContent = last ? fmtDate(last) : "‚Äî";

      const heroSub = byId("heroSubcopy");
      const years = new Set(docs.map((d) => d.anio).filter(Boolean));
      heroSub.textContent = `Consulta ${published.length.toLocaleString(
        "es-MX"
      )} documento(s) publicados ¬∑ ${years.size || "‚Äî"} a√±o(s) de informaci√≥n disponible.`;
    }

    function updateCategoryCounts(docs) {
      document.querySelectorAll(".category-card").forEach((card) => {
        const baseCats = getCardCategories(card);
        const count = docs.filter(
          (d) => d.estado === "Publicado" && baseCats.includes(d.categoria)
        ).length;
        const counter = card.querySelector("[data-count]");
        if (counter) counter.textContent = count.toLocaleString("es-MX");
      });
    }

    // ====== Search / Filter cards (por texto y por categor√≠a base) ======
    const searchInput = byId("documentSearch");
    const categoryFilter = byId("categoryFilter");
    const yearFilter = byId("yearFilter");
    function filterCards() {
      const q = (searchInput.value || "").toLowerCase();
      const cat = categoryFilter.value; // categor√≠a base (opcional)
      const cards = document.querySelectorAll(".category-card");
      cards.forEach((card) => {
        const title = card.querySelector("h3")?.textContent?.toLowerCase() || "";
        const desc = card.querySelector("p")?.textContent?.toLowerCase() || "";
        const baseCats = getCardCategories(card);
        const matchesText = title.includes(q) || desc.includes(q);
        const matchesCat = !cat || baseCats.includes(cat);
        card.style.display = matchesText && matchesCat ? "block" : "none";
      });
    }
    searchInput.addEventListener("input", filterCards);
    categoryFilter.addEventListener("change", filterCards);
    yearFilter.addEventListener("change", () => {
      // El filtro de a√±o se aplica al abrir el modal (no a las tarjetas)
    });

    // ====== Modal rendering desde datos guardados ======
    const modal = byId("documentModal");
    const modalTitle = byId("modalTitle");
    const modalContent = byId("modalContent");
    const modalFooter = byId("modalFooter");
    const modalSearch = byId("modalSearch");
    byId("closeModal").addEventListener("click", () => modal.classList.add("hidden"));
    modal.addEventListener("click", (e) => {
      if (e.target === modal) modal.classList.add("hidden");
    });

    function docMatchesSearch(d, q) {
      const hay = (v) => (v || "").toString().toLowerCase();
      return (
        hay(d.titulo).includes(q) ||
        hay(d.descripcion).includes(q) ||
        hay(d.dependencia).includes(q) ||
        hay(d.categoria).includes(q) ||
        hay(periodStr(d)).includes(q)
      );
    }

    async function renderDocsList(docs) {
      modalContent.innerHTML = "";
      for (const d of docs) {
        // Construir acciones (Ver / Descargar) si existe el archivo en IDB
        let actionsHTML = `<span class="text-xs text-gray-500">Sin archivo</span>`;
        if (d.fileId && db) {
          try {
            const blob = await idbGet(d.fileId);
            if (blob) {
              const url = URL.createObjectURL(blob);
              actionsHTML = `
                <div class="flex space-x-2">
                  <a href="${url}" target="_blank" rel="noopener" class="bg-municipal-blue text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition">
                    <i class="fas fa-eye mr-1"></i> Ver
                  </a>
                  <a href="${url}" download="${(d.fileName || d.titulo || "documento")}.pdf" class="bg-municipal-green text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition">
                    <i class="fas fa-download mr-1"></i> Descargar
                  </a>
                </div>
              `;
            } else {
              actionsHTML = `<span class="text-xs text-red-600">Archivo no encontrado</span>`;
            }
          } catch {
            actionsHTML = `<span class="text-xs text-red-600">Archivo no disponible</span>`;
          }
        }

        const estadoBadge =
          d.estado === "Publicado"
            ? `<span class="px-2 py-1 rounded bg-green-100 text-green-700 text-xs">Publicado</span>`
            : `<span class="px-2 py-1 rounded bg-gray-100 text-gray-600 text-xs">Borrador</span>`;

        const item = document.createElement("div");
        item.className =
          "bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition duration-300";
        item.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="flex items-start">
              <div class="bg-red-100 rounded p-2 mr-3">
                <i class="fas fa-file-pdf text-red-600"></i>
              </div>
              <div>
                <h4 class="font-semibold text-municipal-blue">${d.titulo || "Sin t√≠tulo"}</h4>
                <p class="text-sm text-gray-600">
                  ${d.categoria || "‚Äî"} ‚Ä¢ ${d.dependencia || "‚Äî"} ‚Ä¢ ${periodStr(d)} ‚Ä¢ ${estadoBadge}
                </p>
                ${
                  d.descripcion
                    ? `<p class="text-sm text-gray-500 mt-1 line-clamp-2">${d.descripcion}</p>`
                    : ""
                }
              </div>
            </div>
            ${actionsHTML}
          </div>
        `;
        modalContent.appendChild(item);
      }
      modalFooter.textContent = `üìÑ Mostrando ${docs.length} documento(s) ‚Ä¢ √öltima actualizaci√≥n: ${fmtDate(
        docs.map((d) => d.createdAt).sort().pop()
      )}`;
    }

    function openCategoryModal(uiCard, allDocs) {
      const baseCats = getCardCategories(uiCard);
      const selectedYear = yearFilter.value;

      // Filtrar por categor√≠as base mapeadas, estado, y a√±o si aplica
      let list = allDocs.filter(
        (d) =>
          baseCats.includes(d.categoria) &&
          d.estado === "Publicado" &&
          (!selectedYear || d.anio === selectedYear)
      );

      modalTitle.textContent =
        uiCard.querySelector("h3")?.textContent || "Documentos";
      modal.classList.remove("hidden");

      // B√∫squeda interna del modal (sobre la lista filtrada)
      const initial = list.slice();
      modalSearch.value = "";
      modalSearch.oninput = () => {
        const q = modalSearch.value.trim().toLowerCase();
        const filtered = initial.filter((d) => docMatchesSearch(d, q));
        renderDocsList(filtered);
      };

      renderDocsList(list);
    }

    // Click en tarjetas
    function bindCards(allDocs) {
      document.querySelectorAll(".category-card").forEach((card) => {
        card.addEventListener("click", () => openCategoryModal(card, allDocs));
      });
    }

    // ====== Boot ======
    (async function init() {
      db = await idbOpen().catch(() => null);
      const docs = loadDocs();

      updateStats(docs);
      updateCategoryCounts(docs);
      filterCards();
      bindCards(docs);
    })();

    // ====== Small fade-in helper (cosm√©tico) ======
    const style = document.createElement("style");
    style.textContent = `
      @keyframes fade-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
      .animate-fade-in { animation: fade-in 0.8s ease-out; }
    `;
    document.head.appendChild(style);
  })();
</script>
