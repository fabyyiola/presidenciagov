<!-- Proyectos.html (Público) -->
<section id="ProyectosPublico" class="font-sans">
  <!-- Hero -->
<header
  class="relative text-white min-h-[60vh] md:min-h-[70vh] lg:min-h-[80vh] overflow-hidden"
  id="HeroTransparencia"
>
  <!-- Slides -->
  <div id="transparencia-slides" class="absolute inset-0 w-full h-full"></div>

  <!-- Dark overlay -->
  <div class="absolute inset-0 bg-black/60"></div>

  <!-- Content -->
  <div class="relative container mx-auto px-6 py-16 text-left z-10">
    <h1 class="text-4xl md:text-6xl font-bold mb-6 leading-tight">
      Proyectos<br />
      <span class="text-green-200">Municipales</span>
    </h1>
    <p class="text-xl md:text-2xl mb-8 text-blue-100 leading-relaxed">
      Siempre Trabajando.
    </p>
    <p class="text-lg mb-10 text-blue-50 max-w-2xl">
      Obras y programas estratégicos para impulsar el desarrollo y bienestar de Sabinas Hidalgo.
    </p>
  </div>
</header>
<script>
  (function () {
    // ✅ Array of background images
    const fotos = [
      "https://scontent.fntr8-1.fna.fbcdn.net/v/t39.30808-6/542233429_1094678179507071_3999133727492054948_n.jpg?stp=cp6_dst-jpg_tt6&_nc_cat=100&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeEU_BQrsLdUoxDFMAaKi2ty_9pJYAjXv8P_2klgCNe_w1Q-n3KXMKXlJF07ziQA_NyN9NDLV_GHSBpdyNYBEnR6&_nc_ohc=Yq7Fr3q1iW8Q7kNvwGU3WQC&_nc_oc=AdmIByQM2vfdXHmFqpwlqxhGXgDMw8N-KHwgzOdDI0EIgUpW3NrUYvPb5rzP8IstunO073Fzd1JTeNYyJ5Rd6fn5&_nc_zt=23&_nc_ht=scontent.fntr8-1.fna&_nc_gid=4DSgzu6MYIxiwbVrbWXMtw&oh=00_AfaFnhJ25RPC92B4SvjZzygUtt3YAspYYAlzhqBfuq9-0A&oe=68C79700",
      "https://scontent.fntr8-1.fna.fbcdn.net/v/t39.30808-6/538165276_1086461650328724_5052366737822557849_n.jpg?_nc_cat=105&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeEkDypM8IH3ns5D0bn0DX_taxF6Q3ve9BdrEXpDe970FxsKjc33ErNia8ikCjeDQfYwJCSINzpI420BGvxNDoXx&_nc_ohc=1MDII1bij6kQ7kNvwGfPQUr&_nc_oc=AdluSEkTj6TNrjxRxAJvQciIj94MSQYDAtFCoT_TLIE6tBSU8zlm_rVUudykyameWaIqhnVw8Oowr-bws7ro0qCB&_nc_zt=23&_nc_ht=scontent.fntr8-1.fna&_nc_gid=vjChOseRHgv-GeMz3neItg&oh=00_Afbq-h-VJY-SyTcNopBbfWdz5qnnLkNiIUWddYGFeBO1bw&oe=68C7A306",
      "https://scontent.fntr8-1.fna.fbcdn.net/v/t51.82787-15/543810022_18293228677264631_5207836924973580763_n.jpg?_nc_cat=103&ccb=1-7&_nc_sid=127cfc&_nc_eui2=AeF2tY6E7g1LXsnkEJAMDNrNqjuApQISIduqO4ClAhIh22gjRtVxVQqpsAa3G0R38TMwBd8CKAK8zIV-_YKuS6-l&_nc_ohc=v-zzwO_mKU8Q7kNvwGM0-KH&_nc_oc=AdmXEAxGpxTCS3tMTDeMPivYLwMxx3UFkczJuBrnzefncRYerHgeZJKEB1dB0iNJhFOSnZ-_YWhBWakKBEJMTa9e&_nc_zt=23&_nc_ht=scontent.fntr8-1.fna&_nc_gid=mN_DUuGa49_Zvi_CP62yGg&oh=00_AfabrLqzxDRf0FQ5X3rIkv1S6A_UCyqOzTZ2mYIszkAGQw&oe=68C79428",
    ];

    const slidesContainer = document.getElementById("transparencia-slides");

    // Crear slides
    fotos.forEach((url, i) => {
      const slide = document.createElement("div");
      slide.className = `absolute inset-0 w-full h-full transition-opacity duration-1000 ${
        i === 0 ? "opacity-100" : "opacity-0"
      }`;
      slide.style.backgroundImage = `url('${url}')`;
      slide.style.backgroundSize = "cover";
      slide.style.backgroundPosition = "center";
      slidesContainer.appendChild(slide);
    });

    const slides = Array.from(slidesContainer.children);
    let idx = 0;

    function showNext() {
      slides[idx].classList.remove("opacity-100");
      slides[idx].classList.add("opacity-0");

      idx = (idx + 1) % slides.length;

      slides[idx].classList.remove("opacity-0");
      slides[idx].classList.add("opacity-100");
    }

    setInterval(showNext, 5000); // ⏱ cambia cada 5s
  })();
</script>


  <!-- Controles -->
  <div class="border-b">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <h2 class="text-2xl font-bold text-municipal-blue text-center mb-6">
        TODOS LOS PROYECTOS
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <div class="md:col-span-2">
          <label class="sr-only" for="pp-search">Buscar</label>
          <div class="relative">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input id="pp-search" type="text" placeholder="Buscar por nombre del proyecto…"
                   class="w-full pl-10 pr-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-municipal-blue focus:border-transparent">
          </div>
        </div>
        <div>
          <select id="pp-categoria"
                  class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-municipal-blue focus:border-transparent">
            <option value="">Todas las categorías</option>
            <option>Infraestructura</option>
            <option>Desarrollo Social</option>
            <option>Medio Ambiente</option>
            <option>Tecnología</option>
            <option>Educación</option>
            <option>Salud</option>
          </select>
        </div>
        <div>
          <select id="pp-estatus"
                  class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-municipal-blue focus:border-transparent">
            <option value="">Todos los estatus</option>
            <option>Planificación</option>
            <option>En Progreso</option>
            <option>Pausado</option>
            <option>Completado</option>
            <option>Cancelado</option>
          </select>
        </div>
      </div>
      <div id="pp-chips" class="flex flex-wrap gap-2 mt-3"></div>
    </div>
  </div>

  <!-- KPIs -->
  <section class="bg-gradient-to-b from-slate-50 to-white">
    <div class="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
      <div class="bg-white rounded-xl border-l-4 border-municipal-blue shadow-sm p-5">
        <div class="flex items-center justify-between">
          <div>
            <p id="pp-kpi-activos" class="text-2xl font-bold text-gray-800">0</p>
            <p class="text-gray-600 text-sm">Proyectos Activos</p>
          </div>
          <div class="bg-blue-100 p-3 rounded-lg"><i class="fas fa-project-diagram text-blue-600 text-xl"></i></div>
        </div>
      </div>
      <div class="bg-white rounded-xl border-l-4 border-emerald-500 shadow-sm p-5">
        <div class="flex items-center justify-between">
          <div>
            <p id="pp-kpi-avance" class="text-2xl font-bold text-gray-800">0%</p>
            <p class="text-gray-600 text-sm">Avance Promedio</p>
          </div>
          <div class="bg-emerald-100 p-3 rounded-lg"><i class="fas fa-chart-line text-emerald-600 text-xl"></i></div>
        </div>
      </div>
      <div class="bg-white rounded-xl border-l-4 border-purple-500 shadow-sm p-5">
        <div class="flex items-center justify-between">
          <div>
            <p id="pp-kpi-inversion" class="text-2xl font-bold text-gray-800">$0</p>
            <p class="text-gray-600 text-sm">Inversión Total</p>
          </div>
          <div class="bg-purple-100 p-3 rounded-lg"><i class="fas fa-dollar-sign text-purple-600 text-xl"></i></div>
        </div>
      </div>
      <div class="bg-white rounded-xl border-l-4 border-indigo-500 shadow-sm p-5">
        <div class="flex items-center justify-between">
          <div>
            <p id="pp-kpi-beneficiarios" class="text-2xl font-bold text-gray-800">0</p>
            <p class="text-gray-600 text-sm">Beneficiarios</p>
          </div>
          <div class="bg-indigo-100 p-3 rounded-lg"><i class="fas fa-users text-indigo-600 text-xl"></i></div>
        </div>
      </div>
      <div class="bg-white rounded-xl border-l-4 border-rose-500 shadow-sm p-5">
        <div class="flex items-center justify-between">
          <div>
            <p id="pp-kpi-riesgo" class="text-2xl font-bold text-gray-800">0</p>
            <p class="text-gray-600 text-sm">En Riesgo</p>
          </div>
          <div class="bg-rose-100 p-3 rounded-lg"><i class="fas fa-exclamation-triangle text-rose-600 text-xl"></i></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Lista -->
  <section class="max-w-7xl mx-auto px-4 pb-12">
    <div id="pp-empty" class="text-center py-16 hidden">
      <div class="w-16 h-16 rounded-full bg-gray-100 mx-auto flex items-center justify-center mb-4">
        <i class="fas fa-folder-open text-gray-400 text-2xl"></i>
      </div>
      <h3 class="text-lg font-semibold text-gray-800">Sin proyectos publicados</h3>
      <p class="text-gray-600">Cuando existan proyectos, podrás consultarlos aquí.</p>
    </div>

    <div id="pp-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
  </section>

  <!-- Modal Detalles -->
  <div id="pp-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" data-close></div>
    <div class="relative max-w-4xl mx-auto mt-10 mb-10 bg-white rounded-2xl shadow-2xl overflow-hidden">
      <header class="px-6 py-4 bg-gradient-to-r from-municipal-blue to-municipal-teal text-white">
        <div class="flex items-center justify-between">
          <h3 id="pp-modal-title" class="text-xl font-bold">Proyecto</h3>
          <button id="pp-modal-close" class="text-white/90 hover:text-white"><i class="fas fa-times text-xl"></i></button>
        </div>
      </header>
      <div id="pp-modal-body" class="p-6 space-y-6"></div>
    </div>
  </div>
</section>

<script>
(function(){
  "use strict";

  // Debe coincidir con el módulo de administración
  const STORAGE_KEY = "municipio.proyectos.v1";
  const IDB_NAME = "proyectos_media";
  const IDB_STORE = "etapa_fotos";
  let idb = null;

  // IndexedDB (solo lectura para fotos)
  function idbOpen(){
    return new Promise((res,rej)=>{
      const req = indexedDB.open(IDB_NAME,1);
      req.onsuccess = ()=>res(req.result);
      req.onerror = ()=>rej(req.error);
    });
  }
  function idbGetPhotoById(pid){
    return new Promise((res,rej)=>{
      if(!idb) return res(null);
      const tx = idb.transaction(IDB_STORE,"readonly");
      const st = tx.objectStore(IDB_STORE);
      const rq = st.get(pid);
      rq.onsuccess = ()=>res(rq.result || null);
      rq.onerror = ()=>rej(rq.error);
    });
  }

  // Estado
  let proyectos = [];
  let filtrados = [];

  // Elements
  const grid = document.getElementById("pp-grid");
  const empty = document.getElementById("pp-empty");
  const searchEl = document.getElementById("pp-search");
  const catEl = document.getElementById("pp-categoria");
  const estEl = document.getElementById("pp-estatus");
  const chips = document.getElementById("pp-chips");

  // Modal
  const modal = document.getElementById("pp-modal");
  const modalBody = document.getElementById("pp-modal-body");
  const modalTitle = document.getElementById("pp-modal-title");

  // Init
  (async function init(){
    try { idb = await idbOpen(); } catch {}
    load();
    filtrados = [...proyectos];
    bind();
    renderKPIs();
    renderList();
  })();

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    proyectos = raw ? JSON.parse(raw) : [];
  }

  function bind(){
    [searchEl, catEl, estEl].forEach(el => el.addEventListener("input", applyFilters));
    document.getElementById("pp-modal-close").addEventListener("click", closeModal);
    modal.querySelector("[data-close]").addEventListener("click", closeModal);
    window.addEventListener("keydown", e => { if(e.key==="Escape") closeModal(); });

    // Delegación para acordeones dentro del modal
    modalBody.addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-acc='toggle']");
      if(!btn) return;
      const id = btn.getAttribute("data-acc-id");
      const panel = modalBody.querySelector(`[data-acc='panel'][data-acc-id="${id}"]`);
      const chev = btn.querySelector("[data-acc='chev']");
      const open = panel.classList.contains("hidden");
      panel.classList.toggle("hidden", !open === false); // ensure toggle
      panel.classList.toggle("hidden");
      if(chev){
        chev.classList.toggle("rotate-180");
        chev.classList.add("transition-transform","duration-200");
      }
    });
  }

  function applyFilters(){
    const q = (searchEl.value || "").toLowerCase().trim();
    const cat = catEl.value;
    const est = estEl.value;

    filtrados = proyectos.filter(p=>{
      if(q && !p.nombre.toLowerCase().includes(q)) return false;
      if(cat && p.categoria !== cat) return false;
      if(est && p.estatusGeneral !== est) return false;
      return true;
    });

    updateChips({q,cat,est});
    renderKPIs();
    renderList();
  }

  function updateChips({q,cat,est}){
    const items = [];
    if(q) items.push({t:"q",l:`Búsqueda: ${q}`});
    if(cat) items.push({t:"cat",l:`Categoría: ${cat}`});
    if(est) items.push({t:"est",l:`Estatus: ${est}`});
    chips.innerHTML = items.map(c=>`
      <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-50 text-municipal-blue border border-blue-200">
        ${c.l}
        <button class="ml-2 hover:text-blue-800" onclick="(function(){
          const map={q:'pp-search',cat:'pp-categoria',est:'pp-estatus'};
          const el=document.getElementById(map['${c.t}']);
          if(el){ el.value=''; el.dispatchEvent(new Event('input')); }
        })()"><i class="fas fa-times text-xs"></i></button>
      </span>
    `).join("");
  }

  // --- Render KPIs ---
  function renderKPIs(){
    const activos = filtrados.filter(p=>["En Progreso","Planificación"].includes(p.estatusGeneral)).length;
    const avanceProm = filtrados.length
      ? Math.round(filtrados.reduce((s,p)=>s+calcProgreso(p),0)/filtrados.length)
      : 0;
    const inversion = filtrados.reduce((s,p)=>s+(p.inversionTotal||0),0);
    const beneficiarios = filtrados.reduce((s,p)=>s+(p.beneficiarios||0),0);
    const riesgo = filtrados.filter(p=>calcTimeVariance(p).status==="critico").length;

    document.getElementById("pp-kpi-activos").textContent = activos;
    document.getElementById("pp-kpi-avance").textContent = `${avanceProm}%`;
    document.getElementById("pp-kpi-inversion").textContent = `$${fmt(inversion)}`;
    document.getElementById("pp-kpi-beneficiarios").textContent = fmt(beneficiarios);
    document.getElementById("pp-kpi-riesgo").textContent = riesgo;
  }

  // --- Render Lista ---
  function renderList(){
    if(!filtrados.length){
      grid.innerHTML = "";
      empty.classList.remove("hidden");
      return;
    }
    empty.classList.add("hidden");
    grid.innerHTML = filtrados.map(p=>{
      const prog = calcProgreso(p);
      const time = calcTimeVariance(p);
      return `
        <article class="bg-white rounded-2xl border shadow-sm overflow-hidden flex flex-col">
          <div class="p-5 border-b bg-gradient-to-r from-slate-50 to-white">
            <div class="flex items-start justify-between gap-3">
              <h3 class="text-lg font-semibold text-gray-900">${esc(p.nombre)}</h3>
              <span class="px-2.5 py-0.5 rounded-full text-xs font-medium ${badgeStatus(p.estatusGeneral)}">${esc(p.estatusGeneral)}</span>
            </div>
            <div class="mt-2 flex flex-wrap gap-2 text-sm text-gray-600">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-blue-50 text-municipal-blue border border-blue-200">
                <i class="fas fa-layer-group mr-1"></i>${esc(p.categoria || "—")}
              </span>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full ${timeBadge(time.status)}">
                <i class="far fa-clock mr-1"></i>${esc(time.label)}
              </span>
            </div>
          </div>

          <div class="p-5 space-y-4 flex-1">
            <div>
              <div class="flex items-center justify-between text-sm">
                <span class="font-medium text-gray-700">Avance</span>
                <span class="font-bold text-gray-900">${prog}%</span>
              </div>
              <div class="w-full h-2 bg-gray-200 rounded-full mt-2">
                <div class="h-2 rounded-full bg-gradient-to-r from-emerald-400 to-emerald-600" style="width:${prog}%"></div>
              </div>
            </div>

            <dl class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <dt class="text-gray-500">Inversión</dt>
                <dd class="font-semibold text-gray-900">$${fmt(p.inversionTotal||0)}</dd>
              </div>
              <div>
                <dt class="text-gray-500">Beneficiarios</dt>
                <dd class="font-semibold text-gray-900">${fmt(p.beneficiarios||0)}</dd>
              </div>
            </dl>
          </div>

          <div class="px-5 pb-5">
            <button class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg border border-gray-300 hover:border-municipal-blue hover:text-municipal-blue transition"
                    onclick='PP_open("${p.id}")'>
              <i class="fas fa-eye"></i> Ver detalles
            </button>
          </div>
        </article>
      `;
    }).join("");
  }

  // --- Modal con ACORDEÓN de etapas ---
  window.PP_open = async function(id){
    const p = proyectos.find(x=>x.id===id);
    if(!p) return;
    modalTitle.textContent = p.nombre;

    const etapasHTML = await buildEtapasAccordion(p);
    const resumen = `
      <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-slate-50 rounded-xl p-4">
          <h4 class="font-semibold text-gray-800 mb-2">Resumen</h4>
          <ul class="text-sm text-gray-700 space-y-1">
            <li><span class="text-gray-500">Categoría:</span> <span class="font-medium">${esc(p.categoria||"—")}</span></li>
            <li><span class="text-gray-500">Estatus:</span> <span class="font-medium">${esc(p.estatusGeneral||"—")}</span></li>
            <li><span class="text-gray-500">Inversión:</span> <span class="font-medium">$${fmt(p.inversionTotal||0)}</span></li>
            <li><span class="text-gray-500">Beneficiarios:</span> <span class="font-medium">${fmt(p.beneficiarios||0)}</span></li>
          </ul>
          <div class="mt-4">
            <div class="flex items-center justify-between text-sm">
              <span class="font-medium text-gray-700">Progreso General</span>
              <span class="font-bold text-gray-900">${calcProgreso(p)}%</span>
            </div>
            <div class="w-full h-3 bg-gray-200 rounded-full mt-2">
              <div class="h-3 rounded-full bg-gradient-to-r from-emerald-400 to-emerald-600" style="width:${calcProgreso(p)}%"></div>
            </div>
          </div>
        </div>
        <div class="bg-slate-50 rounded-xl p-4">
          <h4 class="font-semibold text-gray-800 mb-2">Contacto y Transparencia</h4>
          <p class="text-sm text-gray-700">
            Para comentarios o solicitudes de información, acude a la Unidad de Transparencia del Municipio.
          </p>
        </div>
      </section>
    `;

    modalBody.innerHTML = `
      ${resumen}
      <section class="mt-6">
        <h4 class="font-semibold text-gray-800 mb-3">Cronograma de Etapas</h4>
        <div class="space-y-3">${etapasHTML}</div>
      </section>
    `;

    openModal();
  };

  function openModal(){
    modal.classList.remove("hidden");
    document.body.classList.add("overflow-hidden");
  }
  function closeModal(){
    modal.classList.add("hidden");
    document.body.classList.remove("overflow-hidden");
    modalBody.innerHTML = "";
  }
  window.closeModal = closeModal;

  // --- Etapas: Acordeón ---
  async function buildEtapasAccordion(p){
    if(!p.etapas?.length) return `<div class="text-sm text-gray-500">Sin etapas registradas.</div>`;
    let i = 0;
    const parts = [];
    for(const e of p.etapas){
      i++;
      const avance = calcAvanceEtapa(e);
      const peso = Number(e.peso||0);
      const montoEtapa = Math.round((p.inversionTotal||0) * (peso/100)); // estimado por % peso
      const beneficiariosEtapa = Math.round((p.beneficiarios||0) * (peso/100)); // estimado por % peso
      const accId = `acc-${e.id || (i+"-"+Math.random().toString(36).slice(2,6))}`;

      // thumbnails (máx 6)
      let thumbs = "";
      if(e.photoIds?.length && idb){
        const urls = [];
        for(const pid of e.photoIds.slice(0,6)){
          const rec = await idbGetPhotoById(pid);
          if(rec?.blob){
            urls.push(URL.createObjectURL(rec.blob));
          }
        }
        if(urls.length){
          thumbs = `<div class="grid grid-cols-3 md:grid-cols-6 gap-2 mt-3">` +
                   urls.map(u=>`<img src="${u}" class="w-full h-16 object-cover rounded">`).join("") +
                   `</div>`;
        }
      }

      // tareas
      const tareas = e.tareas||[];
      const totalTareasCosto = tareas.reduce((s,t)=>s + (Number(t.costo)||0), 0);

      const fi = e.inicio ? new Date(e.inicio).toLocaleDateString("es-MX") : "Sin fecha";
      const ff = e.fin ? new Date(e.fin).toLocaleDateString("es-MX") : "Sin fecha";

      // Header compacto: Título | % avance | $ total (estim.) | Beneficiarios (estim.)
      parts.push(`
        <article class="border rounded-xl bg-white overflow-hidden">
          <button type="button" data-acc="toggle" data-acc-id="${accId}"
                  class="w-full px-4 py-3 flex items-center justify-between hover:bg-slate-50">
            <div class="min-w-0">
              <div class="flex items-center gap-2">
                <span class="text-sm text-gray-500">${i}.</span>
                <span class="font-medium text-gray-900 truncate">${esc(e.nombre||"Etapa")}</span>
                <span class="text-xs text-gray-500">(${peso}%)</span>
              </div>
            </div>
            <div class="flex items-center gap-4 text-sm shrink-0">
              <span class="inline-flex items-center gap-1 text-gray-700"><i class="fas fa-chart-pie"></i> ${avance}%</span>
              <span class="inline-flex items-center gap-1 text-gray-700"><i class="fas fa-dollar-sign"></i> $${fmt(montoEtapa)}</span>
              <span class="inline-flex items-center gap-1 text-gray-700"><i class="fas fa-users"></i> ${fmt(beneficiariosEtapa)}</span>
              <i data-acc="chev" class="fas fa-chevron-down text-gray-400"></i>
            </div>
          </button>

          <div class="px-4 pb-4 border-t hidden" data-acc="panel" data-acc-id="${accId}">
            <!-- Detalle expandido -->
            <div class="pt-4">
              <div class="flex items-center justify-between text-sm">
                <span class="font-medium text-gray-700">Avance de la etapa</span>
                <span class="font-semibold text-gray-900">${avance}%</span>
              </div>
              <div class="w-full h-2 bg-gray-200 rounded-full mt-2">
                <div class="h-2 rounded-full bg-gradient-to-r from-municipal-blue to-municipal-teal" style="width:${avance}%"></div>
              </div>

              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 text-sm">
                <div><span class="text-gray-500">Inicio:</span> <span class="font-medium text-gray-800">${fi}</span></div>
                <div><span class="text-gray-500">Fin:</span> <span class="font-medium text-gray-800">${ff}</span></div>
                <div><span class="text-gray-500">Monto estimado:</span> <span class="font-medium text-gray-800">$${fmt(montoEtapa)}</span></div>
                <div><span class="text-gray-500">Beneficiarios est.:</span> <span class="font-medium text-gray-800">${fmt(beneficiariosEtapa)}</span></div>
              </div>

              ${thumbs || ''}

              <div class="mt-4">
                <h6 class="font-semibold text-gray-800 mb-2">Tareas</h6>
                ${
                  tareas.length
                  ? `
                    <div class="overflow-hidden rounded-lg border">
                      <div class="divide-y">
                        ${tareas.map(t => `
                          <div class="grid grid-cols-1 md:grid-cols-6 gap-2 p-3 bg-white">
                            <div class="md:col-span-2">
                              <div class="text-sm font-medium text-gray-900">${esc(t.nombre||"—")}</div>
                              <div class="text-xs text-gray-500">Responsable: ${esc(t.responsable||"—")}</div>
                            </div>
                            <div class="flex items-center gap-2">
                              <span class="text-xs ${t.completada ? 'text-emerald-700 bg-emerald-50' : 'text-gray-700 bg-gray-100'} px-2 py-0.5 rounded-full">
                                ${t.completada ? 'Completada' : 'Pendiente'}
                              </span>
                            </div>
                            <div class="md:col-span-2 text-sm text-gray-700">Costo: $${fmt(t.costo||0)}</div>
                          </div>
                        `).join('')}
                      </div>
                      <div class="px-3 py-2 bg-slate-50 text-sm flex justify-end">
                        <div><span class="text-gray-600">Total costos de tareas:</span> <span class="font-semibold text-gray-900">$${fmt(totalTareasCosto)}</span></div>
                      </div>
                    </div>
                  `
                  : `<div class="text-sm text-gray-500">Sin tareas registradas.</div>`
                }
              </div>
            </div>
          </div>
        </article>
      `);
    }
    return parts.join("");
  }

  // --- Cálculos ---
  function calcProgreso(p){
    if(!p.etapas?.length) return 0;
    let total = 0;
    for(const e of p.etapas){
      total += (Number(e.peso)||0)/100 * calcAvanceEtapa(e);
    }
    return Math.round(total);
  }
  function calcAvanceEtapa(e){
    if(typeof e.avanceManual === "number") return clamp(e.avanceManual,0,100);
    const total = e.tareas?.length || 0;
    if(!total) return 0;
    const done = e.tareas.filter(t=>t.completada).length;
    return Math.round((done/total)*100);
  }
  function calcTimeVariance(p){
    if(!p.etapas?.length) return {status:"sin-datos", label:"Sin datos"};
    const prog = calcProgreso(p);
    const finStr = p.etapas[p.etapas.length-1]?.fin;
    if(!finStr) return {status:"sin-datos", label:"Sin datos"};
    const fin = new Date(finStr);
    const hoy = new Date();
    if(prog===100) return {status:"completado", label:"Completado"};
    if(hoy<=fin) return {status:"a-tiempo", label:"A tiempo"};
    const dias = Math.floor((hoy - fin)/(1000*60*60*24));
    return dias<=7
      ? {status:"retraso-leve", label:`${dias}d retraso`}
      : {status:"critico", label:`${dias}d crítico`};
  }

  // --- UI helpers ---
  function badgeStatus(s){
    const map = {
      "Planificación":"bg-yellow-50 text-yellow-700 border border-yellow-200",
      "En Progreso":"bg-blue-50 text-blue-700 border border-blue-200",
      "Pausado":"bg-orange-50 text-orange-700 border border-orange-200",
      "Completado":"bg-emerald-50 text-emerald-700 border border-emerald-200",
      "Cancelado":"bg-rose-50 text-rose-700 border border-rose-200"
    };
    return map[s] || "bg-gray-50 text-gray-700 border border-gray-200";
  }
  function timeBadge(st){
    const map = {
      "completado":"bg-emerald-50 text-emerald-700 border border-emerald-200",
      "a-tiempo":"bg-emerald-50 text-emerald-700 border border-emerald-200",
      "retraso-leve":"bg-yellow-50 text-yellow-700 border border-yellow-200",
      "critico":"bg-rose-50 text-rose-700 border border-rose-200",
      "sin-datos":"bg-gray-50 text-gray-700 border border-gray-200"
    };
    return map[st] || "bg-gray-50 text-gray-700 border";
  }
  function fmt(n){ return new Intl.NumberFormat("es-MX").format(Number(n||0)); }
  function clamp(x,min,max){ return Math.max(min,Math.min(max,Number(x))); }
  function esc(s){ return String(s??"").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
})();
</script>
