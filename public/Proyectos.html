<!-- Proyectos.html (Público) -->
<section id="ProyectosPublico" class="font-sans">
  <!-- Hero -->
  <header class="relative">
    <div class="absolute inset-0 bg-gradient-to-r from-municipal-blue to-municipal-teal"></div>
    <div class="relative max-w-7xl mx-auto px-4 py-10 md:py-14 text-white">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">Proyectos Municipales</h1>
          <p class="mt-2 text-white/90 max-w-2xl">
            Transparencia y resultados. Consulta el avance, inversión y cronograma de obras y programas clave del municipio.
          </p>
        </div>
        <div class="flex items-center gap-3">
          <span class="inline-flex items-center gap-2 bg-white/10 px-4 py-2 rounded-lg">
            <i class="fas fa-shield-alt"></i>
            <span class="text-sm">Gobierno Abierto</span>
          </span>
        </div>
      </div>
    </div>
  </header>

  <!-- Controles -->
  <div class="border-b">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <div class="md:col-span-2">
          <label class="sr-only" for="pp-search">Buscar</label>
          <div class="relative">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input id="pp-search" type="text" placeholder="Buscar por nombre del proyecto…"
                   class="w-full pl-10 pr-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-municipal-blue focus:border-transparent">
          </div>
        </div>
        <div>
          <select id="pp-categoria"
                  class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-municipal-blue focus:border-transparent">
            <option value="">Todas las categorías</option>
            <option>Infraestructura</option>
            <option>Desarrollo Social</option>
            <option>Medio Ambiente</option>
            <option>Tecnología</option>
            <option>Educación</option>
            <option>Salud</option>
          </select>
        </div>
        <div>
          <select id="pp-estatus"
                  class="w-full px-3 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-municipal-blue focus:border-transparent">
            <option value="">Todos los estatus</option>
            <option>Planificación</option>
            <option>En Progreso</option>
            <option>Pausado</option>
            <option>Completado</option>
            <option>Cancelado</option>
          </select>
        </div>
      </div>
      <div id="pp-chips" class="flex flex-wrap gap-2 mt-3"></div>
    </div>
  </div>

  <!-- KPIs -->
  <section class="bg-gradient-to-b from-slate-50 to-white">
    <div class="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
      <div class="bg-white rounded-xl border-l-4 border-municipal-blue shadow-sm p-5">
        <div class="flex items-center justify-between">
          <div>
            <p id="pp-kpi-activos" class="text-2xl font-bold text-gray-800">0</p>
            <p class="text-gray-600 text-sm">Proyectos Activos</p>
          </div>
          <div class="bg-blue-100 p-3 rounded-lg"><i class="fas fa-project-diagram text-blue-600 text-xl"></i></div>
        </div>
      </div>
      <div class="bg-white rounded-xl border-l-4 border-emerald-500 shadow-sm p-5">
        <div class="flex items-center justify-between">
          <div>
            <p id="pp-kpi-avance" class="text-2xl font-bold text-gray-800">0%</p>
            <p class="text-gray-600 text-sm">Avance Promedio</p>
          </div>
          <div class="bg-emerald-100 p-3 rounded-lg"><i class="fas fa-chart-line text-emerald-600 text-xl"></i></div>
        </div>
      </div>
      <div class="bg-white rounded-xl border-l-4 border-purple-500 shadow-sm p-5">
        <div class="flex items-center justify-between">
          <div>
            <p id="pp-kpi-inversion" class="text-2xl font-bold text-gray-800">$0</p>
            <p class="text-gray-600 text-sm">Inversión Total</p>
          </div>
          <div class="bg-purple-100 p-3 rounded-lg"><i class="fas fa-dollar-sign text-purple-600 text-xl"></i></div>
        </div>
      </div>
      <div class="bg-white rounded-xl border-l-4 border-indigo-500 shadow-sm p-5">
        <div class="flex items-center justify-between">
          <div>
            <p id="pp-kpi-beneficiarios" class="text-2xl font-bold text-gray-800">0</p>
            <p class="text-gray-600 text-sm">Beneficiarios</p>
          </div>
          <div class="bg-indigo-100 p-3 rounded-lg"><i class="fas fa-users text-indigo-600 text-xl"></i></div>
        </div>
      </div>
      <div class="bg-white rounded-xl border-l-4 border-rose-500 shadow-sm p-5">
        <div class="flex items-center justify-between">
          <div>
            <p id="pp-kpi-riesgo" class="text-2xl font-bold text-gray-800">0</p>
            <p class="text-gray-600 text-sm">En Riesgo</p>
          </div>
          <div class="bg-rose-100 p-3 rounded-lg"><i class="fas fa-exclamation-triangle text-rose-600 text-xl"></i></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Lista -->
  <section class="max-w-7xl mx-auto px-4 pb-12">
    <div id="pp-empty" class="text-center py-16 hidden">
      <div class="w-16 h-16 rounded-full bg-gray-100 mx-auto flex items-center justify-center mb-4">
        <i class="fas fa-folder-open text-gray-400 text-2xl"></i>
      </div>
      <h3 class="text-lg font-semibold text-gray-800">Sin proyectos publicados</h3>
      <p class="text-gray-600">Cuando existan proyectos, podrás consultarlos aquí.</p>
    </div>

    <div id="pp-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
  </section>

  <!-- Modal Detalles -->
  <div id="pp-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" data-close></div>
    <div class="relative max-w-4xl mx-auto mt-10 mb-10 bg-white rounded-2xl shadow-2xl overflow-hidden">
      <header class="px-6 py-4 bg-gradient-to-r from-municipal-blue to-municipal-teal text-white">
        <div class="flex items-center justify-between">
          <h3 id="pp-modal-title" class="text-xl font-bold">Proyecto</h3>
          <button id="pp-modal-close" class="text-white/90 hover:text-white"><i class="fas fa-times text-xl"></i></button>
        </div>
      </header>
      <div id="pp-modal-body" class="p-6 space-y-6"></div>
    </div>
  </div>
</section>

<script>
(function(){
  "use strict";

  // Debe coincidir con el módulo de administración
  const STORAGE_KEY = "municipio.proyectos.v1";

  // Opcional: leer fotos desde IndexedDB si existen (solo lectura)
  const IDB_NAME = "proyectos_media";
  const IDB_STORE = "etapa_fotos";
  let idb = null;
  function idbOpen(){
    return new Promise((res,rej)=>{
      const req = indexedDB.open(IDB_NAME,1);
      req.onsuccess = ()=>res(req.result);
      req.onerror = ()=>rej(req.error);
    });
  }
  function idbGetPhotoById(pid){
    return new Promise((res,rej)=>{
      if(!idb) return res(null);
      const tx = idb.transaction(IDB_STORE,"readonly");
      const st = tx.objectStore(IDB_STORE);
      const rq = st.get(pid);
      rq.onsuccess = ()=>res(rq.result || null);
      rq.onerror = ()=>rej(rq.error);
    });
  }

  // Estado
  let proyectos = [];
  let filtrados = [];

  // Elements
  const grid = document.getElementById("pp-grid");
  const empty = document.getElementById("pp-empty");
  const searchEl = document.getElementById("pp-search");
  const catEl = document.getElementById("pp-categoria");
  const estEl = document.getElementById("pp-estatus");
  const chips = document.getElementById("pp-chips");

  // Modal
  const modal = document.getElementById("pp-modal");
  const modalBody = document.getElementById("pp-modal-body");
  const modalTitle = document.getElementById("pp-modal-title");

  // Init
  (async function init(){
    try { idb = await idbOpen(); } catch {}
    load();
    filtrados = [...proyectos];
    bind();
    renderKPIs();
    renderList();
  })();

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    proyectos = raw ? JSON.parse(raw) : [];
  }

  function bind(){
    [searchEl, catEl, estEl].forEach(el => el.addEventListener("input", applyFilters));
    document.getElementById("pp-modal-close").addEventListener("click", closeModal);
    modal.querySelector("[data-close]").addEventListener("click", closeModal);
    window.addEventListener("keydown", e => { if(e.key==="Escape") closeModal(); });
  }

  function applyFilters(){
    const q = (searchEl.value || "").toLowerCase().trim();
    const cat = catEl.value;
    const est = estEl.value;

    filtrados = proyectos.filter(p=>{
      if(q && !p.nombre.toLowerCase().includes(q)) return false;
      if(cat && p.categoria !== cat) return false;
      if(est && p.estatusGeneral !== est) return false;
      return true;
    });

    updateChips({q,cat,est});
    renderKPIs();
    renderList();
  }

  function updateChips({q,cat,est}){
    const items = [];
    if(q) items.push({t:"q",l:`Búsqueda: ${q}`});
    if(cat) items.push({t:"cat",l:`Categoría: ${cat}`});
    if(est) items.push({t:"est",l:`Estatus: ${est}`});
    chips.innerHTML = items.map(c=>`
      <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-50 text-municipal-blue border border-blue-200">
        ${c.l}
        <button class="ml-2 hover:text-blue-800" onclick="(function(){
          const map={q:'pp-search',cat:'pp-categoria',est:'pp-estatus'};
          const el=document.getElementById(map['${c.t}']);
          if(el){ el.value=''; el.dispatchEvent(new Event('input')); }
        })()"><i class="fas fa-times text-xs"></i></button>
      </span>
    `).join("");
  }

  // --- Render KPIs ---
  function renderKPIs(){
    const activos = filtrados.filter(p=>["En Progreso","Planificación"].includes(p.estatusGeneral)).length;
    const avanceProm = filtrados.length
      ? Math.round(filtrados.reduce((s,p)=>s+calcProgreso(p),0)/filtrados.length)
      : 0;
    const inversion = filtrados.reduce((s,p)=>s+(p.inversionTotal||0),0);
    const beneficiarios = filtrados.reduce((s,p)=>s+(p.beneficiarios||0),0);
    const riesgo = filtrados.filter(p=>calcTimeVariance(p).status==="critico").length;

    document.getElementById("pp-kpi-activos").textContent = activos;
    document.getElementById("pp-kpi-avance").textContent = `${avanceProm}%`;
    document.getElementById("pp-kpi-inversion").textContent = `$${fmt(inversion)}`;
    document.getElementById("pp-kpi-beneficiarios").textContent = fmt(beneficiarios);
    document.getElementById("pp-kpi-riesgo").textContent = riesgo;
  }

  // --- Render Lista ---
  function renderList(){
    if(!filtrados.length){
      grid.innerHTML = "";
      empty.classList.remove("hidden");
      return;
    }
    empty.classList.add("hidden");
    grid.innerHTML = filtrados.map(p=>{
      const prog = calcProgreso(p);
      const time = calcTimeVariance(p);
      return `
        <article class="bg-white rounded-2xl border shadow-sm overflow-hidden flex flex-col">
          <div class="p-5 border-b bg-gradient-to-r from-slate-50 to-white">
            <div class="flex items-start justify-between gap-3">
              <h3 class="text-lg font-semibold text-gray-900">${esc(p.nombre)}</h3>
              <span class="px-2.5 py-0.5 rounded-full text-xs font-medium ${badgeStatus(p.estatusGeneral)}">${esc(p.estatusGeneral)}</span>
            </div>
            <div class="mt-2 flex flex-wrap gap-2 text-sm text-gray-600">
              <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-blue-50 text-municipal-blue border border-blue-200">
                <i class="fas fa-layer-group mr-1"></i>${esc(p.categoria || "—")}
              </span>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full ${timeBadge(time.status)}">
                <i class="far fa-clock mr-1"></i>${esc(time.label)}
              </span>
            </div>
          </div>

          <div class="p-5 space-y-4 flex-1">
            <div>
              <div class="flex items-center justify-between text-sm">
                <span class="font-medium text-gray-700">Avance</span>
                <span class="font-bold text-gray-900">${prog}%</span>
              </div>
              <div class="w-full h-2 bg-gray-200 rounded-full mt-2">
                <div class="h-2 rounded-full bg-gradient-to-r from-emerald-400 to-emerald-600" style="width:${prog}%"></div>
              </div>
            </div>

            <dl class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <dt class="text-gray-500">Inversión</dt>
                <dd class="font-semibold text-gray-900">$${fmt(p.inversionTotal||0)}</dd>
              </div>
              <div>
                <dt class="text-gray-500">Beneficiarios</dt>
                <dd class="font-semibold text-gray-900">${fmt(p.beneficiarios||0)}</dd>
              </div>
            </dl>
          </div>

          <div class="px-5 pb-5">
            <button class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 rounded-lg border border-gray-300 hover:border-municipal-blue hover:text-municipal-blue transition"
                    onclick='PP_open("${p.id}")'>
              <i class="fas fa-eye"></i> Ver detalles
            </button>
          </div>
        </article>
      `;
    }).join("");
  }

  // --- Modal ---
  window.PP_open = async function(id){
    const p = proyectos.find(x=>x.id===id);
    if(!p) return;
    modalTitle.textContent = p.nombre;

    const etapasHTML = await buildEtapasPreview(p);
    const resumen = `
      <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-slate-50 rounded-xl p-4">
          <h4 class="font-semibold text-gray-800 mb-2">Resumen</h4>
          <ul class="text-sm text-gray-700 space-y-1">
            <li><span class="text-gray-500">Categoría:</span> <span class="font-medium">${esc(p.categoria||"—")}</span></li>
            <li><span class="text-gray-500">Estatus:</span> <span class="font-medium">${esc(p.estatusGeneral||"—")}</span></li>
            <li><span class="text-gray-500">Inversión:</span> <span class="font-medium">$${fmt(p.inversionTotal||0)}</span></li>
            <li><span class="text-gray-500">Beneficiarios:</span> <span class="font-medium">${fmt(p.beneficiarios||0)}</span></li>
          </ul>
          <div class="mt-4">
            <div class="flex items-center justify-between text-sm">
              <span class="font-medium text-gray-700">Progreso General</span>
              <span class="font-bold text-gray-900">${calcProgreso(p)}%</span>
            </div>
            <div class="w-full h-3 bg-gray-200 rounded-full mt-2">
              <div class="h-3 rounded-full bg-gradient-to-r from-emerald-400 to-emerald-600" style="width:${calcProgreso(p)}%"></div>
            </div>
          </div>
        </div>
        <div class="bg-slate-50 rounded-xl p-4">
          <h4 class="font-semibold text-gray-800 mb-2">Contacto y Transparencia</h4>
          <p class="text-sm text-gray-700">
            Para comentarios o solicitudes de información, acude a la Unidad de Transparencia del Municipio.
          </p>
        </div>
      </section>
    `;

    modalBody.innerHTML = `
      ${resumen}
      <section class="mt-6">
        <h4 class="font-semibold text-gray-800 mb-3">Cronograma de Etapas</h4>
        <div class="space-y-3">${etapasHTML}</div>
      </section>
    `;

    openModal();
  };

  function openModal(){
    modal.classList.remove("hidden");
    document.body.classList.add("overflow-hidden");
  }
  function closeModal(){
    modal.classList.add("hidden");
    document.body.classList.remove("overflow-hidden");
    modalBody.innerHTML = "";
  }
  window.closeModal = closeModal;

  // --- Helpers de Render ---
  async function buildEtapasPreview(p){
    if(!p.etapas?.length) return `<div class="text-sm text-gray-500">Sin etapas registradas.</div>`;
    const parts = [];
    for(const e of p.etapas){
      const avance = calcAvanceEtapa(e);
      // Thumbs: intenta con photoIds si existen
      let thumbs = "";
      if(e.photoIds?.length && idb){
        const urls = [];
        for(const pid of e.photoIds.slice(0,6)){
          const rec = await idbGetPhotoById(pid);
          if(rec?.blob){
            const url = URL.createObjectURL(rec.blob);
            urls.push(url);
          }
        }
        if(urls.length){
          thumbs = `<div class="grid grid-cols-3 md:grid-cols-6 gap-2 mt-2">` +
                   urls.map(u=>`<img src="${u}" class="w-full h-16 object-cover rounded">`).join("") +
                   `</div>`;
        }
      }
      const fi = e.inicio ? new Date(e.inicio).toLocaleDateString("es-MX") : "Sin fecha";
      const ff = e.fin ? new Date(e.fin).toLocaleDateString("es-MX") : "Sin fecha";
      parts.push(`
        <article class="border rounded-xl p-4 bg-white">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <h5 class="font-medium text-gray-900">${esc(e.nombre||"Etapa")}</h5>
              <span class="text-xs text-gray-500">(${e.peso||0}%)</span>
            </div>
            <span class="text-sm font-semibold text-gray-900">${avance}%</span>
          </div>
          <div class="w-full h-2 bg-gray-200 rounded-full mt-2">
            <div class="h-2 rounded-full bg-gradient-to-r from-municipal-blue to-municipal-teal" style="width:${avance}%"></div>
          </div>
          <div class="flex justify-between text-xs text-gray-500 mt-2">
            <span>${fi}</span><span>${ff}</span>
          </div>
          ${thumbs || ""}
        </article>
      `);
    }
    return parts.join("");
  }

  function calcProgreso(p){
    if(!p.etapas?.length) return 0;
    let total = 0;
    for(const e of p.etapas){
      total += (Number(e.peso)||0)/100 * calcAvanceEtapa(e);
    }
    return Math.round(total);
  }
  function calcAvanceEtapa(e){
    if(typeof e.avanceManual === "number") return clamp(e.avanceManual,0,100);
    const total = e.tareas?.length || 0;
    if(!total) return 0;
    const done = e.tareas.filter(t=>t.completada).length;
    return Math.round((done/total)*100);
  }
  function calcTimeVariance(p){
    if(!p.etapas?.length) return {status:"sin-datos", label:"Sin datos"};
    const prog = calcProgreso(p);
    const finStr = p.etapas[p.etapas.length-1]?.fin;
    if(!finStr) return {status:"sin-datos", label:"Sin datos"};
    const fin = new Date(finStr);
    const hoy = new Date();
    if(prog===100) return {status:"completado", label:"Completado"};
    if(hoy<=fin) return {status:"a-tiempo", label:"A tiempo"};
    const dias = Math.floor((hoy - fin)/(1000*60*60*24));
    return dias<=7
      ? {status:"retraso-leve", label:`${dias}d retraso`}
      : {status:"critico", label:`${dias}d crítico`};
  }

  // --- UI helpers ---
  function badgeStatus(s){
    const map = {
      "Planificación":"bg-yellow-50 text-yellow-700 border border-yellow-200",
      "En Progreso":"bg-blue-50 text-blue-700 border border-blue-200",
      "Pausado":"bg-orange-50 text-orange-700 border border-orange-200",
      "Completado":"bg-emerald-50 text-emerald-700 border border-emerald-200",
      "Cancelado":"bg-rose-50 text-rose-700 border border-rose-200"
    };
    return map[s] || "bg-gray-50 text-gray-700 border border-gray-200";
    }
  function timeBadge(st){
    const map = {
      "completado":"bg-emerald-50 text-emerald-700 border border-emerald-200",
      "a-tiempo":"bg-emerald-50 text-emerald-700 border border-emerald-200",
      "retraso-leve":"bg-yellow-50 text-yellow-700 border border-yellow-200",
      "critico":"bg-rose-50 text-rose-700 border border-rose-200",
      "sin-datos":"bg-gray-50 text-gray-700 border border-gray-200"
    };
    return map[st] || "bg-gray-50 text-gray-700 border";
  }
  function fmt(n){ return new Intl.NumberFormat("es-MX").format(Number(n||0)); }
  function clamp(x,min,max){ return Math.max(min,Math.min(max,Number(x))); }
  function esc(s){ return String(s??"").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
})();
</script>
