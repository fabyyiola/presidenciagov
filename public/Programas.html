<!-- ServiciosPublicos.html (Public module) -->
<section id="ServiciosPublicos" class="bg-gray-500 font-sans">
  <!-- Header / Hero Section -->
  <header
    class="relative text-white"
    style="
      background-image: url('https://scontent.fntr8-1.fna.fbcdn.net/v/t39.30808-6/536276326_1086609113647311_48730282605770136_n.jpg?stp=cp6_dst-jpg_tt6&_nc_cat=100&ccb=1-7&_nc_sid=f727a1&_nc_eui2=AeGRPafL6L3wMshxfjt6HbfPVurNb8KCSk9W6s1vwoJKTx7vQnWhKmIMA273Xr3kzhToxGxXocF7EL-wse02jw4s&_nc_ohc=MdBEw8kSRxMQ7kNvwGauXAo&_nc_oc=Adl8Yw7OaALvjurEHojFktj8fhZ8iPwHY0MKQ4IXffTKjdu-dAb4dpscX3hd7Ien4bc9qs0K3Lo3VphvpA1X-LBb&_nc_zt=23&_nc_ht=scontent.fntr8-1.fna&_nc_gid=0IdaEdKWPrZSwUeW0LHEHw&oh=00_AfZ_sDvKcsrxdnmM5YD5dbCJ712EVpeSQtM_QcPsfEzlUg&oe=68C69AD5');
      background-size: cover;
      background-position: center;
    "
  >
    <!-- Dark overlay -->
    <div class="absolute inset-0 bg-black/60"></div>

    <!-- Content -->
    <div class="relative container mx-auto px-6 py-16 text-left max-w-4xl">
      <h1 class="text-4xl md:text-6xl font-bold mb-6 leading-tight">
        Servicios Municipales y<br />
        <span class="text-green-200">Apoyo Comunitario</span>
      </h1>
      <p class="text-xl md:text-2xl mb-8 text-blue-100 leading-relaxed">
        Programas y Beneficios para la Comunidad
      </p>
      <p class="text-lg mb-10 text-blue-50 max-w-2xl">
        Descubre los programas sociales disponibles para ti y tu familia.
        Estamos aquí para apoyarte en cada etapa de tu vida.
      </p>
      <button
        onclick="openForm()"
        class="bg-white text-blue-700 px-8 py-4 rounded-xl font-bold text-lg hover:bg-blue-50 transition-all duration-300 shadow-lg hover:shadow-xl"
      >
        <i class="fas fa-edit mr-3"></i> Solicitar Apoyo Ahora
      </button>
    </div>
  </header>

  <!-- Programs Section -->
  <section class="py-16 bg-white">
    <div class="container mx-auto px-6">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4">
          Programas Disponibles
        </h2>
        <p class="text-xl text-gray-600 max-w-2xl mx-auto">
          Conoce todos los programas sociales que tenemos para ti
        </p>
      </div>

      <!-- Grid -->
      <div
        id="programs-grid"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
      ></div>

      <!-- Empty state -->
      <div id="programs-empty" class="text-center text-gray-500 hidden">
        Aún no hay programas activos para mostrar.
      </div>
    </div>
  </section>

  <!-- Application Form Modal -->
  <div
    id="form-modal"
    class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4"
  >
    <div
      class="bg-white rounded-2xl shadow-xl w-full max-w-3xl p-8 relative overflow-y-auto max-h-[90vh]"
    >
      <button
        onclick="closeForm()"
        class="absolute top-3 right-3 text-gray-500 hover:text-gray-800"
      >
        <i class="fas fa-times text-lg"></i>
      </button>
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Solicitud de Apoyo</h2>
      <form id="support-form" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label
              for="fullName"
              class="block text-sm font-semibold text-gray-700 mb-2"
              >Nombre Completo *</label
            >
            <input
              id="fullName"
              name="fullName"
              required
              class="w-full px-4 py-3 border rounded-lg"
            />
          </div>
          <div>
            <label
              for="curp"
              class="block text-sm font-semibold text-gray-700 mb-2"
              >CURP *</label
            >
            <input
              id="curp"
              name="curp"
              required
              maxlength="18"
              class="w-full px-4 py-3 border rounded-lg uppercase"
            />
          </div>
          <div>
            <label
              for="age"
              class="block text-sm font-semibold text-gray-700 mb-2"
              >Edad *</label
            >
            <input
              id="age"
              name="age"
              type="number"
              min="1"
              max="120"
              required
              class="w-full px-4 py-3 border rounded-lg"
            />
          </div>
          <div>
            <label
              for="phone"
              class="block text-sm font-semibold text-gray-700 mb-2"
              >Teléfono *</label
            >
            <input
              id="phone"
              name="phone"
              required
              class="w-full px-4 py-3 border rounded-lg"
            />
          </div>
        </div>
        <div>
          <label
            for="address"
            class="block text-sm font-semibold text-gray-700 mb-2"
            >Dirección *</label
          >
          <textarea
            id="address"
            name="address"
            rows="3"
            required
            class="w-full px-4 py-3 border rounded-lg"
          ></textarea>
        </div>
        <div>
          <label
            for="program"
            class="block text-sm font-semibold text-gray-700 mb-2"
            >Programa Solicitado *</label
          >
          <select
            id="program"
            name="program"
            required
            class="w-full px-4 py-3 border rounded-lg"
          ></select>
        </div>
        <div>
          <label
            for="reason"
            class="block text-sm font-semibold text-gray-700 mb-2"
            >Motivo *</label
          >
          <textarea
            id="reason"
            name="reason"
            rows="4"
            required
            class="w-full px-4 py-3 border rounded-lg"
          ></textarea>
        </div>
        <label class="flex items-start bg-blue-50 border rounded-lg p-4">
          <input type="checkbox" id="privacy" required class="mt-1" />
          <span class="ml-3 text-sm text-gray-700"
            >Acepto la política de privacidad y autorizo el tratamiento de mis
            datos.</span
          >
        </label>
        <div class="text-center pt-6">
          <button
            type="submit"
            class="bg-gradient-to-r from-blue-600 to-green-600 text-white px-12 py-4 rounded-xl font-bold"
          >
            Enviar Solicitud
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Success Modal -->
  <div
    id="success-modal"
    class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center"
  >
    <div class="bg-white rounded-2xl max-w-md w-full p-8 text-center">
      <div
        class="bg-green-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-6"
      >
        <i class="fas fa-check text-green-600 text-2xl"></i>
      </div>
      <h3 class="text-2xl font-bold text-gray-800 mb-4">¡Solicitud Enviada!</h3>
      <p class="text-gray-600 mb-6">
        Tu solicitud ha sido recibida correctamente. Te contactaremos pronto.
      </p>
      <p class="text-sm text-gray-500 mb-6">
        ID de solicitud:
        <span id="request-id" class="font-mono font-bold"></span>
      </p>
      <button
        onclick="closeSuccessModal()"
        class="bg-green-600 text-white px-6 py-3 rounded-lg"
      >
        Entendido
      </button>
    </div>
  </div>
</section>

<script>
  (() => {
    const STORAGE_KEY = "municipio.solicitudes.v1";
    let requests = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

    // ---- Helpers ----
    const iconByCategory = (cat) =>
      ({
        Alimentación: "fas fa-utensils",
        Salud: "fas fa-heartbeat",
        Economía: "fas fa-hand-holding-usd",
        Vivienda: "fas fa-home",
        Educación: "fas fa-graduation-cap",
        "Limpieza/Servicios": "fas fa-broom",
        "Cultura/Deporte": "fas fa-running",
        Otros: "fas fa-hands-helping",
      }[cat] || "fas fa-hands-helping");

    const getPublicPrograms = () => {
      try {
        // Prefer official getter from the admin module
        if (
          window.Programas &&
          typeof window.Programas.getPublic === "function"
        ) {
          return window.Programas.getPublic(); // [{id,name,desc,requisitos,dependencia,category}]
        }
        // Fallback: read LS and filter active=true
        const raw = JSON.parse(
          localStorage.getItem("municipio.programas.v1") || "[]"
        );
        return raw
          .filter((p) => p && p.active)
          .map((p) => ({
            id: p.id,
            name: p.name,
            desc: p.desc,
            requisitos: p.requisitos,
            dependencia: p.dependencia,
            category: p.category,
          }));
      } catch {
        return [];
      }
    };

    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(requests));
    }
    function generateId() {
      const y = new Date().getFullYear();
      // ensure unique even if tab refreshes
      const seq = (Date.now() % 1e7).toString(36);
      return `REQ-${y}-${seq.toUpperCase()}`;
    }

    // ---- Rendering ----
    function renderPrograms() {
      const list = getPublicPrograms();
      const grid = document.getElementById("programs-grid");
      const empty = document.getElementById("programs-empty");

      grid.innerHTML = "";
      document.getElementById("program").innerHTML =
        '<option value="">Selecciona un programa</option>';

      if (!list.length) {
        empty.classList.remove("hidden");
        return;
      }
      empty.classList.add("hidden");

      // Cards
      list.forEach((p) => {
        const card = document.createElement("div");
        card.className =
          "bg-white rounded-2xl shadow-md hover:shadow-xl transition p-6 flex flex-col";
        const icon = iconByCategory(p.category);
        card.innerHTML = `
        <div class="flex items-center mb-4">
          <div class="bg-blue-100 text-blue-600 rounded-full p-4 mr-4"><i class="${icon} text-2xl"></i></div>
          <div>
            <h3 class="text-lg font-bold text-gray-800">${
              p.name || "Programa"
            }</h3>
            <p class="text-sm text-gray-600">${p.desc || ""}</p>
            <div class="text-xs text-gray-500 mt-1">${
              p.dependencia ? "Dependencia: " + p.dependencia : ""
            }</div>
          </div>
        </div>
        ${
          Array.isArray(p.requisitos) && p.requisitos.length
            ? `<div class="text-xs text-gray-600 mb-4">
                 <div class="font-semibold text-gray-700 mb-1">Requisitos:</div>
                 <ul class="list-disc pl-5 space-y-0.5">
                   ${p.requisitos.map((r) => `<li>${r}</li>`).join("")}
                 </ul>
               </div>`
            : ""
        }
        <button data-program="${String(p.name || "")}"
          class="mt-auto bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
          Solicitar
        </button>
      `;
        grid.appendChild(card);
      });

      // Dropdown (form)
      const options = list
        .map((p) => `<option value="${p.name}">${p.name}</option>`)
        .join("");
      document
        .getElementById("program")
        .insertAdjacentHTML("beforeend", options);

      // Bind “Solicitar” buttons
      grid.querySelectorAll("button[data-program]").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.getElementById("program").value = btn.dataset.program || "";
          openForm();
        });
      });
    }

    // Re-render if admin updates programs in another tab
    window.addEventListener("storage", (e) => {
      if (e.key === "municipio.programas.v1") renderPrograms();
    });

    // ---- Form submission ----
    document.getElementById("support-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());
      const request = {
        id: generateId(),
        ...data,
        status: "pending",
        submissionDate: new Date().toISOString().split("T")[0],
      };
      requests.unshift(request);
      save();

      document.getElementById("request-id").textContent = request.id;
      closeForm();
      document.getElementById("success-modal").classList.remove("hidden");
      e.target.reset();
    });

    // ---- Modal controls ----
    window.openForm = () =>
      document.getElementById("form-modal").classList.remove("hidden");
    window.closeForm = () =>
      document.getElementById("form-modal").classList.add("hidden");
    window.closeSuccessModal = () =>
      document.getElementById("success-modal").classList.add("hidden");

    // ---- Expose for admin dashboards if needed ----
    window.Servicios = {
      getSolicitudes: () =>
        JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"),
    };

    // Init
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", renderPrograms);
    } else {
      renderPrograms();
    }
  })();
</script>
