<!-- TuCiudad_Negocios.html (Public module) -->
<section id="TuCiudadNegocios" class="font-sans">

  <!-- Hero Section -->
  <header 
    class="relative text-white"
    style="background-image: url('https://scontent.fntr8-1.fna.fbcdn.net/v/t39.30808-6/518139577_1061598692815020_4654446006479060152_n.jpg?stp=cp6_dst-jpg_tt6&_nc_cat=104&ccb=1-7&_nc_sid=f727a1&_nc_eui2=AeEi7S5EjeuLq7F89axJdaex8goNa6t9JtbyCg1rq30m1md9T4rmjjt-IkzVNlNE6xGWtrE4WvYgEEXImg3K-88d&_nc_ohc=fTa-4WDpEp0Q7kNvwEJ3w5N&_nc_oc=AdkF0j13OrDtBsARBondAWtbUtMbqbAIMXDHLacsObarXZ8EyvFHdM5s67OmdD7Q3gxHw2BmozNQp6pYOiEP8ZI3&_nc_zt=23&_nc_ht=scontent.fntr8-1.fna&_nc_gid=ens-ktojqmDXnjTbtydNWQ&oh=00_Afamq4Q8xBgemjfXTcRnlqsaDjWh67u239MPJ-qKwY5yzA&oe=68C6BDE3'); background-size: cover; background-position: center;"
  >
    <!-- Overlay -->
    <div class="absolute inset-0 bg-black/60"></div>

    <!-- Content -->
    <div class="relative container mx-auto px-6 py-20 text-center max-w-3xl">
      <i class="fas fa-store text-6xl mb-4 opacity-90"></i>
      <h1 class="text-4xl md:text-5xl font-bold mb-6 leading-tight">
        Directorio de Negocios Locales
      </h1>
      <p class="text-xl md:text-2xl mb-6 text-blue-100 leading-relaxed">
        Descubre y apoya a los emprendedores de Sabinas Hidalgo
      </p>
      <p class="text-lg mb-8 text-blue-50">
        Encuentra restaurantes, servicios, comercios y m√°s. Filtra por nombre, giro, servicios y tipo de comida.
      </p>
    </div>
  </header>

  <!-- Hero (search & filters) -->
  <section class="relative overflow-hidden">
    <div class="mx-auto px-4 md:py-14">
      <div class="grid md:grid-cols-2 gap-8 items-center">
        <div>
          <h2 class="text-2xl md:text-3xl font-extrabold text-slate-900">
            Encuentra lo que buscas f√°cilmente
          </h2>
          <p class="mt-3 text-gov-gray">
            Filtra por categor√≠a, giro, servicios generales o escribe lo que necesitas en el buscador.
          </p>
        </div>
        <div class="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-2xl p-5 md:p-6 shadow">
          <!-- Search & Filters -->
          <div class="flex flex-col md:flex-row gap-3">
            <div class="relative flex-1">
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
              <input id="biz-q" type="text" placeholder="Buscar: nombre, giro, 'tacos', 'tarjetas'‚Ä¶"
                     class="w-full pl-10 pr-3 py-3 rounded-xl border focus:ring-2 focus:ring-municipal-blue" />
            </div>
            <select id="biz-cat" class="px-3 py-3 rounded-xl border focus:ring-2 focus:ring-municipal-blue">
              <option value="">Todas las categor√≠as</option>
            </select>
            <select id="biz-giro" class="px-3 py-3 rounded-xl border focus:ring-2 focus:ring-municipal-blue">
              <option value="">Todos los giros</option>
            </select>
          </div>
          <div class="mt-3 flex flex-wrap gap-2" id="biz-service-chips"></div>
          <div class="mt-2 text-xs text-gov-gray" id="biz-match-hint"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Results -->
  <main class="max-w-7xl mx-auto px-4 pb-20">
    <div id="biz-stats" class="text-sm text-gov-gray mb-3"></div>
    <div id="biz-grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <div id="biz-empty" class="hidden text-center py-16">
      <div class="text-6xl mb-3">üîé</div>
      <p class="text-lg font-semibold">No encontramos coincidencias.</p>
      <p class="text-gov-gray">Ajusta los filtros o intenta otra b√∫squeda.</p>
    </div>
  </main>

  <!-- Business Modal -->
  <!-- (keep the same modal code you already have) -->

</section>


<script>
(() => {
  // Lee de varias llaves posibles del admin/p√∫blico
  const STORAGE_KEYS = [
    "admin.negocios.v1",
    "negocios.registrados.v1",
    "negocios.registrados",
    "negocios.v1",
    "negocios",
    "TuCiudad.negocios"
  ];

  const CATALOG = {
    domicilio:{label:"Servicio a domicilio",icon:"fa-solid fa-truck"},
    tarjetas:{label:"Acepta tarjetas",icon:"fa-solid fa-credit-card"},
    whatsapp:{label:"WhatsApp",icon:"fa-brands fa-whatsapp"},
    wifi:{label:"WiFi",icon:"fa-solid fa-wifi"},
    aire:{label:"Aire",icon:"fa-regular fa-snowflake"}
  };

  const els = id => document.getElementById(id);

  // Fusiona arrays de varias llaves y deduplica (por id o nombre+direcci√≥n)
  function loadAll() {
    const seen = new Set();
    const rows = [];

    for (const key of STORAGE_KEYS) {
      try {
        const arr = JSON.parse(localStorage.getItem(key) || "[]");
        if (!Array.isArray(arr)) continue;

        for (const n of arr) {
          const id = n.id || `${(n.nombre||"").trim()}|${(n.direccion||"").trim()}`;
          if (seen.has(id)) continue;
          seen.add(id);

          const servicios = Array.isArray(n.servicios) ? n.servicios : [];
          const tiposComida = Array.isArray(n.tiposComida) ? n.tiposComida : [];
          const menu = Array.isArray(n.menu) ? n.menu : [];

          const blob = [
            n.nombre, n.propietario, n.direccion, n.giroNombre,
            servicios.map(k => CATALOG[k]?.label || k).join(" "),
            tiposComida.join(" "),
            menu.map(m => m?.nombre).join(" ")
          ].filter(Boolean).join(" ").toLowerCase();

          rows.push({
            ...n,
            servicios, tiposComida, menu,
            categoriaNombre: n.categoriaNombre || n.categoria || "",
            giroNombre: n.giroNombre || n.giro || "",
            _blob: blob
          });
        }
      } catch { /* ignore */ }
    }
    return rows;
  }

  let DATA = loadAll();

  // Estado de filtros
  let FILTER = { q: "", cat: "", giro: "" };

  function renderFilters() {
    const cats = [...new Set(DATA.map(d => d.categoriaNombre).filter(Boolean))].sort();
    els("biz-cat").innerHTML =
      '<option value="">Todas las categor√≠as</option>' +
      cats.map(c => `<option value="${c}">${c}</option>`).join("");

    const giros = [...new Set(DATA.map(d => d.giroNombre).filter(Boolean))].sort();
    els("biz-giro").innerHTML =
      '<option value="">Todos los giros</option>' +
      giros.map(g => `<option value="${g}">${g}</option>`).join("");
  }

  function apply() {
    const terms = FILTER.q.trim().toLowerCase().split(/\s+/).filter(Boolean);
    let rows = DATA.filter(d => {
      const qok = !terms.length || terms.every(t => d._blob.includes(t));
      const cok = !FILTER.cat || d.categoriaNombre === FILTER.cat;
      const gok = !FILTER.giro || d.giroNombre === FILTER.giro;
      return qok && cok && gok;
    });
    render(rows);
  }

  function render(rows) {
    const stats = els("biz-stats");
    const grid = els("biz-grid");
    const empty = els("biz-empty");

    stats.textContent = `${rows.length} de ${DATA.length} negocios`;
    grid.innerHTML = "";

    if (!rows.length) {
      empty.classList.remove("hidden");
      return;
    }
    empty.classList.add("hidden");

    rows.forEach(b => {
      const card = document.createElement("article");
      card.className = "bg-white rounded-xl border p-5 shadow hover:shadow-md cursor-pointer animate-fade-in";
      card.innerHTML = `
        <h3 class="font-bold">${b.nombre || ""}</h3>
        <p class="text-sm text-slate-600">${b.giroNombre || ""}</p>
        <p class="text-xs text-slate-500">${b.direccion || ""}</p>
      `;
      card.addEventListener("click", () => open(b));
      grid.appendChild(card);
    });
  }

  // Abre modal (si existe en la p√°gina)
  function open(b) {
    const get = id => document.getElementById(id);
    if (!get("biz-modal")) return; // evita error si a√∫n no insertas el modal

    get("m-cat-pill").textContent = b.categoriaNombre || "";
    get("m-giro-pill").textContent = b.giroNombre || "";
    get("m-title").textContent = b.nombre || "";
    get("m-desc").textContent = b.descripcion || "";
    get("m-owner").textContent = b.propietario || "";
    get("m-phone").textContent = b.telefono || "";
    get("m-email").textContent = b.email || "";
    get("m-address").textContent = b.direccion || "";
    get("m-hours").textContent = b.horario || "";
    get("m-services").innerHTML = (b.servicios || [])
      .map(k => `<span class="text-xs border px-2 py-1 rounded">${CATALOG[k]?.label || k}</span>`).join("");

    if (b.giro === "restaurante" && (b.tiposComida || []).length) {
      get("m-food").classList.remove("hidden");
      get("m-food-tags").innerHTML = b.tiposComida.map(t => `<span class="text-xs border px-2 py-1 rounded">${t}</span>`).join("");
    } else get("m-food").classList.add("hidden");

    if (b.giro === "restaurante" && (b.menu || []).length) {
      get("m-menu-box").classList.remove("hidden");
      get("m-menu").innerHTML = b.menu.map(m =>
        `<div class="flex justify-between border p-2 rounded"><span>${m.nombre}</span><span>$${m.precio}</span></div>`
      ).join("");
    } else get("m-menu-box").classList.add("hidden");

    get("biz-modal").classList.remove("hidden");
  }

  // Eventos de UI
  els("biz-q").addEventListener("input", (e) => { FILTER.q = e.target.value; apply(); });
  els("biz-cat").addEventListener("change", (e) => { FILTER.cat = e.target.value; apply(); });
  els("biz-giro").addEventListener("change", (e) => { FILTER.giro = e.target.value; apply(); });

  const closeBtn = document.getElementById("biz-modal-close");
  if (closeBtn) closeBtn.addEventListener("click", () => els("biz-modal").classList.add("hidden"));

  // Escucha cambios desde el Admin (si guardan en cualquier llave)
  window.addEventListener("storage", (e) => {
    if (STORAGE_KEYS.includes(e.key)) {
      DATA = loadAll();
      renderFilters();
      apply();
    }
  });

  // Init: siempre muestra todo al cargar
  renderFilters();
  apply();

  // Mensaje amistoso si no hay datos en ninguna llave
  if (!DATA.length) {
    els("biz-stats").textContent = "0 negocios (a√∫n no hay registros)";
    els("biz-empty").classList.remove("hidden");
  }
})();
</script>

