<section id="EmergencyContactsAdmin" data-bound="0">
  <!-- Top Controls -->
  <div class="mb-8">
    <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-800 mb-2">
          Contactos de Emergencia
        </h1>
        <p class="text-gray-600">
          Gestión de números telefónicos y servicios de emergencia municipal
        </p>
      </div>
      <div class="flex flex-wrap gap-3 mt-4 lg:mt-0">
        <button
          id="contacts-add-btn"
          class="bg-gradient-to-r from-red-600 to-red-700 text-white px-4 py-2 rounded-lg hover:from-red-700 hover:to-red-800 transition-all duration-200 flex items-center shadow-sm"
        >
          <i class="fas fa-plus mr-2"></i>
          Agregar Contacto
        </button>
      </div>
    </div>
  </div>

  <!-- Search and Filters -->
  <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
    <div class="flex flex-col lg:flex-row gap-4 mb-4">
      <div class="flex-1">
        <label for="contacts-search" class="sr-only">Buscar contactos</label>
        <div class="relative">
          <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          <input
            type="text"
            id="contacts-search"
            placeholder="Buscar contactos... (presiona / para enfocar)"
            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
          />
        </div>
      </div>
      <div class="flex flex-wrap gap-2">
        <select
          id="contacts-filter-categoria"
          class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
        >
          <option value="">Todas las categorías</option>
          <option value="Emergencias Médicas">Emergencias Médicas</option>
          <option value="Seguridad Pública">Seguridad Pública</option>
          <option value="Bomberos">Bomberos</option>
          <option value="Protección Civil">Protección Civil</option>
          <option value="Servicios Públicos">Servicios Públicos</option>
          <option value="Gobierno Municipal">Gobierno Municipal</option>
          <option value="Otros Servicios">Otros Servicios</option>
        </select>
        <select
          id="contacts-filter-disponibilidad"
          class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
        >
          <option value="">Toda disponibilidad</option>
          <option value="24/7">24 horas</option>
          <option value="Horario Laboral">Horario laboral</option>
          <option value="Emergencias">Solo emergencias</option>
        </select>
        <select
          id="contacts-filter-activo"
          class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
        >
          <option value="">Todos los estados</option>
          <option value="true">Activos</option>
          <option value="false">Inactivos</option>
        </select>
      </div>
    </div>
    <div id="contacts-filter-chips" class="flex flex-wrap gap-2"></div>
  </div>

  <!-- Contacts Table -->
  <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-8">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
          <tr>
            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Servicio</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teléfono(s)</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Disponibilidad</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prioridad</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Activo</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Inicio</th>
            <th class="px-6 py-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
          </tr>
        </thead>
        <tbody id="contacts-table-body" class="bg-white divide-y divide-gray-200"></tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div id="contacts-empty-state" class="text-center py-12 hidden">
      <div class="bg-gray-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-phone text-gray-400 text-2xl"></i>
      </div>
      <h3 class="text-lg font-medium text-gray-800 mb-2">No hay contactos registrados</h3>
      <p class="text-gray-600 mb-4">Comienza agregando los primeros contactos de emergencia.</p>
      <button id="contacts-empty-add-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors duration-200">
        <i class="fas fa-plus mr-2"></i>
        Agregar Contacto
      </button>
    </div>
  </div>

  <!-- Form Modal -->
  <div
    id="contacts-modal"
    class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4"
  >
    <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-gray-200">
        <div class="flex justify-between items-center">
          <h3 id="contacts-modal-title" class="text-2xl font-bold text-gray-800">Nuevo Contacto</h3>
          <button id="contacts-modal-close" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>

      <form id="contacts-form" class="p-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="lg:col-span-2">
            <label for="contacts-form-nombre" class="block text-sm font-medium text-gray-700 mb-2">Nombre del Servicio *</label>
            <input type="text" id="contacts-form-nombre" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"/>
          </div>

          <div>
            <label for="contacts-form-categoria" class="block text-sm font-medium text-gray-700 mb-2">Categoría *</label>
            <select id="contacts-form-categoria" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
              <option value="">Seleccionar categoría</option>
              <option value="Emergencias Médicas">Emergencias Médicas</option>
              <option value="Seguridad Pública">Seguridad Pública</option>
              <option value="Bomberos">Bomberos</option>
              <option value="Protección Civil">Protección Civil</option>
              <option value="Servicios Públicos">Servicios Públicos</option>
              <option value="Gobierno Municipal">Gobierno Municipal</option>
              <option value="Otros Servicios">Otros Servicios</option>
            </select>
          </div>

          <div>
            <label for="contacts-form-telefono" class="block text-sm font-medium text-gray-700 mb-2">Número Telefónico *</label>
            <input type="tel" id="contacts-form-telefono" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"/>
          </div>

          <div>
            <label for="contacts-form-telefono-alt" class="block text-sm font-medium text-gray-700 mb-2">Teléfono Alternativo</label>
            <input type="tel" id="contacts-form-telefono-alt" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"/>
          </div>

          <div>
            <label for="contacts-form-disponibilidad" class="block text-sm font-medium text-gray-700 mb-2">Disponibilidad *</label>
            <select id="contacts-form-disponibilidad" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
              <option value="24/7">24 horas / 7 días</option>
              <option value="Horario Laboral">Horario laboral</option>
              <option value="Emergencias">Solo emergencias</option>
            </select>
          </div>

          <div>
            <label for="contacts-form-prioridad" class="block text-sm font-medium text-gray-700 mb-2">Prioridad *</label>
            <select id="contacts-form-prioridad" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
              <option value="1">Alta (Emergencias críticas)</option>
              <option value="2">Media (Servicios importantes)</option>
              <option value="3">Baja (Información general)</option>
            </select>
          </div>

          <div class="lg:col-span-2">
            <label for="contacts-form-descripcion" class="block text-sm font-medium text-gray-700 mb-2">Descripción</label>
            <textarea id="contacts-form-descripcion" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Descripción del servicio y cuándo contactar"></textarea>
          </div>

          <div>
            <label for="contacts-form-direccion" class="block text-sm font-medium text-gray-700 mb-2">Dirección</label>
            <input type="text" id="contacts-form-direccion" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"/>
          </div>

          <div>
            <label for="contacts-form-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
            <input type="email" id="contacts-form-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"/>
          </div>

          <div class="lg:col-span-2">
            <label class="flex items-center">
              <input type="checkbox" id="contacts-form-activo" checked class="rounded border-gray-300 text-red-600 shadow-sm focus:border-red-300 focus:ring focus:ring-red-200 focus:ring-opacity-50"/>
              <span class="ml-2 text-sm text-gray-700">Contacto activo (visible en página pública)</span>
            </label>
          </div>

          <div class="lg:col-span-2">
            <label class="flex items-center">
              <input type="checkbox" id="contacts-form-show-home" class="rounded border-gray-300 text-red-600 shadow-sm focus:border-red-300 focus:ring focus:ring-red-200 focus:ring-opacity-50"/>
              <span class="ml-2 text-sm text-gray-700">Mostrar en página de inicio</span>
            </label>
          </div>
        </div>

        <div class="flex justify-end space-x-4">
          <button type="button" id="contacts-form-cancel" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200">Cancelar</button>
          <button type="button" id="contacts-form-delete" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200 hidden">
            <i class="fas fa-trash mr-2"></i>Eliminar
          </button>
          <button type="submit" id="contacts-form-submit" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200">
            <i class="fas fa-save mr-2"></i>Guardar
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

<script>
(function () {
  "use strict";

  const STORAGE_KEY = "municipio.contactos.emergencia.v1";
  let contactos = [];
  let filteredContactos = [];
  let currentEditId = null;

  // -------- Init ----------
  function init() {
    const root = document.getElementById("EmergencyContactsAdmin");
    if (!root) return;
    if (root.dataset.bound === "1") return;
    root.dataset.bound = "1";

    loadContactos();
    setupEventListeners();
    setupKeyboardShortcuts();

    filteredContactos = [...contactos];
    renderContactos();
  }
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }

  // -------- Storage ----------
  function saveContactos() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(contactos));
  }
  function loadContactos() {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      contactos = JSON.parse(stored);
      return;
    }
    // Seed data
    contactos = [
      { id:"1", nombre:"Cruz Roja Mexicana", categoria:"Emergencias Médicas", telefono:"911", telefonoAlt:"065", disponibilidad:"24/7", prioridad:1, descripcion:"Atención médica de emergencia", direccion:"Av. Principal #123", email:"emergencias@cruzroja.org.mx", activo:true, showInHome:true },
      { id:"2", nombre:"Policía Municipal", categoria:"Seguridad Pública", telefono:"911", telefonoAlt:"(555) 123-4567", disponibilidad:"24/7", prioridad:1, descripcion:"Seguridad pública", direccion:"Comandancia Municipal", email:"policia@municipio.gob.mx", activo:true, showInHome:true },
      { id:"3", nombre:"Bomberos", categoria:"Bomberos", telefono:"911", telefonoAlt:"(555) 234-5678", disponibilidad:"24/7", prioridad:1, descripcion:"Incendios y rescates", direccion:"Estación Central", email:"bomberos@municipio.gob.mx", activo:true, showInHome:false }
    ];
    saveContactos();
  }

  // -------- Events ----------
  function setupEventListeners() {
    document.getElementById("contacts-add-btn").addEventListener("click", () => openModal());
    const emptyAdd = document.getElementById("contacts-empty-add-btn");
    if (emptyAdd) emptyAdd.addEventListener("click", () => openModal());

    // Filters
    document.getElementById("contacts-search").addEventListener("input", filterContactos);
    document.getElementById("contacts-filter-categoria").addEventListener("change", filterContactos);
    document.getElementById("contacts-filter-disponibilidad").addEventListener("change", filterContactos);
    document.getElementById("contacts-filter-activo").addEventListener("change", filterContactos);

    // Modal buttons
    document.getElementById("contacts-modal-close").addEventListener("click", closeModal);
    document.getElementById("contacts-form-cancel").addEventListener("click", closeModal);
    document.getElementById("contacts-form").addEventListener("submit", saveContacto);
    document.getElementById("contacts-form-delete").addEventListener("click", deleteContacto);

    // Close on backdrop
    document.getElementById("contacts-modal").addEventListener("click", (e) => {
      if (e.target.id === "contacts-modal") closeModal();
    });
  }

  function setupKeyboardShortcuts() {
    document.addEventListener("keydown", (e) => {
      if (["INPUT","TEXTAREA","SELECT"].includes(e.target.tagName)) {
        if (e.key === "Escape") e.target.blur();
        return;
      }
      if (e.key === "/") { e.preventDefault(); document.getElementById("contacts-search").focus(); }
      if (e.key === "n" && !e.ctrlKey && !e.metaKey) { e.preventDefault(); openModal(); }
      if (e.key === "Escape") closeModal();
    });
    document.getElementById("contacts-modal").addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "s") {
        e.preventDefault();
        document.getElementById("contacts-form").dispatchEvent(new Event("submit"));
      }
    });
  }

  // -------- Filters ----------
  function filterContactos() {
    const search = document.getElementById("contacts-search").value.toLowerCase();
    const categoria = document.getElementById("contacts-filter-categoria").value;
    const disponibilidad = document.getElementById("contacts-filter-disponibilidad").value;
    const activo = document.getElementById("contacts-filter-activo").value;

    filteredContactos = contactos.filter((c) => {
      if (search && !(
        (c.nombre && c.nombre.toLowerCase().includes(search)) ||
        (c.descripcion && c.descripcion.toLowerCase().includes(search)) ||
        (c.telefono && String(c.telefono).includes(search))
      )) return false;
      if (categoria && c.categoria !== categoria) return false;
      if (disponibilidad && c.disponibilidad !== disponibilidad) return false;
      if (activo !== "" && String(c.activo) !== activo) return false;
      return true;
    });

    renderContactos();
    updateFilterChips();
  }

  function updateFilterChips() {
    const container = document.getElementById("contacts-filter-chips");
    const chips = [];
    const s = document.getElementById("contacts-search").value;
    const cat = document.getElementById("contacts-filter-categoria").value;
    const disp = document.getElementById("contacts-filter-disponibilidad").value;
    const act = document.getElementById("contacts-filter-activo").value;
    if (s) chips.push({t:"search", label:`Búsqueda: ${s}`});
    if (cat) chips.push({t:"categoria", label:`Categoría: ${cat}`});
    if (disp) chips.push({t:"disponibilidad", label:`Disponibilidad: ${disp}`});
    if (act !== "") chips.push({t:"activo", label:`Estado: ${act==="true"?"Activos":"Inactivos"}`});
    container.innerHTML = chips.map(c => `
      <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-red-100 text-red-800">
        ${c.label}
        <button onclick="removeFilter('${c.t}')" class="ml-2 text-red-600 hover:text-red-800"><i class="fas fa-times text-xs"></i></button>
      </span>
    `).join("");
  }
  window.removeFilter = function (type) {
    if (type==="search") document.getElementById("contacts-search").value = "";
    if (type==="categoria") document.getElementById("contacts-filter-categoria").value = "";
    if (type==="disponibilidad") document.getElementById("contacts-filter-disponibilidad").value = "";
    if (type==="activo") document.getElementById("contacts-filter-activo").value = "";
    filterContactos();
  };

  // -------- Render TABLE ----------
  function renderContactos() {
    const tbody = document.getElementById("contacts-table-body");
    const emptyState = document.getElementById("contacts-empty-state");

    if (!filteredContactos.length) {
      tbody.innerHTML = "";
      emptyState.classList.remove("hidden");
      return;
    }
    emptyState.classList.add("hidden");

    const sorted = [...filteredContactos].sort((a,b) => (a.prioridad-b.prioridad) || a.nombre.localeCompare(b.nombre));

    tbody.innerHTML = sorted.map((c) => {
      const prioridadBadge =
        c.prioridad===1 ? "bg-red-100 text-red-800"
        : c.prioridad===2 ? "bg-yellow-100 text-yellow-800"
        : "bg-green-100 text-green-800";
      const activoBadge = c.activo ? "bg-green-100 text-green-800" : "bg-gray-100 text-gray-700";
      const homeBadge = c.showInHome ? "bg-amber-100 text-amber-800" : "bg-gray-100 text-gray-600";
      return `
        <tr class="hover:bg-gray-50 cursor-pointer" data-row-id="${c.id}">
          <td class="px-6 py-4 text-sm text-gray-800">${c.nombre}</td>
          <td class="px-6 py-4 text-sm"><span class="px-2 py-0.5 rounded-full ${getCategoriaColor(c.categoria)}">${c.categoria}</span></td>
          <td class="px-6 py-4 text-sm text-gray-700">
            <div class="font-medium">${c.telefono}</div>
            ${c.telefonoAlt ? `<div class="text-xs text-gray-500">Alt: ${c.telefonoAlt}</div>` : ""}
          </td>
          <td class="px-6 py-4 text-sm text-gray-700">${c.disponibilidad}</td>
          <td class="px-6 py-4 text-sm"><span class="px-2 py-0.5 rounded-full ${prioridadBadge}">${getPrioridadLabel(c.prioridad)}</span></td>
          <td class="px-6 py-4 text-sm"><span class="px-2 py-0.5 rounded-full ${activoBadge}">${c.activo ? "Sí" : "No"}</span></td>
          <td class="px-6 py-4 text-sm"><span class="px-2 py-0.5 rounded-full ${homeBadge}">${c.showInHome ? "Sí" : "No"}</span></td>
          <td class="px-6 py-4 text-right">
            <button class="text-blue-600 hover:text-blue-800 mr-3" data-action="edit" title="Editar"><i class="fas fa-edit"></i></button>
            <button class="${c.activo ? "text-orange-600 hover:text-orange-800" : "text-green-600 hover:text-green-800"} mr-3" data-action="toggle" title="${c.activo ? "Desactivar" : "Activar"}"><i class="fas fa-${c.activo ? "eye-slash" : "eye"}"></i></button>
            <button class="text-red-600 hover:text-red-800" data-action="delete" title="Eliminar"><i class="fas fa-trash"></i></button>
          </td>
        </tr>
      `;
    }).join("");

    // Row click -> edit; but keep action buttons working
    tbody.querySelectorAll("tr").forEach((tr) => {
      const id = tr.getAttribute("data-row-id");
      tr.addEventListener("click", () => openModal(id));
      tr.querySelectorAll("button").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const action = btn.getAttribute("data-action");
          if (action === "edit") openModal(id);
          if (action === "toggle") toggleContactoStatus(id);
          if (action === "delete") deleteContactoFromTable(id);
        });
      });
    });
  }

  // -------- Utils (colors/labels) ----------
  function getCategoriaColor(categoria) {
    const colors = {
      "Emergencias Médicas": "bg-red-100 text-red-800",
      "Seguridad Pública": "bg-blue-100 text-blue-800",
      "Bomberos": "bg-orange-100 text-orange-800",
      "Protección Civil": "bg-yellow-100 text-yellow-800",
      "Servicios Públicos": "bg-green-100 text-green-800",
      "Gobierno Municipal": "bg-purple-100 text-purple-800",
      "Otros Servicios": "bg-gray-100 text-gray-800",
    };
    return colors[categoria] || "bg-gray-100 text-gray-800";
  }
  function getPrioridadLabel(p) { return ({1:"Alta",2:"Media",3:"Baja"})[p] || "Normal"; }
  function generateId(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }

  // -------- Modal / CRUD ----------
  function openModal(contactoId = null) {
    currentEditId = contactoId;
    const title = document.getElementById("contacts-modal-title");
    const del = document.getElementById("contacts-form-delete");

    if (contactoId) {
      title.textContent = "Editar Contacto";
      del.classList.remove("hidden");
      loadContactoToForm(contactoId);
    } else {
      title.textContent = "Nuevo Contacto";
      del.classList.add("hidden");
      resetForm();
    }
    document.getElementById("contacts-modal").classList.remove("hidden");
    document.getElementById("contacts-form-nombre").focus();
  }
  function closeModal() {
    document.getElementById("contacts-modal").classList.add("hidden");
    currentEditId = null;
    resetForm();
  }
  function resetForm() {
    document.getElementById("contacts-form").reset();
    document.getElementById("contacts-form-activo").checked = true;
    document.getElementById("contacts-form-show-home").checked = false;
  }
  function loadContactoToForm(id) {
    const c = contactos.find(x => x.id === id);
    if (!c) return;
    document.getElementById("contacts-form-nombre").value = c.nombre || "";
    document.getElementById("contacts-form-categoria").value = c.categoria || "";
    document.getElementById("contacts-form-telefono").value = c.telefono || "";
    document.getElementById("contacts-form-telefono-alt").value = c.telefonoAlt || "";
    document.getElementById("contacts-form-disponibilidad").value = c.disponibilidad || "24/7";
    document.getElementById("contacts-form-prioridad").value = c.prioridad || 2;
    document.getElementById("contacts-form-descripcion").value = c.descripcion || "";
    document.getElementById("contacts-form-direccion").value = c.direccion || "";
    document.getElementById("contacts-form-email").value = c.email || "";
    document.getElementById("contacts-form-activo").checked = !!c.activo;
    document.getElementById("contacts-form-show-home").checked = !!c.showInHome;
  }

  function saveContacto(e) {
    e.preventDefault();
    const formData = {
      nombre: document.getElementById("contacts-form-nombre").value,
      categoria: document.getElementById("contacts-form-categoria").value,
      telefono: document.getElementById("contacts-form-telefono").value,
      telefonoAlt: document.getElementById("contacts-form-telefono-alt").value,
      disponibilidad: document.getElementById("contacts-form-disponibilidad").value,
      prioridad: parseInt(document.getElementById("contacts-form-prioridad").value, 10),
      descripcion: document.getElementById("contacts-form-descripcion").value,
      direccion: document.getElementById("contacts-form-direccion").value,
      email: document.getElementById("contacts-form-email").value,
      activo: document.getElementById("contacts-form-activo").checked,
      showInHome: document.getElementById("contacts-form-show-home").checked,
    };

    if (currentEditId) {
      const i = contactos.findIndex(c => c.id === currentEditId);
      if (i > -1) contactos[i] = { ...contactos[i], ...formData };
    } else {
      formData.id = generateId();
      contactos.push(formData);
    }

    saveContactos();
    filterContactos();
    closeModal();
  }

  window.editContacto = (id) => openModal(id); // (kept for compatibility)

  window.toggleContactoStatus = function (id) {
    const c = contactos.find(x => x.id === id);
    if (!c) return;
    c.activo = !c.activo;
    saveContactos();
    filterContactos();
  };

  function deleteContacto() {
    if (!currentEditId) return;
    const c = contactos.find(x => x.id === currentEditId);
    if (!c) return;
    if (confirm(`¿Eliminar "${c.nombre}"?`)) {
      contactos = contactos.filter(x => x.id !== currentEditId);
      saveContactos();
      filterContactos();
      closeModal();
    }
  }

  function deleteContactoFromTable(id) {
    const c = contactos.find(x => x.id === id);
    if (!c) return;
    if (confirm(`¿Eliminar "${c.nombre}"?`)) {
      contactos = contactos.filter(x => x.id !== id);
      saveContactos();
      filterContactos();
    }
  }
  // expose for row actions
  window.deleteContactoFromTable = deleteContactoFromTable;

})();
</script>
