<!-- =========================
     ACCESOS RÁPIDOS (ADMIN)
========================== -->
<section id="QuickLinksAdmin" class="p-6 bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen" data-bound="0">
  <div class="mb-8">
    <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-800 mb-2">Accesos Rápidos</h1>
        <p class="text-gray-600">Configura tarjetas con icono, colores y enlace</p>
      </div>
      <button id="ql-add-btn" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 py-2 rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-200 flex items-center shadow-sm">
        <i class="fas fa-plus mr-2"></i>Agregar Acceso
      </button>
    </div>
  </div>

  <!-- Grid -->
  <div id="ql-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>

  <!-- Empty State -->
  <div id="ql-empty" class="text-center py-12 hidden">
    <div class="bg-gray-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
      <i class="fas fa-th-large text-gray-400 text-2xl"></i>
    </div>
    <h3 class="text-lg font-medium text-gray-800 mb-2">Sin accesos configurados</h3>
    <p class="text-gray-600 mb-4">Crea tu primer acceso rápido.</p>
    <button id="ql-empty-add" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
      <i class="fas fa-plus mr-2"></i>Agregar
    </button>
  </div>

  <!-- Form Modal -->
  <div id="ql-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 p-4">
    <div class="bg-white rounded-2xl max-w-2xl mx-auto max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b flex items-center justify-between">
        <h3 id="ql-modal-title" class="text-2xl font-bold text-gray-800">Nuevo Acceso</h3>
        <button id="ql-close" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
      </div>

      <form id="ql-form" class="p-6 space-y-5">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Título *</label>
            <input id="ql-title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">URL *</label>
            <input id="ql-href" type="url" required placeholder="/tramites o https://..."
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Icono *</label>
            <div class="flex gap-2">
              <input id="ql-icon" required readonly class="flex-1 px-4 py-2 border border-gray-300 rounded-lg bg-gray-50" placeholder="Selecciona un icono">
              <button type="button" id="ql-pick-icon" class="px-3 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900">
                <i class="fas fa-icons mr-1"></i>Elegir
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-1">Clases de Font Awesome (ej. <code>fas fa-calendar-alt</code>).</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Orden</label>
            <input id="ql-order" type="number" min="0" value="0"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Color del icono</label>
            <input id="ql-icon-color" type="color" value="#2563eb" class="w-12 h-10 p-1 border rounded">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Color del título</label>
            <input id="ql-title-color" type="color" value="#0f172a" class="w-12 h-10 p-1 border rounded">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Color de fondo</label>
            <input id="ql-bg-color" type="color" value="#ffffff" class="w-12 h-10 p-1 border rounded">
          </div>

          <div class="md:col-span-2">
            <label class="flex items-center">
              <input id="ql-active" type="checkbox" checked class="rounded border-gray-300 text-blue-600 shadow-sm focus:ring-blue-200">
              <span class="ml-2 text-sm text-gray-700">Acceso activo (visible)</span>
            </label>
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-2">
          <button type="button" id="ql-delete" class="hidden px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
            <i class="fas fa-trash mr-2"></i>Eliminar
          </button>
          <button type="button" id="ql-cancel" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">Cancelar</button>
          <button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            <i class="fas fa-save mr-2"></i>Guardar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Icon Picker Modal -->
  <div id="ql-icon-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 p-4">
    <div class="bg-white rounded-2xl max-w-3xl mx-auto max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold text-gray-800">Elegir icono</h3>
          <button id="ql-icon-close" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-lg"></i></button>
        </div>
        <div class="mt-4">
          <input id="ql-icon-search" placeholder="Buscar (car, file, calendar, map...)" class="w-full px-4 py-2 border rounded-lg">
        </div>
      </div>
      <div id="ql-icon-grid" class="p-6 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-3"></div>
    </div>
  </div>

<script>
(() => {
  'use strict';

  const STORAGE_KEY = 'municipio.quicklinks.v1';
  const gid = () => Date.now().toString(36) + Math.random().toString(36).slice(2,8);

  // Public module API expected by your SPA
  window.QuickLinksAdmin = {
    // SPA will call: QuickLinksAdmin.bind(root, { qs, qsa })   (helpers optional)
    bind(root, helpers = {}) {
      if (!root || root.dataset.bound === '1') return;
      root.dataset.bound = '1';

      // Local, safe selectors scoped to this root
      const qs  = (sel) => root.querySelector(sel);
      const qsa = (sel) => Array.from(root.querySelectorAll(sel));

      // ---------- state ----------
      let items = load();
      let editId = null;

      // ---------- ui bindings ----------
      qs('#ql-add-btn')?.addEventListener('click', () => openForm());
      qs('#ql-empty-add')?.addEventListener('click', () => openForm());

      qs('#ql-close')?.addEventListener('click', closeForm);
      qs('#ql-cancel')?.addEventListener('click', closeForm);
      qs('#ql-form')?.addEventListener('submit', onSubmit);
      qs('#ql-delete')?.addEventListener('click', removeCurrent);

      qs('#ql-pick-icon')?.addEventListener('click', () => iconModal(true));
      qs('#ql-icon-close')?.addEventListener('click', () => iconModal(false));
      qs('#ql-icon-search')?.addEventListener('input', renderIconGrid);

      render();

      // ---------- persistence ----------
      function load(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          const list = raw ? JSON.parse(raw) : [];
          if (!list.length){
            const seeded = [
              { id: gid(), titulo:'Multas de Tránsito', href:'/pagos/multas', iconClass:'fas fa-car',
                iconColor:'#2563eb', titleColor:'#0f172a', bgColor:'#ffffff', order:10, activo:true },
              { id: gid(), titulo:'Trámites Municipales', href:'/tramites', iconClass:'fas fa-file-lines',
                iconColor:'#14b8a6', titleColor:'#0f172a', bgColor:'#ffffff', order:20, activo:true }
            ];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(seeded));
            return seeded;
          }
          return list;
        } catch { return []; }
      }
      function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(items)); }

      // ---------- render ----------
      function render(){
        const grid = qs('#ql-grid');
        const empty = qs('#ql-empty');
        if (!grid) return;

        if (!items.length){
          grid.innerHTML = '';
          empty?.classList.remove('hidden');
          return;
        }
        empty?.classList.add('hidden');

        const sorted = [...items].sort((a,b)=>(a.order??0)-(b.order??0) || a.titulo.localeCompare(b.titulo));
        grid.innerHTML = sorted.map(i => `
          <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6" style="background:${i.bgColor||'#ffffff'}">
              <div class="w-14 h-14 rounded-xl mx-auto flex items-center justify-center mb-3" style="background:rgba(0,0,0,0.04)">
                <i class="${i.iconClass||'fas fa-circle'} text-3xl" style="color:${i.iconColor||'#0f172a'}"></i>
              </div>
              <div class="text-center">
                <div class="text-lg font-bold" style="color:${i.titleColor||'#0f172a'}">${i.titulo||''}</div>
                <div class="text-xs text-slate-500 break-all">${i.href||''}</div>
              </div>
            </div>
            <div class="px-4 py-3 border-t flex items-center justify-between">
              <div class="flex items-center gap-3 text-slate-600">
                <button class="hover:text-blue-700" title="Editar" data-act="edit" data-id="${i.id}"><i class="fas fa-edit"></i></button>
                <button class="hover:text-amber-700" title="${i.activo?'Desactivar':'Activar'}" data-act="toggle" data-id="${i.id}">
                  <i class="fas fa-${i.activo?'eye-slash':'eye'}"></i>
                </button>
                <button class="hover:text-red-700" title="Eliminar" data-act="remove" data-id="${i.id}"><i class="fas fa-trash"></i></button>
              </div>
              <div class="text-xs ${i.activo?'text-green-700':'text-slate-500'}">${i.activo?'Activo':'Oculto'}</div>
            </div>
          </div>
        `).join('');

        // delegate grid clicks
        grid.addEventListener('click', (e)=>{
          const btn = e.target.closest('[data-act]'); if(!btn) return;
          const id = btn.dataset.id, act = btn.dataset.act;
          if (act==='edit') openForm(id);
          if (act==='toggle'){ const it=items.find(x=>x.id===id); if(!it) return; it.activo=!it.activo; save(); render(); }
          if (act==='remove'){ const it=items.find(x=>x.id===id); if(!it) return;
            if(!confirm(`¿Eliminar "${it.titulo}"?`)) return;
            items = items.filter(x=>x.id!==id); save(); render();
          }
        }, { once: true }); // re-bound each render
      }

      // ---------- form ----------
      function openForm(id=null){
        editId = id;
        qs('#ql-modal-title').textContent = id ? 'Editar Acceso' : 'Nuevo Acceso';
        qs('#ql-delete').classList.toggle('hidden', !id);
        resetForm();

        if (id){
          const it = items.find(x=>x.id===id);
          if (it){
            set('#ql-title', it.titulo);
            set('#ql-href', it.href);
            set('#ql-icon', it.iconClass);
            set('#ql-order', it.order ?? 0);
            set('#ql-icon-color', it.iconColor || '#2563eb');
            set('#ql-title-color', it.titleColor || '#0f172a');
            set('#ql-bg-color', it.bgColor || '#ffffff');
            qs('#ql-active').checked = !!it.activo;
          }
        }
        qs('#ql-modal').classList.remove('hidden');
        qs('#ql-title')?.focus();
      }
      function closeForm(){ qs('#ql-modal')?.classList.add('hidden'); editId=null; }
      function resetForm(){
        ['#ql-title','#ql-href','#ql-icon'].forEach(sel => set(sel,''));
        set('#ql-order', 0);
        set('#ql-icon-color','#2563eb'); set('#ql-title-color','#0f172a'); set('#ql-bg-color','#ffffff');
        if (qs('#ql-active')) qs('#ql-active').checked = true;
      }
      function set(sel,val){ const el=qs(sel); if(el) el.value = val; }

      function onSubmit(e){
        e.preventDefault();
        const data = {
          titulo: qs('#ql-title').value.trim(),
          href: qs('#ql-href').value.trim(),
          iconClass: qs('#ql-icon').value.trim(),
          order: parseInt(qs('#ql-order').value||'0',10),
          iconColor: qs('#ql-icon-color').value,
          titleColor: qs('#ql-title-color').value,
          bgColor: qs('#ql-bg-color').value,
          activo: qs('#ql-active').checked
        };
        if (!data.titulo || !data.href || !data.iconClass){
          alert('Completa Título, URL e Icono.'); return;
        }
        if (editId){
          const i = items.findIndex(x=>x.id===editId);
          if (i!==-1) items[i] = { ...items[i], ...data };
        } else {
          items.push({ id: gid(), ...data });
        }
        save(); render(); closeForm();
      }

      function removeCurrent(){
        if (!editId) return; const it = items.find(x=>x.id===editId); if(!it) return;
        if (!confirm(`¿Eliminar el acceso "${it.titulo}"?`)) return;
        items = items.filter(x=>x.id!==editId); save(); render(); closeForm();
      }

      // ---------- icon picker ----------
      const ICONS = [
        'fas fa-car','fas fa-file-lines','fas fa-calendar-alt','fas fa-scale-balanced',
        'fas fa-comments','fas fa-users','fas fa-map','fas fa-phone','fas fa-bullhorn',
        'fas fa-shield-alt','fas fa-ambulance','fas fa-water','fas fa-tree','fas fa-building',
        'fas fa-university','fas fa-credit-card','fas fa-receipt','fas fa-id-card',
        'fas fa-globe','fas fa-lightbulb','fas fa-route','fas fa-ticket-alt'
      ];
      function iconModal(show){
        qs('#ql-icon-modal')?.classList.toggle('hidden', !show);
        if (show){ const s=qs('#ql-icon-search'); if (s){ s.value=''; renderIconGrid(); s.focus(); } }
      }
      function renderIconGrid(){
        const needle = (qs('#ql-icon-search')?.value||'').toLowerCase().trim();
        const list = ICONS.filter(c=> c.toLowerCase().includes(needle));
        const grid = qs('#ql-icon-grid');
        if (!grid) return;
        grid.innerHTML = list.map(c=>`
          <button type="button" data-icon="${c}" class="group border rounded-lg p-3 hover:border-blue-500 hover:bg-blue-50 text-center">
            <i class="${c} text-2xl mb-2 block"></i>
            <div class="text-xs text-slate-700 break-all">${c.replace('fas ','')}</div>
          </button>
        `).join('') || `<div class="text-slate-500 text-sm">Sin resultados.</div>`;
        grid.querySelectorAll('[data-icon]').forEach(btn=>{
          btn.addEventListener('click', ()=>{ const v=btn.getAttribute('data-icon'); const input=qs('#ql-icon'); if (input) input.value=v; iconModal(false); });
        });
      }

      // ---------- public getter for Home ----------
      window.getQuickLinks = function(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          const list = raw ? JSON.parse(raw) : [];
          return list.filter(x=>x.activo).sort((a,b)=>(a.order??0)-(b.order??0)||a.titulo.localeCompare(b.titulo));
        }catch{ return []; }
      };
    }
  };
})();
</script>

</section>
