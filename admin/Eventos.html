<!-- Eventos.html -->
<section class="section-content p-6">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h2 class="text-3xl font-bold text-gray-800 mb-2">Eventos</h2>
      <p class="text-gov-gray">Gestión de eventos municipales y comunitarios</p>
    </div>
    <button onclick="Eventos.openForm()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition flex items-center">
      <i class="fas fa-plus mr-2"></i> Agregar Evento
    </button>
  </div>

  <!-- Filtros -->
  <div class="bg-white p-4 rounded-xl shadow mb-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <select id="filterCategoria" onchange="Eventos.applyFilters()" class="px-4 py-2 border rounded-lg">
        <option value="">Todas las categorías</option>
        <option value="Religioso">Religioso</option>
        <option value="Deportivo">Deportivo</option>
        <option value="Cultural">Cultural</option>
        <option value="Gastronomico">Gastronómico</option>
        <option value="Familiar">Familiar</option>
      </select>
      <select id="filterOrganizador" onchange="Eventos.applyFilters()" class="px-4 py-2 border rounded-lg">
        <option value="">Todos los organizadores</option>
      </select>
      <select id="filterMes" onchange="Eventos.applyFilters()" class="px-4 py-2 border rounded-lg">
        <option value="">Todos los meses</option>
        <option value="01">Enero</option>
        <option value="02">Febrero</option>
        <option value="03">Marzo</option>
        <option value="04">Abril</option>
        <option value="05">Mayo</option>
        <option value="06">Junio</option>
        <option value="07">Julio</option>
        <option value="08">Agosto</option>
        <option value="09">Septiembre</option>
        <option value="10">Octubre</option>
        <option value="11">Noviembre</option>
        <option value="12">Diciembre</option>
      </select>
      <select id="filterEstado" onchange="Eventos.applyFilters()" class="px-4 py-2 border rounded-lg">
        <option value="">Todos</option>
        <option value="Pendiente">Pendiente</option>
        <option value="Finalizado">Finalizado</option>
      </select>
    </div>
    <button onclick="Eventos.clearFilters()" class="mt-2 text-sm text-indigo-600 hover:underline">Limpiar filtros</button>
  </div>

  <!-- Tabla -->
  <div class="bg-white rounded-xl shadow overflow-hidden">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50 text-left">
        <tr>
          <th class="px-4 py-3">Evento</th>
          <th class="px-4 py-3">Fecha y Hora</th>
          <th class="px-4 py-3">Lugar</th>
          <th class="px-4 py-3">Organizador</th>
          <th class="px-4 py-3">Estado</th>
          <th class="px-4 py-3">Acciones</th>
        </tr>
      </thead>
      <tbody id="eventos-body"></tbody>
    </table>
  </div>
</section>

<!-- Modal Formulario -->
<div id="evento-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-xl w-full max-w-2xl shadow-lg overflow-y-auto max-h-[90vh]">
    <div class="flex justify-between items-center px-6 py-4 border-b">
      <h3 id="evento-modal-title" class="text-lg font-bold">Agregar Evento</h3>
      <button onclick="Eventos.closeForm()" class="text-gray-500 hover:text-gray-800"><i class="fas fa-times"></i></button>
    </div>

    <form id="evento-form" class="p-6 space-y-4">
      <div>
        <label class="block text-sm font-medium">Título del Evento *</label>
        <input type="text" id="titulo" required class="w-full px-3 py-2 border rounded-lg">
      </div>
      <div>
        <label class="block text-sm font-medium">Descripción *</label>
        <textarea id="descripcion" rows="3" required class="w-full px-3 py-2 border rounded-lg"></textarea>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium">Fecha de Inicio *</label>
          <input type="date" id="fechaInicio" required class="w-full px-3 py-2 border rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium">Fecha de Fin</label>
          <input type="date" id="fechaFin" class="w-full px-3 py-2 border rounded-lg">
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium">Hora *</label>
        <input type="text" id="hora" required placeholder="Ej. 18:00 hrs, Todo el día" class="w-full px-3 py-2 border rounded-lg">
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium">Lugar *</label>
          <input type="text" id="lugar" required class="w-full px-3 py-2 border rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium">Colonia</label>
          <input type="text" id="colonia" class="w-full px-3 py-2 border rounded-lg">
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium">Organizador *</label>
        <input type="text" id="organizador" required class="w-full px-3 py-2 border rounded-lg">
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium">Contacto</label>
          <input type="text" id="contacto" class="w-full px-3 py-2 border rounded-lg">
        </div>
        <div>
          <label class="block text-sm font-medium">Precio *</label>
          <input type="text" id="precio" required class="w-full px-3 py-2 border rounded-lg">
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium">Categoría *</label>
        <select id="categoria" required class="w-full px-3 py-2 border rounded-lg">
          <option value="">Seleccionar categoría</option>
          <option value="Religioso">Religioso</option>
          <option value="Deportivo">Deportivo</option>
          <option value="Cultural">Cultural</option>
          <option value="Gastronomico">Gastronómico</option>
          <option value="Familiar">Familiar</option>
        </select>
      </div>
      <div class="flex items-center gap-2">
        <input type="checkbox" id="destacado">
        <label for="destacado">Marcar como evento destacado</label>
      </div>
      <div>
        <label class="block text-sm font-medium">Fotos del Evento</label>
        <input type="file" id="fotos" multiple accept="image/*" class="w-full px-3 py-2 border rounded-lg">
        <div id="foto-preview" class="grid grid-cols-3 gap-2 mt-2"></div>
      </div>
      <div class="flex justify-end gap-3 pt-4">
        <button type="button" onclick="Eventos.closeForm()" class="px-4 py-2 border rounded-lg">Cancelar</button>
        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Detalle + Carrusel -->
<div id="evento-detalle-modal" class="fixed inset-0 bg-black/60 hidden z-50 p-4">
  <div class="bg-white rounded-xl max-w-4xl mx-auto h-full overflow-y-auto">
    <div class="flex justify-between items-center px-6 py-4 border-b sticky top-0 bg-white">
      <h3 class="text-lg font-bold" id="detalle-title">Detalle del Evento</h3>
      <button onclick="Eventos.closeDetalle()" class="text-gray-500 hover:text-gray-800"><i class="fas fa-times"></i></button>
    </div>

    <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Carrusel -->
      <div class="lg:col-span-2">
        <div class="relative rounded-xl overflow-hidden bg-gray-100 aspect-video select-none" id="carousel-wrapper">
          <img id="carousel-image" class="w-full h-full object-cover" alt="Imagen del evento">
          <!-- Controles -->
          <button id="carousel-prev" class="absolute inset-y-0 left-0 px-3 text-white/90 hover:text-white text-2xl flex items-center"
                  onclick="Eventos.prevFoto()"
                  aria-label="Anterior">❮</button>
          <button id="carousel-next" class="absolute inset-y-0 right-0 px-3 text-white/90 hover:text-white text-2xl flex items-center"
                  onclick="Eventos.nextFoto()"
                  aria-label="Siguiente">❯</button>
          <!-- Indicadores -->
          <div id="carousel-dots" class="absolute bottom-2 left-0 right-0 flex justify-center gap-2"></div>
        </div>
      </div>

      <!-- Datos -->
      <div class="space-y-2">
        <div><span class="text-xs uppercase text-gray-500">Fechas</span><div id="detalle-fechas" class="font-medium"></div></div>
        <div><span class="text-xs uppercase text-gray-500">Hora</span><div id="detalle-hora" class="font-medium"></div></div>
        <div><span class="text-xs uppercase text-gray-500">Lugar</span><div id="detalle-lugar" class="font-medium"></div></div>
        <div><span class="text-xs uppercase text-gray-500">Organizador</span><div id="detalle-organizador" class="font-medium"></div></div>
        <div><span class="text-xs uppercase text-gray-500">Contacto</span><div id="detalle-contacto" class="font-medium"></div></div>
        <div><span class="text-xs uppercase text-gray-500">Precio</span><div id="detalle-precio" class="font-medium"></div></div>
        <div><span class="text-xs uppercase text-gray-500">Categoría</span><div id="detalle-categoria" class="font-medium"></div></div>
        <div><span class="text-xs uppercase text-gray-500">Descripción</span><p id="detalle-descripcion" class="text-sm text-gray-700"></p></div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const LS_KEY = "eventos";
  let eventos = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
  let editId = null;
  let currentFotos = [];

  // --- IndexedDB setup ---
  let db;
  const request = indexedDB.open("EventosDB", 1);
  request.onupgradeneeded = e => {
    db = e.target.result;
    if (!db.objectStoreNames.contains("imagenes")) {
      db.createObjectStore("imagenes");
    }
  };
  request.onsuccess = e => { db = e.target.result; render(); };

  function saveImage(id, blob) {
    return new Promise((resolve,reject)=>{
      const tx = db.transaction("imagenes", "readwrite");
      tx.objectStore("imagenes").put(blob, id);
      tx.oncomplete = resolve;
      tx.onerror = reject;
    });
  }
  function getImage(id) {
    return new Promise((resolve,reject)=>{
      const tx = db.transaction("imagenes", "readonly");
      const req = tx.objectStore("imagenes").get(id);
      req.onsuccess = ()=> resolve(req.result);
      req.onerror = reject;
    });
  }
  function deleteImage(id){
    const tx = db.transaction("imagenes", "readwrite");
    tx.objectStore("imagenes").delete(id);
  }

  // --- Render list ---
  async function render() {
    const body = document.getElementById("eventos-body");
    if (!body) return;
    body.innerHTML = "";

    for (const ev of eventos) {
      let thumbHtml = "";
      if (ev.fotoIds && ev.fotoIds.length) {
        const blob = await getImage(ev.fotoIds[0]);
        if (blob) {
          const url = URL.createObjectURL(blob);
          thumbHtml = `<img src="${url}" class="w-12 h-12 object-cover rounded">`;
        }
      }

      body.innerHTML += `
        <tr class="border-t hover:bg-gray-50 cursor-pointer" data-id="${ev.id}" onclick="Eventos.view(${ev.id})">
          <td class="px-4 py-3">
            <div class="font-semibold">${ev.titulo}</div>
            <div class="text-gray-500 text-xs line-clamp-2">${ev.descripcion || ""}</div>
            ${ev.destacado ? `<span class="inline-block mt-1 bg-yellow-200 text-yellow-800 text-xs px-2 py-1 rounded">Destacado</span>` : ""}
          </td>
          <td class="px-4 py-3">${ev.fechaInicio}${ev.fechaFin ? " - " + ev.fechaFin : ""}<br><span class="text-gray-500 text-xs">${ev.hora || ""}</span></td>
          <td class="px-4 py-3">${ev.lugar || ""}</td>
          <td class="px-4 py-3">${ev.organizador || ""}</td>
          <td class="px-4 py-3">${ev.categoria || ""}</td>
          <td class="px-4 py-3 flex items-center gap-2" onclick="event.stopPropagation()">
            ${thumbHtml}
            <button onclick="event.stopPropagation(); Eventos.edit(${ev.id})" class="text-yellow-600 hover:text-yellow-700" title="Editar"><i class="fas fa-edit"></i></button>
            <button onclick="event.stopPropagation(); Eventos.remove(${ev.id})" class="text-red-600 hover:text-red-700" title="Eliminar"><i class="fas fa-trash"></i></button>
          </td>
        </tr>
      `;
    }
  }

  // --- Filters (placeholder) ---
  function applyFilters(){ /* TODO: implementar */ }
  function clearFilters(){ render(); }

  // --- Form ---
  function openForm(id=null) {
    editId = id;
    document.getElementById("evento-modal").classList.remove("hidden");
    document.getElementById("evento-modal-title").textContent = id ? "Editar Evento" : "Agregar Evento";
    document.getElementById("evento-form").reset();
    currentFotos = [];
    document.getElementById("foto-preview").innerHTML = "";

    if (id) {
      const ev = eventos.find(e => e.id === id);
      if (!ev) return;
      ["titulo","descripcion","fechaInicio","fechaFin","hora","lugar","colonia","organizador","contacto","precio","categoria"].forEach(f => {
        const el = document.getElementById(f);
        if (el) el.value = ev[f] || "";
      });
      document.getElementById("destacado").checked = ev.destacado;
    }
  }
  function closeForm(){ document.getElementById("evento-modal").classList.add("hidden"); }

  document.getElementById("evento-form").addEventListener("submit", async e => {
    e.preventDefault();

    const fotoIds = [];
    for (const foto of currentFotos) {
      const id = Date.now() + "-" + Math.random().toString(16).slice(2);
      fotoIds.push(id);
      await saveImage(id, foto.blob);
    }

    const data = {
      id: editId || (eventos.length ? Math.max(...eventos.map(e=>e.id))+1 : 1),
      titulo: titulo.value.trim(),
      descripcion: descripcion.value.trim(),
      fechaInicio: fechaInicio.value,
      fechaFin: fechaFin.value,
      hora: hora.value,
      lugar: lugar.value,
      colonia: colonia.value,
      organizador: organizador.value,
      contacto: contacto.value,
      precio: precio.value,
      categoria: categoria.value,
      destacado: document.getElementById("destacado").checked,
      fotoIds,
      estado: "Pendiente"
    };

    if (editId) {
      const i = eventos.findIndex(e => e.id===editId);
      if (i!==-1) eventos[i]=data;
    } else {
      eventos.push(data);
    }
    localStorage.setItem(LS_KEY, JSON.stringify(eventos));
    render();
    closeForm();
  });

  // --- Fotos (form) ---
  document.getElementById("fotos").addEventListener("change", e => {
    const files = Array.from(e.target.files);
    files.forEach(f => { currentFotos.push({blob:f}); });
    renderPreviews();
    e.target.value="";
  });

  function renderPreviews(){
    const c = document.getElementById("foto-preview");
    c.innerHTML = currentFotos.map((f,i)=>`
      <div class="relative">
        <img src="${URL.createObjectURL(f.blob)}" class="w-full h-20 object-cover rounded">
        <button type="button" onclick="Eventos.removeFoto(${i})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">×</button>
      </div>`).join("");
  }
  function removeFoto(i){ currentFotos.splice(i,1); renderPreviews(); }

  // --- CRUD ---
  function edit(id){ openForm(id); }
  function remove(id){
    if (!confirm("¿Eliminar este evento?")) return;
    const ev = eventos.find(e=>e.id===id);
    if (ev?.fotoIds) ev.fotoIds.forEach(deleteImage);
    eventos = eventos.filter(e=>e.id!==id);
    localStorage.setItem(LS_KEY, JSON.stringify(eventos));
    render();
  }

  // ====== DETALLE + CARRUSEL ======
  let detalle = {
    ev: null,
    urls: [],
    idx: 0,
    touchStartX: null,
  };

  async function view(id){
    const ev = eventos.find(e=>e.id===id);
    if (!ev) return;

    // limpiar urls anteriores
    cleanupCarouselUrls();

    detalle.ev = ev;
    detalle.urls = [];
    detalle.idx = 0;

    // Cargar blobs → ObjectURLs
    if (ev.fotoIds?.length) {
      for (const fid of ev.fotoIds) {
        const blob = await getImage(fid);
        if (blob) detalle.urls.push(URL.createObjectURL(blob));
      }
    }

    // Datos
    document.getElementById("detalle-title").textContent = ev.titulo || "Detalle del Evento";
    document.getElementById("detalle-fechas").textContent = ev.fechaInicio + (ev.fechaFin ? " – " + ev.fechaFin : "");
    document.getElementById("detalle-hora").textContent = ev.hora || "";
    document.getElementById("detalle-lugar").textContent = [ev.lugar, ev.colonia].filter(Boolean).join(", ");
    document.getElementById("detalle-organizador").textContent = ev.organizador || "";
    document.getElementById("detalle-contacto").textContent = ev.contacto || "";
    document.getElementById("detalle-precio").textContent = ev.precio || "";
    document.getElementById("detalle-categoria").textContent = ev.categoria || "";
    document.getElementById("detalle-descripcion").textContent = ev.descripcion || "";

    // Carrusel
    updateCarouselImage();
    renderDots();

    // Mostrar modal
    document.getElementById("evento-detalle-modal").classList.remove("hidden");

    // Teclado
    window.addEventListener("keydown", handleKeys);
    // Swipe
    const wrapper = document.getElementById("carousel-wrapper");
    wrapper.addEventListener("touchstart", onTouchStart, {passive:true});
    wrapper.addEventListener("touchend", onTouchEnd, {passive:true});
  }

  function closeDetalle(){
    document.getElementById("evento-detalle-modal").classList.add("hidden");
    window.removeEventListener("keydown", handleKeys);
    const wrapper = document.getElementById("carousel-wrapper");
    wrapper.removeEventListener("touchstart", onTouchStart);
    wrapper.removeEventListener("touchend", onTouchEnd);
    cleanupCarouselUrls();
  }

  function cleanupCarouselUrls(){
    if (detalle.urls?.length) {
      detalle.urls.forEach(u => URL.revokeObjectURL(u));
    }
    detalle.urls = [];
  }

  function handleKeys(e){
    if (e.key === "Escape") closeDetalle();
    if (e.key === "ArrowRight") nextFoto();
    if (e.key === "ArrowLeft") prevFoto();
  }

  function onTouchStart(e){
    detalle.touchStartX = e.changedTouches[0].clientX;
  }
  function onTouchEnd(e){
    const dx = e.changedTouches[0].clientX - (detalle.touchStartX ?? 0);
    if (Math.abs(dx) > 40) {
      if (dx < 0) nextFoto(); else prevFoto();
    }
    detalle.touchStartX = null;
  }

  function updateCarouselImage(){
    const img = document.getElementById("carousel-image");
    if (!detalle.urls.length) {
      img.src = "";
      img.alt = "Sin imágenes";
      img.classList.add("opacity-60");
      img.parentElement.classList.add("flex","items-center","justify-center");
      img.parentElement.innerHTML = `<div class="text-gray-500">Sin imágenes para este evento</div>`;
      return;
    }
    img.parentElement.classList.remove("flex","items-center","justify-center");
    img.classList.remove("opacity-60");
    img.src = detalle.urls[detalle.idx];
    img.alt = `Imagen ${detalle.idx+1} de ${detalle.urls.length}`;
  }

  function renderDots(){
    const c = document.getElementById("carousel-dots");
    c.innerHTML = "";
    if (!detalle.urls.length) return;
    detalle.urls.forEach((_, i) => {
      const b = document.createElement("button");
      b.className = "w-2.5 h-2.5 rounded-full " + (i===detalle.idx ? "bg-white shadow ring-1 ring-black/20" : "bg-white/60 hover:bg-white");
      b.style.margin = "0 3px";
      b.onclick = ()=> goFoto(i);
      c.appendChild(b);
    });
  }

  function goFoto(i){
    if (!detalle.urls.length) return;
    detalle.idx = (i + detalle.urls.length) % detalle.urls.length;
    updateCarouselImage();
    renderDots();
  }
  function nextFoto(){ goFoto(detalle.idx + 1); }
  function prevFoto(){ goFoto(detalle.idx - 1); }

  // --- Expose ---
  window.Eventos = {
    openForm, closeForm, edit, remove, applyFilters, clearFilters,
    removeFoto,
    view, closeDetalle, nextFoto, prevFoto
  };

})();
</script>
