<!-- Eventos.html (módulo completo con soporte de fotos por URL + caché opcional) -->
<section class="section-content p-6">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h2 class="text-3xl font-bold text-gray-800 mb-2">Eventos</h2>
      <p class="text-gov-gray">Gestión de eventos municipales y comunitarios</p>
    </div>
    <button
      onclick="Eventos.openForm()"
      class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition flex items-center"
    >
      <i class="fas fa-plus mr-2"></i> Agregar Evento
    </button>
  </div>

  <!-- KPIs (Eventos) -->
  <section class="mb-6">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6" id="eventos-kpis">
      <!-- Total (filtrados) -->
      <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-indigo-600">
        <div class="flex items-center justify-between">
          <div>
            <p id="kpi-evt-total" class="text-2xl font-bold text-gray-800">0</p>
            <p class="text-sm text-gray-600">Eventos (filtrados)</p>
          </div>
          <div class="p-3 rounded-lg bg-indigo-100">
            <i class="fas fa-calendar-check text-indigo-700 text-xl"></i>
          </div>
        </div>
      </div>
      <!-- Este mes -->
      <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
          <div>
            <p id="kpi-evt-mes" class="text-2xl font-bold text-gray-800">0</p>
            <p class="text-sm text-gray-600">Este mes</p>
          </div>
          <div class="p-3 rounded-lg bg-blue-100">
            <i class="fas fa-calendar-alt text-blue-600 text-xl"></i>
          </div>
        </div>
      </div>
      <!-- Próx. 7 días -->
      <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-emerald-500">
        <div class="flex items-center justify-between">
          <div>
            <p id="kpi-evt-prox" class="text-2xl font-bold text-gray-800">0</p>
            <p class="text-sm text-gray-600">Próx. 7 días</p>
          </div>
          <div class="p-3 rounded-lg bg-emerald-100">
            <i class="fas fa-clock text-emerald-700 text-xl"></i>
          </div>
        </div>
      </div>
      <!-- Destacados -->
      <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-amber-500">
        <div class="flex items-center justify-between">
          <div>
            <p id="kpi-evt-dest" class="text-2xl font-bold text-gray-800">0</p>
            <p class="text-sm text-gray-600">Destacados</p>
          </div>
          <div class="p-3 rounded-lg bg-amber-100">
            <i class="fas fa-star text-amber-600 text-xl"></i>
          </div>
        </div>
      </div>
      <!-- Gratuitos -->
      <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-500">
        <div class="flex items-center justify-between">
          <div>
            <p id="kpi-evt-gratis" class="text-2xl font-bold text-gray-800">0</p>
            <p class="text-sm text-gray-600">Gratuitos</p>
          </div>
          <div class="p-3 rounded-lg bg-purple-100">
            <i class="fas fa-hand-holding-usd text-purple-600 text-xl"></i>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Filtros -->
  <div class="bg-white p-4 rounded-xl shadow mb-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <select id="filterCategoria" onchange="Eventos.applyFilters()" class="px-4 py-2 border rounded-lg">
        <option value="">Todas las categorías</option>
        <option value="Religioso">Religioso</option>
        <option value="Deportivo">Deportivo</option>
        <option value="Cultural">Cultural</option>
        <option value="Gastronomico">Gastronómico</option>
        <option value="Familiar">Familiar</option>
      </select>
      <select id="filterOrganizador" onchange="Eventos.applyFilters()" class="px-4 py-2 border rounded-lg">
        <option value="">Todos los organizadores</option>
      </select>
      <select id="filterMes" onchange="Eventos.applyFilters()" class="px-4 py-2 border rounded-lg">
        <option value="">Todos los meses</option>
        <option value="01">Enero</option><option value="02">Febrero</option><option value="03">Marzo</option>
        <option value="04">Abril</option><option value="05">Mayo</option><option value="06">Junio</option>
        <option value="07">Julio</option><option value="08">Agosto</option><option value="09">Septiembre</option>
        <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
      </select>
      <select id="filterEstado" onchange="Eventos.applyFilters()" class="px-4 py-2 border rounded-lg">
        <option value="">Todos</option>
        <option value="Pendiente">Pendiente</option>
        <option value="Finalizado">Finalizado</option>
      </select>
    </div>
    <button onclick="Eventos.clearFilters()" class="mt-2 text-sm text-indigo-600 hover:underline">
      Limpiar filtros
    </button>
  </div>

  <!-- Tabla -->
  <div class="bg-white rounded-xl shadow overflow-hidden">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50 text-left">
        <tr>
          <th class="px-4 py-3">Evento</th>
          <th class="px-4 py-3">Fecha y Hora</th>
          <th class="px-4 py-3">Lugar</th>
          <th class="px-4 py-3">Organizador</th>
          <th class="px-4 py-3">Estado</th>
          <th class="px-4 py-3">Acciones</th>
        </tr>
      </thead>
      <tbody id="eventos-body"></tbody>
    </table>
  </div>
</section>

<!-- Modal Formulario -->
<div id="evento-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-xl w-full max-w-2xl shadow-lg overflow-y-auto max-h-[90vh]">
    <div class="flex justify-between items-center px-6 py-4 border-b">
      <h3 id="evento-modal-title" class="text-lg font-bold">Agregar Evento</h3>
      <button onclick="Eventos.closeForm()" class="text-gray-500 hover:text-gray-800">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <form id="evento-form" class="p-6 space-y-4">
      <div>
        <label class="block text-sm font-medium">Título del Evento *</label>
        <input type="text" id="titulo" required class="w-full px-3 py-2 border rounded-lg" />
      </div>
      <div>
        <label class="block text-sm font-medium">Descripción *</label>
        <textarea id="descripcion" rows="3" required class="w-full px-3 py-2 border rounded-lg"></textarea>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium">Fecha de Inicio *</label>
          <input type="date" id="fechaInicio" required class="w-full px-3 py-2 border rounded-lg" />
        </div>
        <div>
          <label class="block text-sm font-medium">Fecha de Fin</label>
          <input type="date" id="fechaFin" class="w-full px-3 py-2 border rounded-lg" />
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium">Hora *</label>
        <input type="text" id="hora" required placeholder="Ej. 18:00 hrs, Todo el día" class="w-full px-3 py-2 border rounded-lg" />
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium">Lugar *</label>
          <input type="text" id="lugar" required class="w-full px-3 py-2 border rounded-lg" />
        </div>
        <div>
          <label class="block text-sm font-medium">Colonia</label>
          <input type="text" id="colonia" class="w-full px-3 py-2 border rounded-lg" />
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium">Organizador *</label>
        <input type="text" id="organizador" required class="w-full px-3 py-2 border rounded-lg" />
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium">Contacto</label>
          <input type="text" id="contacto" class="w-full px-3 py-2 border rounded-lg" />
        </div>
        <div>
          <label class="block text-sm font-medium">Precio *</label>
          <input type="text" id="precio" required class="w-full px-3 py-2 border rounded-lg" />
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium">Categoría *</label>
        <select id="categoria" required class="w-full px-3 py-2 border rounded-lg">
          <option value="">Seleccionar categoría</option>
          <option value="Religioso">Religioso</option>
          <option value="Deportivo">Deportivo</option>
          <option value="Cultural">Cultural</option>
          <option value="Gastronomico">Gastronómico</option>
          <option value="Familiar">Familiar</option>
        </select>
      </div>

      <div class="flex items-center gap-2">
        <input type="checkbox" id="destacado" />
        <label for="destacado">Marcar como evento destacado</label>
      </div>

      <div>
        <label class="block text-sm font-medium">Fotos del Evento</label>
        <input type="file" id="fotos" multiple accept="image/*" class="w-full px-3 py-2 border rounded-lg" />
        <!-- NUEVO: URLs + caché -->
        <div class="mt-3">
          <label class="block text-sm font-medium">Agregar fotos por URL</label>
          <div class="flex gap-2">
            <input
              type="url"
              id="fotoUrlInput"
              class="flex-1 px-3 py-2 border rounded-lg"
              placeholder="https://sitio.com/imagen.jpg (varias separadas por coma o por renglones)"
            />
            <button type="button" onclick="Eventos.addFotoUrl()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">
              Agregar URL
            </button>
          </div>
          <label class="mt-2 inline-flex items-center gap-2 text-sm">
            <input type="checkbox" id="cacheUrlFotos" class="rounded border-gray-300 text-indigo-600" />
            <span>Intentar copiar a almacenamiento local (si el servidor permite CORS)</span>
          </label>
        </div>
        <div id="foto-preview" class="grid grid-cols-3 gap-2 mt-2"></div>
      </div>

      <!-- NUEVOS CAMPOS -->
      <div>
        <label class="block text-sm font-medium">Link de Google Maps</label>
        <input type="url" id="googleMaps" placeholder="https://maps.google.com/..." class="w-full px-3 py-2 border rounded-lg" />
      </div>
      <div>
        <label class="block text-sm font-medium">Recomendaciones</label>
        <textarea id="recomendaciones" rows="2" placeholder="Ej. No llevar vidrio" class="w-full px-3 py-2 border rounded-lg"></textarea>
      </div>

      <div class="flex justify-end gap-3 pt-4">
        <button type="button" onclick="Eventos.closeForm()" class="px-4 py-2 border rounded-lg">Cancelar</button>
        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Detalle -->
<div id="evento-detalle-modal" class="fixed inset-0 bg-black/60 hidden z-50 p-4">
  <div class="bg-white rounded-xl max-w-5xl mx-auto h-full overflow-y-auto">
    <div class="flex justify-between items-center px-6 py-4 border-b sticky top-0 bg-white">
      <h3 class="text-lg font-bold" id="detalle-title">Detalle del Evento</h3>
      <button onclick="Eventos.closeDetalle()" class="text-gray-500 hover:text-gray-800">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="p-6">
      <div class="rounded-xl overflow-hidden bg-gray-100">
        <img id="carousel-image" class="w-full h-[360px] md:h-[440px] object-cover" alt="Imagen del evento" />
      </div>
      <div id="thumbs" class="flex gap-3 mt-4 overflow-x-auto pb-1"></div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
        <div class="space-y-2">
          <div class="font-semibold" id="detalle-titulo"></div>
          <p id="detalle-descripcion" class="text-sm text-gray-700"></p>

          <div class="flex items-start gap-2">
            <i class="fas fa-tags text-orange-500 mt-[2px]"></i>
            <span class="font-medium" id="detalle-categoria"></span>
          </div>
          <div class="flex items-start gap-2">
            <i class="fas fa-map-marker-alt text-orange-500 mt-[2px]"></i>
            <span class="font-medium" id="detalle-lugar"></span>
          </div>
          <div class="flex items-start gap-2">
            <i class="far fa-clock text-orange-500 mt-[2px]"></i>
            <span class="font-medium" id="detalle-hora"></span>
          </div>
          <div class="flex items-start gap-2">
            <i class="fas fa-dollar-sign text-orange-500 mt-[2px]"></i>
            <span class="font-medium" id="detalle-precio"></span>
          </div>
        </div>

        <div class="bg-gray-50 rounded-xl p-5">
          <div class="font-semibold mb-1">Recomendaciones</div>
          <div id="detalle-recomendaciones" class="text-sm text-gray-700 mb-4"></div>
          <a
            id="detalle-gmaps-btn"
            href="#"
            target="_blank"
            rel="noopener"
            class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg disabled:opacity-50 disabled:pointer-events-none"
          >
            <i class="fas fa-map-marked-alt"></i> Ver en Google Maps
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // ====== Estado / Storage ======
  const LS_KEY = "eventos";
  let eventos = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
  let editId = null;

  // Fotos en edición (mezclado)
  // Cada item puede ser: { blob?, url?, existingId?, existingUrl?, previewUrl, sourceUrl?, _removed? }
  let currentFotos = [];
  let editOriginalFotoIds = [];
  let editOriginalFotoUrls = [];
const SEED_EVENTS = [
    {
        "id": 1,
        "titulo": "Motorock",
        "descripcion": "Motorock Sabinas Hidalgo",
        "fechaInicio": "2025-09-09",
        "fechaFin": "",
        "hora": "18:00",
        "lugar": "Ojo de Agua",
        "colonia": "",
        "organizador": "Municipio",
        "contacto": "",
        "precio": "350",
        "categoria": "Cultural",
        "destacado": true,
        "googleMaps": "",
        "recomendaciones": "",
        "fotoIds": [],
        "fotoUrls": [
            "https://scontent.fntr8-1.fna.fbcdn.net/v/t39.30808-6/487769149_580011498388796_7825819156858778655_n.jpg?stp=cp6_dst-jpg_tt6&_nc_cat=102&ccb=1-7&_nc_sid=833d8c&_nc_eui2=AeGT_aD1GeifpyQpGqLC_ZBWSqfsCocKAs1Kp-wKhwoCzW7lM-sC6ZrSoUEvsmzN9s_btzcuHQ_PgIEsh4j0TX0j&_nc_ohc=K-9Gr8Vl1i8Q7kNvwFZI1xj&_nc_oc=Adlm_yNlFquxpmUfi7Say8q5jyMTeVJUJb7ZpdhW3FgSThNilDMTl5qJZ_Zid29_WzUg1LDs0n-OYAFnmqQqSdvx&_nc_zt=23&_nc_ht=scontent.fntr8-1.fna&_nc_gid=e3J8pfg0GqIUDJetyxc0HA&oh=00_AfbPU29wemjRY5fDkWLdOcixup4A7TWKx7cOnOvHa3k64g&oe=68C68E70"
        ],
        "estado": "Pendiente"
    }
];

function seedDefaults(force = false) {
  if (force || !Array.isArray(eventos) || eventos.length === 0) {
    // Si ya existen IDs, calcula el próximo ID base
    const nextId =
      Array.isArray(eventos) && eventos.length
        ? Math.max(...eventos.map((e) => e.id || 0)) + 1
        : 1;

    const offset = nextId - 1;
    const seeded = SEED_EVENTS.map((e) => ({ ...e, id: e.id + offset }));
    eventos = seeded;
    localStorage.setItem(LS_KEY, JSON.stringify(eventos));
  }
}

  // ====== IndexedDB (imagenes) ======
  let db;
  const request = indexedDB.open("EventosDB", 1);
  request.onupgradeneeded = (e) => {
    db = e.target.result;
    if (!db.objectStoreNames.contains("imagenes"))
      db.createObjectStore("imagenes");
  };
  request.onsuccess = (e) => {
    db = e.target.result;
    populateOrganizadores();
     seedDefaults(false);
    render(getFiltered()); // pintar con filtros actuales (inicialmente vacíos)
  };

  function saveImage(id, blob) {
    return new Promise((resolve, reject) => {
      const tx = db.transaction("imagenes", "readwrite");
      tx.objectStore("imagenes").put(blob, id);
      tx.oncomplete = resolve;
      tx.onerror = reject;
    });
  }
  function getImage(id) {
    return new Promise((resolve, reject) => {
      const tx = db.transaction("imagenes", "readonly");
      const req = tx.objectStore("imagenes").get(id);
      req.onsuccess = () => resolve(req.result);
      req.onerror = reject;
    });
  }
  function deleteImage(id) {
    const tx = db.transaction("imagenes", "readwrite");
    tx.objectStore("imagenes").delete(id);
  }

  // ====== Utils ======
  function cleanupPreviewUrls() {
    currentFotos.forEach((f) => {
      try {
        if (f.previewUrl && f.previewUrl.startsWith("blob:")) {
          URL.revokeObjectURL(f.previewUrl);
        }
      } catch {}
    });
  }
  function isValidHttpUrl(str) {
    try {
      const u = new URL(str);
      return u.protocol === "http:" || u.protocol === "https:";
    } catch { return false; }
  }
  async function fetchUrlAsBlob(url) {
    const res = await fetch(url, { mode: "cors" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.blob();
  }

  // ====== Render tabla (acepta lista filtrada) ======
  async function render(rows) {
    const body = document.getElementById("eventos-body");
    if (!body) return;
    const list = Array.isArray(rows) ? rows : eventos;
    body.innerHTML = "";

    for (const ev of list) {
      let thumbHtml = "";
      // miniatura prioriza blob y cae a URL
      let thumb = null;
      if (ev.fotoIds?.length) {
        const blob = await getImage(ev.fotoIds[0]);
        if (blob) thumb = URL.createObjectURL(blob);
      }
      if (!thumb && ev.fotoUrls?.length) {
        const u = ev.fotoUrls.find(isValidHttpUrl);
        if (u) thumb = u;
      }
      if (thumb) {
        thumbHtml = `<img src="${thumb}" class="w-12 h-12 object-cover rounded">`;
      }

      body.innerHTML += `
        <tr class="border-t hover:bg-gray-50 cursor-pointer" onclick="Eventos.view(${ev.id})">
          <td class="px-4 py-3">
            <div class="flex items-start gap-3">
              ${thumbHtml}
              <div>
                <div class="font-semibold">${ev.titulo}</div>
                <div class="text-gray-500 text-xs line-clamp-2">${ev.descripcion || ""}</div>
                ${ev.destacado ? `<span class="inline-block mt-1 bg-yellow-200 text-yellow-800 text-xs px-2 py-1 rounded">Destacado</span>` : ""}
              </div>
            </div>
          </td>
          <td class="px-4 py-3">${ev.fechaInicio || ""}${ev.fechaFin ? " - " + ev.fechaFin : ""}<br><span class="text-gray-500 text-xs">${ev.hora || ""}</span></td>
          <td class="px-4 py-3">${ev.lugar || ""}</td>
          <td class="px-4 py-3">${ev.organizador || ""}</td>
          <td class="px-4 py-3">${ev.categoria || ""}</td>
          <td class="px-4 py-3 flex items-center gap-2" onclick="event.stopPropagation()">
            <button onclick="event.stopPropagation(); Eventos.edit(${ev.id})" class="text-yellow-600 hover:text-yellow-700" title="Editar"><i class="fas fa-edit"></i></button>
            <button onclick="event.stopPropagation(); Eventos.remove(${ev.id})" class="text-red-600 hover:text-red-700" title="Eliminar"><i class="fas fa-trash"></i></button>
          </td>
        </tr>`;
    }

    KPIs.update(list);
  }

  // ====== Filtros y KPIs ======
  function parseISO(d) { return d ? new Date(d + "T00:00:00") : null; }
  function isFreePrecio(p) {
    const v = (p || "").toString().trim().toLowerCase();
    return v.includes("gratuito") || v === "0" || v === "$0";
  }

  const KPIs = {
    el: {
      total: document.getElementById("kpi-evt-total"),
      mes: document.getElementById("kpi-evt-mes"),
      prox: document.getElementById("kpi-evt-prox"),
      dest: document.getElementById("kpi-evt-dest"),
      gratis: document.getElementById("kpi-evt-gratis"),
    },
    anim(el, to, ms = 450) {
      if (!el) return;
      const start = performance.now();
      const from = 0;
      const end = Number(to) || 0;
      function frame(now) {
        const t = Math.min(1, (now - start) / ms);
        el.textContent = Math.round(from + (end - from) * t).toLocaleString("es-MX");
        if (t < 1) requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    },
    update(list) {
      const today = new Date();
      const y = today.getFullYear();
      const m = today.getMonth();

      const inThisMonth = list.filter((e) => {
        const d = parseISO(e.fechaInicio);
        return d && d.getFullYear() === y && d.getMonth() === m;
      }).length;

      const next7 = list.filter((e) => {
        const d = parseISO(e.fechaInicio);
        if (!d) return false;
        const diff = (d - today) / (1000 * 60 * 60 * 24);
        return diff >= 0 && diff <= 7;
      }).length;

      const destacados = list.filter((e) => !!e.destacado).length;
      const gratis = list.filter((e) => isFreePrecio(e.precio)).length;

      this.anim(this.el.total, list.length);
      this.anim(this.el.mes, inThisMonth);
      this.anim(this.el.prox, next7);
      this.anim(this.el.dest, destacados);
      this.anim(this.el.gratis, gratis);
    },
  };

  function getFiltered() {
    const cat = document.getElementById("filterCategoria")?.value || "";
    const org = document.getElementById("filterOrganizador")?.value || "";
    const mes = document.getElementById("filterMes")?.value || ""; // "01".."12"
    const est = document.getElementById("filterEstado")?.value || ""; // Pendiente/Finalizado

    return (eventos || []).filter((ev) => {
      if (cat && ev.categoria !== cat) return false;
      if (org && ev.organizador !== org) return false;
      if (mes) {
        const d = parseISO(ev.fechaInicio);
        if (!(d && String(d.getMonth() + 1).padStart(2, "0") === mes)) return false;
      }
      if (est && (ev.estado || "Pendiente") !== est) return false;
      return true;
    });
  }

  function applyFilters() { render(getFiltered()); }
  function clearFilters() {
    document.getElementById("filterCategoria").value = "";
    document.getElementById("filterOrganizador").value = "";
    document.getElementById("filterMes").value = "";
    document.getElementById("filterEstado").value = "";
    render(getFiltered());
  }

  function populateOrganizadores() {
    const sel = document.getElementById("filterOrganizador");
    if (!sel) return;
    const current = sel.value;
    const opts = ['<option value="">Todos los organizadores</option>'];
    const names = Array.from(new Set((eventos || []).map((e) => e.organizador).filter(Boolean))).sort();
    names.forEach((n) => opts.push(`<option value="${n}">${n}</option>`));
    sel.innerHTML = opts.join("");
    if (names.includes(current)) sel.value = current;
  }

  // ====== Form ======
  async function openForm(id = null) {
    // limpiar previews previas
    cleanupPreviewUrls();
    currentFotos = [];
    editOriginalFotoIds = [];
    editOriginalFotoUrls = [];

    editId = id;
    document.getElementById("evento-modal").classList.remove("hidden");
    document.getElementById("evento-modal-title").textContent = id ? "Editar Evento" : "Agregar Evento";
    document.getElementById("evento-form").reset();
    document.getElementById("foto-preview").innerHTML = "";
    const urlInput = document.getElementById("fotoUrlInput");
    if (urlInput) urlInput.value = "";

    if (id) {
      const ev = eventos.find((e) => e.id === id);
      if (!ev) return;

      [
        "titulo","descripcion","fechaInicio","fechaFin","hora","lugar","colonia",
        "organizador","contacto","precio","categoria","googleMaps","recomendaciones",
      ].forEach((f) => { const el = document.getElementById(f); if (el) el.value = ev[f] || ""; });
      document.getElementById("destacado").checked = !!ev.destacado;

      // Cargar fotos existentes al editor (blobs + urls)
      editOriginalFotoIds = Array.isArray(ev.fotoIds) ? [...ev.fotoIds] : [];
      editOriginalFotoUrls = Array.isArray(ev.fotoUrls) ? [...ev.fotoUrls] : [];

      for (const fid of editOriginalFotoIds) {
        const blob = await getImage(fid);
        if (blob) {
          const url = URL.createObjectURL(blob);
          currentFotos.push({ blob, existingId: fid, previewUrl: url });
        }
      }
      for (const u of editOriginalFotoUrls) {
        if (isValidHttpUrl(u)) {
          currentFotos.push({ url: u, existingUrl: u, previewUrl: u });
        }
      }
      renderPreviews();
    }
  }

  function closeForm() {
    document.getElementById("evento-modal").classList.add("hidden");
    cleanupPreviewUrls();
    currentFotos = [];
    editOriginalFotoIds = [];
    editOriginalFotoUrls = [];
    editId = null;
  }

  document.getElementById("evento-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    // Construir nueva lista de fotoIds / fotoUrls manteniendo las existentes no removidas
    const fotoIds = [];
    const fotoUrls = [];
    const keptExistingIds = new Set();
    const keptExistingUrls = new Set();

    for (const f of currentFotos) {
      if (f._removed) continue;

      if (f.existingId) {
        fotoIds.push(f.existingId);
        keptExistingIds.add(f.existingId);
      } else if (f.blob) {
        const id = Date.now() + "-" + Math.random().toString(16).slice(2);
        await saveImage(id, f.blob);
        fotoIds.push(id);
      } else if (f.existingUrl) {
        if (isValidHttpUrl(f.existingUrl)) {
          fotoUrls.push(f.existingUrl);
          keptExistingUrls.add(f.existingUrl);
        }
      } else if (f.url && isValidHttpUrl(f.url)) {
        fotoUrls.push(f.url);
      }
    }

    // Si es edición, borrar blobs que fueron quitados
    if (editId && editOriginalFotoIds.length) {
      const removed = editOriginalFotoIds.filter((oldId) => !keptExistingIds.has(oldId));
      removed.forEach(deleteImage);
    }

    const data = {
      id: editId || (eventos.length ? Math.max(...eventos.map((e) => e.id)) + 1 : 1),
      titulo: titulo.value.trim(),
      descripcion: descripcion.value.trim(),
      fechaInicio: fechaInicio.value,
      fechaFin: fechaFin.value,
      hora: hora.value,
      lugar: lugar.value,
      colonia: colonia.value,
      organizador: organizador.value,
      contacto: contacto.value,
      precio: precio.value,
      categoria: categoria.value,
      destacado: document.getElementById("destacado").checked,
      googleMaps: document.getElementById("googleMaps").value.trim(),
      recomendaciones: document.getElementById("recomendaciones").value.trim(),
      fotoIds,
      fotoUrls,
      estado: "Pendiente",
    };

    if (editId) {
      const i = eventos.findIndex((e) => e.id === editId);
      if (i !== -1) eventos[i] = data;
    } else {
      eventos.push(data);
    }

    localStorage.setItem(LS_KEY, JSON.stringify(eventos));
    populateOrganizadores();
    await render(getFiltered());
    closeForm();
  });

  // ====== Fotos (archivo) ======
  document.getElementById("fotos").addEventListener("change", (e) => {
    const files = Array.from(e.target.files);
    files.forEach((f) => {
      const previewUrl = URL.createObjectURL(f);
      currentFotos.push({ blob: f, previewUrl });
    });
    renderPreviews();
    e.target.value = "";
  });

  // ====== Fotos (URL) ======
  async function addFotoUrl() {
    const input = document.getElementById("fotoUrlInput");
    const cache = !!document.getElementById("cacheUrlFotos")?.checked;
    if (!input) return;
    const raw = input.value.trim();
    if (!raw) return;

    const pieces = raw.split(/[\n,]/).map((s) => s.trim()).filter(Boolean);
    let added = 0;

    for (const p of pieces) {
      if (!isValidHttpUrl(p)) continue;

      if (cache) {
        try {
          const blob = await fetchUrlAsBlob(p);
          const previewUrl = URL.createObjectURL(blob);
          currentFotos.push({ blob, previewUrl, sourceUrl: p });
          added++;
          continue;
        } catch (err) {
          console.warn("No se pudo copiar (CORS). Se usará URL directa:", p, err);
        }
      }
      currentFotos.push({ url: p, previewUrl: p });
      added++;
    }

    if (!added) {
      alert("No se encontraron URLs válidas.");
      return;
    }
    input.value = "";
    renderPreviews();
  }

  function renderPreviews() {
    const c = document.getElementById("foto-preview");
    c.innerHTML = currentFotos
      .map((f, i) =>
        f._removed
          ? ""
          : `
        <div class="relative">
          <img src="${f.previewUrl || (f.blob ? URL.createObjectURL(f.blob) : "")}" class="w-full h-20 object-cover rounded">
          <button type="button" onclick="Eventos.removeFoto(${i})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">×</button>
          <div class="absolute bottom-1 right-1 text-[10px] bg-white/80 text-gray-700 px-1 rounded border">
            ${f.url ? "URL" : (f.sourceUrl ? "Copiado" : "Archivo")}
          </div>
        </div>`
      )
      .join("");
  }

  function removeFoto(i) {
    const f = currentFotos[i];
    if (!f) return;
    try {
      if (f.previewUrl && f.previewUrl.startsWith("blob:")) {
        URL.revokeObjectURL(f.previewUrl);
      }
    } catch {}
    f._removed = true;
    renderPreviews();
  }

  // ====== Detalle / Carrusel ======
  let detalle = { ev: null, urls: [], idx: 0 };

  function cleanupCarouselUrls() {
    if (detalle.urls?.length) {
      detalle.urls.forEach((u) => {
        try { if (typeof u === "string" && u.startsWith("blob:")) URL.revokeObjectURL(u); } catch {}
      });
    }
    detalle.urls = [];
  }

  async function view(id) {
    const ev = eventos.find((e) => e.id === id);
    if (!ev) return;

    cleanupCarouselUrls();
    detalle = { ev, urls: [], idx: 0 };

    // blobs
    if (ev.fotoIds?.length) {
      for (const fid of ev.fotoIds) {
        const blob = await getImage(fid);
        if (blob) detalle.urls.push(URL.createObjectURL(blob));
      }
    }
    // urls
    if (ev.fotoUrls?.length) {
      for (const u of ev.fotoUrls) {
        if (isValidHttpUrl(u)) detalle.urls.push(u);
      }
    }

    document.getElementById("detalle-title").textContent = ev.titulo || "Detalle del Evento";
    document.getElementById("detalle-titulo").textContent = ev.titulo || "";
    document.getElementById("detalle-descripcion").textContent = ev.descripcion || "";
    document.getElementById("detalle-categoria").textContent = ev.categoria || "";
    document.getElementById("detalle-lugar").textContent = [ev.lugar, ev.colonia].filter(Boolean).join(", ");
    document.getElementById("detalle-hora").textContent = `${ev.fechaInicio || ""}${ev.fechaFin ? " – " + ev.fechaFin : ""} · ${ev.hora || ""}`;
    document.getElementById("detalle-precio").textContent = ev.precio || "";
    document.getElementById("detalle-recomendaciones").textContent = ev.recomendaciones || "—";

    const mapsBtn = document.getElementById("detalle-gmaps-btn");
    if (ev.googleMaps) {
      mapsBtn.href = ev.googleMaps;
      mapsBtn.removeAttribute("disabled");
    } else {
      mapsBtn.href = "#";
      mapsBtn.setAttribute("disabled", "true");
    }

    const hero = document.getElementById("carousel-image");
    if (detalle.urls.length) {
      hero.src = detalle.urls[0];
      hero.alt = "Imagen 1";
    } else {
      hero.src = "";
      hero.alt = "Sin imágenes";
    }

    renderThumbs();
    document.getElementById("evento-detalle-modal").classList.remove("hidden");
    window.addEventListener("keydown", handleKeys);
  }

  function renderThumbs() {
    const c = document.getElementById("thumbs");
    c.innerHTML = "";
    detalle.urls.forEach((u, i) => {
      const b = document.createElement("button");
      b.className = "w-28 h-20 rounded overflow-hidden border transition ring-0";
      if (i === detalle.idx) b.classList.add("border-orange-500", "ring-2", "ring-orange-500");
      b.onclick = () => { goFoto(i); };
      b.innerHTML = `<img src="${u}" class="w-full h-full object-cover">`;
      c.appendChild(b);
    });
  }
  function handleKeys(e) {
    if (e.key === "Escape") closeDetalle();
    if (e.key === "ArrowRight") nextFoto();
    if (e.key === "ArrowLeft") prevFoto();
  }
  function goFoto(i) {
    if (!detalle.urls.length) return;
    detalle.idx = (i + detalle.urls.length) % detalle.urls.length;
    document.getElementById("carousel-image").src = detalle.urls[detalle.idx];
    renderThumbs();
  }
  function nextFoto() { goFoto(detalle.idx + 1); }
  function prevFoto() { goFoto(detalle.idx - 1); }
  function closeDetalle() {
    document.getElementById("evento-detalle-modal").classList.add("hidden");
    window.removeEventListener("keydown", handleKeys);
    cleanupCarouselUrls();
  }

  // ====== CRUD ======
  function edit(id) { openForm(id); }
  function removeEvt(id) {
    if (!confirm("¿Eliminar este evento?")) return;
    const ev = eventos.find((e) => e.id === id);
    if (ev?.fotoIds) ev.fotoIds.forEach(deleteImage);
    // las URLs solo se quitan del registro
    eventos = eventos.filter((e) => e.id !== id);
    localStorage.setItem(LS_KEY, JSON.stringify(eventos));
    populateOrganizadores();
    render(getFiltered());
  }

  // ====== Expose ======
  window.Eventos = {
    openForm,
    closeForm,
    edit,
    remove: removeEvt,
    applyFilters,
    clearFilters,
    removeFoto,
    view,
    closeDetalle,
    nextFoto,
    prevFoto,
    addFotoUrl,
  };
})();
</script>
