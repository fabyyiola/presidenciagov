<!-- Negocios Registrados.html -->
<section class="section-content p-6">
  <div class="flex justify-between items-center mb-8">
    <div>
      <h2 class="text-3xl font-bold text-gray-800 mb-2">Negocios Registrados</h2>
      <p class="text-gov-gray">Administración y seguimiento de negocios locales</p>
    </div>
    <div class="flex items-center space-x-4">
      <div class="bg-white rounded-lg px-4 py-2 shadow-sm border">
        <span class="text-sm text-gov-gray">Total de negocios:</span>
        <span class="font-bold text-gov-blue ml-2" id="total-businesses">0</span>
      </div>
      <button id="btn-add-business" class="bg-gov-blue text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center">
        <i class="fas fa-plus mr-2"></i> Registrar Negocio
      </button>
    </div>
  </div>

  <!-- Filtros (simplificados, preservando estilos) -->
  <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-base font-bold text-gray-800">Filtros</h3>
      <button id="clear-filters-btn" class="text-red-600 hover:text-red-700 text-sm font-medium hidden">
        <i class="fas fa-times mr-1"></i> Limpiar todos los filtros
      </button>
    </div>
    <div id="active-filters" class="flex flex-wrap gap-2 mb-3 hidden"></div>
    <div class="relative inline-block">
      <button id="add-filter-btn" class="border-2 border-dashed border-gray-300 rounded-lg px-4 py-2 text-gray-500 hover:border-gov-blue hover:text-gov-blue transition duration-200 flex items-center text-sm">
        <i class="fas fa-plus mr-2"></i> Haz clic para agregar filtro
      </button>
      <div id="filter-dropdown" class="absolute top-full left-0 mt-2 bg-white border border-gray-200 rounded-lg shadow-lg z-10 hidden w-80">
        <div class="p-2">
          <div class="text-xs font-medium text-gray-500 uppercase tracking-wider px-3 py-2">Selecciona un campo para filtrar</div>
          <div class="space-y-1">
            <button data-k="nombre" class="filter-opt w-full text-left px-3 py-2 hover:bg-gray-100 rounded-lg flex items-center"><i class="fas fa-store text-gov-blue mr-3 w-4"></i><span class="text-sm">Nombre del negocio</span></button>
            <button data-k="propietario" class="filter-opt w-full text-left px-3 py-2 hover:bg-gray-100 rounded-lg flex items-center"><i class="fas fa-user text-gov-blue mr-3 w-4"></i><span class="text-sm">Propietario</span></button>
            <button data-k="categoriaNombre" class="filter-opt w-full text-left px-3 py-2 hover:bg-gray-100 rounded-lg flex items-center"><i class="fas fa-tag text-gov-blue mr-3 w-4"></i><span class="text-sm">Categoría</span></button>
            <button data-k="giroNombre" class="filter-opt w-full text-left px-3 py-2 hover:bg-gray-100 rounded-lg flex items-center"><i class="fas fa-briefcase text-gov-blue mr-3 w-4"></i><span class="text-sm">Tipo de negocio</span></button>
            <button data-k="estado" class="filter-opt w-full text-left px-3 py-2 hover:bg-gray-100 rounded-lg flex items-center"><i class="fas fa-toggle-on text-gov-blue mr-3 w-4"></i><span class="text-sm">Estado</span></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <div class="bg-white rounded-xl shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Negocio</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Propietario</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contacto</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
          </tr>
        </thead>
        <tbody id="business-table-body" class="bg-white divide-y divide-gray-200"></tbody>
      </table>
    </div>
    <div id="empty-business-state" class="text-center py-12 hidden">
      <div class="bg-gray-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-store text-gray-400 text-2xl"></i>
      </div>
      <h3 class="text-lg font-medium text-gray-800 mb-2">No hay negocios registrados</h3>
      <p class="text-gov-gray">Los negocios aparecerán aquí cuando se registren desde el portal público.</p>
    </div>
  </div>
</section>

<script>
(function(){
  let LS_KEY='negocios';
  const modalWizard = document.getElementById('business-wizard-modal');
  const wizardContent = document.getElementById('bw-content');

  const defaultNegocios = [
    { id:1, nombre:"Restaurante El Sabor", propietario:"María González Hernández", giro:"restaurante", categoria:"alimentos", categoriaNombre:"Alimentos y Bebidas", giroNombre:"Restaurante", telefono:"(873) 742-1234", email:"elsabor@email.com", direccion:"Calle Hidalgo #123, Centro", horarioApertura:"08:00", horarioCierre:"22:00", horario:"08:00 - 22:00", tiposComida:["Mexicana","Antojitos"], serviciosGenerales:["domicilio","whatsapp","efectivo","tarjetas"], fechaRegistro:"2024-01-15", estado:"activo", icono:"fas fa-utensils"},
    { id:2, nombre:"Ferretería San José", propietario:"Juan Carlos Pérez Morales", giro:"ferreteria", categoria:"comercio", categoriaNombre:"Comercio y Ventas", giroNombre:"Ferretería", telefono:"(873) 742-5678", email:"ferreteria@email.com", direccion:"Av. Revolución #456, Col. Centro", horarioApertura:"07:00", horarioCierre:"19:00", horario:"07:00 - 19:00", productos:["Herramientas","Materiales de construcción","Plomería","Electricidad"], serviciosGenerales:["credito","mayoreo","menudeo","estacionamiento"], fechaRegistro:"2024-01-20", estado:"activo", icono:"fas fa-tools"},
    { id:3, nombre:"Panadería La Espiga", propietario:"Rosa María Castillo", giro:"panaderia", categoria:"alimentos", categoriaNombre:"Alimentos y Bebidas", giroNombre:"Panadería / Pastelería", telefono:"(873) 742-9012", email:"laespiga@email.com", direccion:"Calle Morelos #89, Centro", horarioApertura:"06:00", horarioCierre:"20:00", horario:"06:00 - 20:00", serviciosGenerales:["separado","whatsapp","efectivo"], fechaRegistro:"2024-02-01", estado:"activo", icono:"fas fa-bread-slice"},
    { id:4, nombre:"Farmacia Guadalupe", propietario:"Dr. Miguel Ángel Ruiz", giro:"farmacia", categoria:"salud", categoriaNombre:"Salud y Bienestar", giroNombre:"Farmacia", telefono:"(873) 742-3456", email:"farmacia.guadalupe@email.com", direccion:"Av. Juárez #234, Centro", horarioApertura:"08:00", horarioCierre:"21:00", horario:"08:00 - 21:00", servicios:["Medicamentos con receta","Medicamentos sin receta","Toma de presión","Inyecciones"], serviciosGenerales:["domicilio","tarjetas","transferencia"], fechaRegistro:"2024-01-10", estado:"activo", icono:"fas fa-pills"},
    { id:5, nombre:"Taller Mecánico El Rayo", propietario:"Roberto Sánchez López", giro:"mecanico", categoria:"servicios", categoriaNombre:"Servicios", giroNombre:"Taller Mecánico", telefono:"(873) 742-7890", email:"tallerelrayo@email.com", direccion:"Carretera Nacional Km 2.5", horarioApertura:"08:00", horarioCierre:"18:00", horario:"08:00 - 18:00", serviciosGenerales:["garantia","reparacion","mantenimiento","estacionamiento"], fechaRegistro:"2024-01-25", estado:"pendiente", icono:"fas fa-wrench"}
  ];

  function getAll(){
    const raw = localStorage.getItem(LS_KEY);
    if(!raw){ localStorage.setItem(LS_KEY, JSON.stringify(defaultNegocios)); return defaultNegocios.slice(); }
    try { return JSON.parse(raw); } catch { return defaultNegocios.slice(); }
  }
  function saveAll(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }

  const state = { filters:{}, rows:[] };

  function applyFilters(){
    const keys = Object.keys(state.filters);
    if(keys.length===0) return state.rows.slice();
    return state.rows.filter(n=>{
      return keys.every(k=>{
        const v = String(state.filters[k]||'').toLowerCase();
        return String(n[k]||'').toLowerCase().includes(v);
      });
    });
  }

  function render(){
    state.rows = getAll();
    const tb = document.getElementById('business-table-body');
    const empty = document.getElementById('empty-business-state');
    const total = document.getElementById('total-businesses');

    const list = applyFilters();
    total.textContent = list.length;

    if(list.length===0){
      tb.innerHTML = '';
      empty.classList.remove('hidden');
    }else{
      empty.classList.add('hidden');
      tb.innerHTML = list.map(negocio => {
        const statusBadge = negocio.estado === 'activo' ? 
          '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Activo</span>' :
          negocio.estado === 'pendiente' ?
          '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pendiente</span>' :
          '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Inactivo</span>';
        return `
          <tr class="hover:bg-gray-50 transition duration-200">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10">
                  <div class="h-10 w-10 rounded-lg bg-gov-blue bg-opacity-10 flex items-center justify-center">
                    <i class="${negocio.icono} text-gov-blue"></i>
                  </div>
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900">${negocio.nombre}</div>
                  <div class="text-sm text-gray-500">${negocio.giroNombre || negocio.giro}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">${negocio.propietario}</div>
              <div class="text-sm text-gray-500">${negocio.fechaRegistro || 'N/A'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">${negocio.categoriaNombre || 'Sin categoría'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="text-sm text-gray-900">${negocio.telefono}</div>
              <div class="text-sm text-gray-500">${negocio.email || 'Sin email'}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <button data-id="${negocio.id}" class="n-view text-gov-blue hover:text-blue-700 mr-3" title="Ver"><i class="fas fa-eye"></i></button>
              <button data-id="${negocio.id}" class="n-toggle text-yellow-600 hover:text-yellow-700 mr-3" title="Cambiar estado"><i class="fas fa-toggle-on"></i></button>
              <button data-id="${negocio.id}" class="n-del text-red-600 hover:text-red-700" title="Eliminar"><i class="fas fa-trash"></i></button>
            </td>
          </tr>`;
      }).join('');
    }

    // Bind row actions
    document.querySelectorAll('.n-toggle').forEach(b=>b.onclick=()=>toggleStatus(+b.dataset.id));
    document.querySelectorAll('.n-del').forEach(b=>b.onclick=()=>removeBusiness(+b.dataset.id));
    document.querySelectorAll('.n-view').forEach(b=>b.onclick=()=>viewBusiness(+b.dataset.id));
  }

  function toggleStatus(id){
    const arr = getAll();
    const i = arr.findIndex(x=>x.id===id);
    const order = ['pendiente','activo','inactivo'];
    const next = order[(order.indexOf(arr[i].estado)+1)%order.length];
    arr[i].estado = next;
    saveAll(arr);
    render();
  }

  function removeBusiness(id){
    const arr = getAll().filter(x=>x.id!==id);
    saveAll(arr);
    render();
  }

  function viewBusiness(id){
    const it = getAll().find(x=>x.id===id);
    if(!it) return;
    modalWizard.classList.remove('hidden');
    wizardContent.innerHTML = `
      <div class="space-y-4">
        <div class="flex items-center">
          <div class="bg-gov-blue bg-opacity-10 p-3 rounded-lg mr-3"><i class="${it.icono} text-gov-blue text-xl"></i></div>
          <div>
            <h4 class="text-xl font-bold text-gray-800">${it.nombre}</h4>
            <p class="text-gov-gray">${it.giroNombre || it.giro} · ${it.categoriaNombre || ''}</p>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><span class="text-sm text-gov-gray">Propietario</span><p class="font-medium">${it.propietario}</p></div>
          <div><span class="text-sm text-gov-gray">Contacto</span><p class="font-medium">${it.telefono} · ${it.email || '—'}</p></div>
          <div class="md:col-span-2"><span class="text-sm text-gov-gray">Dirección</span><p class="font-medium">${it.direccion || '—'}</p></div>
          <div><span class="text-sm text-gov-gray">Horario</span><p class="font-medium">${it.horario || `${it.horarioApertura||''} - ${it.horarioCierre||''}`}</p></div>
          <div><span class="text-sm text-gov-gray">Estado</span><p class="font-medium capitalize">${it.estado}</p></div>
        </div>
      </div>`;
  }

  // Filters UI
  const addFilterBtn = document.getElementById('add-filter-btn');
  const dd = document.getElementById('filter-dropdown');
  const af = document.getElementById('active-filters');
  const clearBtn = document.getElementById('clear-filters-btn');

  addFilterBtn.onclick = ()=> dd.classList.toggle('hidden');
  document.querySelectorAll('.filter-opt').forEach(btn=>{
    btn.onclick = ()=>{
      dd.classList.add('hidden');
      const k = btn.dataset.k;
      const id = `flt-${k}`;
      if(document.getElementById(id)) return;
      af.classList.remove('hidden');
      clearBtn.classList.remove('hidden');
      const chip = document.createElement('div');
      chip.className='flex items-center gap-2 px-2 py-1 bg-gray-100 rounded';
      chip.id = id;
      chip.innerHTML = `
        <span class="text-xs font-medium">${k}</span>
        <input data-k="${k}" class="text-xs px-2 py-1 border rounded bg-white" placeholder="valor..." />
        <button title="Quitar" class="rm text-red-600"><i class="fas fa-times"></i></button>`;
      af.appendChild(chip);
      chip.querySelector('input').addEventListener('input', (e)=>{
        const key = e.target.dataset.k;
        state.filters[key] = e.target.value;
        render();
      });
      chip.querySelector('.rm').onclick = ()=>{
        delete state.filters[k];
        chip.remove();
        if(af.children.length===0){ af.classList.add('hidden'); clearBtn.classList.add('hidden'); }
        render();
      };
    };
  });
  clearBtn.onclick = ()=>{
    state.filters = {};
    af.innerHTML = '';
    af.classList.add('hidden');
    clearBtn.classList.add('hidden');
    render();
  };

  // Export
  document.getElementById('btn-export').onclick = ()=>{
    const rows = applyFilters();
    const csv = [
      ['Nombre','Propietario','Categoría','Giro','Teléfono','Email','Dirección','Estado'].join(','),
      ...rows.map(n=>[n.nombre,n.propietario,n.categoriaNombre||'',n.giroNombre||n.giro,n.telefono,n.email||'',(n.direccion||'').replace(/,/g,' '),n.estado].join(','))
    ].join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download='negocios.csv'; a.click();
    URL.revokeObjectURL(url);
  };

  // Open wizard to add (simple form)
  document.getElementById('btn-add-business').onclick = ()=>{
    modalWizard.classList.remove('hidden');
    wizardContent.innerHTML = `
      <form id="new-business" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="text-sm text-gray-700">Nombre *</label><input required name="nombre" class="w-full px-3 py-2 border rounded"/></div>
          <div><label class="text-sm text-gray-700">Propietario *</label><input required name="propietario" class="w-full px-3 py-2 border rounded"/></div>
          <div><label class="text-sm text-gray-700">Teléfono *</label><input required name="telefono" class="w-full px-3 py-2 border rounded"/></div>
          <div><label class="text-sm text-gray-700">Email</label><input name="email" class="w-full px-3 py-2 border rounded"/></div>
          <div class="md:col-span-2"><label class="text-sm text-gray-700">Dirección *</label><input required name="direccion" class="w-full px-3 py-2 border rounded"/></div>
          <div><label class="text-sm text-gray-700">Categoría</label><input name="categoriaNombre" placeholder="Alimentos y Bebidas..." class="w-full px-3 py-2 border rounded"/></div>
          <div><label class="text-sm text-gray-700">Giro</label><input name="giroNombre" placeholder="Restaurante..." class="w-full px-3 py-2 border rounded"/></div>
        </div>
        <div class="flex justify-end">
          <button class="px-6 py-2 bg-gov-blue text-white rounded hover:bg-blue-700">Guardar</button>
        </div>
      </form>`;
    document.getElementById('new-business').onsubmit = (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const n = Object.fromEntries(fd.entries());
      const arr = getAll();
      arr.push({
        id: Date.now(),
        nombre: n.nombre, propietario: n.propietario, telefono: n.telefono, email: n.email||'',
        direccion: n.direccion, categoriaNombre: n.categoriaNombre||'', giroNombre: n.giroNombre||'',
        estado: 'pendiente', icono: 'fas fa-store', fechaRegistro: new Date().toISOString().slice(0,10)
      });
      saveAll(arr);
      modalWizard.classList.add('hidden');
      render();
    };
  };

  // seed once & render
  getAll(); 
  render();
})();
</script>
