<section id="BusinessAdmin" data-bound="0" class="p-6 bg-gray-50">
  <!-- Top -->
  <div class="mb-6 flex items-center justify-between">
    <div>
      <h2 class="text-2xl font-bold text-gray-800">Directorio de Negocios (Admin)</h2>
      <p class="text-gray-600">Alta, edición y consulta.</p>
    </div>
    <div class="flex gap-2">
      <button id="biz-add-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
        <i class="fas fa-plus mr-2"></i>Nuevo negocio
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
      <div class="md:col-span-2">
        <div class="relative">
          <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
          <input id="biz-search" type="text" placeholder="Buscar por nombre, giro, dirección..."
                 class="w-full pl-10 pr-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
        </div>
      </div>
      <div>
        <select id="biz-filter-categoria" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="">Todas las categorías</option>
          <option value="alimentos">Alimentos y Bebidas</option>
          <option value="comercio">Comercio y Ventas</option>
          <option value="servicios">Servicios</option>
          <option value="salud">Salud y Bienestar</option>
          <option value="educacion">Educación, Cultura y Entretenimiento</option>
        </select>
      </div>
      <div>
        <select id="biz-filter-giro" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="">Todos los giros</option>
          <option value="restaurante">Restaurante</option>
          <option value="servicar">Servicar</option>
          <option value="fondita">Fondita / Cocina económica</option>
          <option value="comida_casera">Comidas caseras por días</option>
          <option value="comida_ambulante">Comida ambulante / Puesto</option>
          <option value="food_truck">Food truck</option>
          <option value="panaderia">Panadería / Pastelería</option>
          <option value="otro_alimentos">Otro (Alimentos)</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="bg-white rounded-xl shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50 border-b">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">Nombre</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">Categoría</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">Giro</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">Teléfono</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase">Dirección</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-600 uppercase">Acciones</th>
          </tr>
        </thead>
        <tbody id="biz-table-body" class="divide-y"></tbody>
      </table>
    </div>
    <div id="biz-empty" class="py-10 text-center text-gray-600 hidden">
      No hay registros. Agrega tu primer negocio.
    </div>
  </div>

  <!-- Drawer (dashboard) -->
  <div id="biz-drawer" class="fixed inset-y-0 right-0 w-full md:w-[560px] bg-white shadow-2xl translate-x-full transition-transform duration-300 z-50 overflow-y-auto">
    <div class="p-5 border-b flex items-center justify-between">
      <h3 class="text-xl font-bold text-gray-800" id="biz-drawer-title">Detalle del Negocio</h3>
      <button id="biz-drawer-close" class="text-gray-500 hover:text-gray-800 text-xl">&times;</button>
    </div>
    <div id="biz-drawer-content" class="p-5 space-y-6"></div>
  </div>

  <!-- Wizard Modal -->
  <div id="biz-wizard-modal" class="fixed inset-0 bg-black/50 hidden z-50 items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b flex items-center justify-between">
        <h3 class="text-2xl font-bold text-gray-800" id="biz-wizard-title">Nuevo Negocio</h3>
        <button id="biz-wizard-close" class="text-gray-400 hover:text-gray-700 text-xl">&times;</button>
      </div>

      <!-- Step indicators -->
      <div id="wiz-indicators" class="px-6 py-3 flex items-center gap-3 border-b"></div>

      <!-- Steps -->
      <div class="p-6" id="wiz-steps"></div>

      <div class="p-6 border-t flex justify-between">
        <button id="wiz-prev" class="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-50 hidden"><i class="fas fa-arrow-left mr-2"></i>Anterior</button>
        <div class="flex gap-2">
          <button id="wiz-cancel" class="px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-50">Cancelar</button>
          <button id="wiz-next" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Siguiente <i class="fas fa-arrow-right ml-2"></i></button>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
(function(){
  "use strict";

  const STORAGE_KEY = "admin.negocios.v1";
  let negocios = [];
  let filtered = [];
  let currentEditId = null;

  // ========= Catalogs from your page =========
  const GENERAL_SERVICES_CATALOG = {
    domicilio:{label:"Servicio a domicilio",icon:"fas fa-truck"},
    separado:{label:"Apartado/Separado",icon:"fas fa-bookmark"},
    credito:{label:"Venta a crédito",icon:"fas fa-credit-card"},
    whatsapp:{label:"Pedidos por WhatsApp",icon:"fab fa-whatsapp"},
    facebook:{label:"Ventas por Facebook",icon:"fab fa-facebook"},
    efectivo:{label:"Solo efectivo",icon:"fas fa-money-bill-wave"},
    tarjetas:{label:"Acepta tarjetas",icon:"fas fa-credit-card"},
    transferencia:{label:"Transferencias",icon:"fas fa-mobile-alt"},
    mayoreo:{label:"Venta al mayoreo",icon:"fas fa-boxes"},
    menudeo:{label:"Venta al menudeo",icon:"fas fa-shopping-basket"},
    instalacion:{label:"Instalación",icon:"fas fa-tools"},
    garantia:{label:"Garantía",icon:"fas fa-shield-alt"},
    reparacion:{label:"Reparación",icon:"fas fa-wrench"},
    mantenimiento:{label:"Mantenimiento",icon:"fas fa-cogs"},
    estacionamiento:{label:"Estacionamiento",icon:"fas fa-parking"},
    wifi:{label:"WiFi gratuito",icon:"fas fa-wifi"},
    aire:{label:"Aire acondicionado",icon:"fas fa-snowflake"},
    accesible:{label:"Acceso discapacitados",icon:"fas fa-wheelchair"},
  };

  const BUSINESS_CATEGORIES = {
    alimentos:{ id:"alimentos", name:"Alimentos y Bebidas", generalServices:["domicilio","whatsapp","efectivo","tarjetas","estacionamiento","wifi","aire","accesible"],
      subcategories:[
        { id:"restaurante", name:"Restaurante" },
        { id:"servicar", name:"Servicar" , generalServices:["domicilio","efectivo","tarjetas","aire"]},
        { id:"fondita", name:"Fondita / Cocina económica" },
        { id:"comida_casera", name:"Comidas caseras por días", generalServices:["whatsapp","domicilio","efectivo"] },
        { id:"comida_ambulante", name:"Comida ambulante / Puesto", generalServices:["efectivo","whatsapp"] },
        { id:"food_truck", name:"Carro de comida / Food truck", generalServices:["efectivo","tarjetas"] },
        { id:"panaderia", name:"Panadería / Pastelería" },
        { id:"otro_alimentos", name:"Otro (Alimentos)" },
      ]
    },
    comercio:{ id:"comercio", name:"Comercio y Ventas", generalServices:["tarjetas","transferencia","mayoreo","menudeo","garantia"], subcategories:[] },
    servicios:{ id:"servicios", name:"Servicios", generalServices:["garantia","reparacion","mantenimiento","whatsapp","transferencia"], subcategories:[] },
    salud:{ id:"salud", name:"Salud y Bienestar", generalServices:["tarjetas","transferencia","accesible"], subcategories:[] },
    educacion:{ id:"educacion", name:"Educación, Cultura y Entretenimiento", generalServices:["tarjetas","transferencia","wifi","accesible"], subcategories:[] },
  };

  // ========= Wizard state =========
  let wiz = {};
  let stepIdx = 0;

  const TEMPLATES = {
    general: () => `
      <h4 class="text-lg font-semibold text-gray-800 mb-4">Información general</h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="text-sm text-gray-700">Nombre *</label>
          <input id="w-name" class="mt-1 w-full border rounded-lg px-3 py-2" required>
        </div>
        <div><label class="text-sm text-gray-700">Propietario *</label>
          <input id="w-owner" class="mt-1 w-full border rounded-lg px-3 py-2" required>
        </div>
        <div><label class="text-sm text-gray-700">Teléfono *</label>
          <input id="w-phone" type="tel" class="mt-1 w-full border rounded-lg px-3 py-2" required>
        </div>
        <div><label class="text-sm text-gray-700">Email</label>
          <input id="w-email" type="email" class="mt-1 w-full border rounded-lg px-3 py-2">
        </div>
        <div class="md:col-span-2"><label class="text-sm text-gray-700">Dirección *</label>
          <input id="w-address" class="mt-1 w-full border rounded-lg px-3 py-2" required>
        </div>
        <div><label class="text-sm text-gray-700">Apertura</label>
          <input id="w-open" type="time" class="mt-1 w-full border rounded-lg px-3 py-2">
        </div>
        <div><label class="text-sm text-gray-700">Cierre</label>
          <input id="w-close" type="time" class="mt-1 w-full border rounded-lg px-3 py-2">
        </div>
      </div>
    `,
    giro: () => {
      const catOptions = Object.values(BUSINESS_CATEGORIES).map(c => `<option value="${c.id}">${c.name}</option>`).join("");
      const subGrid = `<div id="w-subgrid" class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3"></div>`;
      return `
        <h4 class="text-lg font-semibold text-gray-800 mb-4">Giro y servicios</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-gray-700">Categoría *</label>
            <select id="w-category" class="mt-1 w-full border rounded-lg px-3 py-2">
              <option value="">Selecciona...</option>${catOptions}
            </select>
            <div class="mt-4">
              <label class="text-sm text-gray-700">Giro *</label>
              ${subGrid}
              <div id="w-custom" class="hidden mt-2">
                <input id="w-giro-custom" placeholder="Especifica tu tipo de negocio" class="w-full border rounded-lg px-3 py-2">
              </div>
            </div>
          </div>
          <div>
            <label class="text-sm text-gray-700">Servicios generales</label>
            <div id="w-services" class="mt-2 grid grid-cols-1 gap-2"></div>
          </div>
        </div>
      `;
    },
    detalles: () => `
      <h4 class="text-lg font-semibold text-gray-800 mb-4">Detalles específicos</h4>
      <div id="w-specific"></div>
    `,
    confirm: () => `
      <h4 class="text-lg font-semibold text-gray-800 mb-4">Confirmación</h4>
      <div id="w-confirm" class="bg-gray-50 border rounded-lg p-4 text-sm"></div>
    `,
  };

  const STEPS = [
    {
      key:"general", label:"General", render:TEMPLATES.general,
      validate: () => ["w-name","w-owner","w-phone","w-address"].every(id => document.getElementById(id)?.value.trim()),
      save: () => {
        wiz.nombre = v("w-name"); wiz.propietario = v("w-owner");
        wiz.telefono = v("w-phone"); wiz.email = v("w-email"); wiz.direccion = v("w-address");
        const o=v("w-open"), c=v("w-close"); wiz.horario = (o && c) ? `${o} - ${c}` : "";
      }
    },
    {
      key:"giro", label:"Giro", render:TEMPLATES.giro,
      validate: () => !!wiz.categoria && !!wiz.giro,
      save: () => {
        if (wiz.giro?.includes("otro")) { const t = v("w-giro-custom"); if (t) wiz.giroNombre = t; }
      },
      onEnter: () => initGiroUi()
    },
    {
      key:"detalles", label:"Detalles", render:TEMPLATES.detalles,
      validate: () => true,
      onEnter: () => renderSpecific()
    },
    {
      key:"confirm", label:"Confirmar", render:TEMPLATES.confirm,
      validate: () => true,
      onEnter: () => renderConfirm()
    },
  ];

  // ========= Init =========
  function init(){
    const root = document.getElementById("BusinessAdmin");
    if (!root || root.dataset.bound==="1") return;
    root.dataset.bound="1";

    load();
    bind();
    filtered = [...negocios];
    renderTable();
  }
  if (document.readyState==="loading") document.addEventListener("DOMContentLoaded", init); else init();

  // ========= Storage =========
  function load(){
    const s = localStorage.getItem(STORAGE_KEY);
    if (s) negocios = JSON.parse(s);
    else {
      negocios = [
        { id: "n1", nombre:"Pizzería Don Carlos", propietario:"Carlos D.", categoria:"alimentos", categoriaNombre:"Alimentos y Bebidas", giro:"restaurante", giroNombre:"Restaurante", telefono:"(824) 555-0101", email:"", direccion:"Calle Hidalgo #123, Centro", horario:"12:00 - 22:00", servicios:["domicilio","tarjetas","wifi"], tiposComida:["Pizza","Italiana"], menu:[{nombre:"Pizza Pepperoni",precio:190}] },
        { id: "n2", nombre:"Café Central", propietario:"María G.", categoria:"alimentos", categoriaNombre:"Alimentos y Bebidas", giro:"restaurante", giroNombre:"Restaurante", telefono:"(824) 555-0106", email:"", direccion:"Plaza de Armas #1", horario:"07:00 - 22:00", servicios:["efectivo","wifi","aire"] },
      ];
      save();
    }
  }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(negocios)); }

  // ========= Helpers =========
  const v = (id) => document.getElementById(id)?.value?.trim() || "";

  function badge(txt, cls){ return `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs ${cls}">${txt}</span>`; }
  function serviceBadge(key){
    const s = GENERAL_SERVICES_CATALOG[key]; if (!s) return "";
    return `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs bg-blue-50 text-blue-700"><i class="${s.icon}"></i>${s.label}</span>`;
  }

  // ========= Filters =========
  function applyFilters(){
    const q = document.getElementById("biz-search").value.toLowerCase();
    const cat = document.getElementById("biz-filter-categoria").value;
    const giro = document.getElementById("biz-filter-giro").value;

    filtered = negocios.filter(n=>{
      const blob = `${n.nombre} ${n.giroNombre||""} ${n.direccion||""}`.toLowerCase();
      const okQ = !q || blob.includes(q);
      const okC = !cat || n.categoria===cat;
      const okG = !giro || n.giro===giro;
      return okQ && okC && okG;
    });
    renderTable();
  }

  // ========= Table =========
  function renderTable(){
    const tb = document.getElementById("biz-table-body");
    const empty = document.getElementById("biz-empty");
    if (!filtered.length){ tb.innerHTML=""; empty.classList.remove("hidden"); return; }
    empty.classList.add("hidden");

    tb.innerHTML = filtered.map(n => `
      <tr class="hover:bg-gray-50 cursor-pointer" data-id="${n.id}">
        <td class="px-6 py-3 text-sm text-gray-800">${n.nombre}</td>
        <td class="px-6 py-3 text-sm">${badge(n.categoriaNombre||catName(n.categoria),"bg-gray-100 text-gray-800")}</td>
        <td class="px-6 py-3 text-sm">${n.giroNombre || n.giro || ""}</td>
        <td class="px-6 py-3 text-sm">${n.telefono||""}</td>
        <td class="px-6 py-3 text-sm">${n.direccion||""}</td>
        <td class="px-6 py-3 text-right text-sm">
          <button class="text-blue-600 hover:text-blue-800 mr-3" data-action="edit"><i class="fas fa-edit"></i></button>
          <button class="text-red-600 hover:text-red-800" data-action="delete"><i class="fas fa-trash"></i></button>
        </td>
      </tr>
    `).join("");

    // Row interactions
    tb.querySelectorAll("tr").forEach(tr=>{
      const id = tr.getAttribute("data-id");
      tr.addEventListener("click", ()=> openDrawer(id));
      tr.querySelectorAll("button").forEach(btn=>{
        btn.addEventListener("click",(e)=>{
          e.stopPropagation();
          const action = btn.getAttribute("data-action");
          if (action==="edit") openWizard(id);
          if (action==="delete") del(id);
        });
      });
    });
  }

  function catName(id){ return BUSINESS_CATEGORIES[id]?.name || id || ""; }

  // ========= Drawer (dashboard) =========
  function openDrawer(id){
    const n = negocios.find(x=>x.id===id);
    if(!n) return;
    document.getElementById("biz-drawer-title").textContent = n.nombre;

    const info = `
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4">
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div><span class="text-gray-600">Propietario</span><div class="font-medium">${n.propietario||"-"}</div></div>
          <div><span class="text-gray-600">Teléfono</span><div class="font-medium">${n.telefono||"-"}</div></div>
          <div><span class="text-gray-600">Email</span><div class="font-medium">${n.email||"-"}</div></div>
          <div><span class="text-gray-600">Horario</span><div class="font-medium">${n.horario||"-"}</div></div>
          <div class="col-span-2"><span class="text-gray-600">Dirección</span><div class="font-medium">${n.direccion||"-"}</div></div>
          <div><span class="text-gray-600">Categoría</span><div class="font-medium">${n.categoriaNombre||catName(n.categoria)}</div></div>
          <div><span class="text-gray-600">Giro</span><div class="font-medium">${n.giroNombre||n.giro||"-"}</div></div>
        </div>
      </div>`;

    const servicios = (n.servicios||[]).map(serviceBadge).join(" ") || '<span class="text-gray-500 text-sm">Sin servicios registrados</span>';

    const tipos = (n.tiposComida||[]).map(t=>badge(t,"bg-green-50 text-green-700")).join(" ");

    const menu = (n.menu||[]).length
      ? n.menu.map(m=>`<div class="flex justify-between border rounded p-2"><span>${m.nombre}</span><span>$ ${Number(m.precio).toFixed(2)}</span></div>`).join("")
      : '<span class="text-gray-500 text-sm">Sin menú</span>';

    document.getElementById("biz-drawer-content").innerHTML = `
      <div class="space-y-6">
        ${info}
        <div>
          <h4 class="font-semibold text-gray-800 mb-2">Servicios</h4>
          <div class="flex flex-wrap gap-2">${servicios}</div>
        </div>
        ${(n.giro==="restaurante") ? `
          <div>
            <h4 class="font-semibold text-gray-800 mb-2">Tipos de comida</h4>
            <div class="flex flex-wrap gap-2">${tipos || '<span class="text-gray-500 text-sm">No especificado</span>'}</div>
          </div>
          <div>
            <h4 class="font-semibold text-gray-800 mb-2">Menú</h4>
            <div class="space-y-2">${menu}</div>
          </div>
        ` : ""}

        <div class="pt-2 border-t flex gap-2">
          <button class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" onclick="document.getElementById('biz-drawer-close').click();openWizard('${n.id}')"><i class="fas fa-edit mr-1"></i>Editar</button>
          <button class="px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700" onclick="del('${n.id}')"><i class="fas fa-trash mr-1"></i>Eliminar</button>
        </div>
      </div>
    `;

    document.getElementById("biz-drawer").classList.remove("translate-x-full");
  }
  document.getElementById("biz-drawer-close").addEventListener("click",()=>{
    document.getElementById("biz-drawer").classList.add("translate-x-full");
  });

  // ========= Wizard =========
  function openWizard(id=null){
    currentEditId = id;
    wiz = {};
    stepIdx = 0;
    document.getElementById("biz-wizard-title").textContent = id ? "Editar Negocio" : "Nuevo Negocio";
    renderIndicators();
    renderSteps();
    if (id) prefill(id);
    updateNav();
    document.getElementById("biz-wizard-modal").classList.remove("hidden");
    document.getElementById("biz-wizard-modal").classList.add("flex");
  }
  function closeWizard(){
    document.getElementById("biz-wizard-modal").classList.add("hidden");
    document.getElementById("biz-wizard-modal").classList.remove("flex");
  }

  function renderIndicators(){
    const wrap = document.getElementById("wiz-indicators");
    wrap.innerHTML = STEPS.map((s,i)=>`
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${i<=stepIdx?'bg-blue-600 text-white':'bg-gray-300 text-gray-700'}">${i+1}</div>
        <span class="text-sm ${i<=stepIdx?'text-blue-700':'text-gray-600'}">${s.label}</span>
        ${i<STEPS.length-1?'<div class="w-10 h-[2px] bg-gray-200"></div>':''}
      </div>
    `).join("");
  }
  function renderSteps(){
    const body = document.getElementById("wiz-steps");
    body.innerHTML = STEPS.map((s,i)=>`<div class="${i===stepIdx?'':'hidden'}">${s.render()}</div>`).join("");
    STEPS[stepIdx].onEnter && STEPS[stepIdx].onEnter();
  }
  function updateNav(){
    document.getElementById("wiz-prev").classList.toggle("hidden", stepIdx===0);
    document.getElementById("wiz-next").innerHTML = stepIdx===STEPS.length-1 ? '<i class="fas fa-check mr-2"></i>Guardar' : 'Siguiente <i class="fas fa-arrow-right ml-2"></i>';
    renderIndicators();
  }

  // Giro UI
  function initGiroUi(){
    const sel = document.getElementById("w-category");
    sel.addEventListener("change", ()=>{
      wiz.categoria = sel.value || null;
      wiz.categoriaNombre = catName(sel.value);
      renderSubcats();
      renderServices();
    });
    // restore if editing
    if (wiz.categoria){ sel.value = wiz.categoria; renderSubcats(); renderServices(); }
  }
  function renderSubcats(){
    const grid = document.getElementById("w-subgrid");
    const custom = document.getElementById("w-custom");
    const cat = BUSINESS_CATEGORIES[wiz.categoria]; if(!cat){ grid.innerHTML=""; return; }
    grid.innerHTML = cat.subcategories.map(s=>`
      <button type="button" class="text-left p-3 border rounded hover:border-blue-500 ${wiz.giro===s.id?'ring-2 ring-blue-500 bg-blue-50':''}" data-id="${s.id}">
        ${s.name}
      </button>
    `).join("");
    grid.querySelectorAll("button").forEach(b=>{
      b.addEventListener("click", ()=>{
        grid.querySelectorAll("button").forEach(x=>x.classList.remove("ring-2","ring-blue-500","bg-blue-50"));
        b.classList.add("ring-2","ring-blue-500","bg-blue-50");
        wiz.giro = b.getAttribute("data-id");
        wiz.giroNombre = (cat.subcategories.find(x=>x.id===wiz.giro)?.name)||wiz.giro;
        // per-subcat services override
        const sub = cat.subcategories.find(x=>x.id===wiz.giro);
        renderServices(sub?.generalServices || cat.generalServices || []);
        // custom
        if (wiz.giro.includes("otro")) custom.classList.remove("hidden");
        else { custom.classList.add("hidden"); const ci=document.getElementById("w-giro-custom"); if(ci) ci.value=""; }
      });
    });
    // restore selected
    if (wiz.giro){
      const btn = grid.querySelector(`button[data-id="${wiz.giro}"]`);
      btn && btn.click();
    }
  }
  function renderServices(keys){
    const wrap = document.getElementById("w-services");
    const base = keys || (BUSINESS_CATEGORIES[wiz.categoria]?.generalServices || []);
    wrap.innerHTML = base.map(k=>{
      const meta = GENERAL_SERVICES_CATALOG[k]; if(!meta) return "";
      const checked = (wiz.servicios||[]).includes(k) ? "checked" : "";
      return `
        <label class="flex items-center gap-2 p-2 border rounded">
          <input type="checkbox" value="${k}" ${checked} class="w-service">
          <i class="${meta.icon} text-blue-600"></i>
          <span class="text-sm">${meta.label}</span>
        </label>`;
    }).join("");
    wrap.querySelectorAll(".w-service").forEach(ch=>{
      ch.addEventListener("change", ()=>{
        wiz.servicios = [...document.querySelectorAll(".w-service")].filter(x=>x.checked).map(x=>x.value);
      });
    });
  }

  // Specific details
  function renderSpecific(){
    const c = document.getElementById("w-specific");
    if (!wiz.giro || wiz.giro!=="restaurante"){
      c.innerHTML = '<p class="text-gray-600 text-sm">Sin campos adicionales para este giro.</p>'; return;
    }
    const tags = ["Mexicana","Hamburguesas","Pizza","Mariscos","Tacos","Comida Rápida","Antojitos","Internacional"];
    c.innerHTML = `
      <div class="space-y-5">
        <div>
          <label class="text-sm text-gray-700">Tipo de comida</label>
          <div class="mt-2 flex flex-wrap gap-2" id="w-foodtags">
            ${tags.map(t=>`<button type="button" class="px-3 py-1 border rounded text-sm ${ (wiz.tiposComida||[]).includes(t)?'bg-blue-50 ring-1 ring-blue-400':''}" data-t="${t}">${t}</button>`).join("")}
          </div>
        </div>
        <div>
          <label class="text-sm text-gray-700 mb-2 block">Menú (opcional)</label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
            <input id="w-menu-name" placeholder="Platillo" class="border rounded px-3 py-2">
            <input id="w-menu-price" type="number" step="0.01" min="0" placeholder="Precio" class="border rounded px-3 py-2">
          </div>
          <button id="w-menu-add" class="mt-2 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"><i class="fas fa-plus mr-1"></i>Agregar</button>
          <div id="w-menu-list" class="mt-3 space-y-2"></div>
        </div>
      </div>
    `;
    const list = document.getElementById("w-menu-list");
    function paintMenu(){
      list.innerHTML = (wiz.menu||[]).map((m,i)=>`
        <div class="flex justify-between border rounded p-2 text-sm">
          <span>${m.nombre}</span><span>$ ${Number(m.precio).toFixed(2)}</span>
          <button class="text-red-600 ml-2" data-del="${i}"><i class="fas fa-times"></i></button>
        </div>`).join("");
      list.querySelectorAll("[data-del]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const idx = Number(b.getAttribute("data-del"));
          wiz.menu.splice(idx,1); paintMenu();
        });
      });
    }
    paintMenu();
    document.getElementById("w-menu-add").addEventListener("click",(e)=>{
      e.preventDefault();
      const n = v("w-menu-name"); const p = parseFloat(document.getElementById("w-menu-price").value || "0");
      if(!n || !p){ alert("Completa platillo y precio."); return; }
      wiz.menu = wiz.menu || []; wiz.menu.push({nombre:n,precio:p}); paintMenu();
      document.getElementById("w-menu-name").value=""; document.getElementById("w-menu-price").value="";
    });
    document.querySelectorAll("#w-foodtags button").forEach(b=>{
      b.addEventListener("click", ()=>{
        const t=b.getAttribute("data-t"); wiz.tiposComida = wiz.tiposComida||[];
        const i = wiz.tiposComida.indexOf(t); if(i>=0) wiz.tiposComida.splice(i,1); else wiz.tiposComida.push(t);
        b.classList.toggle("bg-blue-50"); b.classList.toggle("ring-1"); b.classList.toggle("ring-blue-400");
      });
    });
  }

  // Confirm
  function renderConfirm(){
    const div = document.getElementById("w-confirm");
    div.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div><span class="text-gray-500">Nombre</span><div class="font-medium">${wiz.nombre||""}</div></div>
        <div><span class="text-gray-500">Propietario</span><div class="font-medium">${wiz.propietario||""}</div></div>
        <div><span class="text-gray-500">Teléfono</span><div class="font-medium">${wiz.telefono||""}</div></div>
        <div><span class="text-gray-500">Email</span><div class="font-medium">${wiz.email||""}</div></div>
        <div class="md:col-span-2"><span class="text-gray-500">Dirección</span><div class="font-medium">${wiz.direccion||""}</div></div>
        <div><span class="text-gray-500">Categoría</span><div class="font-medium">${wiz.categoriaNombre||catName(wiz.categoria)}</div></div>
        <div><span class="text-gray-500">Giro</span><div class="font-medium">${wiz.giroNombre||wiz.giro||""}</div></div>
      </div>
    `;
  }

  // ========= CRUD =========
  function upsert(){
    const rec = {
      id: currentEditId || (Date.now().toString(36)+Math.random().toString(36).slice(2,8)),
      nombre: wiz.nombre, propietario: wiz.propietario, telefono: wiz.telefono, email: wiz.email,
      direccion: wiz.direccion, horario: wiz.horario,
      categoria: wiz.categoria, categoriaNombre: wiz.categoriaNombre,
      giro: wiz.giro, giroNombre: wiz.giroNombre,
      servicios: wiz.servicios || [],
      tiposComida: wiz.tiposComida || [],
      menu: wiz.menu || [],
    };
    const i = negocios.findIndex(x=>x.id===rec.id);
    if (i>-1) negocios[i]=rec; else negocios.unshift(rec);
    save(); applyFilters(); closeWizard();
  }
  function del(id){
    const n = negocios.find(x=>x.id===id); if(!n) return;
    if (!confirm(`¿Eliminar "${n.nombre}"?`)) return;
    negocios = negocios.filter(x=>x.id!==id);
    save(); applyFilters();
    // close drawer if open
    document.getElementById("biz-drawer").classList.add("translate-x-full");
  }

  function prefill(id){
    const n = negocios.find(x=>x.id===id); if(!n) return;
    wiz = JSON.parse(JSON.stringify(n)); // clone
    // prefill step 1 when rendered
    setTimeout(()=>{
      document.getElementById("w-name").value = n.nombre||"";
      document.getElementById("w-owner").value = n.propietario||"";
      document.getElementById("w-phone").value = n.telefono||"";
      document.getElementById("w-email").value = n.email||"";
      document.getElementById("w-address").value = n.direccion||"";
      const times = (n.horario||"").split(" - ");
      if (times[0]) document.getElementById("w-open").value = times[0];
      if (times[1]) document.getElementById("w-close").value = times[1];
    },0);
  }

  // ========= Bindings =========
  function bind(){
    // buttons
    document.getElementById("biz-add-btn").addEventListener("click", ()=>openWizard());
    document.getElementById("biz-wizard-close").addEventListener("click", closeWizard);
    document.getElementById("wiz-cancel").addEventListener("click", closeWizard);
    document.getElementById("wiz-prev").addEventListener("click", ()=>{
      if (stepIdx>0){ stepIdx--; renderSteps(); updateNav(); }
    });
    document.getElementById("wiz-next").addEventListener("click", ()=>{
      const step = STEPS[stepIdx];
      // gather & validate
      step.save && step.save();
      if (step.validate && !step.validate()){ alert("Completa los campos obligatorios."); return; }
      if (stepIdx<STEPS.length-1){ stepIdx++; renderSteps(); updateNav(); }
      else { upsert(); }
    });

    // filters
    ["biz-search","biz-filter-categoria","biz-filter-giro"].forEach(id=>{
      const el=document.getElementById(id); el.addEventListener("input", applyFilters); el.addEventListener("change", applyFilters);
    });
  }

  // ========= Expose (optional) =========
  window.openWizard = openWizard;
  window.del = del;

})(); 
</script>
