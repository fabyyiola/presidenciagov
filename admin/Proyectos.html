<section
  id="ProjectsAdmin"
  class="p-6 bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen"
>
  <!-- Top Controls -->
  <div class="mb-8">
    <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-800 mb-2">
          Proyectos Municipales
        </h1>
        <p class="text-gray-600">
          Gestión integral de proyectos e inversiones públicas
        </p>
      </div>
      <div class="flex flex-wrap gap-3 mt-4 lg:mt-0">
        <button
          id="projects-add-btn"
          class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 py-2 rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-200 flex items-center shadow-sm"
        >
          <i class="fas fa-plus mr-2"></i>
          Agregar Proyecto
        </button>
      </div>
    </div>

    <!-- Search and Filters -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
      <div class="flex flex-col lg:flex-row gap-4 mb-4">
        <div class="flex-1">
          <label for="projects-search" class="sr-only">Buscar proyectos</label>
          <div class="relative">
            <i
              class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
            ></i>
            <input
              type="text"
              id="projects-search"
              placeholder="Buscar proyectos... (presiona / para enfocar)"
              class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
        </div>
        <div class="flex flex-wrap gap-2">
          <select
            id="projects-filter-categoria"
            class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="">Todas las categorías</option>
            <option value="Infraestructura">Infraestructura</option>
            <option value="Desarrollo Social">Desarrollo Social</option>
            <option value="Medio Ambiente">Medio Ambiente</option>
            <option value="Tecnología">Tecnología</option>
            <option value="Educación">Educación</option>
            <option value="Salud">Salud</option>
          </select>
          <select
            id="projects-filter-estatus"
            class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="">Todos los estatus</option>
            <option value="Planificación">Planificación</option>
            <option value="En Progreso">En Progreso</option>
            <option value="Pausado">Pausado</option>
            <option value="Completado">Completado</option>
            <option value="Cancelado">Cancelado</option>
          </select>
          <input
            type="date"
            id="projects-filter-fecha-inicio"
            class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          <input
            type="date"
            id="projects-filter-fecha-fin"
            class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
      </div>
      <div id="projects-filter-chips" class="flex flex-wrap gap-2"></div>
    </div>
  </div>

  <!-- KPIs Row -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-2xl font-bold text-gray-800" id="projects-kpi-activos">
            0
          </p>
          <p class="text-gray-600 text-sm">Proyectos Activos</p>
        </div>
        <div class="bg-blue-100 p-3 rounded-lg">
          <i class="fas fa-project-diagram text-blue-600 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-green-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-2xl font-bold text-gray-800" id="projects-kpi-avance">
            0%
          </p>
          <p class="text-gray-600 text-sm">Avance Promedio</p>
        </div>
        <div class="bg-green-100 p-3 rounded-lg">
          <i class="fas fa-chart-line text-green-600 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-500">
      <div class="flex items-center justify-between">
        <div>
          <p
            class="text-2xl font-bold text-gray-800"
            id="projects-kpi-inversion"
          >
            $0
          </p>
          <p class="text-gray-600 text-sm">Inversión Total</p>
        </div>
        <div class="bg-purple-100 p-3 rounded-lg">
          <i class="fas fa-dollar-sign text-purple-600 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-indigo-500">
      <div class="flex items-center justify-between">
        <div>
          <p
            class="text-2xl font-bold text-gray-800"
            id="projects-kpi-beneficiarios"
          >
            0
          </p>
          <p class="text-gray-600 text-sm">Beneficiarios</p>
        </div>
        <div class="bg-indigo-100 p-3 rounded-lg">
          <i class="fas fa-users text-indigo-600 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-red-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-2xl font-bold text-gray-800" id="projects-kpi-riesgo">
            0
          </p>
          <p class="text-gray-600 text-sm">En Riesgo</p>
        </div>
        <div class="bg-red-100 p-3 rounded-lg">
          <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Projects Table -->
  <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-8">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead
          class="bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200"
        >
          <tr>
            <th
              class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Proyecto
            </th>
            <th
              class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Categoría
            </th>
            <th
              class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Inversión
            </th>
            <th
              class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Beneficiarios
            </th>
            <th
              class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Avance
            </th>
            <th
              class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Estatus
            </th>
            <th
              class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Tiempo
            </th>
            <th
              class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Acciones
            </th>
          </tr>
        </thead>
        <tbody
          id="projects-table-body"
          class="bg-white divide-y divide-gray-200"
        ></tbody>
      </table>
    </div>
    <div id="projects-empty-state" class="text-center py-12 hidden">
      <div
        class="bg-gray-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4"
      >
        <i class="fas fa-project-diagram text-gray-400 text-2xl"></i>
      </div>
      <h3 class="text-lg font-medium text-gray-800 mb-2">
        No hay proyectos registrados
      </h3>
      <p class="text-gray-600 mb-4">
        Comienza agregando tu primer proyecto municipal.
      </p>
      <button
        id="projects-empty-add"
        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200"
      >
        <i class="fas fa-plus mr-2"></i>
        Agregar Proyecto
      </button>
    </div>
  </div>

  <!-- Details Drawer -->
  <div
    id="projects-details-drawer"
    class="fixed inset-y-0 right-0 w-full lg:w-1/2 xl:w-1/3 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 overflow-y-auto"
  >
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-gray-800" id="projects-drawer-title">
          Detalles del Proyecto
        </h2>
        <button
          id="projects-drawer-close"
          class="text-gray-400 hover:text-gray-600 transition-colors duration-200"
        >
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div id="projects-drawer-content"></div>
    </div>
  </div>

  <!-- Form Modal -->
  <div
    id="projects-modal"
    class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4"
  >
    <div
      class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
    >
      <div class="p-6 border-b border-gray-200">
        <div class="flex justify-between items-center">
          <h3
            id="projects-modal-title"
            class="text-2xl font-bold text-gray-800"
          >
            Nuevo Proyecto
          </h3>
          <button
            id="projects-modal-close"
            class="text-gray-400 hover:text-gray-600 transition-colors duration-200"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>

      <form id="projects-form" class="p-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="lg:col-span-2">
            <label
              for="projects-form-nombre"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Nombre del Proyecto *</label
            >
            <input
              type="text"
              id="projects-form-nombre"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            <div>
              <label class="inline-flex items-center flex">
                <input
                  type="checkbox"
                  id="projects-form-show-home"
                  class="rounded border-gray-300 text-blue-600"
                />
                <span class="ml-2 text-sm text-gray-700"
                  >Mostrar en página de inicio</span
                >
              </label>
              <p class="text-xs text-gray-500 mt-1">
                Si está marcado, el proyecto se destacará en la página
                principal.
              </p>
            </div>
          </div>

          <div>
            <label
              for="projects-form-categoria"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Categoría *</label
            >
            <select
              id="projects-form-categoria"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">Seleccionar categoría</option>
              <option value="Infraestructura">Infraestructura</option>
              <option value="Desarrollo Social">Desarrollo Social</option>
              <option value="Medio Ambiente">Medio Ambiente</option>
              <option value="Tecnología">Tecnología</option>
              <option value="Educación">Educación</option>
              <option value="Salud">Salud</option>
            </select>
          </div>
          <div>
            <label
              for="projects-form-estatus"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Estatus *</label
            >
            <select
              id="projects-form-estatus"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="Planificación">Planificación</option>
              <option value="En Progreso">En Progreso</option>
              <option value="Pausado">Pausado</option>
              <option value="Completado">Completado</option>
              <option value="Cancelado">Cancelado</option>
            </select>
          </div>
          <div>
            <label
              for="projects-form-inversion"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Inversión Total *</label
            >
            <input
              type="number"
              id="projects-form-inversion"
              required
              min="0"
              step="0.01"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
          <div>
            <label
              for="projects-form-beneficiarios"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Beneficiarios *</label
            >
            <input
              type="number"
              id="projects-form-beneficiarios"
              required
              min="0"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
        </div>

        <!-- Etapas Section (TABS) -->
        <div class="mb-6">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-lg font-semibold text-gray-800">
              Cronograma y Etapas
            </h4>
            <button
              type="button"
              id="projects-add-etapa"
              class="bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700 transition-colors duration-200 text-sm"
            >
              <i class="fas fa-plus mr-1"></i>
              Agregar Etapa
            </button>
          </div>

          <!-- Tabs wrapper -->
          <div
            id="form-etapas-tabs"
            data-tabs="form-etapas"
            class="bg-white border rounded-lg"
          >
            <div
              id="form-etapas-tablist"
              role="tablist"
              class="flex overflow-x-auto gap-2 p-2 border-b bg-gray-50"
            ></div>
            <div id="form-etapas-panels"></div>
          </div>

          <div class="mt-4 p-4 bg-gray-50 rounded-lg">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-gray-700"
                >Total de pesos:</span
              >
              <span
                id="projects-peso-total"
                class="text-sm font-bold text-gray-800"
                >0%</span
              >
            </div>
            <div
              id="projects-peso-error"
              class="text-red-600 text-sm mt-1 hidden"
            >
              La suma de los pesos debe ser exactamente 100%
            </div>
          </div>
        </div>

        <div class="flex justify-end space-x-4">
          <button
            type="button"
            id="projects-form-cancel"
            class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200"
          >
            Cancelar
          </button>
          <button
            type="button"
            id="projects-form-duplicate"
            class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors duration-200 hidden"
          >
            <i class="fas fa-copy mr-2"></i>
            Duplicar
          </button>
          <button
            type="button"
            id="projects-form-delete"
            class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200 hidden"
          >
            <i class="fas fa-trash mr-2"></i>
            Eliminar
          </button>
          <button
            type="submit"
            id="projects-form-submit"
            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200"
          >
            <i class="fas fa-save mr-2"></i>
            Guardar
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

<script>
  (function () {
    "use strict";

    const STORAGE_KEY = "municipio.proyectos.v1";
    const IDB_NAME = "proyectos_media";
    const IDB_STORE = "etapa_fotos";

    let proyectos = [];
    let filteredProyectos = [];
    let currentEditId = null;
    let etapaCounter = 0;
    let tareaCounter = 0;
    let db = null;

    // ---------------- IndexedDB helpers ----------------
    function idbOpen() {
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(IDB_NAME, 1);
        req.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(IDB_STORE)) {
            const store = db.createObjectStore(IDB_STORE, { keyPath: "id" });
            store.createIndex("byEtapa", "etapaId", { unique: false });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    async function idbSavePhoto(etapaId, file) {
      const id = generateId();
      const blob =
        file instanceof Blob
          ? file
          : new Blob([file], { type: file.type || "application/octet-stream" });
      return new Promise((resolve, reject) => {
        const tx = db.transaction(IDB_STORE, "readwrite");
        tx.objectStore(IDB_STORE).put({
          id,
          etapaId,
          blob,
          mime: blob.type,
          filename: file.name || "imagen",
          createdAt: new Date().toISOString(),
        });
        tx.oncomplete = () => resolve(id);
        tx.onerror = () => reject(tx.error);
      });
    }
    async function idbGetPhotos(etapaId) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(IDB_STORE, "readonly");
        const idx = tx.objectStore(IDB_STORE).index("byEtapa");
        const req = idx.getAll(etapaId);
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
      });
    }
    async function idbGetPhotoById(photoId) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(IDB_STORE, "readonly");
        const req = tx.objectStore(IDB_STORE).get(photoId);
        req.onsuccess = () => resolve(req.result || null);
        req.onerror = () => reject(req.error);
      });
    }
    async function idbDeletePhoto(photoId) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction(IDB_STORE, "readwrite");
        tx.objectStore(IDB_STORE).delete(photoId);
        tx.oncomplete = () => resolve(true);
        tx.onerror = () => reject(tx.error);
      });
    }

    // ---------------- Init / Load ----------------
    function init() {
      idbOpen()
        .then((r) => (db = r))
        .catch(console.error);
      loadProyectos();
      setupEventListeners();
      setupKeyboardShortcuts();
      filteredProyectos = [...proyectos];
      renderProyectos();
      updateKPIs();
    }
    if (document.readyState === "loading")
      document.addEventListener("DOMContentLoaded", init);
    else init();

    function saveProyectos() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(proyectos));
    }
    function loadProyectos() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        proyectos = JSON.parse(stored);
        return;
      }
      proyectos = [
        {
          id: "1",
          nombre: "Renovación del Parque Central",
          categoria: "Infraestructura",
          inversionTotal: 2500000,
          beneficiarios: 15000,
          estatusGeneral: "En Progreso",
          etapas: [
            {
              id: "e1",
              nombre: "Diseño y Planificación",
              peso: 20,
              inicio: "2024-01-15",
              fin: "2024-02-15",
              tareas: [],
              photoIds: [],
            },
            {
              id: "e2",
              nombre: "Construcción Fase 1",
              peso: 40,
              inicio: "2024-02-16",
              fin: "2024-05-15",
              tareas: [],
              photoIds: [],
            },
            {
              id: "e3",
              nombre: "Construcción Fase 2",
              peso: 30,
              inicio: "2024-05-16",
              fin: "2024-08-15",
              tareas: [],
              photoIds: [],
            },
            {
              id: "e4",
              nombre: "Finalización y Entrega",
              peso: 10,
              inicio: "2024-08-16",
              fin: "2024-09-15",
              tareas: [],
              photoIds: [],
            },
          ],
        },
        {
          id: "2",
          nombre: "Sistema de Gestión Digital",
          categoria: "Tecnología",
          inversionTotal: 800000,
          beneficiarios: 50000,
          estatusGeneral: "Planificación",
          etapas: [
            {
              id: "e5",
              nombre: "Análisis de Requerimientos",
              peso: 25,
              inicio: "2024-03-01",
              fin: "2024-03-31",
              tareas: [],
              photoIds: [],
            },
            {
              id: "e6",
              nombre: "Desarrollo del Sistema",
              peso: 50,
              inicio: "2024-04-01",
              fin: "2024-07-31",
              tareas: [],
              photoIds: [],
            },
            {
              id: "e7",
              nombre: "Implementación y Capacitación",
              peso: 25,
              inicio: "2024-08-01",
              fin: "2024-09-30",
              tareas: [],
              photoIds: [],
            },
          ],
        },
      ];
      saveProyectos();
    }

    // ---------------- Events ----------------
    function setupEventListeners() {
      document
        .getElementById("projects-add-btn")
        .addEventListener("click", () => openModal());
      const emptyAdd = document.getElementById("projects-empty-add");
      if (emptyAdd) emptyAdd.addEventListener("click", () => openModal());

      [
        "projects-search",
        "projects-filter-categoria",
        "projects-filter-estatus",
        "projects-filter-fecha-inicio",
        "projects-filter-fecha-fin",
      ].forEach((id) =>
        document.getElementById(id).addEventListener("input", filterProyectos)
      );
      document
        .getElementById("projects-filter-categoria")
        .addEventListener("change", filterProyectos);
      document
        .getElementById("projects-filter-estatus")
        .addEventListener("change", filterProyectos);

      document
        .getElementById("projects-modal-close")
        .addEventListener("click", closeModal);
      document
        .getElementById("projects-form-cancel")
        .addEventListener("click", closeModal);
      document
        .getElementById("projects-form")
        .addEventListener("submit", saveProyecto);
      document
        .getElementById("projects-form-duplicate")
        .addEventListener("click", duplicateProyecto);
      document
        .getElementById("projects-form-delete")
        .addEventListener("click", deleteProyecto);
      document
        .getElementById("projects-add-etapa")
        .addEventListener("click", () => addEtapa());

      document
        .getElementById("projects-drawer-close")
        .addEventListener("click", closeDrawer);

      // backdrop close
      document
        .getElementById("projects-modal")
        .addEventListener("click", (e) => {
          if (e.target.id === "projects-modal") closeModal();
        });
    }

    function setupKeyboardShortcuts() {
      document.addEventListener("keydown", (e) => {
        if (["INPUT", "TEXTAREA", "SELECT"].includes(e.target.tagName)) {
          if (e.key === "Escape") e.target.blur();
          return;
        }
        if (e.key === "/") {
          e.preventDefault();
          document.getElementById("projects-search").focus();
        }
        if (e.key === "n" && !e.ctrlKey && !e.metaKey) {
          e.preventDefault();
          openModal();
        }
        if (e.key === "Escape") {
          closeModal();
          closeDrawer();
        }
      });
      document
        .getElementById("projects-modal")
        .addEventListener("keydown", (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key === "s") {
            e.preventDefault();
            document
              .getElementById("projects-form")
              .dispatchEvent(new Event("submit"));
          }
        });
    }

    // ---------------- Filters / Render ----------------
    function filterProyectos() {
      const search = document
        .getElementById("projects-search")
        .value.toLowerCase();
      const categoria = document.getElementById(
        "projects-filter-categoria"
      ).value;
      const estatus = document.getElementById("projects-filter-estatus").value;
      const fechaInicio = document.getElementById(
        "projects-filter-fecha-inicio"
      ).value;
      const fechaFin = document.getElementById(
        "projects-filter-fecha-fin"
      ).value;

      filteredProyectos = proyectos.filter((p) => {
        if (search && !p.nombre.toLowerCase().includes(search)) return false;
        if (categoria && p.categoria !== categoria) return false;
        if (estatus && p.estatusGeneral !== estatus) return false;
        if (fechaInicio || fechaFin) {
          const pInicio = p.etapas[0]?.inicio || null;
          const pFin = p.etapas[p.etapas.length - 1]?.fin || null;
          if (fechaInicio && pInicio && pInicio < fechaInicio) return false;
          if (fechaFin && pFin && pFin > fechaFin) return false;
        }
        return true;
      });
      renderProyectos();
      updateFilterChips();
    }

    function updateFilterChips() {
      const container = document.getElementById("projects-filter-chips");
      const chips = [];
      const search = document.getElementById("projects-search").value;
      const categoria = document.getElementById(
        "projects-filter-categoria"
      ).value;
      const estatus = document.getElementById("projects-filter-estatus").value;
      const fi = document.getElementById("projects-filter-fecha-inicio").value;
      const ff = document.getElementById("projects-filter-fecha-fin").value;
      if (search) chips.push({ t: "search", l: `Búsqueda: ${search}` });
      if (categoria)
        chips.push({ t: "categoria", l: `Categoría: ${categoria}` });
      if (estatus) chips.push({ t: "estatus", l: `Estatus: ${estatus}` });
      if (fi) chips.push({ t: "fi", l: `Desde: ${fi}` });
      if (ff) chips.push({ t: "ff", l: `Hasta: ${ff}` });
      container.innerHTML = chips
        .map(
          (c) => `
      <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800">
        ${c.l}
        <button onclick="removeFilter('${c.t}')" class="ml-2 text-blue-600 hover:text-blue-800">
          <i class="fas fa-times text-xs"></i>
        </button>
      </span>`
        )
        .join("");
    }
    window.removeFilter = function (type) {
      const ids = {
        search: "projects-search",
        categoria: "projects-filter-categoria",
        estatus: "projects-filter-estatus",
        fi: "projects-filter-fecha-inicio",
        ff: "projects-filter-fecha-fin",
      };
      const el = document.getElementById(ids[type]);
      if (el) {
        el.value = "";
        filterProyectos();
      }
    };

    function renderProyectos() {
      const tbody = document.getElementById("projects-table-body");
      const emptyState = document.getElementById("projects-empty-state");
      if (!filteredProyectos.length) {
        tbody.innerHTML = "";
        emptyState.classList.remove("hidden");
        return;
      }
      emptyState.classList.add("hidden");
      tbody.innerHTML = filteredProyectos
        .map((p) => {
          const progreso = calcularProgreso(p);
          const variacion = calcularVariacionTiempo(p);
          return `
      <tr class="hover:bg-gray-50 cursor-pointer transition-colors duration-200" onclick="openDrawer('${
        p.id
      }')">
        <td class="px-6 py-4"><div class="font-medium text-gray-800">${
          p.nombre
        }</div></td>
        <td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${
          p.categoria
        }</span></td>
        <td class="px-6 py-4"><div class="text-sm font-medium text-gray-800">$${formatNumber(
          p.inversionTotal
        )}</div></td>
        <td class="px-6 py-4"><div class="text-sm text-gray-800">${formatNumber(
          p.beneficiarios
        )}</div></td>
        <td class="px-6 py-4">
          <div class="flex items-center">
            <div class="w-16 bg-gray-200 rounded-full h-2 mr-3">
              <div class="bg-gradient-to-r from-green-400 to-green-600 h-2 rounded-full" style="width:${progreso}%"></div>
            </div>
            <span class="text-sm font-medium text-gray-800">${progreso}%</span>
          </div>
        </td>
        <td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getEstatusColor(
          p.estatusGeneral
        )}">${p.estatusGeneral}</span></td>
        <td class="px-6 py-4"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getTiempoColor(
          variacion
        )}">${variacion.label}</span></td>
        <td class="px-6 py-4">
          <div class="flex space-x-2">
            <button onclick="event.stopPropagation(); editProyecto('${
              p.id
            }')" class="text-blue-600 hover:text-blue-800" title="Editar"><i class="fas fa-edit"></i></button>
            <button onclick="event.stopPropagation(); duplicateProyectoFromTable('${
              p.id
            }')" class="text-purple-600 hover:text-purple-800" title="Duplicar"><i class="fas fa-copy"></i></button>
            <button onclick="event.stopPropagation(); deleteProyectoFromTable('${
              p.id
            }')" class="text-red-600 hover:text-red-800" title="Eliminar"><i class="fas fa-trash"></i></button>
          </div>
        </td>
      </tr>`;
        })
        .join("");
    }

    function updateKPIs() {
      const activos = proyectos.filter((p) =>
        ["En Progreso", "Planificación"].includes(p.estatusGeneral)
      ).length;
      const avanceProm = proyectos.length
        ? Math.round(
            proyectos.reduce((s, p) => s + calcularProgreso(p), 0) /
              proyectos.length
          )
        : 0;
      const inversion = proyectos.reduce((s, p) => s + p.inversionTotal, 0);
      const beneficiarios = proyectos.reduce((s, p) => s + p.beneficiarios, 0);
      const riesgo = proyectos.filter(
        (p) => calcularVariacionTiempo(p).status === "critico"
      ).length;
      document.getElementById("projects-kpi-activos").textContent = activos;
      document.getElementById(
        "projects-kpi-avance"
      ).textContent = `${avanceProm}%`;
      document.getElementById(
        "projects-kpi-inversion"
      ).textContent = `$${formatNumber(inversion)}`;
      document.getElementById("projects-kpi-beneficiarios").textContent =
        formatNumber(beneficiarios);
      document.getElementById("projects-kpi-riesgo").textContent = riesgo;
    }

    // ---------------- Calculations ----------------
    function calcularProgreso(p) {
      if (!p.etapas?.length) return 0;
      let total = 0;
      p.etapas.forEach((e) => {
        total += (e.peso / 100) * calcularAvanceEtapa(e);
      });
      return Math.round(total);
    }
    function calcularAvanceEtapa(e) {
      if (typeof e.avanceManual === "number")
        return Math.max(0, Math.min(100, e.avanceManual));
      if (!e.tareas?.length) return 0;
      const done = e.tareas.filter((t) => t.completada).length;
      return Math.round((done / e.tareas.length) * 100);
    }
    function calcularVariacionTiempo(p) {
      if (!p.etapas?.length) return { status: "sin-datos", label: "Sin datos" };
      const prog = calcularProgreso(p);
      const fin = new Date(p.etapas[p.etapas.length - 1].fin);
      const hoy = new Date();
      if (prog === 100) return { status: "completado", label: "Completado" };
      if (hoy <= fin) return { status: "a-tiempo", label: "A tiempo" };
      const dias = Math.floor((hoy - fin) / (1000 * 60 * 60 * 24));
      return dias <= 7
        ? { status: "retraso-leve", label: `${dias}d retraso` }
        : { status: "critico", label: `${dias}d crítico` };
    }

    // ---------------- Utils ----------------
    function formatNumber(n) {
      return new Intl.NumberFormat("es-MX").format(n);
    }
    function getEstatusColor(s) {
      return (
        {
          Planificación: "bg-yellow-100 text-yellow-800",
          "En Progreso": "bg-blue-100 text-blue-800",
          Pausado: "bg-orange-100 text-orange-800",
          Completado: "bg-green-100 text-green-800",
          Cancelado: "bg-red-100 text-red-800",
        }[s] || "bg-gray-100 text-gray-800"
      );
    }
    function getTiempoColor(v) {
      return (
        {
          completado: "bg-green-100 text-green-800",
          "a-tiempo": "bg-green-100 text-green-800",
          "retraso-leve": "bg-yellow-100 text-yellow-800",
          critico: "bg-red-100 text-red-800",
          "sin-datos": "bg-gray-100 text-gray-800",
        }[v.status] || "bg-gray-100 text-gray-800"
      );
    }
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
    }

    // ---------------- Modal ----------------
    function openModal(id = null) {
      currentEditId = id;
      const title = document.getElementById("projects-modal-title");
      const dup = document.getElementById("projects-form-duplicate");
      const del = document.getElementById("projects-form-delete");
      if (id) {
        title.textContent = "Editar Proyecto";
        dup.classList.remove("hidden");
        del.classList.remove("hidden");
        loadProyectoToForm(id);
      } else {
        title.textContent = "Nuevo Proyecto";
        dup.classList.add("hidden");
        del.classList.add("hidden");
        resetForm();
      }
      document.getElementById("projects-modal").classList.remove("hidden");
      document.getElementById("projects-form-nombre").focus();
    }
    function closeModal() {
      document.getElementById("projects-modal").classList.add("hidden");
      currentEditId = null;
      resetForm();
    }
    function resetForm() {
      document.getElementById("projects-form").reset();
      // Clear tabs
      document.getElementById("form-etapas-tablist").innerHTML = "";
      document.getElementById("form-etapas-panels").innerHTML = "";
      document.getElementById("projects-form-show-home").checked = false;
      updatePesoTotal();
      etapaCounter = 0;
      tareaCounter = 0;
    }

    function loadProyectoToForm(id) {
      const p = proyectos.find((x) => x.id === id);
      if (!p) return;
      document.getElementById("projects-form-nombre").value = p.nombre;
      document.getElementById("projects-form-categoria").value = p.categoria;
      document.getElementById("projects-form-estatus").value = p.estatusGeneral;
      document.getElementById("projects-form-inversion").value =
        p.inversionTotal;
      document.getElementById("projects-form-show-home").checked =
        !!p.mostrarEnHome;
      document.getElementById("projects-form-beneficiarios").value =
        p.beneficiarios;

      // Build etapas as tabs
      const tablist = document.getElementById("form-etapas-tablist");
      const panels = document.getElementById("form-etapas-panels");
      tablist.innerHTML = "";
      panels.innerHTML = "";
      p.etapas.forEach((e) => addEtapa(e));
      updatePesoTotal();
    }

    function saveProyecto(e) {
      e.preventDefault();
      const data = {
        nombre: document.getElementById("projects-form-nombre").value,
        categoria: document.getElementById("projects-form-categoria").value,
        estatusGeneral: document.getElementById("projects-form-estatus").value,
        inversionTotal: parseFloat(
          document.getElementById("projects-form-inversion").value
        ),
        beneficiarios: parseInt(
          document.getElementById("projects-form-beneficiarios").value,
          10
        ),
        etapas: getEtapasFromForm(),
        mostrarEnHome: document.getElementById("projects-form-show-home")
          .checked,
      };
      const pesoTotal = data.etapas.reduce((s, e) => s + e.peso, 0);
      if (Math.abs(pesoTotal - 100) > 0.01) {
        alert("La suma de los pesos de las etapas debe ser exactamente 100%");
        return;
      }

      if (currentEditId) {
        const i = proyectos.findIndex((p) => p.id === currentEditId);
        if (i > -1) proyectos[i] = { ...proyectos[i], ...data };
      } else {
        data.id = generateId();
        proyectos.push(data);
      }
      saveProyectos();
      filterProyectos();
      updateKPIs();
      closeModal();
    }

    function getEtapasFromForm() {
      const res = [];
      document
        .querySelectorAll('[data-form-role="form-etapa-panel"]')
        .forEach((el) => {
          const id = el.getAttribute("data-etapa-id");
          const nombre = el.querySelector('[data-field="nombre"]').value;
          const peso =
            parseFloat(el.querySelector('[data-field="peso"]').value) || 0;
          const inicio = el.querySelector('[data-field="inicio"]').value;
          const fin = el.querySelector('[data-field="fin"]').value;
          const avanceManualInput = el.querySelector(
            '[data-field="avance-manual"]'
          ).value;
          const avanceManual =
            avanceManualInput === ""
              ? undefined
              : parseFloat(avanceManualInput);
          const photoIds = (el.getAttribute("data-photo-ids") || "")
            .split(",")
            .filter(Boolean);

          const tareas = [];
          el.querySelectorAll("[data-tarea-id]").forEach((tEl) => {
            const tid = tEl.getAttribute("data-tarea-id");
            const nombre = tEl.querySelector(
              '[data-field="tarea-nombre"]'
            ).value;
            const completada = tEl.querySelector(
              '[data-field="completada"]'
            ).checked;
            const responsable = tEl.querySelector(
              '[data-field="responsable"]'
            ).value;
            const costoVal = tEl.querySelector('[data-field="costo"]').value;
            const costo = costoVal ? parseFloat(costoVal) : undefined;
            if (nombre) {
              tareas.push({
                id: tid,
                nombre,
                completada,
                responsable,
                ...(costo ? { costo } : {}),
              });
            }
          });

          if (nombre) {
            res.push({
              id,
              nombre,
              peso,
              inicio,
              fin,
              tareas,
              ...(typeof avanceManual === "number" ? { avanceManual } : {}),
              photoIds,
            });
          }
        });
      return res;
    }

    // ---------------- Tabs helpers (generic) ----------------
    window.switchTabs = function (tabsGroupId, tabIndex) {
      const root = document.querySelector(`[data-tabs="${tabsGroupId}"]`);
      if (!root) return;
      const buttons = root.querySelectorAll('[data-role="tab"]');
      const panels = root.querySelectorAll('[data-role="panel"]');
      buttons.forEach((b, i) => {
        const active = i === tabIndex;
        b.classList.toggle("bg-white", active);
        b.classList.toggle("text-blue-700", active);
        b.classList.toggle("border-b-2", active);
        b.classList.toggle("border-blue-600", active);
        b.setAttribute("aria-selected", active ? "true" : "false");
      });
      panels.forEach((p, i) => p.classList.toggle("hidden", i !== tabIndex));
    };

    // ---------------- Etapas tabs in FORM ----------------
    function addEtapa(etapa = null) {
      const tablist = document.getElementById("form-etapas-tablist");
      const panels = document.getElementById("form-etapas-panels");
      const id = etapa ? etapa.id : `etapa-${++etapaCounter}`;
      const photoIds = etapa?.photoIds || [];

      // TAB BUTTON
      const index = tablist.children.length;
      const btn = document.createElement("button");
      btn.type = "button";
      btn.setAttribute("data-role", "tab");
      btn.className =
        "whitespace-nowrap px-3 py-2 rounded-t-md text-sm font-medium text-gray-600 hover:text-blue-700 hover:bg-white transition";
      btn.innerHTML = `${index + 1}. ${etapa?.nombre || "Nueva Etapa"}`;
      btn.addEventListener("click", () =>
        switchTabs("form-etapas", Array.from(tablist.children).indexOf(btn))
      );
      tablist.appendChild(btn);

      // PANEL
      const wrap = document.createElement("div");
      wrap.className = "p-4";
      wrap.setAttribute("data-role", "panel");
      wrap.setAttribute("data-etapa-id", id);
      wrap.setAttribute("data-photo-ids", photoIds.join(","));
      wrap.setAttribute("data-form-role", "form-etapa-panel");

      wrap.innerHTML = `
      <div class="flex items-center justify-between mb-4">
        <h5 class="font-semibold text-gray-800">Etapa</h5>
        <div class="flex space-x-2">
          <label class="text-sm bg-indigo-600 text-white px-2 py-1 rounded cursor-pointer hover:bg-indigo-700">
            <i class="fas fa-image mr-1"></i> Fotos
            <input type="file" accept="image/*" multiple class="hidden" data-field="etapa-fotos">
          </label>
          <button type="button" class="text-blue-600 hover:text-blue-800 text-sm" data-action="add-tarea"><i class="fas fa-plus mr-1"></i>Tarea</button>
          <button type="button" class="text-red-600 hover:text-red-800" data-action="remove-etapa"><i class="fas fa-trash"></i></button>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-4">
        <div class="lg:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
          <input type="text" data-field="nombre" value="${
            etapa ? etapa.nombre : ""
          }" required
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Peso (%) *</label>
          <input type="number" data-field="peso" value="${
            etapa ? etapa.peso : ""
          }" required min="0" max="100" step="0.1"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Avance Manual (%)</label>
          <input type="number" data-field="avance-manual" value="${
            etapa && typeof etapa.avanceManual === "number"
              ? etapa.avanceManual
              : ""
          }" min="0" max="100"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Inicio</label>
          <input type="date" data-field="inicio" value="${
            etapa ? etapa.inicio : ""
          }"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Fin</label>
          <input type="date" data-field="fin" value="${etapa ? etapa.fin : ""}"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
        </div>
      </div>

      <div class="mb-3">
        <div class="text-sm font-medium text-gray-700 mb-2">Galería</div>
        <div class="grid grid-cols-3 md:grid-cols-6 gap-2" data-field="gallery"></div>
      </div>

      <div class="tareas-container space-y-2"></div>
    `;
      panels.appendChild(wrap);

      // Wire events
      wrap
        .querySelector('[data-action="remove-etapa"]')
        .addEventListener("click", () => removeEtapaTab(id));
      wrap
        .querySelector('[data-action="add-tarea"]')
        .addEventListener("click", () => addTarea(id));
      wrap
        .querySelector('[data-field="etapa-fotos"]')
        .addEventListener("change", async (e) => {
          const files = Array.from(e.target.files || []);
          if (!files.length) return;
          const currIds = (wrap.getAttribute("data-photo-ids") || "")
            .split(",")
            .filter(Boolean);
          for (const f of files) {
            const photoId = await idbSavePhoto(id, f);
            currIds.push(photoId);
            await renderEtapaGallery(id, wrap, currIds);
          }
          wrap.setAttribute("data-photo-ids", currIds.join(","));
          if (currentEditId) {
            const p = proyectos.find((x) => x.id === currentEditId);
            const et = p?.etapas.find((e) => e.id === id);
            if (et) {
              et.photoIds = currIds;
              saveProyectos();
            }
          }
          e.target.value = "";
        });
      // Keep tab label synced with "Nombre"
      wrap
        .querySelector('[data-field="nombre"]')
        .addEventListener("input", (ev) => {
          const name = ev.target.value.trim() || "Nueva Etapa";
          btn.textContent = `${
            Array.from(tablist.children).indexOf(btn) + 1
          }. ${name}`;
        });
      // Update total weights when peso changes
      wrap
        .querySelector('[data-field="peso"]')
        .addEventListener("input", updatePesoTotal);

      // Render existing tareas + gallery
      if (etapa?.tareas?.length) etapa.tareas.forEach((t) => addTarea(id, t));
      renderEtapaGallery(id, wrap, photoIds).catch(console.error);

      // Activate the newly created tab
      switchTabs("form-etapas", index);
      updatePesoTotal();
    }

    function removeEtapaTab(etapaId) {
      if (!confirm("¿Eliminar esta etapa?")) return;
      const tablist = document.getElementById("form-etapas-tablist");
      const panels = document.getElementById("form-etapas-panels");
      const panel = panels.querySelector(`[data-etapa-id="${etapaId}"]`);
      if (!panel) return;
      const idx = Array.from(panels.children).indexOf(panel);
      panel.remove();
      tablist.children[idx]?.remove();
      // Re-number remaining tabs
      Array.from(tablist.children).forEach((b, i) => {
        const label = b.textContent.split(". ").slice(1).join(". ") || "Etapa";
        b.textContent = `${i + 1}. ${label}`;
      });
      // Show first tab if any
      if (panels.children.length)
        switchTabs("form-etapas", Math.max(0, idx - 1));
      updatePesoTotal();
    }

    async function renderEtapaGallery(etapaId, wrapEl, photoIds) {
      const gal = wrapEl.querySelector('[data-field="gallery"]');
      gal.innerHTML = "";
      if (!db) db = await idbOpen();
      let photos = [];
      if (photoIds?.length) {
        photos = await Promise.all(
          photoIds.map(async (pid) => await idbGetPhotoById(pid))
        );
        photos = photos.filter(Boolean);
      } else {
        photos = await idbGetPhotos(etapaId);
      }
      photos.forEach((rec) => {
        const url = URL.createObjectURL(rec.blob);
        const cell = document.createElement("div");
        cell.className = "relative group";
        cell.innerHTML = `
        <img src="${url}" alt="Foto etapa" class="w-full h-20 object-cover rounded">
        <button class="absolute top-1 right-1 bg-black/60 text-white p-1 rounded opacity-0 group-hover:opacity-100 transition" title="Eliminar">
          <i class="fas fa-trash text-xs"></i>
        </button>`;
        cell.querySelector("button").addEventListener("click", async () => {
          await idbDeletePhoto(rec.id);
          const ids = (wrapEl.getAttribute("data-photo-ids") || "")
            .split(",")
            .filter(Boolean)
            .filter((x) => x !== rec.id);
          wrapEl.setAttribute("data-photo-ids", ids.join(","));
          if (currentEditId) {
            const p = proyectos.find((x) => x.id === currentEditId);
            const et = p?.etapas.find((e) => e.id === etapaId);
            if (et) {
              et.photoIds = ids;
              saveProyectos();
            }
          }
          renderEtapaGallery(etapaId, wrapEl, ids);
        });
        gal.appendChild(cell);
      });
    }

    window.addTarea = function (etapaId, tarea = null) {
      const etapaEl = document.querySelector(`[data-etapa-id="${etapaId}"]`);
      const cont = etapaEl.querySelector(".tareas-container");
      const id = tarea ? tarea.id : `tarea-${++tareaCounter}`;
      const div = document.createElement("div");
      div.className = "bg-white border border-gray-200 rounded p-3";
      div.setAttribute("data-tarea-id", id);
      div.innerHTML = `
      <div class="grid grid-cols-1 lg:grid-cols-5 gap-3 items-center">
        <div class="lg:col-span-2"><input type="text" data-field="tarea-nombre" value="${
          tarea ? tarea.nombre : ""
        }" placeholder="Nombre de la tarea" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500"></div>
        <div><input type="text" data-field="responsable" value="${
          tarea?.responsable || ""
        }" placeholder="Responsable" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500"></div>
        <div><input type="number" data-field="costo" value="${
          tarea?.costo || ""
        }" placeholder="Costo" min="0" step="0.01" class="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500"></div>
        <div class="flex items-center justify-between">
          <label class="flex items-center">
            <input type="checkbox" data-field="completada" ${
              tarea?.completada ? "checked" : ""
            } class="rounded border-gray-300 text-blue-600">
            <span class="ml-2 text-sm text-gray-700">Completada</span>
          </label>
          <button type="button" onclick="removeTarea('${id}')" class="text-red-600 hover:text-red-800 ml-2"><i class="fas fa-trash text-sm"></i></button>
        </div>
      </div>`;
      cont.appendChild(div);
    };
    window.removeTarea = function (id) {
      const el = document.querySelector(`[data-tarea-id="${id}"]`);
      if (el) el.remove();
    };

    function updatePesoTotal() {
      let total = 0;
      document
        .querySelectorAll('#form-etapas-panels [data-field="peso"]')
        .forEach((i) => {
          total += parseFloat(i.value) || 0;
        });
      const t = document.getElementById("projects-peso-total");
      const e = document.getElementById("projects-peso-error");
      t.textContent = `${total.toFixed(1)}%`;
      if (Math.abs(total - 100) > 0.01) {
        t.className = "text-sm font-bold text-red-600";
        e.classList.remove("hidden");
      } else {
        t.className = "text-sm font-bold text-green-600";
        e.classList.add("hidden");
      }
    }
    window.updatePesoTotal = updatePesoTotal;

    // ---------------- CRUD helpers ----------------
    window.editProyecto = (id) => openModal(id);

    function duplicateProyecto() {
      if (!currentEditId) return;
      const p = proyectos.find((x) => x.id === currentEditId);
      if (!p) return;
      const copy = JSON.parse(JSON.stringify(p));
      copy.id = generateId();
      copy.nombre = `${p.nombre} (Copia)`;
      copy.etapas.forEach((e) => {
        e.id = generateId();
        e.tareas?.forEach((t) => {
          t.id = generateId();
          t.completada = false;
        });
      });
      proyectos.push(copy);
      saveProyectos();
      filterProyectos();
      updateKPIs();
      closeModal();
    }
    window.duplicateProyectoFromTable = function (id) {
      const p = proyectos.find((x) => x.id === id);
      if (!p) return;
      if (!confirm(`¿Duplicar "${p.nombre}"?`)) return;
      const copy = JSON.parse(JSON.stringify(p));
      copy.id = generateId();
      copy.nombre = `${p.nombre} (Copia)`;
      copy.etapas.forEach((e) => {
        e.id = generateId();
        e.tareas?.forEach((t) => {
          t.id = generateId();
          t.completada = false;
        });
      });
      proyectos.push(copy);
      saveProyectos();
      filterProyectos();
      updateKPIs();
    };

    function deleteProyecto() {
      if (!currentEditId) return;
      const p = proyectos.find((x) => x.id === currentEditId);
      if (!p) return;
      if (!confirm(`¿Eliminar "${p.nombre}"?`)) return;
      proyectos = proyectos.filter((x) => x.id !== currentEditId);
      saveProyectos();
      filterProyectos();
      updateKPIs();
      closeModal();
    }
    window.deleteProyectoFromTable = function (id) {
      const p = proyectos.find((x) => x.id === id);
      if (!p) return;
      if (!confirm(`¿Eliminar "${p.nombre}"?`)) return;
      proyectos = proyectos.filter((x) => x.id !== id);
      saveProyectos();
      filterProyectos();
      updateKPIs();
    };

    // ---------------- Drawer (tabs already implemented) ----------------
    window.switchTabs = window.switchTabs; // reused

    window.openDrawer = async function (id) {
      const p = proyectos.find((x) => x.id === id);
      if (!p) return;

      const drawer = document.getElementById("projects-details-drawer");
      const title = document.getElementById("projects-drawer-title");
      const content = document.getElementById("projects-drawer-content");
      title.textContent = p.nombre;

      const progreso = calcularProgreso(p);
      if (!db) db = await idbOpen();

      // Build ETAPAS as stacked cards (NO TABS here)
      const etapasHTML = await Promise.all(
        p.etapas.map(async (e) => {
          let photos = [];
          try {
            photos = e.photoIds?.length
              ? await Promise.all(e.photoIds.map((pid) => idbGetPhotoById(pid)))
              : await idbGetPhotos(e.id);
          } catch {
            photos = [];
          }
          const urls = photos
            .filter(Boolean)
            .slice(0, 6)
            .map((rec) => URL.createObjectURL(rec.blob));
          const thumbs = urls
            .map(
              (u) => `<img src="${u}" class="w-full h-16 object-cover rounded">`
            )
            .join("");

          const avance = calcularAvanceEtapa(e);
          const fi = e.inicio
            ? new Date(e.inicio).toLocaleDateString("es-MX")
            : "Sin fecha";
          const ff = e.fin
            ? new Date(e.fin).toLocaleDateString("es-MX")
            : "Sin fecha";

          return `
        <div class="border border-gray-200 rounded-lg p-3">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center">
              <span class="font-medium text-gray-800">${e.nombre}</span>
              <span class="text-xs text-gray-500 ml-2">(${e.peso}%)</span>
            </div>
            <span class="text-sm font-medium text-gray-700">${avance}%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
            <div class="bg-gradient-to-r from-blue-400 to-blue-600 h-2 rounded-full" style="width:${avance}%"></div>
          </div>
          <div class="flex justify-between text-xs text-gray-500 mb-3">
            <span>${fi}</span><span>${ff}</span>
          </div>
          ${
            thumbs
              ? `<div class="grid grid-cols-3 md:grid-cols-6 gap-2">${thumbs}</div>`
              : '<div class="text-sm text-gray-500">Sin fotos</div>'
          }
        </div>
      `;
        })
      );

      content.innerHTML = `
    <div class="space-y-6">
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4">
        <h3 class="font-semibold text-gray-800 mb-3">Resumen del Proyecto</h3>
        <div class="grid grid-cols-2 gap-4 text-sm">
          <div><span class="text-gray-600">Categoría:</span><span class="font-medium text-gray-800 ml-2">${
            p.categoria
          }</span></div>
          <div><span class="text-gray-600">Estatus:</span><span class="font-medium text-gray-800 ml-2">${
            p.estatusGeneral
          }</span></div>
          <div><span class="text-gray-600">Inversión:</span><span class="font-medium text-gray-800 ml-2">$${formatNumber(
            p.inversionTotal
          )}</span></div>
          <div><span class="text-gray-600">Beneficiarios:</span><span class="font-medium text-gray-800 ml-2">${formatNumber(
            p.beneficiarios
          )}</span></div>
        </div>
        <div class="mt-4">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-700">Progreso General</span>
            <span class="text-sm font-bold text-gray-800">${progreso}%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full" style="width:${progreso}%"></div>
          </div>
        </div>
      </div>

      <div>
        <h3 class="font-semibold text-gray-800 mb-3">Cronograma de Etapas</h3>
        <div class="space-y-3">
          ${etapasHTML.join("")}
        </div>
      </div>

      <div>
        <h3 class="font-semibold text-gray-800 mb-3">Acciones Rápidas</h3>
        <div class="flex flex-wrap gap-2">
          <button onclick="editProyecto('${
            p.id
          }'); closeDrawer();" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 text-sm"><i class="fas fa-edit mr-1"></i>Editar</button>
          <button onclick="toggleProyectoStatus('${p.id}')" class="bg-${
        p.estatusGeneral === "Pausado" ? "green" : "orange"
      }-600 text-white px-3 py-2 rounded-lg hover:bg-${
        p.estatusGeneral === "Pausado" ? "green" : "orange"
      }-700 text-sm">
            <i class="fas fa-${
              p.estatusGeneral === "Pausado" ? "play" : "pause"
            } mr-1"></i>${
        p.estatusGeneral === "Pausado" ? "Reanudar" : "Pausar"
      }
          </button>
          ${
            progreso < 100
              ? `<button onclick="completeProyecto('${p.id}')" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 text-sm"><i class="fas fa-check mr-1"></i>Completar</button>`
              : ""
          }
        </div>
      </div>
    </div>
  `;

      drawer.classList.remove("translate-x-full");
    };

    function closeDrawer() {
      document
        .getElementById("projects-details-drawer")
        .classList.add("translate-x-full");
    }

    //comment
    window.toggleProyectoStatus = function (id) {
      const p = proyectos.find((x) => x.id === id);
      if (!p) return;
      p.estatusGeneral =
        p.estatusGeneral === "Pausado" ? "En Progreso" : "Pausado";
      saveProyectos();
      filterProyectos();
      updateKPIs();
      openDrawer(id);
    };
    window.completeProyecto = function (id) {
      if (!confirm("¿Marcar como completado?")) return;
      const p = proyectos.find((x) => x.id === id);
      if (!p) return;
      p.estatusGeneral = "Completado";
      p.etapas.forEach((e) => {
        e.tareas?.forEach((t) => (t.completada = true));
        e.avanceManual = 100;
      });
      saveProyectos();
      filterProyectos();
      updateKPIs();
      openDrawer(id);
    };

    // ---------------- Export CSV ----------------
    function exportCSV() {
      const headers = [
        "Nombre",
        "Categoría",
        "Inversión Total",
        "Beneficiarios",
        "Estatus",
        "Progreso %",
      ];
      const rows = proyectos.map((p) => [
        p.nombre,
        p.categoria,
        p.inversionTotal,
        p.beneficiarios,
        p.estatusGeneral,
        calcularProgreso(p),
      ]);
      const csv = [headers, ...rows]
        .map((r) =>
          r.map((f) => `"${String(f).replace(/"/g, '""')}"`).join(",")
        )
        .join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `proyectos_${new Date().toISOString().slice(0, 10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }
  })();
</script>
