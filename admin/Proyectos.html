<section
  id="ProjectsAdmin"
  class="p-6 bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen"
>
  <!-- Top Controls -->
  <div class="mb-8">
    <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-gray-800 mb-2">
          Proyectos Municipales
        </h1>
        <p class="text-gray-600">
          Gestión integral de proyectos e inversiones públicas
        </p>
      </div>
      <div class="flex flex-wrap gap-3 mt-4 lg:mt-0">
        <button
          id="projects-add-btn"
          class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 py-2 rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-200 flex items-center shadow-sm"
        >
          <i class="fas fa-plus mr-2"></i>
          Agregar Proyecto
        </button>
      </div>
    </div>

    <!-- Search and Filters -->
    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
      <div class="flex flex-col lg:flex-row gap-4 mb-4">
        <div class="flex-1">
          <label for="projects-search" class="sr-only">Buscar proyectos</label>
          <div class="relative">
            <i
              class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
            ></i>
            <input
              type="text"
              id="projects-search"
              placeholder="Buscar proyectos... (presiona / para enfocar)"
              class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
        </div>
        <div class="flex flex-wrap gap-2">
          <select
            id="projects-filter-categoria"
            class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="">Todas las categorías</option>
            <option value="Infraestructura">Infraestructura</option>
            <option value="Desarrollo Social">Desarrollo Social</option>
            <option value="Medio Ambiente">Medio Ambiente</option>
            <option value="Tecnología">Tecnología</option>
            <option value="Educación">Educación</option>
            <option value="Salud">Salud</option>
          </select>
          <select
            id="projects-filter-estatus"
            class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="">Todos los estatus</option>
            <option value="Planificación">Planificación</option>
            <option value="En Progreso">En Progreso</option>
            <option value="Pausado">Pausado</option>
            <option value="Completado">Completado</option>
            <option value="Cancelado">Cancelado</option>
          </select>
          <input
            type="date"
            id="projects-filter-fecha-inicio"
            class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
          <input
            type="date"
            id="projects-filter-fecha-fin"
            class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
      </div>
      <div id="projects-filter-chips" class="flex flex-wrap gap-2"></div>
    </div>
  </div>

  <!-- KPIs Row -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-2xl font-bold text-gray-800" id="projects-kpi-activos">
            0
          </p>
          <p class="text-gray-600 text-sm">Proyectos Activos</p>
        </div>
        <div class="bg-blue-100 p-3 rounded-lg">
          <i class="fas fa-project-diagram text-blue-600 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-green-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-2xl font-bold text-gray-800" id="projects-kpi-avance">
            0%
          </p>
          <p class="text-gray-600 text-sm">Avance Promedio</p>
        </div>
        <div class="bg-green-100 p-3 rounded-lg">
          <i class="fas fa-chart-line text-green-600 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-500">
      <div class="flex items-center justify-between">
        <div>
          <p
            class="text-2xl font-bold text-gray-800"
            id="projects-kpi-inversion"
          >
            $0
          </p>
          <p class="text-gray-600 text-sm">Inversión Total</p>
        </div>
        <div class="bg-purple-100 p-3 rounded-lg">
          <i class="fas fa-dollar-sign text-purple-600 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-indigo-500">
      <div class="flex items-center justify-between">
        <div>
          <p
            class="text-2xl font-bold text-gray-800"
            id="projects-kpi-beneficiarios"
          >
            0
          </p>
          <p class="text-gray-600 text-sm">Beneficiarios</p>
        </div>
        <div class="bg-indigo-100 p-3 rounded-lg">
          <i class="fas fa-users text-indigo-600 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-red-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-2xl font-bold text-gray-800" id="projects-kpi-riesgo">
            0
          </p>
          <p class="text-gray-600 text-sm">En Riesgo</p>
        </div>
        <div class="bg-red-100 p-3 rounded-lg">
          <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Projects Table -->
  <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-8">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead
          class="bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200"
        >
          <tr>
            <th
              class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Proyecto
            </th>
            <th
              class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Categoría
            </th>
            <th
              class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Inversión
            </th>
            <th
              class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Beneficiarios
            </th>
            <th
              class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Avance
            </th>
            <th
              class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Estatus
            </th>
            <th
              class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Tiempo
            </th>
            <th
              class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Acciones
            </th>
          </tr>
        </thead>
        <tbody
          id="projects-table-body"
          class="bg-white divide-y divide-gray-200"
        ></tbody>
      </table>
    </div>
    <!-- Empty State -->
    <div id="projects-empty-state" class="text-center py-12 hidden">
      <div
        class="bg-gray-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4"
      >
        <i class="fas fa-project-diagram text-gray-400 text-2xl"></i>
      </div>
      <h3 class="text-lg font-medium text-gray-800 mb-2">
        No hay proyectos registrados
      </h3>
      <p class="text-gray-600 mb-4">
        Comienza agregando tu primer proyecto municipal.
      </p>
      <button
        id="projects-empty-add"
        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200"
      >
        <i class="fas fa-plus mr-2"></i>
        Agregar Proyecto
      </button>
    </div>
  </div>

  <!-- Details Drawer -->
  <div
    id="projects-details-drawer"
    class="fixed inset-y-0 right-0 w-full lg:w-1/2 xl:w-1/3 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 overflow-y-auto"
  >
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-gray-800" id="projects-drawer-title">
          Detalles del Proyecto
        </h2>
        <button
          id="projects-drawer-close"
          class="text-gray-400 hover:text-gray-600 transition-colors duration-200"
        >
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div id="projects-drawer-content"></div>
    </div>
  </div>

  <!-- Form Modal -->
  <div
    id="projects-modal"
    class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4"
  >
    <div
      class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
    >
      <div class="p-6 border-b border-gray-200">
        <div class="flex justify-between items-center">
          <h3
            id="projects-modal-title"
            class="text-2xl font-bold text-gray-800"
          >
            Nuevo Proyecto
          </h3>
          <button
            id="projects-modal-close"
            class="text-gray-400 hover:text-gray-600 transition-colors duration-200"
          >
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>

      <form id="projects-form" class="p-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="lg:col-span-2">
            <label
              for="projects-form-nombre"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Nombre del Proyecto *</label
            >
            <input
              type="text"
              id="projects-form-nombre"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            <div>
              <label class="inline-flex items-center flex">
                <input
                  type="checkbox"
                  id="projects-form-show-home"
                  class="rounded border-gray-300 text-blue-600"
                />
                <span class="ml-2 text-sm text-gray-700"
                  >Mostrar en página de inicio</span
                >
              </label>
              <p class="text-xs text-gray-500 mt-1">
                Si está marcado, el proyecto se destacará en la página
                principal.
              </p>
            </div>
          </div>

          <div>
            <label
              for="projects-form-categoria"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Categoría *</label
            >
            <select
              id="projects-form-categoria"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">Seleccionar categoría</option>
              <option value="Infraestructura">Infraestructura</option>
              <option value="Desarrollo Social">Desarrollo Social</option>
              <option value="Medio Ambiente">Medio Ambiente</option>
              <option value="Tecnología">Tecnología</option>
              <option value="Educación">Educación</option>
              <option value="Salud">Salud</option>
            </select>
          </div>
          <div>
            <label
              for="projects-form-estatus"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Estatus *</label
            >
            <select
              id="projects-form-estatus"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="Planificación">Planificación</option>
              <option value="En Progreso">En Progreso</option>
              <option value="Pausado">Pausado</option>
              <option value="Completado">Completado</option>
              <option value="Cancelado">Cancelado</option>
            </select>
          </div>
          <div>
            <label
              for="projects-form-inversion"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Inversión Total *</label
            >
            <input
              type="number"
              id="projects-form-inversion"
              required
              min="0"
              step="0.01"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
          <div>
            <label
              for="projects-form-beneficiarios"
              class="block text-sm font-medium text-gray-700 mb-2"
              >Beneficiarios *</label
            >
            <input
              type="number"
              id="projects-form-beneficiarios"
              required
              min="0"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
        </div>

        <!-- Etapas Section -->
        <div class="mb-6">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-lg font-semibold text-gray-800">
              Cronograma y Etapas
            </h4>
            <button
              type="button"
              id="projects-add-etapa"
              class="bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700 transition-colors duration-200 text-sm"
            >
              <i class="fas fa-plus mr-1"></i>
              Agregar Etapa
            </button>
          </div>
          <div id="projects-etapas-container" class="space-y-4"></div>
          <div class="mt-4 p-4 bg-gray-50 rounded-lg">
            <div class="flex justify-between items-center">
              <span class="text-sm font-medium text-gray-700"
                >Total de pesos:</span
              >
              <span
                id="projects-peso-total"
                class="text-sm font-bold text-gray-800"
                >0%</span
              >
            </div>
            <div
              id="projects-peso-error"
              class="text-red-600 text-sm mt-1 hidden"
            >
              La suma de los pesos debe ser exactamente 100%
            </div>
          </div>
        </div>

        <div class="flex justify-end space-x-4">
          <button
            type="button"
            id="projects-form-cancel"
            class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200"
          >
            Cancelar
          </button>
          <button
            type="button"
            id="projects-form-duplicate"
            class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors duration-200 hidden"
          >
            <i class="fas fa-copy mr-2"></i>
            Duplicar
          </button>
          <button
            type="button"
            id="projects-form-delete"
            class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200 hidden"
          >
            <i class="fas fa-trash mr-2"></i>
            Eliminar
          </button>
          <button
            type="submit"
            id="projects-form-submit"
            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200"
          >
            <i class="fas fa-save mr-2"></i>
            Guardar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Import Modal -->
  <div
    id="projects-import-modal"
    class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4"
  >
    <div class="bg-white rounded-xl max-w-md w-full">
      <div class="p-6 border-b border-gray-200">
        <h3 class="text-xl font-bold text-gray-800">Importar Proyectos</h3>
      </div>
      <div class="p-6">
        <input
          type="file"
          id="projects-import-file"
          accept=".json"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-4"
        />
        <div class="flex justify-end space-x-4">
          <button
            id="projects-import-cancel"
            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200"
          >
            Cancelar
          </button>
          <button
            id="projects-import-confirm"
            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors duration-200"
          >
            Importar
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
(function () {
  "use strict";

  const STORAGE_KEY = "municipio.proyectos.v1";
  const IDB_NAME = "proyectos_media";
  const IDB_STORE = "etapa_fotos";

  let proyectos = [];
  let filteredProyectos = [];
  let currentEditId = null;
  let etapaCounter = 0;
  let tareaCounter = 0;
  let db = null;

  // ---------- Utils ----------
  function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
  }
  function formatNumber(n) {
    return new Intl.NumberFormat("es-MX").format(n);
  }

  function getEstatusColor(s) {
    return ({
      Planificación: "bg-yellow-100 text-yellow-800",
      "En Progreso": "bg-blue-100 text-blue-800",
      Pausado: "bg-orange-100 text-orange-800",
      Completado: "bg-green-100 text-green-800",
      Cancelado: "bg-red-100 text-red-800",
    }[s] || "bg-gray-100 text-gray-800");
  }

  function getTiempoColor(v) {
    return ({
      completado: "bg-green-100 text-green-800",
      "a-tiempo": "bg-green-100 text-green-800",
      "retraso-leve": "bg-yellow-100 text-yellow-800",
      critico: "bg-red-100 text-red-800",
      "sin-datos": "bg-gray-100 text-gray-800",
    }[v.status] || "bg-gray-100 text-gray-800");
  }

  // ---------- IndexedDB ----------
  function idbOpen() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(IDB_NAME, 1);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(IDB_STORE)) {
          const store = db.createObjectStore(IDB_STORE, { keyPath: "id" });
          store.createIndex("byEtapa", "etapaId", { unique: false });
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function idbSavePhoto(etapaId, file) {
    const id = generateId();
    const blob = file instanceof Blob ? file : new Blob([file]);
    return new Promise((resolve, reject) => {
      const tx = db.transaction(IDB_STORE, "readwrite");
      tx.objectStore(IDB_STORE).put({
        id,
        etapaId,
        blob,
        mime: blob.type,
        filename: file.name || "imagen",
        createdAt: new Date().toISOString(),
      });
      tx.oncomplete = () => resolve(id);
      tx.onerror = () => reject(tx.error);
    });
  }
  async function idbGetPhotos(etapaId) {
    return new Promise((resolve, reject) => {
      const tx = db.transaction(IDB_STORE, "readonly");
      const idx = tx.objectStore(IDB_STORE).index("byEtapa");
      const req = idx.getAll(etapaId);
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  }
  async function idbGetPhotoById(photoId) {
    return new Promise((resolve, reject) => {
      const tx = db.transaction(IDB_STORE, "readonly");
      const req = tx.objectStore(IDB_STORE).get(photoId);
      req.onsuccess = () => resolve(req.result || null);
      req.onerror = () => reject(req.error);
    });
  }
  async function idbDeletePhoto(photoId) {
    return new Promise((resolve, reject) => {
      const tx = db.transaction(IDB_STORE, "readwrite");
      tx.objectStore(IDB_STORE).delete(photoId);
      tx.oncomplete = () => resolve(true);
      tx.onerror = () => reject(tx.error);
    });
  }

  // ---------- Data ----------
  function saveProyectos() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(proyectos));
  }
  function loadProyectos() {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      proyectos = JSON.parse(stored);
      return;
    }
    // seed
    proyectos = [
      {
        id: "1",
        nombre: "Renovación del Parque Central",
        categoria: "Infraestructura",
        inversionTotal: 2500000,
        beneficiarios: 15000,
        estatusGeneral: "En Progreso",
        etapas: [],
      },
    ];
    saveProyectos();
  }

  // ---------- Calculations ----------
  function calcularAvanceEtapa(e) {
    if (typeof e.avanceManual === "number")
      return Math.max(0, Math.min(100, e.avanceManual));
    if (!e.tareas?.length) return 0;
    const done = e.tareas.filter((t) => t.completada).length;
    return Math.round((done / e.tareas.length) * 100);
  }
  function calcularProgreso(p) {
    if (!p.etapas?.length) return 0;
    let total = 0;
    p.etapas.forEach((e) => {
      total += (e.peso / 100) * calcularAvanceEtapa(e);
    });
    return Math.round(total);
  }
  function calcularVariacionTiempo(p) {
    if (!p.etapas?.length) return { status: "sin-datos", label: "Sin datos" };
    const prog = calcularProgreso(p);
    const fin = new Date(p.etapas[p.etapas.length - 1].fin);
    const hoy = new Date();
    if (prog === 100) return { status: "completado", label: "Completado" };
    if (hoy <= fin) return { status: "a-tiempo", label: "A tiempo" };
    const dias = Math.floor((hoy - fin) / (1000 * 60 * 60 * 24));
    return dias <= 7
      ? { status: "retraso-leve", label: `${dias}d retraso` }
      : { status: "critico", label: `${dias}d crítico` };
  }

  // ---------- Filters / Render ----------
  function filterProyectos() {
    const search = document.getElementById("projects-search").value.toLowerCase();
    const categoria = document.getElementById("projects-filter-categoria").value;
    const estatus = document.getElementById("projects-filter-estatus").value;

    filteredProyectos = proyectos.filter((p) => {
      if (search && !p.nombre.toLowerCase().includes(search)) return false;
      if (categoria && p.categoria !== categoria) return false;
      if (estatus && p.estatusGeneral !== estatus) return false;
      return true;
    });
    renderProyectos();
  }

  function renderProyectos() {
    const tbody = document.getElementById("projects-table-body");
    const empty = document.getElementById("projects-empty-state");
    if (!filteredProyectos.length) {
      tbody.innerHTML = "";
      empty.classList.remove("hidden");
      return;
    }
    empty.classList.add("hidden");
    tbody.innerHTML = filteredProyectos
      .map(
        (p) => `
      <tr onclick="openDrawer('${p.id}')" class="hover:bg-gray-50 cursor-pointer">
        <td class="px-6 py-4 font-medium">${p.nombre}</td>
        <td class="px-6 py-4">${p.categoria}</td>
        <td class="px-6 py-4">$${formatNumber(p.inversionTotal)}</td>
        <td class="px-6 py-4">${formatNumber(p.beneficiarios)}</td>
        <td class="px-6 py-4">${calcularProgreso(p)}%</td>
        <td class="px-6 py-4"><span class="px-2 py-1 rounded ${getEstatusColor(
          p.estatusGeneral
        )}">${p.estatusGeneral}</span></td>
        <td class="px-6 py-4">
          <button onclick="event.stopPropagation(); editProyecto('${p.id}')" class="text-blue-600"><i class="fas fa-edit"></i></button>
          <button onclick="event.stopPropagation(); deleteProyectoFromTable('${p.id}')" class="text-red-600 ml-2"><i class="fas fa-trash"></i></button>
        </td>
      </tr>`
      )
      .join("");
  }

  // ---------- CRUD ----------
  window.editProyecto = (id) => openModal(id);
  window.deleteProyectoFromTable = (id) => {
    if (!confirm("¿Eliminar proyecto?")) return;
    proyectos = proyectos.filter((p) => p.id !== id);
    saveProyectos();
    filterProyectos();
  };

  function openModal(id = null) {
    currentEditId = id;
    document.getElementById("projects-modal").classList.remove("hidden");
  }
  function closeModal() {
    document.getElementById("projects-modal").classList.add("hidden");
  }

  // ---------- Drawer ----------
  window.openDrawer = (id) => {
    const p = proyectos.find((x) => x.id === id);
    if (!p) return;
    const d = document.getElementById("projects-details-drawer");
    document.getElementById("projects-drawer-title").textContent = p.nombre;
    document.getElementById("projects-drawer-content").innerHTML = `
      <p class="text-sm text-gray-600">Categoría: ${p.categoria}</p>
      <p class="text-sm text-gray-600">Estatus: ${p.estatusGeneral}</p>
      <p class="text-sm text-gray-600">Inversión: $${formatNumber(
        p.inversionTotal
      )}</p>
    `;
    d.classList.remove("translate-x-full");
  };
  function closeDrawer() {
    document.getElementById("projects-details-drawer").classList.add("translate-x-full");
  }

  // ---------- Init ----------
  function init() {
    idbOpen().then((r) => (db = r)).catch(console.error);
    loadProyectos();
    filteredProyectos = [...proyectos];
    renderProyectos();

    document.getElementById("projects-add-btn").addEventListener("click", () => openModal());
    document.getElementById("projects-search").addEventListener("input", filterProyectos);
    document.getElementById("projects-filter-categoria").addEventListener("change", filterProyectos);
    document.getElementById("projects-filter-estatus").addEventListener("change", filterProyectos);
    document.getElementById("projects-modal-close").addEventListener("click", closeModal);
    document.getElementById("projects-drawer-close").addEventListener("click", closeDrawer);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
</script>
