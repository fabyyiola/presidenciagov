<!-- Transparencia.html (fragment only) -->
<section class="section-content p-6">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-3xl font-bold text-gray-800 mb-2">Transparencia</h2>
      <p class="text-gov-gray">Administración de documentos oficiales (PDF).</p>
    </div>
    <button onclick="Transparencia.openForm()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition flex items-center">
      <i class="fas fa-plus mr-2"></i> Agregar Documento
    </button>
  </div>

  <!-- Filtros -->
  <div class="bg-white p-5 rounded-xl shadow mb-6">
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
      <input id="filterSearch" type="text" placeholder="Buscar título o descripción..." class="px-4 py-2 border rounded-lg" oninput="Transparencia.applyFilters()">
      <select id="filterCategoria" class="px-4 py-2 border rounded-lg" onchange="Transparencia.applyFilters()">
        <option value="">Todas las categorías</option>
        <option value="Presupuesto">Presupuesto</option>
        <option value="Nómina">Nómina</option>
        <option value="Contrataciones">Contrataciones</option>
        <option value="Obra Pública">Obra Pública</option>
        <option value="Informes">Informes</option>
      </select>
      <select id="filterDependencia" class="px-4 py-2 border rounded-lg" onchange="Transparencia.applyFilters()">
        <option value="">Todas las dependencias</option>
        <option>Presidencia Municipal</option>
        <option>Tesorería</option>
        <option>Obras Públicas</option>
        <option>Recursos Humanos</option>
        <option>Contraloría</option>
      </select>
      <select id="filterAnio" class="px-4 py-2 border rounded-lg" onchange="Transparencia.applyFilters()">
        <option value="">Todos los años</option>
        <option>2025</option><option>2024</option><option>2023</option><option>2022</option>
      </select>
      <select id="filterEstado" class="px-4 py-2 border rounded-lg" onchange="Transparencia.applyFilters()">
        <option value="">Todos</option>
        <option>Publicado</option>
        <option>Borrador</option>
      </select>
    </div>
    <div class="mt-2">
      <button onclick="Transparencia.clearFilters()" class="text-sm text-blue-600 hover:underline">Limpiar filtros</button>
      <span id="countLabel" class="text-sm text-gov-gray ml-2"></span>
    </div>
  </div>

  <!-- Tabla -->
  <div class="bg-white rounded-xl shadow overflow-hidden">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50">
        <tr class="text-left">
          <th class="px-4 py-3">Título</th>
          <th class="px-4 py-3">Categoría</th>
          <th class="px-4 py-3">Dependencia</th>
          <th class="px-4 py-3">Periodo</th>
          <th class="px-4 py-3">Estado</th>
          <th class="px-4 py-3">Acciones</th>
        </tr>
      </thead>
      <tbody id="docs-body"></tbody>
    </table>
  </div>
</section>

<!-- Modal: Agregar/Editar Documento -->
<div id="transp-modal" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
    <div class="flex items-center justify-between px-6 py-4 border-b">
      <h3 id="transp-title" class="text-lg font-bold">Agregar Documento</h3>
      <button onclick="Transparencia.closeForm()" class="text-gov-gray hover:text-gray-800"><i class="fas fa-times"></i></button>
    </div>

    <form id="transp-form" class="p-6 space-y-4">
      <div>
        <label class="block text-sm font-medium">Título *</label>
        <input id="docTitulo" required class="w-full px-3 py-2 border rounded-lg" />
      </div>
      <div>
        <label class="block text-sm font-medium">Descripción</label>
        <textarea id="docDesc" rows="2" class="w-full px-3 py-2 border rounded-lg" placeholder="Breve resumen del contenido..."></textarea>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium">Categoría *</label>
          <select id="docCategoria" required class="w-full px-3 py-2 border rounded-lg">
            <option value="">Seleccionar</option>
            <option>Presupuesto</option>
            <option>Nómina</option>
            <option>Contrataciones</option>
            <option>Obra Pública</option>
            <option>Informes</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">Dependencia *</label>
          <select id="docDependencia" required class="w-full px-3 py-2 border rounded-lg">
            <option value="">Seleccionar</option>
            <option>Presidencia Municipal</option>
            <option>Tesorería</option>
            <option>Obras Públicas</option>
            <option>Recursos Humanos</option>
            <option>Contraloría</option>
          </select>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium">Año *</label>
          <select id="docAnio" required class="w-full px-3 py-2 border rounded-lg">
            <option value="">Seleccionar</option>
            <option>2025</option><option>2024</option><option>2023</option><option>2022</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">Mes</label>
          <select id="docMes" class="w-full px-3 py-2 border rounded-lg">
            <option value="">(Opcional)</option>
            <option>01</option><option>02</option><option>03</option><option>04</option>
            <option>05</option><option>06</option><option>07</option><option>08</option>
            <option>09</option><option>10</option><option>11</option><option>12</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">Estado *</label>
          <select id="docEstado" required class="w-full px-3 py-2 border rounded-lg">
            <option>Publicado</option>
            <option>Borrador</option>
          </select>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium">Archivo PDF *</label>
        <input id="docFile" type="file" accept="application/pdf" class="w-full px-3 py-2 border rounded-lg" />
        <p class="text-xs text-gov-gray mt-1">Tamaño recomendado &lt; 20 MB. Si ya hay un PDF cargado, selecciona otro para reemplazarlo.</p>
        <div id="pdfInfo" class="text-sm text-gray-600 mt-2"></div>
      </div>

      <div class="flex justify-end gap-3 pt-2">
        <button type="button" onclick="Transparencia.closeForm()" class="px-4 py-2 border rounded-lg">Cancelar</button>
        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Guardar</button>
      </div>
    </form>
  </div>
</div>

<script>
(() => {
  // -------- Storage keys --------
  let LS_KEY = 'transparenciaDocs'; // only metadata
  let docs = [];
  let editId = null;
  let pendingFile = null; // { blob, name, size }

  // -------- IndexedDB for PDFs --------
  let db;
  const openReq = indexedDB.open('TransparenciaDB', 1);
  openReq.onupgradeneeded = (e) => {
    db = e.target.result;
    if (!db.objectStoreNames.contains('archivos')) db.createObjectStore('archivos');
  };
  openReq.onsuccess = (e) => {
    db = e.target.result;
    // load metadata after DB is ready
    docs = jsonGet(LS_KEY, []);
    render();
  };
  openReq.onerror = () => console.error('IndexedDB error (TransparenciaDB)');

  function idbPut(key, blob) {
    return new Promise((resolve, reject) => {
      const tx = db.transaction('archivos', 'readwrite');
      tx.objectStore('archivos').put(blob, key);
      tx.oncomplete = resolve;
      tx.onerror = reject;
    });
  }
  function idbGet(key) {
    return new Promise((resolve, reject) => {
      const tx = db.transaction('archivos', 'readonly');
      const req = tx.objectStore('archivos').get(key);
      req.onsuccess = () => resolve(req.result);
      req.onerror = reject;
    });
  }
  function idbDelete(key) {
    const tx = db.transaction('archivos', 'readwrite');
    tx.objectStore('archivos').delete(key);
  }

  // -------- Helpers --------
  const jsonGet = (k, d) => {
    try { return JSON.parse(localStorage.getItem(k) || JSON.stringify(d)); } catch { return d; }
  };
  const jsonSet = (k, v) => localStorage.setItem(k, JSON.stringify(v));
  const byId = (id) => document.getElementById(id);
  const periodStr = (d) => d.mes ? `${d.anio}-${d.mes}` : d.anio;

  // -------- Rendering --------
  async function render(list = docs) {
    const body = byId('docs-body');
    body.innerHTML = '';

    for (const d of list) {
      // make a small "descargar" link if file exists
      let fileBtn = '';
      if (d.fileId) {
        const blob = await idbGet(d.fileId);
        if (blob) {
          const url = URL.createObjectURL(blob);
          fileBtn = `<a href="${url}" download="${(d.fileName || 'documento')}.pdf" class="inline-flex items-center text-blue-600 hover:underline">
                       <i class="fas fa-download mr-1"></i> Descargar
                     </a>`;
        } else {
          fileBtn = `<span class="text-xs text-red-600">Archivo no encontrado</span>`;
        }
      }

      const estadoBadge = d.estado === 'Publicado'
        ? `<span class="px-2 py-1 rounded bg-green-100 text-green-700">Publicado</span>`
        : `<span class="px-2 py-1 rounded bg-gray-100 text-gray-600">Borrador</span>`;

      const tr = document.createElement('tr');
      tr.className = 'border-t';
      tr.innerHTML = `
        <td class="px-4 py-3">
          <div class="font-semibold">${d.titulo}</div>
          <div class="text-gray-500 text-xs line-clamp-2">${d.descripcion || ''}</div>
        </td>
        <td class="px-4 py-3">${d.categoria}</td>
        <td class="px-4 py-3">${d.dependencia}</td>
        <td class="px-4 py-3">${periodStr(d)}</td>
        <td class="px-4 py-3">${estadoBadge}</td>
        <td class="px-4 py-3 flex items-center gap-3">
          ${fileBtn}
          <button onclick="Transparencia.edit(${d.id})" class="text-yellow-600 hover:text-yellow-700"><i class="fas fa-edit"></i></button>
          <button onclick="Transparencia.remove(${d.id})" class="text-red-600 hover:text-red-700"><i class="fas fa-trash"></i></button>
        </td>
      `;
      body.appendChild(tr);
    }
    byId('countLabel').textContent = `${list.length} documento(s) encontrados`;
    // fill dynamic organizer/dependencia filter options from data (unique)
    fillDynamicFilters();
  }

  function fillDynamicFilters() {
    const depSel = byId('filterDependencia');
    const cats = new Set(), deps = new Set(), years = new Set();
    docs.forEach(d => { cats.add(d.categoria); deps.add(d.dependencia); years.add(d.anio); });

    // Dependencias
    const current = depSel.value;
    depSel.innerHTML = `<option value="">Todas las dependencias</option>` +
      Array.from(deps).filter(Boolean).sort().map(v => `<option>${v}</option>`).join('');
    depSel.value = current;
  }

  // -------- Filters --------
  function applyFilters() {
    const q = byId('filterSearch').value.trim().toLowerCase();
    const cat = byId('filterCategoria').value;
    const dep = byId('filterDependencia').value;
    const year = byId('filterAnio').value;
    const est = byId('filterEstado').value;

    let list = docs.slice();
    if (q) list = list.filter(d =>
      (d.titulo||'').toLowerCase().includes(q) ||
      (d.descripcion||'').toLowerCase().includes(q)
    );
    if (cat) list = list.filter(d => d.categoria === cat);
    if (dep) list = list.filter(d => d.dependencia === dep);
    if (year) list = list.filter(d => d.anio === year);
    if (est) list = list.filter(d => d.estado === est);

    render(list);
  }
  function clearFilters() {
    ['filterSearch','filterCategoria','filterDependencia','filterAnio','filterEstado'].forEach(id => byId(id).value = '');
    render();
  }

  // -------- Modal form --------
  function openForm(id = null) {
    editId = id;
    byId('transp-modal').classList.remove('hidden');
    byId('transp-title').textContent = id ? 'Editar Documento' : 'Agregar Documento';
    byId('transp-form').reset();
    byId('pdfInfo').textContent = '';
    pendingFile = null;

    if (id) {
      const d = docs.find(x => x.id === id);
      if (!d) return;
      byId('docTitulo').value = d.titulo || '';
      byId('docDesc').value = d.descripcion || '';
      byId('docCategoria').value = d.categoria || '';
      byId('docDependencia').value = d.dependencia || '';
      byId('docAnio').value = d.anio || '';
      byId('docMes').value = d.mes || '';
      byId('docEstado').value = d.estado || 'Borrador';
      if (d.fileName) byId('pdfInfo').textContent = `PDF actual: ${d.fileName}`;
    }
  }
  function closeForm() { byId('transp-modal').classList.add('hidden'); }

  byId('docFile').addEventListener('change', (e) => {
    const f = e.target.files?.[0];
    if (!f) { pendingFile = null; byId('pdfInfo').textContent = ''; return; }
    if (f.type !== 'application/pdf') { alert('Solo se aceptan archivos PDF'); e.target.value=''; return; }
    pendingFile = { blob: f, name: f.name, size: f.size };
    byId('pdfInfo').textContent = `Archivo seleccionado: ${f.name} (${Math.round(f.size/1024)} KB)`;
  });

  byId('transp-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = {
      titulo: byId('docTitulo').value.trim(),
      descripcion: byId('docDesc').value.trim(),
      categoria: byId('docCategoria').value,
      dependencia: byId('docDependencia').value,
      anio: byId('docAnio').value,
      mes: byId('docMes').value,
      estado: byId('docEstado').value,
    };
    if (!data.titulo || !data.categoria || !data.dependencia || !data.anio) {
      alert('Completa los campos obligatorios (*)');
      return;
    }

    // Handle file: new or keep existing
    let fileId = null, fileName = null;
    if (editId) {
      const idx = docs.findIndex(d => d.id === editId);
      if (idx === -1) return;
      fileId = docs[idx].fileId || null;
      fileName = docs[idx].fileName || null;

      if (pendingFile) {
        // replace file in IDB
        const newId = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
        await idbPut(newId, pendingFile.blob);
        if (fileId) idbDelete(fileId);
        fileId = newId;
        fileName = pendingFile.name;
      }
      docs[idx] = { ...docs[idx], ...data, fileId, fileName };
    } else {
      if (!pendingFile) { alert('Adjunta el PDF del documento'); return; }
      const newId = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
      await idbPut(newId, pendingFile.blob);
      fileId = newId; fileName = pendingFile.name;

      const newDoc = {
        id: (docs.length ? Math.max(...docs.map(d => d.id)) : 0) + 1,
        ...data,
        fileId, fileName,
        createdAt: new Date().toISOString()
      };
      docs.push(newDoc);
    }

    jsonSet(LS_KEY, docs);
    closeForm();
    applyFilters(); // re-render with current filters
  });

  // -------- CRUD actions from table --------
  function edit(id){ openForm(id); }

  function removeItem(id) {
    const d = docs.find(x => x.id === id);
    if (!d) return;
    if (!confirm('¿Eliminar este documento?')) return;
    if (d.fileId) idbDelete(d.fileId);
    docs = docs.filter(x => x.id !== id);
    jsonSet(LS_KEY, docs);
    applyFilters();
  }

  // -------- Expose globally for buttons --------
  window.Transparencia = {
    openForm, closeForm, edit, remove: removeItem,
    applyFilters, clearFilters
  };
})();
</script>
